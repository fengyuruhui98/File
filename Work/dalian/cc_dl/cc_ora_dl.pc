#include "cc_ora_dl.h"
 
#include <sqlca.h>
#include <sqlda.h>
#include <sqlcpr.h>



EXEC SQL BEGIN DECLARE SECTION;
sql_context  *g_context;
EXEC SQL END DECLARE SECTION; 
 
char ORA::ms_db_usename[50];
char ORA::ms_db_passwd[50];
char ORA::ms_db_dbname[50];

sem_t  			ORA::ms_CSSQL;	
 
 
/* ------------------------------------------------------
功能:初始化数据库变量,内存空间申请
--------------------------------------------------------- */
int ORA::init_db()
{	

	EXEC SQL ENABLE THREADS;
	
	int i;
	g_context = (sql_context *)malloc(sizeof(sql_context) * CONN_DB_COUNT);
	for(i = 0;i < CONN_DB_COUNT; i++)
	{
		EXEC SQL CONTEXT ALLOCATE :g_context[i];
	}
	
	return (sqlca.sqlcode);		
}

/* ------------------------------------------------------
功能:数据库连接
返回:失败返回0;成功返回1
--------------------------------------------------------- */
int ORA::connect_to_db(int sequence,char *username,char *passwd,char *hostname)
{	

	EXEC SQL BEGIN DECLARE SECTION;
	VARCHAR db_usename[20];
	VARCHAR db_passwd[20];
	VARCHAR db_dbname[20];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	int             i,flag;
	char            errormsg[1024];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[sequence];

	strcpy((char*)db_usename.arr, username);
	db_usename.len = (unsigned short)strlen((char*)db_usename.arr);
	
	strcpy((char*)db_passwd.arr, passwd);
	db_passwd.len = (unsigned short)strlen((char*)db_passwd.arr);
	
	strcpy((char*)db_dbname.arr, hostname);
	db_dbname.len = (unsigned short)strlen((char*)db_dbname.arr);
	
	flag = 0;
	for(i = 0;i < 20; i++)
	{
		EXEC SQL CONNECT :db_usename IDENTIFIED BY :db_passwd USING :db_dbname;
		if(sqlca.sqlcode != 0)
		{
			memset(errormsg,0x00,sizeof(errormsg));
			sprintf(errormsg,"第%d个数据库连接出错(%d)\n",sequence,sqlca.sqlcode);
			CLog::WriteAppLog(errormsg);
			
			CommonFuncs::my_sleep(5);
		}
		else
		{
			memset(errormsg,0x00,sizeof(errormsg));
			sprintf(errormsg,"第%d个数据库连接成功\n",sequence);
			CLog::WriteAppLog(errormsg);
			
			flag = 1;
			break;
		}
	}
	
	return flag;	
}

 
/* ------------------------------------------------------
功能:断开数据库连接
--------------------------------------------------------- */
void ORA::disconnect_to_db(int sequence)
{
	char   errormsg[1024];
	
	struct sqlca sqlca;

	EXEC SQL COMMIT RELEASE;
	EXEC SQL CONTEXT FREE :g_context[sequence];
	memset(errormsg,0x00,sizeof(errormsg));
	sprintf(errormsg,"第%d个数据库断开连接\n",sequence);
	CLog::WriteAppLog(errormsg);
}

/* ------------------------------------------------------
功能:释放数据库内存空间
--------------------------------------------------------- */
void ORA::free_db()
{
	if(g_context != NULL)
	{
		free(g_context);
		g_context = NULL;
	}
}


/*--------------------------------------------------------------
功能:静态变量赋值，数据库连接初始化
返回:成功返回1,失败返回0
----------------------------------------------------------------*/
int ORA::DbStart(char *username,char *passwd,char *hostname)
{
		int ret = 0;
		
		/*-------静态变量初始化并赋值-------------------*/
		memset(ms_db_usename,0x00,sizeof(ms_db_usename));
		strcpy(ms_db_usename,username);
		
		memset(ms_db_passwd,0x00,sizeof(ms_db_passwd));
		strcpy(ms_db_passwd,passwd);
		
		memset(ms_db_dbname,0x00,sizeof(ms_db_dbname));
		strcpy(ms_db_dbname,hostname);

		/*-------初始化信号量-------------------*/
		sem_init(&ms_CSSQL,0,1);

		/* -------- 连接数据库 ---------- */
	  init_db();
	  
		for(int i = 0;i < CONN_DB_COUNT; i++)
		{
			ret = connect_to_db(i,username,passwd,hostname);
			if(ret == 0)
				break;
		}
		
		if(ret == 0)
		{
			return 0;
		}
	 
	 return 1;
};

/*--------------------------------------------------------------
功能:断开数据库连接,释放空间，销毁信号量
----------------------------------------------------------------*/
void ORA::DbEnd()
{
	sem_wait(&ms_CSSQL);
  for(int i = 0;i < CONN_DB_COUNT; i++)
	{
		disconnect_to_db(i);
	}
	free_db();
	sem_post(&ms_CSSQL);

	//*释放信号量
	sem_destroy(&ms_CSSQL);
}
 
/* ------------------------------------------------------
            获得设备信息列表
--------------------------------------------------------- */
void ORA::getsclist()
{
	EXEC SQL BEGIN DECLARE SECTION;
	char scip[20],temp[20];
	int  scport;
	int  lineId;
	int  downloadflag;
	char sccode[9];
	int  lv_count;
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];		
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL WHENEVER NOT FOUND CONTINUE;	
	
	int i,count;

	for(i=0;i<MAX_SLE_COUNT;i++)
	{
		CConfig::g_ScList[i].lineId        = 0;
		memset(CConfig::g_ScList[i].scip,0x00,sizeof(CConfig::g_ScList[i].scip));
		memset(CConfig::g_ScList[i].sccode,0x00,sizeof(CConfig::g_ScList[i].sccode));
		CConfig::g_ScList[i].scport        = 0;
		CConfig::g_ScList[i].IsConnect     = 1;
		CConfig::g_ScList[i].downloadflag  = 0;
		CConfig::g_ScList[i].EntryFlow  = 0;
		CConfig::g_ScList[i].ExitFlow  = 0;
		CConfig::g_ScList[i].SJTFlow  = 0;
		CConfig::g_ScList[i].uploadfag  = 0;
	}
   
	count = 0;       
	EXEC SQL DECLARE SQL_SCINFO_cursor CURSOR FOR SELECT LINE_ID,SC_NID,SC_IP,SC_PORT,DOWNLOAD_FLAG 
	                                               FROM TBL_SS_SC_INFO 
                                                 ORDER BY SC_NID;
	EXEC SQL OPEN SQL_SCINFO_cursor;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "SQL_SCINFO_cursor error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	for(;;)
	{
		memset(temp,0x00,sizeof(temp));
		memset(sccode,0x00,sizeof(sccode));
		EXEC SQL FETCH SQL_SCINFO_cursor INTO :lineId,:sccode,:temp,:scport,:downloadflag;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "SQL_SCINFO_cursor error code is %d\n",sqlca.sqlcode);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_SCINFO_cursor;
				return;
			}
		}
		
		CConfig::g_ScList[count].lineId       = lineId;
		CConfig::g_ScList[count].scport       = scport;
		CConfig::g_ScList[count].downloadflag = downloadflag;
		memset(scip,0x00,sizeof(scip));
		CommonFuncs::delspace(scip,temp);
		strcpy(CConfig::g_ScList[count].scip,scip);
		strcpy(CConfig::g_ScList[count].sccode,sccode);
			
		count++;
		
	}
	EXEC SQL CLOSE SQL_SCINFO_cursor;
}



/* ------------------------------------------------------
            获得MLC所属线路基础信息列表
--------------------------------------------------------- */
void ORA::get_mlc_line_list()
{
	EXEC SQL BEGIN DECLARE SECTION;
	int			LINE_ID;									
	char		LINE_NID[9];							
	char		UP_FTP_IP[17];						
	int			UP_FTP_PORT;							
	char		UP_FTP_USER[33];					
	char		UP_FTP_PASSWD[33];				
	char		DIR_DATA_TRANS[65];				
	char		DIR_DATA_STATUS[65];			
	char		DIR_DATA_OTHER[65];				
	char		DOWN_NORMAL_FTP_IP[17];				
	int			DOWN_NORMAL_FTP_PORT;					
	char		DOWN_NORMAL_FTP_USER[33];			
	char		DOWN_NORMAL_FTP_PASSWD[33];		
	char		DIR_PARAM_MODE[65];						
	char		DIR_SETTLE[65];								
	char		DIR_STOCK[65];								
	char		DOWN_SPECIAL_FTP_IP[17];			
	int			DOWN_SPECIAL_FTP_PORT;				
	char		DOWN_SPECIAL_FTP_USER[33];		
	char		DOWN_SPECIAL_FTP_PASSWD[33];	
	char		DIR_PARAM_RUN[65];						
	char		DIR_PARAM_OTHER[65];					
	char		DIR_PARAM_BLACKLIST[65];			
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL WHENEVER NOT FOUND CONTINUE;	
 
	int 	i,count;
	char	temp[20];
	
	for(i=0;i<MAX_SLE_COUNT;i++)
	{
		CConfig::ms_MlcLineList[i].LINE_ID			=	0;
		memset(CConfig::ms_MlcLineList[i].LINE_NID,0x00,sizeof(CConfig::ms_MlcLineList[i].LINE_NID));
		
		memset(CConfig::ms_MlcLineList[i].UP_FTP_IP,0x00,sizeof(CConfig::ms_MlcLineList[i].UP_FTP_IP));		
		CConfig::ms_MlcLineList[i].UP_FTP_PORT			=	0;
		memset(CConfig::ms_MlcLineList[i].UP_FTP_USER,0x00,sizeof(CConfig::ms_MlcLineList[i].UP_FTP_USER));		
		memset(CConfig::ms_MlcLineList[i].UP_FTP_PASSWD,0x00,sizeof(CConfig::ms_MlcLineList[i].UP_FTP_PASSWD));		
		
		memset(CConfig::ms_MlcLineList[i].DIR_DATA_TRANS,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_DATA_TRANS));		
		memset(CConfig::ms_MlcLineList[i].DIR_DATA_STATUS,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_DATA_STATUS));		
		memset(CConfig::ms_MlcLineList[i].DIR_DATA_OTHER,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_DATA_OTHER));	
                        		
		memset(CConfig::ms_MlcLineList[i].DOWN_NORMAL_FTP_IP,0x00,sizeof(CConfig::ms_MlcLineList[i].DOWN_NORMAL_FTP_IP));		
		CConfig::ms_MlcLineList[i].DOWN_NORMAL_FTP_PORT			=	0;
		memset(CConfig::ms_MlcLineList[i].DOWN_NORMAL_FTP_USER,0x00,sizeof(CConfig::ms_MlcLineList[i].DOWN_NORMAL_FTP_USER));
		memset(CConfig::ms_MlcLineList[i].DOWN_NORMAL_FTP_PASSWD,0x00,sizeof(CConfig::ms_MlcLineList[i].DOWN_NORMAL_FTP_PASSWD));
		
		memset(CConfig::ms_MlcLineList[i].DIR_PARAM_MODE,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_PARAM_MODE));
		memset(CConfig::ms_MlcLineList[i].DIR_SETTLE,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_SETTLE));                          
		memset(CConfig::ms_MlcLineList[i].DIR_STOCK,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_STOCK));
		
		memset(CConfig::ms_MlcLineList[i].DOWN_SPECIAL_FTP_IP,0x00,sizeof(CConfig::ms_MlcLineList[i].DOWN_SPECIAL_FTP_IP));		
		CConfig::ms_MlcLineList[i].DOWN_SPECIAL_FTP_PORT			=	0;
		memset(CConfig::ms_MlcLineList[i].DOWN_SPECIAL_FTP_USER,0x00,sizeof(CConfig::ms_MlcLineList[i].DOWN_SPECIAL_FTP_USER));
		memset(CConfig::ms_MlcLineList[i].DOWN_SPECIAL_FTP_PASSWD,0x00,sizeof(CConfig::ms_MlcLineList[i].DOWN_SPECIAL_FTP_PASSWD));
 
		memset(CConfig::ms_MlcLineList[i].DIR_PARAM_RUN,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_PARAM_RUN));
		memset(CConfig::ms_MlcLineList[i].DIR_PARAM_OTHER,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_PARAM_OTHER));                          
		memset(CConfig::ms_MlcLineList[i].DIR_PARAM_BLACKLIST,0x00,sizeof(CConfig::ms_MlcLineList[i].DIR_PARAM_BLACKLIST));			 
	}
   
	count = 0;       
	EXEC SQL DECLARE SQL_LINEINFO_cursor CURSOR FOR 
												 SELECT LINE_ID,LINE_NID,UP_FTP_IP,UP_FTP_PORT,UP_FTP_USER,UP_FTP_PASSWD,
																DIR_DATA_TRANS,DIR_DATA_STATUS,DIR_DATA_OTHER,
																DOWN_NORMAL_FTP_IP,DOWN_NORMAL_FTP_PORT,DOWN_NORMAL_FTP_USER,DOWN_NORMAL_FTP_PASSWD,
																DIR_PARAM_MODE,DIR_SETTLE,DIR_STOCK,
																DOWN_SPECIAL_FTP_IP,DOWN_SPECIAL_FTP_PORT,DOWN_SPECIAL_FTP_USER,DOWN_SPECIAL_FTP_PASSWD,
																DIR_PARAM_RUN,DIR_PARAM_OTHER,DIR_PARAM_BLACKLIST 
                           FROM TBL_SS_MLC_LINE 
                           ORDER BY LINE_ID;
	EXEC SQL OPEN SQL_LINEINFO_cursor;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "SQL_LINEINFO_cursor error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	for(;;)
	{
		memset(LINE_NID,0x00,sizeof(LINE_NID));
		
		memset(UP_FTP_IP,0x00,sizeof(UP_FTP_IP));		
		memset(UP_FTP_USER,0x00,sizeof(UP_FTP_USER));		
		memset(UP_FTP_PASSWD,0x00,sizeof(UP_FTP_PASSWD));		
		
		memset(DIR_DATA_TRANS,0x00,sizeof(DIR_DATA_TRANS));		
		memset(DIR_DATA_STATUS,0x00,sizeof(DIR_DATA_STATUS));		
		memset(DIR_DATA_OTHER,0x00,sizeof(DIR_DATA_OTHER));	
                        		
		memset(DOWN_NORMAL_FTP_IP,0x00,sizeof(DOWN_NORMAL_FTP_IP));		
		memset(DOWN_NORMAL_FTP_USER,0x00,sizeof(DOWN_NORMAL_FTP_USER));
		memset(DOWN_NORMAL_FTP_PASSWD,0x00,sizeof(DOWN_NORMAL_FTP_PASSWD));
		
		memset(DIR_PARAM_MODE,0x00,sizeof(DIR_PARAM_MODE));
		memset(DIR_SETTLE,0x00,sizeof(DIR_SETTLE));                          
		memset(DIR_STOCK,0x00,sizeof(DIR_STOCK));
		
		memset(DOWN_SPECIAL_FTP_IP,0x00,sizeof(DOWN_SPECIAL_FTP_IP));		
		memset(DOWN_SPECIAL_FTP_USER,0x00,sizeof(DOWN_SPECIAL_FTP_USER));
		memset(DOWN_SPECIAL_FTP_PASSWD,0x00,sizeof(DOWN_SPECIAL_FTP_PASSWD));
 
		memset(DIR_PARAM_RUN,0x00,sizeof(DIR_PARAM_RUN));
		memset(DIR_PARAM_OTHER,0x00,sizeof(DIR_PARAM_OTHER));                          
		memset(DIR_PARAM_BLACKLIST,0x00,sizeof(DIR_PARAM_BLACKLIST));	
		
		EXEC SQL FETCH SQL_LINEINFO_cursor INTO :LINE_ID,:LINE_NID,:UP_FTP_IP,:UP_FTP_PORT,:UP_FTP_USER,:UP_FTP_PASSWD,
																:DIR_DATA_TRANS,:DIR_DATA_STATUS,:DIR_DATA_OTHER,
																:DOWN_NORMAL_FTP_IP,:DOWN_NORMAL_FTP_PORT,:DOWN_NORMAL_FTP_USER,:DOWN_NORMAL_FTP_PASSWD,
																:DIR_PARAM_MODE,:DIR_SETTLE,DIR_STOCK,
																:DOWN_SPECIAL_FTP_IP,:DOWN_SPECIAL_FTP_PORT,:DOWN_SPECIAL_FTP_USER,:DOWN_SPECIAL_FTP_PASSWD,
																:DIR_PARAM_RUN,:DIR_PARAM_OTHER,:DIR_PARAM_BLACKLIST ;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "SQL_LINEINFO_cursor error code is %d\n",sqlca.sqlcode);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_LINEINFO_cursor;
				return;
			}
		}
		
		CConfig::ms_MlcLineList[count].LINE_ID			=	LINE_ID;
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,LINE_NID);
		strcpy(CConfig::ms_MlcLineList[count].LINE_NID,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,UP_FTP_IP);			
		strcpy(CConfig::ms_MlcLineList[count].UP_FTP_IP,temp);	
 
		CConfig::ms_MlcLineList[count].UP_FTP_PORT			=	UP_FTP_PORT;
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,UP_FTP_USER);		
		strcpy(CConfig::ms_MlcLineList[count].UP_FTP_USER,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,UP_FTP_PASSWD);					
		strcpy(CConfig::ms_MlcLineList[count].UP_FTP_PASSWD,temp );		
	
	
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_DATA_TRANS);			
		strcpy(CConfig::ms_MlcLineList[count].DIR_DATA_TRANS,temp);	
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_DATA_STATUS);				
		strcpy(CConfig::ms_MlcLineList[count].DIR_DATA_STATUS,temp);		
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_DATA_OTHER);			
		strcpy(CConfig::ms_MlcLineList[count].DIR_DATA_OTHER,temp);	
                        		
                        		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DOWN_NORMAL_FTP_IP);		                   		
		strcpy(CConfig::ms_MlcLineList[count].DOWN_NORMAL_FTP_IP,temp);		
		
		CConfig::ms_MlcLineList[count].DOWN_NORMAL_FTP_PORT			=	DOWN_NORMAL_FTP_PORT;
		
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "CConfig::ms_MlcLineList[%d].DOWN_NORMAL_FTP_PORT:%d\n",count,DOWN_NORMAL_FTP_PORT);
		CLog::WriteAppLog(oplogmsg);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DOWN_NORMAL_FTP_USER);				
		strcpy(CConfig::ms_MlcLineList[count].DOWN_NORMAL_FTP_USER,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DOWN_NORMAL_FTP_PASSWD);				
		strcpy(CConfig::ms_MlcLineList[count].DOWN_NORMAL_FTP_PASSWD,temp);
	
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_PARAM_MODE);			
		strcpy(CConfig::ms_MlcLineList[count].DIR_PARAM_MODE,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_SETTLE);				
		strcpy(CConfig::ms_MlcLineList[count].DIR_SETTLE,temp);                          
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_STOCK);				
		strcpy(CConfig::ms_MlcLineList[count].DIR_STOCK,temp);
	
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DOWN_SPECIAL_FTP_IP);			
		strcpy(CConfig::ms_MlcLineList[count].DOWN_SPECIAL_FTP_IP,temp);		
		
		CConfig::ms_MlcLineList[count].DOWN_SPECIAL_FTP_PORT	=	DOWN_SPECIAL_FTP_PORT;
		
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "CConfig::ms_MlcLineList[%d].DOWN_SPECIAL_FTP_PORT:%d\n",count,DOWN_SPECIAL_FTP_PORT);
		CLog::WriteAppLog(oplogmsg);

		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DOWN_SPECIAL_FTP_USER);		
		strcpy(CConfig::ms_MlcLineList[count].DOWN_SPECIAL_FTP_USER,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DOWN_SPECIAL_FTP_PASSWD);				
		strcpy(CConfig::ms_MlcLineList[count].DOWN_SPECIAL_FTP_PASSWD,temp);
 
 		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_PARAM_RUN);	
		strcpy(CConfig::ms_MlcLineList[count].DIR_PARAM_RUN,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_PARAM_OTHER);			
		strcpy(CConfig::ms_MlcLineList[count].DIR_PARAM_OTHER,temp);  
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,DIR_PARAM_BLACKLIST);			                        
		strcpy(CConfig::ms_MlcLineList[count].DIR_PARAM_BLACKLIST,temp);		
			
		count++;
	}
	EXEC SQL CLOSE SQL_LINEINFO_cursor;
}



/* ------------------------------------------------------
            获得综合监控车站信息列表
--------------------------------------------------------- */
void ORA::get_iscs_station_list()
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	char temp[20];
	char AFC_LINE_NID[3];
	char AFC_STATION_NID[5];
	char ISCS_LINE_NID[3];
	char ISCS_STATION_NID[5];          
	int	ISCS_STATION_ID;
	
	int	ISCS_BOM_START_BYTE;
	int	ISCS_TVM_START_BYTE;
	int	ISCS_TCM_START_BYTE;
	int	ISCS_AGM_START_BYTE;    
	    
	int	ISCS_BOM_START_OFFSET;        
	int	ISCS_TVM_START_OFFSET;        
	int	ISCS_TCM_START_OFFSET;   
	int	ISCS_AGM_START_OFFSET;
    
	int	ISCS_SNC_START_BYTE;        
	int	ISCS_RUNMODE_START_BYTE;    
	int	ISCS_EPF_START_BYTE;        
	int	ISCS_XPF_START_BYTE;        
	int	ISCS_SPF_START_BYTE;	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];		
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL WHENEVER NOT FOUND CONTINUE;	
	
	int i,count;

	for(i=0;i<MAX_SLE_COUNT;i++)
	{
		memset(CConfig::ms_IscsStation[i].AFC_LINE_NID,0x00,sizeof(CConfig::ms_IscsStation[i].AFC_LINE_NID));
		memset(CConfig::ms_IscsStation[i].AFC_STATION_NID,0x00,sizeof(CConfig::ms_IscsStation[i].AFC_STATION_NID));		
		memset(CConfig::ms_IscsStation[i].ISCS_LINE_NID,0x00,sizeof(CConfig::ms_IscsStation[i].ISCS_LINE_NID));
		memset(CConfig::ms_IscsStation[i].ISCS_STATION_NID,0x00,sizeof(CConfig::ms_IscsStation[i].ISCS_STATION_NID));
		CConfig::ms_IscsStation[i].ISCS_STATION_ID = -1;			
	}
	
	EXEC SQL DECLARE SQL_IscsStation_cursor CURSOR FOR SELECT AFC_LINE_NID, AFC_STATION_NID, 
																			ISCS_LINE_NID, ISCS_STATION_NID, ISCS_STATION_ID, 
																			ISCS_BOM_START_BYTE, ISCS_TVM_START_BYTE, 
																			ISCS_TCM_START_BYTE, ISCS_AGM_START_BYTE, 
																			ISCS_BOM_START_OFFSET, ISCS_TVM_START_OFFSET, 
																			ISCS_TCM_START_OFFSET, ISCS_AGM_START_OFFSET,
																			ISCS_SNC_START_BYTE, 
																			ISCS_RUNMODE_START_BYTE, ISCS_EPF_START_BYTE, 
																			ISCS_XPF_START_BYTE, ISCS_SPF_START_BYTE
																			FROM TBL_SS_ISCS_STATION
																			ORDER BY ISCS_STATION_ID;

	EXEC SQL OPEN SQL_IscsStation_cursor;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "SQL_IscsStation_cursor error code is [%d]\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	count = 0;
	for(;;)
	{
		memset(AFC_LINE_NID,0x00,sizeof(AFC_LINE_NID));
		memset(AFC_STATION_NID,0x00,sizeof(AFC_STATION_NID));
		memset(ISCS_LINE_NID,0x00,sizeof(ISCS_STATION_NID));
		memset(ISCS_STATION_NID,0x00,sizeof(ISCS_STATION_NID));
		memset(temp,0x00,sizeof(temp));
 
		EXEC SQL FETCH SQL_IscsStation_cursor INTO :AFC_LINE_NID, :AFC_STATION_NID, 
																			:ISCS_LINE_NID, :ISCS_STATION_NID, :ISCS_STATION_ID, 
																			:ISCS_BOM_START_BYTE, :ISCS_TVM_START_BYTE, 
																			:ISCS_TCM_START_BYTE, :ISCS_AGM_START_BYTE,
																			:ISCS_BOM_START_OFFSET, :ISCS_TVM_START_OFFSET, 
																			:ISCS_TCM_START_OFFSET, :ISCS_AGM_START_OFFSET,
																			:ISCS_SNC_START_BYTE, 
																			:ISCS_RUNMODE_START_BYTE, :ISCS_EPF_START_BYTE, 
																			:ISCS_XPF_START_BYTE, :ISCS_SPF_START_BYTE;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "SQL_IscsStation_cursor error code is %d\n",sqlca.sqlcode);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_IscsStation_cursor;
				return;
			}
		}
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,AFC_LINE_NID);		
		strcpy(CConfig::ms_IscsStation[count].AFC_LINE_NID,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,AFC_STATION_NID);		
		strcpy(CConfig::ms_IscsStation[count].AFC_STATION_NID,temp);				
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,ISCS_LINE_NID);		
		strcpy(CConfig::ms_IscsStation[count].ISCS_LINE_NID,temp);
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,ISCS_STATION_NID);		
		strcpy(CConfig::ms_IscsStation[count].ISCS_STATION_NID,temp);			

		CConfig::ms_IscsStation[count].ISCS_STATION_ID = ISCS_STATION_ID;	         
		CConfig::ms_IscsStation[count].ISCS_BOM_START_BYTE = ISCS_BOM_START_BYTE;        
		CConfig::ms_IscsStation[count].ISCS_TVM_START_BYTE = ISCS_TVM_START_BYTE;       
		CConfig::ms_IscsStation[count].ISCS_TCM_START_BYTE = ISCS_TCM_START_BYTE;       
		CConfig::ms_IscsStation[count].ISCS_AGM_START_BYTE = ISCS_AGM_START_BYTE; 
		      
		CConfig::ms_IscsStation[count].ISCS_BOM_START_OFFSET = ISCS_BOM_START_OFFSET;       
		CConfig::ms_IscsStation[count].ISCS_TVM_START_OFFSET = ISCS_TVM_START_OFFSET;       
		CConfig::ms_IscsStation[count].ISCS_TCM_START_OFFSET = ISCS_TCM_START_OFFSET;  
		CConfig::ms_IscsStation[count].ISCS_AGM_START_OFFSET = ISCS_AGM_START_OFFSET;  		
																			     
		CConfig::ms_IscsStation[count].ISCS_SNC_START_BYTE = ISCS_SNC_START_BYTE;       
		CConfig::ms_IscsStation[count].ISCS_RUNMODE_START_BYTE = ISCS_RUNMODE_START_BYTE;    
		CConfig::ms_IscsStation[count].ISCS_EPF_START_BYTE = ISCS_EPF_START_BYTE;        
		CConfig::ms_IscsStation[count].ISCS_XPF_START_BYTE = ISCS_XPF_START_BYTE;       
		CConfig::ms_IscsStation[count].ISCS_SPF_START_BYTE = ISCS_SPF_START_BYTE;	
 
		count++;	
	}
	EXEC SQL CLOSE SQL_IscsStation_cursor;
	
	/*------------日志输出------------*/
	for(i=0;i<MAX_SLE_COUNT;i++)
	{
		if(CConfig::ms_IscsStation[i].ISCS_STATION_ID > 0)
		{
	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "===[%d]===---begin----",i);
			CLog::WriteAppLog(oplogmsg);
			
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "AFC_STATION_NID[%s],ISCS_STATION_NID[%s],ISCS_STATION_ID[%d]\n", AFC_STATION_NID,ISCS_STATION_NID,ISCS_STATION_ID);
			CLog::WriteAppLog(oplogmsg);

			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "ISCS_BOM_START_BYTE[%d],ISCS_TVM_START_BYTE[%d],ISCS_TCM_START_BYTE[%d],ISCS_AGM_START_BYTE[%d]",ISCS_BOM_START_BYTE,ISCS_TVM_START_BYTE,ISCS_TCM_START_BYTE,ISCS_AGM_START_BYTE);
			CLog::WriteAppLog(oplogmsg);
			
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "===[%d]===---end----",i);
			CLog::WriteAppLog(oplogmsg);
					
		}		
	}	
 
}


/* ------------------------------------------------------
            获得会话流水号
--------------------------------------------------------- */
int ORA::get_session_number()
{
	EXEC SQL BEGIN DECLARE SECTION;
	int session_num;
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];

	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL WHENEVER NOT FOUND CONTINUE;	

	EXEC SQL SELECT SEQ_PACKAGE_SESSION.nextval INTO :session_num FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "get_session_number error, error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	else
		return session_num;
}

/* ------------------------------------------------------
            获得会话流水号
--------------------------------------------------------- */
int ORA::get_pkg_number()
{
	EXEC SQL BEGIN DECLARE SECTION;
	int session_num;
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];

	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	EXEC SQL SELECT SEQ_PACKAGE_ID.nextval INTO :session_num FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "get_session_number error, error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	else
		return session_num;
}

/* ------------------------------------------------------
            生成0300参数
--------------------------------------------------------- */
int ORA::create0300param(char *c_recvid,const char *c_ver)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int ParamNbr;
	char          ValidTime[15];
	int           ParamRecords;
	char          c_paraCtrlId[9];
 
	char						ParamVer[15];		
	char						PARA_TYPE[5];	
	char  					SUB_PARA_INDEX[15];
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	char            	c_PkgID[30],filePath[MAX_PATH];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0300_Head 		m_Para0300_Head;
	Para0300_Record   *m_Para0300_Record;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	char              *stopstring;
	char              temp[50];
	BYTE							b_ValidTime[7];

	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
		strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS=0 AND PARAMETER_TYPE='0300' AND FILE_FLAG = 0 AND ROWNUM = 1;			                
	}
  else
  {
  	strcpy(c_paraCtrlId,c_recvid); 
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION=:ParamVer AND PARAMETER_TYPE='0300' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }
	
  if(sqlca.sqlcode != 0)
	{
		return 0;
	}  
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_PM_0300_VERSION_CTRL
		 WHERE PARAMETER_NBR = :ParamNbr;
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0300param(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -------- 包体头 ---------- */
	memset(&m_Para0300_Head,0x00,sizeof(Para0300_Head));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0300_Head.ParamVer,sizeof(m_Para0300_Head.ParamVer));
	CommonFuncs::chartobyte(ValidTime,(char*)m_Para0300_Head.ValidTime,sizeof(m_Para0300_Head.ValidTime));

	m_Para0300_Head.Records 		= CommonFuncs::dwordtowin(ParamRecords);
	
	m_Para0300_Record = (Para0300_Record*)malloc(ParamRecords * sizeof(Para0300_Record));
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_0300_Record CURSOR FOR SELECT PARA_TYPE,SUB_PARA_INDEX
		                                          FROM   TBL_PM_0300_VERSION_CTRL
		                                          WHERE PARAMETER_NBR = :ParamNbr
		                                          ORDER BY PARA_TYPE;                                 
	EXEC SQL OPEN SQL_0300_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create0300param(OPEN SQL_0300_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Para0300_Record);
		m_Para0300_Record = NULL;
		return 0;
	}
	index = 0;
	for(;;)
	{
		memset(PARA_TYPE,0x00,sizeof(PARA_TYPE));
		memset(SUB_PARA_INDEX,0x00,sizeof(SUB_PARA_INDEX));

		EXEC SQL FETCH SQL_0300_Record INTO :PARA_TYPE,:SUB_PARA_INDEX;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create0300param(FETCH SQL_0300_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_0300_Record;
				free(m_Para0300_Record);
				m_Para0300_Record = NULL;
				return 0;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Para0300_Record[index],0x00,sizeof(Para0300_Record ));
		CommonFuncs::chartobyte(PARA_TYPE,(char*)m_Para0300_Record[index].PARA_TYPE,sizeof(m_Para0300_Record[index].PARA_TYPE));
		CommonFuncs::chartobyte(SUB_PARA_INDEX,(char*)m_Para0300_Record[index].SUB_PARA_INDEX,sizeof(m_Para0300_Record[index].SUB_PARA_INDEX));		 
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_0300_Record;	
	
	bodylen = sizeof(Para0300_Head)+ParamRecords*sizeof(Para0300_Record);
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,bodylen,0x0300,1,b_sccode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Para0300_Head,sizeof(Para0300_Head));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Para0300_Head)+index*sizeof(Para0300_Record),&m_Para0300_Record[index],sizeof(Para0300_Record));
	}
	/* -- 生成文件 -- */    
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
	
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0300_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0300_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0300_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0300_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}
 
	
	/* -------- 内存释放 ---------- */
	free(m_Para0300_Record);
	m_Para0300_Record = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;
 
	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE	PARAMETER_STATUS = 2 
		         AND 		PARAMETER_TYPE = '0300'
		         AND		PARAMETER_CTRL_NID = :c_paraCtrlId;
		         
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE  PARAMETER_STATUS = 0 
			         AND 		PARAMETER_TYPE = '0300'
			         AND		PARAMETER_CTRL_NID = :c_paraCtrlId;
			         
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0300",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE 	PARAMETER_STATUS = 0 
		       AND 		PARAMETER_TYPE = '0300'
		       AND		PARAMETER_CTRL_NID = :c_paraCtrlId;
		       			         
	EXEC SQL COMMIT; 
 
	return 1;
}

/* ------------------------------------------------------
            生成0301参数
--------------------------------------------------------- */
int ORA::create0301param(char *c_id,const char *c_ver)
{ 
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int ParamNbr;
	char          ValidTime[15];
	int           ParamRecords;
	char          sc_id[9];
	char          c_paraCtrlId[9];
		
	char						ParamVer[15];
	unsigned int    dw_ValidTime;
	char						STATION_NID[9];	
	char						MASTER_SERVER_IP[9];
	char						STANDY_SERVER_IP[9];
	unsigned short	SERVER_PORT;
	
	char						DEVICE_NID[9];
	char  					DEVICE_NAME[9];	
	int							DEVICE_TYPE;
	char						DEVICE_IP[9];
	unsigned int		X_POINT;
	unsigned int		Y_POINT;
	int 						ROTATE_ANGEL;
	int   					USE_FLAG;
	
	char						START_OPERATE_TIME[7];
	unsigned short	START_DELAY_TIME;
	char						END_OPERATE_TIME[7];
	unsigned short	END_DELAY_TIME;
	int             DEVICE_RESTART_TIME;
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	char            	c_PkgID[30];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0301_Head 		m_Para0301_Head;
	Para0301_Record   *m_Para0301_Record;
	Para0301_Tail 		m_Para0301_Tail;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(sc_id,0x00,sizeof(sc_id));
	strcpy(sc_id,c_id);
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
		strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));

	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM  T_PARAMETER_CTRL 
		                WHERE PARAMETER_CTRL_NID = :sc_id 
		                AND 	PARAMETER_STATUS=0 
		                AND 	PARAMETER_TYPE='0301' 
		                AND 	FILE_FLAG = 0
		                AND		ROWNUM = 1;	
	}
  else
  {
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_CTRL_NID = :sc_id 
		                AND PARAMETER_VERSION=:ParamVer 
		                AND PARAMETER_TYPE ='0301';
  }

  if(sqlca.sqlcode != 0)
	{
		return 0;
	}           
	memset(STATION_NID,0x00,sizeof(STATION_NID));
	memset(MASTER_SERVER_IP,0x00,sizeof(MASTER_SERVER_IP));
	memset(STANDY_SERVER_IP,0x00,sizeof(STANDY_SERVER_IP));
	memset(START_OPERATE_TIME,0x00,sizeof(START_OPERATE_TIME));
	memset(END_OPERATE_TIME,0x00,sizeof(END_OPERATE_TIME));
	EXEC SQL SELECT STATION_NID,MASTER_SERVER_IP,STANDY_SERVER_IP,SERVER_PORT,
	                START_OPERATE_TIME,START_DELAY_TIME,END_OPERATE_TIME,END_DELAY_TIME,
	                DEVICE_RESTART_TIME
	         INTO   :STATION_NID,:MASTER_SERVER_IP,:STANDY_SERVER_IP,:SERVER_PORT,
	                :START_OPERATE_TIME,:START_DELAY_TIME,:END_OPERATE_TIME,:END_DELAY_TIME,
	                :DEVICE_RESTART_TIME
	         FROM   TBL_PM_0301_STATION
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:create0301param(TBL_PM_0301_STATION) error code is %d\n",c_id,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}  
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_PM_0301_DEVICE
		 WHERE PARAMETER_NBR = :ParamNbr;
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:create0301param(Record = %d)\n",c_id,ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -------- 包体头 ---------- */
	memset(&m_Para0301_Head,0x00,sizeof(Para0301_Head));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0301_Head.ParamVer,sizeof(m_Para0301_Head.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	m_Para0301_Head.ValidTime = CommonFuncs::dwordtowin(dw_ValidTime);
	CommonFuncs::chartobyte(STATION_NID,(char*)m_Para0301_Head.STATION_NID,sizeof(m_Para0301_Head.STATION_NID));
	CommonFuncs::chartobyte(MASTER_SERVER_IP,(char*)m_Para0301_Head.MASTER_SERVER_IP,sizeof(m_Para0301_Head.MASTER_SERVER_IP));
	CommonFuncs::chartobyte(STANDY_SERVER_IP,(char*)m_Para0301_Head.STANDY_SERVER_IP,sizeof(m_Para0301_Head.STANDY_SERVER_IP));
	m_Para0301_Head.SERVER_PORT = CommonFuncs::wordtowin(SERVER_PORT);
	m_Para0301_Head.Records 		= CommonFuncs::dwordtowin(ParamRecords);
	/* -------- 包体尾 ---------- */
	memset(&m_Para0301_Tail,0x00,sizeof(Para0301_Tail));
	CommonFuncs::chartobyte(START_OPERATE_TIME,(char*)m_Para0301_Tail.START_OPERATE_TIME,sizeof(m_Para0301_Tail.START_OPERATE_TIME));
	CommonFuncs::chartobyte(END_OPERATE_TIME,(char*)m_Para0301_Tail.END_OPERATE_TIME,sizeof(m_Para0301_Tail.END_OPERATE_TIME));
	m_Para0301_Tail.START_DELAY_TIME 		= CommonFuncs::wordtowin(START_DELAY_TIME);
	m_Para0301_Tail.END_DELAY_TIME 			= CommonFuncs::wordtowin(END_DELAY_TIME);
	m_Para0301_Tail.DEVICE_RESTART_TIME = (BYTE)DEVICE_RESTART_TIME;
	
	m_Para0301_Record = (Para0301_Record*)malloc(ParamRecords * sizeof(Para0301_Record));
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_0301_Record CURSOR FOR SELECT DEVICE_NID,DEVICE_NAME,DEVICE_TYPE,DEVICE_IP,SERVER_PORT,
	                                                   X_POINT,Y_POINT,ROTATE_ANGEL,USE_FLAG
		                                          FROM   TBL_PM_0301_DEVICE
		                                          WHERE PARAMETER_NBR = :ParamNbr
		                                          ORDER BY DEVICE_NID;                                 
	EXEC SQL OPEN SQL_0301_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:create0301param(OPEN SQL_0301_Record):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Para0301_Record);
		m_Para0301_Record = NULL;
		return 0;
	}
	index = 0;
	for(;;)
	{
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		memset(DEVICE_NAME,0x00,sizeof(DEVICE_NAME));
		memset(DEVICE_IP,0x00,sizeof(DEVICE_IP));
		EXEC SQL FETCH SQL_0301_Record INTO :DEVICE_NID,:DEVICE_NAME,:DEVICE_TYPE,:DEVICE_IP,:SERVER_PORT,
	                                      :X_POINT,:Y_POINT,:ROTATE_ANGEL,:USE_FLAG;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"%s:create0301param(FETCH SQL_0301_Record):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_0301_Record;
				free(m_Para0301_Record);
				m_Para0301_Record = NULL;
				return 0;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Para0301_Record[index],0x00,sizeof(Para0301_Record ));
		CommonFuncs::chartobyte(DEVICE_NID,(char*)m_Para0301_Record[index].DEVICE_NID,sizeof(m_Para0301_Record[index].DEVICE_NID));
		memcpy(m_Para0301_Record[index].DEVICE_NAME,DEVICE_NAME,sizeof(m_Para0301_Record[index].DEVICE_NAME));
		CommonFuncs::chartobyte(DEVICE_IP,(char*)m_Para0301_Record[index].DEVICE_IP,sizeof(m_Para0301_Record[index].DEVICE_IP));
		m_Para0301_Record[index].SERVER_PORT 	= CommonFuncs::wordtowin(SERVER_PORT);
		m_Para0301_Record[index].DEVICE_TYPE  = (BYTE)DEVICE_TYPE;
		m_Para0301_Record[index].X_POINT 			= CommonFuncs::dwordtowin(X_POINT);
		m_Para0301_Record[index].Y_POINT 			= CommonFuncs::dwordtowin(Y_POINT);
		m_Para0301_Record[index].ROTATE_ANGEL = (BYTE)ROTATE_ANGEL;
		m_Para0301_Record[index].USE_FLAG     = (BYTE)USE_FLAG;
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_0301_Record;	
	
	bodylen = sizeof(Para0301_Head)+ParamRecords*sizeof(Para0301_Record)+sizeof(Para0301_Tail);
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte(sc_id,(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,bodylen,0x0301,1,b_sccode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Para0301_Head,sizeof(Para0301_Head));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Para0301_Head)+index*sizeof(Para0301_Record),&m_Para0301_Record[index],sizeof(Para0301_Record));
	}
	memcpy(packagebody+sizeof(Para0301_Head)+ParamRecords*sizeof(Para0301_Record),(char*)&m_Para0301_Tail,sizeof(Para0301_Tail));
	/* -- 生成文件 -- */    
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
 
	char strTemp[5],temp[100];
	memset(strTemp,0x00,sizeof(strTemp));
	memcpy(strTemp,c_id,4);

	for(int i = 0;i < MAX_SLE_COUNT;i++)
	{
		if(strncmp(sc_id,CConfig::g_ScList[i].sccode,4) == 0)
		{
			memset(temp,0x00,sizeof(temp));
			sprintf(temp,"0301_%s",strTemp);
	
			memset(filePath,0x00,sizeof(filePath));
			sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::g_ScList[i].lineId);
			CommonFuncs::DeleteFile(filePath,temp);
			
			memset(filename,0x00,sizeof(filename));
			sprintf(filename,"%s0301_%s_%s",filePath,strTemp,ParamVer);
			CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
			
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
			CLog::WriteAppLog(oplogmsg);
			
			break;
		}
	}	

	/* -------- 内存释放 ---------- */
	free(m_Para0301_Record);
	m_Para0301_Record = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;
	
	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 
		         AND PARAMETER_TYPE = '0301' 
		         AND PARAMETER_CTRL_NID = :sc_id;
		         
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 
			         AND PARAMETER_TYPE = '0301' 
			         AND PARAMETER_CTRL_NID = :sc_id;
			         
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(%s参数索引:%d)生效\n","0301",sc_id,ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}	
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 
		       AND PARAMETER_TYPE = '0301' 
		       AND PARAMETER_CTRL_NID = :sc_id;
		       
	EXEC SQL COMMIT; 
 
	
	return 1;
}

/* ------------------------------------------------------
            生成0302参数
--------------------------------------------------------- */
int ORA::create0302param(char *c_id,const char *c_ver)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		ParamNbr;
	char          	ValidTime[15];
	char          	sc_id[9];
	
	char						ParamVer[15];	
	unsigned int    dw_ValidTime;
	
	unsigned int		Records_1;	
	
	int							ROLE_ID;		
	char						ROLE_DESC[33];
	unsigned int		Records_2;
	
	int  						DEVICE_TYPE;		
	int	 						ROLE_RIGHT;
	char						FUNC_DESC[65];
	
	unsigned int		Records_3;
	
	char						USER_ID[9];	
	int		          i_USER_ID;	
	char						USER_NAME[33];
	char						COMPANY_NAME[65];
	char						USER_PIN[33];
	char						USE_TIME[15];
	char						VALID_TIME[15];
	char						DEVICE_PRIV[3];	
	unsigned int		Records_4;
	
	int 						ROLE_ID_1;
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];

	char            	c_PkgID[30];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0302_Head 		m_Para0302_Head;
	Para0302_Record_1 m_Para0302_Record_1;
	Para0302_Record_2 m_Para0302_Record_2;
	Para0302_Record_3 m_Para0302_Record_3;
	Para0302_Record_4 m_Para0302_Record_4;
	Para0302_Record_5 m_Para0302_Record_5;
	Para0302_Record_6 m_Para0302_Record_6;
	Para0302_Record_7 m_Para0302_Record_7;
	char        			filename[MAX_PATH],*filebuf,*packagebody,*p;
	unsigned int      bodylen,filelen;
	char              *stopstring;
	char              temp[100];
	BYTE						  b_ValidTime[7];
	char        			filePath[MAX_PATH];	
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(sc_id,0x00,sizeof(sc_id));
	strcpy(sc_id,c_id);
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
		strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_CTRL_NID = :sc_id 
		                AND PARAMETER_STATUS = 0 
		                AND PARAMETER_TYPE = '0302' 
		                AND FILE_FLAG = 0;	
	}
	else if(strcmp(c_ver,"FFFFFFFF") == 0)
			 {
					EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
					                INTO :ParamNbr,:ParamVer,:ValidTime
					                FROM T_PARAMETER_CTRL 
					                WHERE PARAMETER_CTRL_NID = :sc_id 
					                	 AND PARAMETER_TYPE='0302' 
					                	 AND PARAMETER_VERSION = (SELECT MAX(PARAMETER_VERSION) FROM T_PARAMETER_CTRL 
					                                            WHERE PARAMETER_CTRL_NID = :sc_id AND PARAMETER_TYPE='0302') 
					                   AND UPDATE_FLAG = 1;
				}
			  else
			  {
					EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
					                INTO :ParamNbr,:ParamVer,:ValidTime
					                FROM T_PARAMETER_CTRL 
					                WHERE PARAMETER_CTRL_NID = :sc_id AND PARAMETER_VERSION=:ParamVer AND PARAMETER_TYPE='0302';
			  }

  if(sqlca.sqlcode != 0)
	{
		return 0;
	}
	/* --- 包体长度 ----- */
	Records_1 = 0;
	EXEC SQL SELECT COUNT(*) 
	         INTO :Records_1 
	         FROM TBL_PM_0302_ROLE 
		       WHERE PARAMETER_NBR = :ParamNbr;
	if(Records_1 == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "TBL_PM_0302_ROLE:%s:create0302param(Record = %d)\n",c_id,Records_1);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	Records_3 = 0;
	EXEC SQL SELECT COUNT(*) 
	         INTO :Records_3 
	         FROM TBL_PM_0302_USER
		       WHERE PARAMETER_NBR = :ParamNbr;
	if(Records_3 == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "TBL_PM_0302_USER:%s:create0302param(Record = %d)\n",c_id,Records_3);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	bodylen = sizeof(Para0302_Head) + 
	          sizeof(Para0302_Record_1) + 
	          Records_1 * (sizeof(Para0302_Record_2)+8*255*sizeof(Para0302_Record_3)) +
	          sizeof(Para0302_Record_4) + 
	          Records_3 * (sizeof(Para0302_Record_5)+Records_1*sizeof(Para0302_Record_6)) +
	          sizeof(Para0302_Record_7);
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	p = packagebody;
	bodylen = 0;
	/* -------- 包体头 ---------- */
	memset(&m_Para0302_Head,0x00,sizeof(Para0302_Head));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0302_Head.ParamVer,sizeof(m_Para0302_Head.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	m_Para0302_Head.ValidTime = CommonFuncs::dwordtowin(dw_ValidTime);
	memcpy(p,&m_Para0302_Head,sizeof(Para0302_Head));
	p = p + sizeof(Para0302_Head);
	bodylen = bodylen + sizeof(Para0302_Head);
	/* -------- 包体(Para0302_Record_1) ---------- */  
	memset(&m_Para0302_Record_1,0x00,sizeof(Para0302_Record_1));
	m_Para0302_Record_1.Records_1 = CommonFuncs::dwordtowin(Records_1);
	memcpy(p,&m_Para0302_Record_1,sizeof(Para0302_Record_1));
	
	p = p + sizeof(Para0302_Record_1);
	bodylen = bodylen + sizeof(Para0302_Record_1);
	/* -------- 包体(Para0302_Record_2) ---------- */
	EXEC SQL DECLARE SQL_0302_Record_2 CURSOR FOR SELECT ROLE_ID,ROLE_DESC
		                                          FROM   TBL_PM_0302_ROLE
		                                          WHERE PARAMETER_NBR = :ParamNbr
		                                          ORDER BY ROLE_ID;                                 
	EXEC SQL OPEN SQL_0302_Record_2;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:create0302param(OPEN SQL_0302_Record_2):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(packagebody);
		packagebody = NULL;
		return 0;
	}
	for(;;)
	{
		memset(ROLE_DESC,0x00,sizeof(ROLE_DESC));
		EXEC SQL FETCH SQL_0302_Record_2 INTO :ROLE_ID,:ROLE_DESC;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"%s:create0302param(FETCH SQL_0302_Record_2):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_0302_Record_2;
				free(packagebody);
				packagebody = NULL;
				return 0;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Para0302_Record_2,0x00,sizeof(Para0302_Record_2));
		memcpy((char*)m_Para0302_Record_2.ROLE_DESC,ROLE_DESC,sizeof(m_Para0302_Record_2.ROLE_DESC));
		m_Para0302_Record_2.ROLE_ID  = (BYTE)ROLE_ID;
		Records_2 = 0;
		EXEC SQL SELECT COUNT(*) 
		         INTO :Records_2
		         FROM TBL_PM_0302_ROLE_TO_FUNC 
			       WHERE PARAMETER_NBR = :ParamNbr AND ROLE_ID = :ROLE_ID;
		if(Records_2 == 0)
		{
			m_Para0302_Record_2.Records_2 = CommonFuncs::dwordtowin(Records_2);
			memcpy(p,&m_Para0302_Record_2,sizeof(Para0302_Record_2));
			p = p + sizeof(Para0302_Record_2);
			bodylen = bodylen + sizeof(Para0302_Record_2);
			
			continue;
		}
		m_Para0302_Record_2.Records_2 = CommonFuncs::dwordtowin(Records_2);
		memcpy(p,&m_Para0302_Record_2,sizeof(Para0302_Record_2));
		p = p + sizeof(Para0302_Record_2);
		bodylen = bodylen + sizeof(Para0302_Record_2);
		/* -------- 包体(Para0302_Record_3) ---------- */
		EXEC SQL DECLARE SQL_0302_Record_3 CURSOR FOR SELECT DEVICE_TYPE,ROLE_RIGHT,FUNC_DESC
		                                          FROM   TBL_PM_0302_ROLE_TO_FUNC
		                                          WHERE PARAMETER_NBR = :ParamNbr AND ROLE_ID = :ROLE_ID
		                                          ORDER BY DEVICE_TYPE,ROLE_RIGHT;                                 
		EXEC SQL OPEN SQL_0302_Record_3;
		if(sqlca.sqlcode != 0)
		{	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:create0302param(OPEN SQL_0302_Record_3):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			free(packagebody);
			packagebody = NULL;
			return 0;
		}
		for(;;)
		{
			memset(FUNC_DESC,0x00,sizeof(FUNC_DESC));
			EXEC SQL FETCH SQL_0302_Record_3 INTO :DEVICE_TYPE,:ROLE_RIGHT,:FUNC_DESC;
			if(sqlca.sqlcode != 0)
			{
				if(sqlca.sqlcode == 1403)
				{
					break;
				}
				else
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg,"%s:create0302param(FETCH SQL_0302_Record_3):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
					EXEC SQL CLOSE SQL_0302_Record_3;
					free(packagebody);
					packagebody = NULL;
					return 0;
				}
			}
			/* -- 参数结构赋值 -- */ 
			memset(&m_Para0302_Record_3,0x00,sizeof(Para0302_Record_3));
			memset(temp,0x00,sizeof(temp));
			sprintf(temp,"%02X",DEVICE_TYPE);
			m_Para0302_Record_3.DEVICE_TYPE = (BYTE)strtoul(temp,&stopstring,16);
			m_Para0302_Record_3.ROLE_RIGHT  = (BYTE)ROLE_RIGHT;
			memcpy(m_Para0302_Record_3.FUNC_DESC,FUNC_DESC,sizeof(m_Para0302_Record_3.FUNC_DESC));
			memcpy(p,&m_Para0302_Record_3,sizeof(Para0302_Record_3));
			p = p + sizeof(Para0302_Record_3);	
			bodylen = bodylen + sizeof(Para0302_Record_3);
		}
		EXEC SQL CLOSE SQL_0302_Record_3;
	}
	EXEC SQL CLOSE SQL_0302_Record_2;
	
	memset(&m_Para0302_Record_4,0x00,sizeof(Para0302_Record_4));
	m_Para0302_Record_4.Records_3 = CommonFuncs::dwordtowin(Records_3);
	memcpy(p,&m_Para0302_Record_4,sizeof(Para0302_Record_4));
	p = p + sizeof(Para0302_Record_4);	
	bodylen = bodylen + sizeof(Para0302_Record_4);
	/* -------- 包体(Para0302_Record_5) ---------- */
	EXEC SQL DECLARE SQL_0302_Record_5 CURSOR FOR SELECT USER_ID,USER_NAME,COMPANY_NAME,USER_PIN,
	                                              TO_CHAR(USE_TIME,'YYYYMMDDHH24MISS'),TO_CHAR(VALID_TIME,'YYYYMMDDHH24MISS'),DEVICE_PRIV
		                                            FROM   TBL_PM_0302_USER
		                                            WHERE PARAMETER_NBR = :ParamNbr
		                                            ORDER BY USER_ID;                                 
	EXEC SQL OPEN SQL_0302_Record_5;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:create0302param(OPEN SQL_0302_Record_5):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(packagebody);
		packagebody = NULL;
		return 0;
	}
	for(;;)
	{
		memset(USER_ID,0x00,sizeof(USER_ID));
		memset(USER_NAME,0x00,sizeof(USER_NAME));
		memset(COMPANY_NAME,0x00,sizeof(COMPANY_NAME));
		memset(USER_PIN,0x00,sizeof(USER_PIN));
		memset(USE_TIME,0x00,sizeof(USE_TIME));
		memset(VALID_TIME,0x00,sizeof(VALID_TIME));
		memset(DEVICE_PRIV,0x00,sizeof(DEVICE_PRIV));
		EXEC SQL FETCH SQL_0302_Record_5 INTO :USER_ID,:USER_NAME,:COMPANY_NAME,:USER_PIN,
		                                      :USE_TIME,:VALID_TIME,:DEVICE_PRIV;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"%s:create0302param(FETCH SQL_0302_Record_5):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_0302_Record_5;
				free(packagebody);
				packagebody = NULL;
				return 0;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Para0302_Record_5,0x00,sizeof(Para0302_Record_5));
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,USER_ID);
		memset(USER_ID,0x00,sizeof(USER_ID));
		sprintf(USER_ID,"%08s",temp);
		i_USER_ID = atoi(USER_ID);
		CommonFuncs::chartobyte(USER_ID,(char*)m_Para0302_Record_5.USER_ID,sizeof(m_Para0302_Record_5.USER_ID));
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,USER_NAME);
		memcpy((char*)m_Para0302_Record_5.USER_NAME,temp,sizeof(m_Para0302_Record_5.USER_NAME));
		
		memset(temp,0x00,sizeof(temp));
		CommonFuncs::delspace(temp,COMPANY_NAME);
		memcpy((char*)m_Para0302_Record_5.COMPANY_NAME,temp,sizeof(m_Para0302_Record_5.COMPANY_NAME));
		
		CommonFuncs::chartobyte(USER_PIN,(char*)m_Para0302_Record_5.USER_PIN,sizeof(m_Para0302_Record_5.USER_PIN));
		CommonFuncs::chartobyte(USE_TIME,(char*)m_Para0302_Record_5.USE_TIME,sizeof(m_Para0302_Record_5.USE_TIME));
		CommonFuncs::chartobyte(VALID_TIME,(char*)m_Para0302_Record_5.VALID_TIME,sizeof(m_Para0302_Record_5.VALID_TIME));
		m_Para0302_Record_5.DEVICE_PRIV = (BYTE)strtoul(DEVICE_PRIV,&stopstring,16);
		
		Records_4 = 0;
		EXEC SQL SELECT COUNT(*) 
		         INTO :Records_4
		         FROM TBL_PM_0302_USER_TO_ROLE
			       WHERE PARAMETER_NBR = :ParamNbr AND TO_NUMBER(OPERATOR_ID) = :i_USER_ID;
		if(Records_4 == 0)
		{
			m_Para0302_Record_5.Records_4 = CommonFuncs::dwordtowin(Records_4);
			memcpy(p,&m_Para0302_Record_5,sizeof(Para0302_Record_5));
			p = p + sizeof(Para0302_Record_5);
			bodylen = bodylen + sizeof(Para0302_Record_5);
			/* -------- 包体(Para0302_Record_7) ---------- */
			memset(&m_Para0302_Record_7,0x00,sizeof(Para0302_Record_7));
			memcpy(p,&m_Para0302_Record_7,sizeof(Para0302_Record_7));
			p = p + sizeof(Para0302_Record_7);	
			bodylen = bodylen + sizeof(Para0302_Record_7);
			
			continue;
		}
		m_Para0302_Record_5.Records_4 = CommonFuncs::dwordtowin(Records_4);
		memcpy(p,&m_Para0302_Record_5,sizeof(Para0302_Record_5));
		p = p + sizeof(Para0302_Record_5);
		bodylen = bodylen + sizeof(Para0302_Record_5);
		/* -------- 包体(Para0302_Record_6) ---------- */
		EXEC SQL DECLARE SQL_0302_Record_6 CURSOR FOR SELECT ROLE_ID
		                                          FROM   TBL_PM_0302_USER_TO_ROLE
		                                          WHERE PARAMETER_NBR = :ParamNbr AND TO_NUMBER(OPERATOR_ID) = :i_USER_ID
		                                          ORDER BY ROLE_ID;                                 
		EXEC SQL OPEN SQL_0302_Record_6;
		if(sqlca.sqlcode != 0)
		{	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:create0302param(OPEN SQL_0302_Record_6):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			free(packagebody);
			packagebody = NULL;
			return 0;
		}
		for(;;)
		{
			EXEC SQL FETCH SQL_0302_Record_6 INTO :ROLE_ID;
			if(sqlca.sqlcode != 0)
			{
				if(sqlca.sqlcode == 1403)
				{
					break;
				}
				else
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg,"%s:create0302param(FETCH SQL_0302_Record_6):ErrorCode is %d,ErrorDesc is:%s\n",c_id,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
					EXEC SQL CLOSE SQL_0302_Record_6;
					free(packagebody);
					packagebody = NULL;
					return 0;
				}
			}
			/* -- 参数结构赋值 -- */ 
			memset(&m_Para0302_Record_6,0x00,sizeof(Para0302_Record_6));
			m_Para0302_Record_6.ROLE_ID  = (BYTE)ROLE_ID;
			memcpy(p,&m_Para0302_Record_6,sizeof(Para0302_Record_6));
			p = p + sizeof(Para0302_Record_6);	
			bodylen = bodylen + sizeof(Para0302_Record_6);
		}
		EXEC SQL CLOSE SQL_0302_Record_6;
			
		/* -------- 包体(Para0302_Record_7) ---------- */
		memset(&m_Para0302_Record_7,0x00,sizeof(Para0302_Record_7));
		memcpy(p,&m_Para0302_Record_7,sizeof(Para0302_Record_7));
		p = p + sizeof(Para0302_Record_7);	
		bodylen = bodylen + sizeof(Para0302_Record_7);
	}
	EXEC SQL CLOSE SQL_0302_Record_5;
	
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte(sc_id,(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,bodylen,0x0302,1,b_sccode,c_PkgID);
	/* -- 生成文件 -- */    
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
 
	char strTemp[5],temp2[100];
	memset(strTemp,0x00,sizeof(strTemp));
	memcpy(strTemp,c_id,4);

	for(int i = 0;i < MAX_SLE_COUNT;i++)
	{
		if(strncmp(sc_id,CConfig::g_ScList[i].sccode,4) == 0)
		{
			memset(temp2,0x00,sizeof(temp2));
			sprintf(temp2,"0302_%s",strTemp);
	
			memset(filePath,0x00,sizeof(filePath));
			sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::g_ScList[i].lineId);
			CommonFuncs::DeleteFile(filePath,temp2);
			
			memset(filename,0x00,sizeof(filename));
			sprintf(filename,"%s0302_%s_%s",filePath,strTemp,ParamVer);
			CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
			
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
			CLog::WriteAppLog(oplogmsg);
			
			break;
		}
	}		
 
	/* -------- 内存释放 ---------- */
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver == NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		     		 SET    FILE_FLAG = 1
		       	 WHERE PARAMETER_STATUS = 0 
		       	 AND PARAMETER_TYPE = '0302' 
		       	 AND PARAMETER_CTRL_NID = :sc_id;
	}
	else if (strcmp(c_ver,"FFFFFFFF") == 0)
				{
					EXEC SQL UPDATE T_PARAMETER_CTRL
					     		 SET    UPDATE_FLAG = 0
					       	 WHERE PARAMETER_NBR = :ParamNbr;
					       	 
					EXEC SQL UPDATE T_PARAMETER_CTRL
					     		 SET    PARAMETER_VERSION = :ParamVer
					       	 WHERE PARAMETER_NBR = :ParamNbr;
				}
				else
				{
					EXEC SQL UPDATE T_PARAMETER_CTRL
					         SET    PARAMETER_STATUS = 3
					         WHERE PARAMETER_STATUS = 2 
					         AND PARAMETER_TYPE = '0302' 
					         AND PARAMETER_CTRL_NID = :sc_id;
					         
					EXEC SQL UPDATE T_PARAMETER_CTRL
					         SET    PARAMETER_STATUS = 2
					         WHERE PARAMETER_NBR = :ParamNbr;
					         	
					gap = 0;
					EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
					if(gap >=0)
					{
						EXEC SQL UPDATE T_PARAMETER_CTRL
						         SET    PARAMETER_STATUS = 1
						         WHERE PARAMETER_STATUS = 0 
						         AND PARAMETER_TYPE = '0302' 
						         AND PARAMETER_CTRL_NID = :sc_id;
						         
						EXEC SQL UPDATE T_PARAMETER_CTRL
						         SET    PARAMETER_STATUS = 0
						         WHERE PARAMETER_NBR = :ParamNbr;
							       	
						memset(oplogmsg,0x00,sizeof(oplogmsg));
						sprintf(oplogmsg, "参数%s(%s参数索引:%d)生效\n","0302",sc_id,ParamNbr);
						CLog::WriteAppLog(oplogmsg);
					}
					
					EXEC SQL UPDATE T_PARAMETER_CTRL
					     		 SET    FILE_FLAG = 1
					       	 WHERE PARAMETER_STATUS = 0 
					       	 AND PARAMETER_TYPE = '0302' 
					       	 AND PARAMETER_CTRL_NID = :sc_id;
					       	 
				}
	EXEC SQL COMMIT;
	
 
	
	return 1;
}

/* ------------------------------------------------------
            生成0303参数
--------------------------------------------------------- */
int  ORA::create0303param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	int           ParamRecords;
	char          c_paraCtrlId[9];
	
	char						ParamVer[15];
	unsigned int    dw_ValidTime;
	int							ERROR_NBR;													/* ---  --- */
	int							WRITE_INCOM_TIME;										/* ---  --- */
	int							WRITE_INCOM_RETRY_COUNT;						/* ---  --- */
	int							PASSWD_ENTRY_TIME;									/* ---  --- */
	int							LOGIN_RETRY_COUNT;									/* ---  --- */
	int							AUTO_LOGOUT_TIME;										/* ---  --- */
	int							DOOR_CLOSE_ALERT;										/* ---  --- */
	int							TICKETBOX_PRE_EMPTY_PERCENTAGE;			/* ---  --- */
	int             TICKETBOX_EMPTY_PERCENTAGE;
	int							TICKETBOX_PRE_FULL_PERCENTAGE;			/* ---  --- */
	int							TICKETBOX_FULL_PERCENTAGE;					/* ---  --- */
	int							TRASH_PRE_FULL_PERCENTAGE;					/* ---  --- */
	int							TRASH_FULL_PERCENTAGE;							/* ---  --- */
	int							CNT_BOTTOM_LINE;										/* ---  --- */
	int							TIME_TOP_LINE;												/* ---  --- */
	int							TIME_REPORT_STATUS;									/* ---  --- */
	int							TIME_REPORT_AUDIT;									/* ---  --- */
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];

	char            	c_PkgID[30];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0303 					m_Para0303;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
 
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
		strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 
		                AND PARAMETER_TYPE = '0303' 
		                AND FILE_FLAG = 0
		                AND ROWNUM = 1;
	}
  else
  {
  	strcpy(c_paraCtrlId,c_recvid); 
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION = :ParamVer 
		                AND PARAMETER_TYPE = '0303'
		                AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }

  if(sqlca.sqlcode != 0)
	{
		return 0;
	}           
	EXEC SQL SELECT ERROR_NBR,WRITE_INCOM_TIME,WRITE_INCOM_RETRY_COUNT,
                  PASSWD_ENTRY_TIME,LOGIN_RETRY_COUNT,AUTO_LOGOUT_TIME,DOOR_CLOSE_ALERT,
                  TICKETBOX_PRE_EMPTY_PERCENTAGE,TICKETBOX_PRE_FULL_PERCENTAGE,
                  TICKETBOX_FULL_PERCENTAGE,TRASH_PRE_FULL_PERCENTAGE,TRASH_FULL_PERCENTAGE,
                  CNT_BOTTOM_LINE,TIME_TOP_LINE,TIME_REPORT_STATUS,TIME_REPORT_AUDIT,TICKETBOX_EMPTY_PERCENTAGE
	         INTO   :ERROR_NBR,:WRITE_INCOM_TIME,:WRITE_INCOM_RETRY_COUNT,
                  :PASSWD_ENTRY_TIME,:LOGIN_RETRY_COUNT,:AUTO_LOGOUT_TIME,:DOOR_CLOSE_ALERT,
                  :TICKETBOX_PRE_EMPTY_PERCENTAGE,:TICKETBOX_PRE_FULL_PERCENTAGE,
                  :TICKETBOX_FULL_PERCENTAGE,:TRASH_PRE_FULL_PERCENTAGE,:TRASH_FULL_PERCENTAGE,
                  :CNT_BOTTOM_LINE,:TIME_TOP_LINE,:TIME_REPORT_STATUS,:TIME_REPORT_AUDIT,:TICKETBOX_EMPTY_PERCENTAGE
	         FROM   TBL_PM_0303_DEVICE
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0303param(TBL_PM_0303_DEVICE) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0303,0x00,sizeof(Para0303));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0303.ParamVer,sizeof(m_Para0303.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	m_Para0303.ValidTime = CommonFuncs::dwordtowin(dw_ValidTime);
	m_Para0303.ERROR_NBR = (BYTE)(ERROR_NBR);
	m_Para0303.WRITE_INCOM_TIME = (BYTE)(WRITE_INCOM_TIME);
	m_Para0303.WRITE_INCOM_RETRY_COUNT = (BYTE)(WRITE_INCOM_RETRY_COUNT);
	m_Para0303.PASSWD_ENTRY_TIME = (BYTE)(PASSWD_ENTRY_TIME);
	m_Para0303.LOGIN_RETRY_COUNT = (BYTE)(LOGIN_RETRY_COUNT);
	m_Para0303.AUTO_LOGOUT_TIME = (BYTE)(AUTO_LOGOUT_TIME);
	m_Para0303.DOOR_CLOSE_ALERT = (BYTE)(DOOR_CLOSE_ALERT);
	m_Para0303.TICKETBOX_PRE_EMPTY_PERCENTAGE = (BYTE)(TICKETBOX_PRE_EMPTY_PERCENTAGE);
	m_Para0303.TICKETBOX_EMPTY_PERCENTAGE = (BYTE)(TICKETBOX_EMPTY_PERCENTAGE);
	m_Para0303.TICKETBOX_PRE_FULL_PERCENTAGE = (BYTE)(TICKETBOX_PRE_FULL_PERCENTAGE);
	m_Para0303.TICKETBOX_FULL_PERCENTAGE = (BYTE)(TICKETBOX_FULL_PERCENTAGE);
	m_Para0303.TRASH_PRE_FULL_PERCENTAGE = (BYTE)(TRASH_PRE_FULL_PERCENTAGE);
	m_Para0303.TRASH_FULL_PERCENTAGE = (BYTE)(TRASH_FULL_PERCENTAGE);
	m_Para0303.CNT_BOTTOM_LINE = (BYTE)(CNT_BOTTOM_LINE);
	m_Para0303.TIME_TOP_LINE = (BYTE)(TIME_TOP_LINE);
	m_Para0303.TIME_REPORT_STATUS = (BYTE)(TIME_REPORT_STATUS);
	m_Para0303.TIME_REPORT_AUDIT = (BYTE)(TIME_REPORT_AUDIT);
	
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0303),0x0303,1,b_sccode,c_PkgID);
	/* -- 生成文件 -- */    
	filelen = sizeof(MsgHead)+sizeof(Para0303)+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)&m_Para0303,sizeof(Para0303));

 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0303_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0303_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0303_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0303_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}
 
	/* -------- 内存释放 ---------- */
	free(filebuf);
	filebuf = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 
		         AND PARAMETER_TYPE = '0303'
		         AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		         
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 
			         AND PARAMETER_TYPE = '0303'
			         AND PARAMETER_CTRL_NID = :c_paraCtrlId;
			         
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0303",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 
		       AND PARAMETER_TYPE = '0303'
		       AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		       
	EXEC SQL COMMIT; 
 
	return 1;
}

/* ------------------------------------------------------
            生成0304参数
--------------------------------------------------------- */
int ORA::create0304param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	int           ParamRecords;
	char          c_paraCtrlId[9];
		
	char						ParamVer[15];
	unsigned int    dw_ValidTime;
	int 						MAX_SALE;												
	int 						TICKET_TIMEOUT;								
	int							COIN_WAIT;						          
	int 						ALLOW_STANDBY;						
	unsigned short	STANDBY_TIME;								
	char						SALE_CASH_TYPE[5];						
	char						SALE_COIN_TYPE[5];	
	unsigned short	MAX_CASH_AMOUNT;			
	int 						MAX_CASH_COUNT;		
	char						LOAD_CASH_TYPE[5];		
	unsigned int		LOAD_CASH_AMOUNT;							
	int 						LOAD_CASH_COUNT;							
	int 						IS_SALE_NO_COIN;							
	int 						MAX_COIN_CHANGE_COUNT;					
	int 						IS_BILL_CHANGE;									
	int 						MAX_CHANGE_BILL_COUNT;					
	unsigned short	MAX_CHANGE_BILL_AMOUNT;					
	unsigned short	CASHBOX_PRE_FULL_COUNT;					
	unsigned short	CASHBOX_FULL_COUNT;							
	unsigned short	COIN_TRASH_PRE_FULL_COUNT;			
	unsigned short	COIN_TRASH_FULL_COUNT;					
	unsigned short	COIN_CHANGE_PRE_EMPTY_COUNT;
	unsigned short	CASH_CHANGE_PRE_EMPTY_COUNT;
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	char            	c_PkgID[30];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0304 					m_Para0304;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
 
 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
		strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 
		                AND PARAMETER_TYPE = '0304' 
		                AND FILE_FLAG = 0
		                AND ROWNUM = 1;
	}
  else
  {
  	strcpy(c_paraCtrlId,c_recvid); 
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION =: ParamVer 
		                AND PARAMETER_TYPE = '0304'
		                AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }

  if(sqlca.sqlcode != 0)
	{
		return 0;
	}    
	
	memset(SALE_CASH_TYPE,0x00,sizeof(SALE_CASH_TYPE));
	memset(SALE_COIN_TYPE,0x00,sizeof(SALE_COIN_TYPE));
	memset(LOAD_CASH_TYPE,0x00,sizeof(LOAD_CASH_TYPE));
	EXEC SQL SELECT MAX_SALE,TICKET_TIMEOUT,COIN_WAIT,ALLOW_STANDBY,STANDBY_TIME,
                  SALE_CASH_TYPE,SALE_COIN_TYPE,MAX_CASH_AMOUNT,MAX_CASH_COUNT,LOAD_CASH_TYPE,
                  LOAD_CASH_AMOUNT,LOAD_CASH_COUNT,IS_SALE_NO_COIN,MAX_COIN_CHANGE_COUNT,IS_BILL_CHANGE,
                  MAX_CHANGE_BILL_COUNT,MAX_CHANGE_BILL_AMOUNT,CASHBOX_PRE_FULL_COUNT,CASHBOX_FULL_COUNT,COIN_TRASH_PRE_FULL_COUNT,
                  COIN_TRASH_FULL_COUNT,COIN_CHANGE_PRE_EMPTY_COUNT,CASH_CHANGE_PRE_EMPTY_COUNT
	         INTO   :MAX_SALE,:TICKET_TIMEOUT,:COIN_WAIT,:ALLOW_STANDBY,:STANDBY_TIME,
                  :SALE_CASH_TYPE,:SALE_COIN_TYPE,:MAX_CASH_AMOUNT,:MAX_CASH_COUNT,:LOAD_CASH_TYPE,
                  :LOAD_CASH_AMOUNT,:LOAD_CASH_COUNT,:IS_SALE_NO_COIN,:MAX_COIN_CHANGE_COUNT,:IS_BILL_CHANGE,
                  :MAX_CHANGE_BILL_COUNT,:MAX_CHANGE_BILL_AMOUNT,:CASHBOX_PRE_FULL_COUNT,:CASHBOX_FULL_COUNT,:COIN_TRASH_PRE_FULL_COUNT,
                  :COIN_TRASH_FULL_COUNT,:COIN_CHANGE_PRE_EMPTY_COUNT,:CASH_CHANGE_PRE_EMPTY_COUNT
	         FROM   TBL_PM_0304_TVM
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0304param(TBL_PM_0304_TVM) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0304,0x00,sizeof(Para0304));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0304.ParamVer,sizeof(m_Para0304.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	m_Para0304.ValidTime = CommonFuncs::dwordtowin(dw_ValidTime);
	m_Para0304.MAX_SALE = (BYTE)(MAX_SALE);
	m_Para0304.TICKET_TIMEOUT = (BYTE)(TICKET_TIMEOUT);
	m_Para0304.COIN_WAIT = (BYTE)(COIN_WAIT);
	m_Para0304.ALLOW_STANDBY = (BYTE)(ALLOW_STANDBY);
	m_Para0304.STANDBY_TIME = CommonFuncs::wordtowin(STANDBY_TIME);
	CommonFuncs::chartobyte(SALE_CASH_TYPE,(char*)m_Para0304.SALE_CASH_TYPE,sizeof(m_Para0304.SALE_CASH_TYPE));
	CommonFuncs::chartobyte(SALE_COIN_TYPE,(char*)m_Para0304.SALE_COIN_TYPE,sizeof(m_Para0304.SALE_COIN_TYPE));
	m_Para0304.MAX_CASH_AMOUNT = CommonFuncs::wordtowin(MAX_CASH_AMOUNT);
	m_Para0304.MAX_CASH_COUNT = (BYTE)(MAX_CASH_COUNT);
	CommonFuncs::chartobyte(LOAD_CASH_TYPE,(char*)m_Para0304.LOAD_CASH_TYPE,sizeof(m_Para0304.LOAD_CASH_TYPE));
	m_Para0304.LOAD_CASH_AMOUNT = CommonFuncs::dwordtowin(LOAD_CASH_AMOUNT);
	m_Para0304.LOAD_CASH_COUNT = (BYTE)(LOAD_CASH_COUNT);
	m_Para0304.IS_SALE_NO_COIN = (BYTE)(IS_SALE_NO_COIN);
	m_Para0304.MAX_COIN_CHANGE_COUNT = (BYTE)(MAX_COIN_CHANGE_COUNT);
	m_Para0304.IS_BILL_CHANGE = (BYTE)(IS_BILL_CHANGE);
	m_Para0304.MAX_CHANGE_BILL_COUNT = (BYTE)(MAX_CHANGE_BILL_COUNT);
	m_Para0304.MAX_CHANGE_BILL_AMOUNT = CommonFuncs::wordtowin(MAX_CHANGE_BILL_AMOUNT);
	m_Para0304.CASHBOX_PRE_FULL_COUNT = CommonFuncs::wordtowin(CASHBOX_PRE_FULL_COUNT);
	m_Para0304.CASHBOX_FULL_COUNT = CommonFuncs::wordtowin(CASHBOX_FULL_COUNT);
	m_Para0304.COIN_TRASH_PRE_FULL_COUNT = CommonFuncs::wordtowin(COIN_TRASH_PRE_FULL_COUNT);
	m_Para0304.COIN_TRASH_FULL_COUNT = CommonFuncs::wordtowin(COIN_TRASH_FULL_COUNT);
	m_Para0304.COIN_CHANGE_PRE_EMPTY_COUNT = CommonFuncs::wordtowin(COIN_CHANGE_PRE_EMPTY_COUNT);
	m_Para0304.CASH_CHANGE_PRE_EMPTY_COUNT = CommonFuncs::wordtowin(CASH_CHANGE_PRE_EMPTY_COUNT);
	
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0304),0x0304,1,b_sccode,c_PkgID);
	
	/* -- 生成文件 -- */    
	filelen = sizeof(MsgHead)+sizeof(Para0304)+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)&m_Para0304,sizeof(Para0304));
	
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0304_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0304_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0304_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0304_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}	
	
	/* -------- 内存释放 ---------- */
	free(filebuf);
	filebuf = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = '0304';
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0304';
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s生效\n","0304");
			CLog::WriteAppLog(oplogmsg);
		}
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0304';
	EXEC SQL COMMIT; 
	
 
	
	return 1;
}

 
/* ------------------------------------------------------
            生成0305参数
--------------------------------------------------------- */
int ORA::create0305param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	int           ParamRecords;
	char          c_paraCtrlId[9];
		
	char						ParamVer[15];		/* ---  --- */
	unsigned int    dw_ValidTime;
	int							ERROR_NBR;
	int							WRITE_RETRY_OVER_TIME;
	int							WRITE_RETRY_COUNT;
	int							AUTO_LOGOUT_TIME;
	int							TRANS_OVER_TIME;
	int							TICKETBOX_PRE_EMPTY_PERCENTAGE;
	int							TICKETBOX_EMPTY_PERCENTAGE;
	int							TRASH_PRE_FULL_PERCENTAGE;
	int							TRASH_FULL_PERCENTAGE;
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	char            	c_PkgID[30];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0305 					m_Para0305;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
		strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 
		                AND PARAMETER_TYPE = '0305'
		                AND FILE_FLAG = 0
		                AND ROWNUM = 1;
	}
  else
  {
  	strcpy(c_paraCtrlId,c_recvid); 
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION = :ParamVer 
		                AND PARAMETER_TYPE = '0305'
		                AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }

  if(sqlca.sqlcode != 0)
	{
		return 0;
	}    
	       
	EXEC SQL SELECT ERROR_NBR, WRITE_RETRY_OVER_TIME,WRITE_RETRY_COUNT,
                  AUTO_LOGOUT_TIME, TRANS_OVER_TIME,
                  TICKETBOX_PRE_EMPTY_PERCENTAGE,TICKETBOX_EMPTY_PERCENTAGE, 
                  TRASH_PRE_FULL_PERCENTAGE,TRASH_FULL_PERCENTAGE
	         INTO   :ERROR_NBR, :WRITE_RETRY_OVER_TIME,:WRITE_RETRY_COUNT,
                  :AUTO_LOGOUT_TIME, :TRANS_OVER_TIME,
                  :TICKETBOX_PRE_EMPTY_PERCENTAGE,:TICKETBOX_EMPTY_PERCENTAGE, 
                  :TRASH_PRE_FULL_PERCENTAGE,:TRASH_FULL_PERCENTAGE
	         FROM   TBL_PM_0305_BOM
	         WHERE  PARAMETER_NBR = :ParamNbr;
	         
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0305param(TBL_PM_0305_BOM) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0305,0x00,sizeof(Para0305));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0305.ParamVer,sizeof(m_Para0305.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	m_Para0305.ValidTime = CommonFuncs::dwordtowin(dw_ValidTime);
	m_Para0305.ERROR_NBR = (BYTE)(ERROR_NBR);
	m_Para0305.WRITE_RETRY_OVER_TIME = (BYTE)(WRITE_RETRY_OVER_TIME);
	m_Para0305.WRITE_RETRY_COUNT = (BYTE)(WRITE_RETRY_COUNT);
	m_Para0305.AUTO_LOGOUT_TIME = CommonFuncs::wordtowin(AUTO_LOGOUT_TIME);;
	m_Para0305.TRANS_OVER_TIME = (BYTE)(TRANS_OVER_TIME);
	m_Para0305.TICKETBOX_PRE_EMPTY_PERCENTAGE = (BYTE)(TICKETBOX_PRE_EMPTY_PERCENTAGE);
	m_Para0305.TICKETBOX_EMPTY_PERCENTAGE = (BYTE)(TICKETBOX_EMPTY_PERCENTAGE);
	m_Para0305.TRASH_PRE_FULL_PERCENTAGE = (BYTE)(TRASH_PRE_FULL_PERCENTAGE);
	m_Para0305.TRASH_FULL_PERCENTAGE	 = (BYTE)(TRASH_FULL_PERCENTAGE);
 
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0305),0x0305,1,b_sccode,c_PkgID);
	/* -- 生成文件 -- */    
	filelen = sizeof(MsgHead)+sizeof(Para0305)+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)&m_Para0305,sizeof(Para0305));
	
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0305_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0305_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0305_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0305_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}	
	
	/* -------- 内存释放 ---------- */
	free(filebuf);
	filebuf = NULL;
	
	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 
		         AND PARAMETER_TYPE = '0305'
		         AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		         
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 
			         AND PARAMETER_TYPE = '0305'
			         AND PARAMETER_CTRL_NID = :c_paraCtrlId;
			         
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0305",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 
		       AND PARAMETER_TYPE = '0305'
		       AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		       
	EXEC SQL COMMIT; 
 
	return 1;
}


/* ------------------------------------------------------
            生成0306参数
--------------------------------------------------------- */
int ORA::create0306param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	int           ParamRecords;
	char          c_paraCtrlId[9];
		
	char						ParamVer[15];	
	unsigned int    dw_ValidTime;
	int 						MAX_PASS;		
	int 						RELEASE_TIME;	
	int 						DELAY_TIME;						
	char						BLACKLIST_LIGHT_ACTION[5];
	char						BLACKLIST_SOUND_ACTION[5];
	char						ILLEGAL_LIGHT_ACTION[5];
	char						ILLEGAL_SOUND_ACTION[5];
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	char            	c_PkgID[30];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0306 					m_Para0306;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
		strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
		
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 
		                AND PARAMETER_TYPE = '0306' 
		                AND FILE_FLAG = 0
		                AND ROWNUM = 1;
	}
  else
  {
		strcpy(c_paraCtrlId,c_recvid); 
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
                INTO :ParamNbr,:ParamVer,:ValidTime
                FROM T_PARAMETER_CTRL 
                WHERE PARAMETER_VERSION = :ParamVer 
                AND PARAMETER_TYPE = '0306';
  }

  if(sqlca.sqlcode != 0)
	{
		return 0;
	}    
	
	memset(BLACKLIST_LIGHT_ACTION,0x00,sizeof(BLACKLIST_LIGHT_ACTION));
	memset(BLACKLIST_SOUND_ACTION,0x00,sizeof(BLACKLIST_SOUND_ACTION));
	memset(ILLEGAL_LIGHT_ACTION,0x00,sizeof(ILLEGAL_LIGHT_ACTION));
	memset(ILLEGAL_SOUND_ACTION,0x00,sizeof(ILLEGAL_SOUND_ACTION));
	EXEC SQL SELECT MAX_PASS,RELEASE_TIME,DELAY_TIME,BLACKLIST_LIGHT_ACTION,BLACKLIST_SOUND_ACTION,ILLEGAL_LIGHT_ACTION,ILLEGAL_SOUND_ACTION
	         INTO   :MAX_PASS,:RELEASE_TIME,:DELAY_TIME,:BLACKLIST_LIGHT_ACTION,:BLACKLIST_SOUND_ACTION,:ILLEGAL_LIGHT_ACTION,:ILLEGAL_SOUND_ACTION
	         FROM   TBL_PM_0306_AG
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0306param(TBL_PM_0306_AG) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0306,0x00,sizeof(Para0306));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0306.ParamVer,sizeof(m_Para0306.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	m_Para0306.ValidTime = CommonFuncs::dwordtowin(dw_ValidTime);
	m_Para0306.MAX_PASS = (BYTE)(MAX_PASS);
	m_Para0306.RELEASE_TIME = (BYTE)(RELEASE_TIME);
	m_Para0306.DELAY_TIME = (BYTE)(DELAY_TIME);
	CommonFuncs::chartobyte(BLACKLIST_LIGHT_ACTION,(char*)m_Para0306.BLACKLIST_LIGHT_ACTION,sizeof(m_Para0306.BLACKLIST_LIGHT_ACTION));
	CommonFuncs::chartobyte(BLACKLIST_SOUND_ACTION,(char*)m_Para0306.BLACKLIST_SOUND_ACTION,sizeof(m_Para0306.BLACKLIST_SOUND_ACTION));
	CommonFuncs::chartobyte(ILLEGAL_LIGHT_ACTION,(char*)m_Para0306.ILLEGAL_LIGHT_ACTION,sizeof(m_Para0306.ILLEGAL_LIGHT_ACTION));
	CommonFuncs::chartobyte(ILLEGAL_SOUND_ACTION,(char*)m_Para0306.ILLEGAL_SOUND_ACTION,sizeof(m_Para0306.ILLEGAL_SOUND_ACTION));
	
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0306),0x0306,1,b_sccode,c_PkgID);
	
	/* -- 生成文件 -- */    
	filelen = sizeof(MsgHead)+sizeof(Para0306)+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)&m_Para0306,sizeof(Para0306));
 
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0306_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0306_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0306_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0306_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}
 
	/* -------- 内存释放 ---------- */
	free(filebuf);
	filebuf = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 
		         AND PARAMETER_TYPE = '0306'
		         AND PARAMETER_CTRL_NID = :c_paraCtrlId;
 
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 
			         AND PARAMETER_TYPE = '0306'
			         AND PARAMETER_CTRL_NID = :c_paraCtrlId;
			         
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0306",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 
		       AND PARAMETER_TYPE = '0306'
		       AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		       
	EXEC SQL COMMIT; 
 
	return 1;
}

/* ------------------------------------------------------
            生成0307参数
--------------------------------------------------------- */
int ORA::create0307param(char *c_recvid,const char *c_ver)
{  
	return 0;
}


/* ------------------------------------------------------
            生成0501参数
--------------------------------------------------------- */
int ORA::create0501param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	char          c_paraCtrlId[9];
	
	char						ParamVer[15];
	unsigned int    dw_ValidTime;		
	char						SOFT_VERSION[13];
	char						SOFT_FILE_NAME[33];	
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
 
	char            	c_PkgID[30],temp[100];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0501					m_Para0501;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
	char        			softFullFileName[MAX_PATH];
	 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
			strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE='0501' AND FILE_FLAG = 0 AND ROWNUM = 1;	              
	}
  else
  {
		strcpy(c_paraCtrlId,c_recvid); 
 		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION =: ParamVer AND PARAMETER_TYPE='0501' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }

  if(sqlca.sqlcode != 0)
	{
		/*-----------------------------------------
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0501param(T_PARAMETER_CTRL(ParamVer:%s;c_paraCtrlId:%s)) error code is %d\n",ParamVer,c_paraCtrlId,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		-------------------------------*/
		
		return 0;
	}    
 
	memset(SOFT_VERSION,0x00,sizeof(SOFT_VERSION));
	memset(SOFT_FILE_NAME,0x00,sizeof(SOFT_FILE_NAME));

	EXEC SQL SELECT SOFT_VERSION,SOFT_FILE_NAME
	         INTO   :SOFT_VERSION,:SOFT_FILE_NAME
	         FROM   TBL_PM_0501_SOFT_TVM
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0501param(TBL_PM_0501_SOFT_TVM) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0501,0x00,sizeof(Para0501));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0501.ParamVer,sizeof(m_Para0501.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	memset(temp,0x00,sizeof(temp));
	CommonFuncs::delspace(temp,SOFT_FILE_NAME);			
	strcpy(m_Para0501.SoftVersion,SOFT_VERSION); 
		
 
	unsigned char       *recvbuf,*bodybuf;
	struct stat         buf;
	int                 buflen,bodylen;
 
 	memset(softFullFileName,0x00,sizeof(softFullFileName));
	sprintf(softFullFileName,"%s%s",CConfig::g_SleSoftfilePath,temp);
 
	/* ---  读取文件 --- */
	buflen = stat(softFullFileName,&buf);
	if(buflen != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0501param(softFullFileName:%s) error code is %d\n",softFullFileName,buflen);
		CLog::WriteAppLog(oplogmsg);
		
		return 0;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(softFullFileName,(char*)recvbuf);
	
	m_Para0501.SoftLength = CommonFuncs::dwordtowin(buflen);
 
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0501)+buflen,0x0501,1,b_sccode,c_PkgID);
	
	/* -- 生成文件 -- */
	bodylen = sizeof(Para0501) + buflen;  
	bodybuf = (unsigned char*)malloc(bodylen);
	memset(bodybuf,0x00,bodylen);	
	memcpy(bodybuf,&m_Para0501,sizeof(Para0501));		
	memcpy(bodybuf + sizeof(Para0501),recvbuf,buflen);	 
 
 	filelen = sizeof(MsgHead) + bodylen + LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)bodybuf,bodylen);
 
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0501_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0501_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0501_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0501_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}
 

	/* -------- 内存释放 ---------- */
	free(bodybuf);
	bodybuf = NULL;
	
	free(recvbuf);
	recvbuf = NULL;

	free(filebuf);
	filebuf = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = '0501' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0501' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0501",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0501' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
	EXEC SQL COMMIT; 
 
  memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "参数%s(参数索引:%d)生成成功,删除软件包(%s)\n","0501",ParamNbr,softFullFileName);
	CLog::WriteAppLog(oplogmsg);

	remove(softFullFileName);
 
	return 1;
}
 
/* ------------------------------------------------------
            生成0502参数
--------------------------------------------------------- */
int ORA::create0502param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	char          c_paraCtrlId[9];
	
	char						ParamVer[15];
	unsigned int    dw_ValidTime;		
	char						SOFT_VERSION[13];
	char						SOFT_FILE_NAME[33];	
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
 
	char            	c_PkgID[30],temp[100];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0502					m_Para0502;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
	char        			softFullFileName[MAX_PATH];
	 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
			strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE='0502' AND FILE_FLAG = 0 AND ROWNUM = 1;	              
	}
  else
  {
		strcpy(c_paraCtrlId,c_recvid); 
 		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION =: ParamVer AND PARAMETER_TYPE='0502' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }

  if(sqlca.sqlcode != 0)
	{
		/*-----------------------------------------
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0502param(T_PARAMETER_CTRL(ParamVer:%s;c_paraCtrlId:%s)) error code is %d\n",ParamVer,c_paraCtrlId,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		-------------------------------*/
		
		return 0;
	}    
 
	memset(SOFT_VERSION,0x00,sizeof(SOFT_VERSION));
	memset(SOFT_FILE_NAME,0x00,sizeof(SOFT_FILE_NAME));

	EXEC SQL SELECT SOFT_VERSION,SOFT_FILE_NAME
	         INTO   :SOFT_VERSION,:SOFT_FILE_NAME
	         FROM   TBL_PM_0502_SOFT_AGM
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0502param(TBL_PM_0502_SOFT_AGM) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0502,0x00,sizeof(Para0502));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0502.ParamVer,sizeof(m_Para0502.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	memset(temp,0x00,sizeof(temp));
	CommonFuncs::delspace(temp,SOFT_FILE_NAME);			
	strcpy(m_Para0502.SoftVersion,SOFT_VERSION); 
		
 
	unsigned char       *recvbuf,*bodybuf;
	struct stat         buf;
	int                 buflen,bodylen;
 
 	memset(softFullFileName,0x00,sizeof(softFullFileName));
	sprintf(softFullFileName,"%s%s",CConfig::g_SleSoftfilePath,temp);
 
	/* ---  读取文件 --- */
	buflen = stat(softFullFileName,&buf);
	if(buflen != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0502param(softFullFileName:%s) error code is %d\n",softFullFileName,buflen);
		CLog::WriteAppLog(oplogmsg);
		
		return 0;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(softFullFileName,(char*)recvbuf);
	
	m_Para0502.SoftLength = CommonFuncs::dwordtowin(buflen);
 
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0502)+buflen,0x0502,1,b_sccode,c_PkgID);
	
	/* -- 生成文件 -- */
	bodylen = sizeof(Para0502) + buflen;  
	bodybuf = (unsigned char*)malloc(bodylen);
	memset(bodybuf,0x00,bodylen);	
	memcpy(bodybuf,&m_Para0502,sizeof(Para0502));		
	memcpy(bodybuf + sizeof(Para0502),recvbuf,buflen);	 
 
 	filelen = sizeof(MsgHead) + bodylen + LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)bodybuf,bodylen);
 
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0502_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0502_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0502_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0502_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}
 

	/* -------- 内存释放 ---------- */
	free(bodybuf);
	bodybuf = NULL;
	
	free(recvbuf);
	recvbuf = NULL;

	free(filebuf);
	filebuf = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = '0502' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0502' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0502",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0502' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
	EXEC SQL COMMIT; 
 
 memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "参数%s(参数索引:%d)生成成功,删除软件包(%s)\n","0502",ParamNbr,softFullFileName);
	CLog::WriteAppLog(oplogmsg);

	remove(softFullFileName);
 
	return 1;
}

 
/* ------------------------------------------------------
            生成0503参数
--------------------------------------------------------- */
int ORA::create0503param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	char          c_paraCtrlId[9];
	
	char						ParamVer[15];
	unsigned int    dw_ValidTime;		
	char						SOFT_VERSION[13];
	char						SOFT_FILE_NAME[33];	
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
 
	char            	c_PkgID[30],temp[100];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0503					m_Para0503;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
	char        			softFullFileName[MAX_PATH];
	 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
			strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE='0503' AND FILE_FLAG = 0 AND ROWNUM = 1;	              
	}
  else
  {
		strcpy(c_paraCtrlId,c_recvid); 
 		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION =: ParamVer AND PARAMETER_TYPE='0503' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }

  if(sqlca.sqlcode != 0)
	{
		/*-----------------------------------------
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0503param(T_PARAMETER_CTRL(ParamVer:%s;c_paraCtrlId:%s)) error code is %d\n",ParamVer,c_paraCtrlId,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		-------------------------------*/
		
		return 0;
	}    
 
	memset(SOFT_VERSION,0x00,sizeof(SOFT_VERSION));
	memset(SOFT_FILE_NAME,0x00,sizeof(SOFT_FILE_NAME));

	EXEC SQL SELECT SOFT_VERSION,SOFT_FILE_NAME
	         INTO   :SOFT_VERSION,:SOFT_FILE_NAME
	         FROM   TBL_PM_0503_SOFT_BOM
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0503param(TBL_PM_0503_SOFT_BOM) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0503,0x00,sizeof(Para0503));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0503.ParamVer,sizeof(m_Para0503.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	memset(temp,0x00,sizeof(temp));
	CommonFuncs::delspace(temp,SOFT_FILE_NAME);			
	strcpy(m_Para0503.SoftVersion,SOFT_VERSION); 
		
 
	unsigned char       *recvbuf,*bodybuf;
	struct stat         buf;
	int                 buflen,bodylen;
 
 	memset(softFullFileName,0x00,sizeof(softFullFileName));
	sprintf(softFullFileName,"%s%s",CConfig::g_SleSoftfilePath,temp);
 
	/* ---  读取文件 --- */
	buflen = stat(softFullFileName,&buf);
	if(buflen != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0503param(softFullFileName:%s) error code is %d\n",softFullFileName,buflen);
		CLog::WriteAppLog(oplogmsg);
		
		return 0;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(softFullFileName,(char*)recvbuf);
	
	m_Para0503.SoftLength = CommonFuncs::dwordtowin(buflen);
 
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0503)+buflen,0x0503,1,b_sccode,c_PkgID);
	
	/* -- 生成文件 -- */
	bodylen = sizeof(Para0503) + buflen;  
	bodybuf = (unsigned char*)malloc(bodylen);
	memset(bodybuf,0x00,bodylen);	
	memcpy(bodybuf,&m_Para0503,sizeof(Para0503));		
	memcpy(bodybuf + sizeof(Para0503),recvbuf,buflen);	 
 
 	filelen = sizeof(MsgHead) + bodylen + LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)bodybuf,bodylen);
 
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0503_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0503_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0503_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0503_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}
 

	/* -------- 内存释放 ---------- */
	free(bodybuf);
	bodybuf = NULL;
	
	free(recvbuf);
	recvbuf = NULL;

	free(filebuf);
	filebuf = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = '0503' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0503' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0503",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0503' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
	EXEC SQL COMMIT; 
 
 
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "参数%s(参数索引:%d)生成成功,删除软件包(%s)\n","0503",ParamNbr,softFullFileName);
	CLog::WriteAppLog(oplogmsg);

	remove(softFullFileName);
 
	return 1;
}

/* ------------------------------------------------------
            生成0504参数
--------------------------------------------------------- */
int ORA::create0504param(char *c_recvid,const char *c_ver)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	char          c_paraCtrlId[9];
	
	char						ParamVer[15];
	unsigned int    dw_ValidTime;		
	char						SOFT_VERSION[13];
	char						SOFT_FILE_NAME[33];	
	
	int             gap;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
 
	char            	c_PkgID[30],temp[100];
	MsgHead	       		m_MsgHead;
	unsigned char 		b_sccode[4];
	Para0504					m_Para0504;
	char        			filename[MAX_PATH],*filebuf;
	unsigned int      filelen;
	BYTE							b_ValidTime[7];
	char        			filePath[MAX_PATH];	
 	char        			softFullFileName[MAX_PATH];	
 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	if(c_ver != NULL)
	{
			strcpy(ParamVer,c_ver);
	}

	memset(ValidTime,0x00,sizeof(ValidTime));
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	if(c_ver == NULL)
	{
		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS'),PARAMETER_CTRL_NID
		                INTO :ParamNbr,:ParamVer,:ValidTime,:c_paraCtrlId
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE='0504' AND FILE_FLAG = 0 AND ROWNUM = 1;	              
	}
  else
  {
		strcpy(c_paraCtrlId,c_recvid); 
 		EXEC SQL SELECT PARAMETER_NBR,PARAMETER_VERSION,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ParamVer,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_VERSION =: ParamVer AND PARAMETER_TYPE='0504' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
  }

  if(sqlca.sqlcode != 0)
	{
		/*-----------------------------------------
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0504param(T_PARAMETER_CTRL(ParamVer:%s;c_paraCtrlId:%s)) error code is %d\n",ParamVer,c_paraCtrlId,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		-------------------------------*/
		
		return 0;
	}    
 
	memset(SOFT_VERSION,0x00,sizeof(SOFT_VERSION));
	memset(SOFT_FILE_NAME,0x00,sizeof(SOFT_FILE_NAME));

	EXEC SQL SELECT SOFT_VERSION,SOFT_FILE_NAME
	         INTO   :SOFT_VERSION,:SOFT_FILE_NAME
	         FROM   TBL_PM_0504_SOFT_TCM
	         WHERE  PARAMETER_NBR = :ParamNbr;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0504param(TBL_PM_0504_SOFT_BOM) error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		return 0;
	}
	/* -- 参数结构赋值 -- */ 
	memset(&m_Para0504,0x00,sizeof(Para0504));
	CommonFuncs::chartobyte(ParamVer,(char*)m_Para0504.ParamVer,sizeof(m_Para0504.ParamVer));
	dw_ValidTime = (unsigned int) CTime::GetGmtTime(ValidTime);
	memset(temp,0x00,sizeof(temp));
	CommonFuncs::delspace(temp,SOFT_FILE_NAME);			
	strcpy(m_Para0504.SoftVersion,SOFT_VERSION); 
		
 
	unsigned char       *recvbuf,*bodybuf;
	struct stat         buf;
	int                 buflen,bodylen;
 
 	memset(softFullFileName,0x00,sizeof(softFullFileName));
	sprintf(softFullFileName,"%s%s",CConfig::g_SleSoftfilePath,temp);
 
	/* ---  读取文件 --- */
	buflen = stat(softFullFileName,&buf);
	if(buflen != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create0504param(softFullFileName:%s) error code is %d\n",softFullFileName,buflen);
		CLog::WriteAppLog(oplogmsg);
		
		return 0;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(softFullFileName,(char*)recvbuf);
	
	m_Para0504.SoftLength = CommonFuncs::dwordtowin(buflen);
 
	/* -------- 生成包头 ---------- */
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	memset(b_sccode,0x00,sizeof(b_sccode));
	CommonFuncs::chartobyte("00000000",(char*)b_sccode,sizeof(b_sccode));
	CPackage::Create_Pkg_Head(1,&m_MsgHead,sizeof(Para0504)+buflen,0x0504,1,b_sccode,c_PkgID);
	
	/* -- 生成文件 -- */
	bodylen = sizeof(Para0504) + buflen;  
	bodybuf = (unsigned char*)malloc(bodylen);
	memset(bodybuf,0x00,bodylen);	
	memcpy(bodybuf,&m_Para0504,sizeof(Para0504));		
	memcpy(bodybuf + sizeof(Para0504),recvbuf,buflen);	 
 
 	filelen = sizeof(MsgHead) + bodylen + LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)bodybuf,bodylen);
 
 	if(strcmp(c_paraCtrlId,CConfig::g_CCID) == 0) //MLC参数，需要各线路生成
 	{
 		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(CConfig::ms_MlcLineList[i].LINE_ID > 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0504_");
			
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0504_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
			}
		}
 	}
 	else
 	{
		for(int i = 0;i < MAX_SLE_COUNT;i++)
		{
			if(strcmp(c_paraCtrlId,CConfig::ms_MlcLineList[i].LINE_NID) == 0)
			{
				memset(filePath,0x00,sizeof(filePath));
				sprintf(filePath,"%slc%d/",CConfig::g_CurParamPath,CConfig::ms_MlcLineList[i].LINE_ID);
				CommonFuncs::DeleteFile(filePath,(char*)"0504_");
				
				memset(filename,0x00,sizeof(filename));
				sprintf(filename,"%s0504_%s",filePath,ParamVer);
				CommonFuncs::WriteBufferFile("wb",filename,filebuf,filelen);
				
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "参数文件%s生成成功\n",filename);
				CLog::WriteAppLog(oplogmsg);
				
				break;
			}
		}
 	}
 

	/* -------- 内存释放 ---------- */
	free(bodybuf);
	bodybuf = NULL;
	
	free(recvbuf);
	recvbuf = NULL;

	free(filebuf);
	filebuf = NULL;

	/* -------- 更新表 ---------- */
	if(c_ver != NULL)
	{
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 3
		         WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = '0504' AND PARAMETER_CTRL_NID = :c_paraCtrlId;
		EXEC SQL UPDATE T_PARAMETER_CTRL
		         SET    PARAMETER_STATUS = 2
		         WHERE PARAMETER_NBR = :ParamNbr;
		         	
		gap = 0;
		EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
		if(gap >=0)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 1
			         WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0504' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
			EXEC SQL UPDATE T_PARAMETER_CTRL
			         SET    PARAMETER_STATUS = 0
			         WHERE PARAMETER_NBR = :ParamNbr;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(参数索引:%d)生效\n","0504",ParamNbr);
			CLog::WriteAppLog(oplogmsg);
		}
	}
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    FILE_FLAG = 1
		       WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = '0504' AND PARAMETER_CTRL_NID = :c_paraCtrlId;;
	EXEC SQL COMMIT; 
 
 	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "参数%s(参数索引:%d)生成成功,删除软件包(%s)\n","0504",ParamNbr,softFullFileName);
	CLog::WriteAppLog(oplogmsg);

	remove(softFullFileName);
 
	return 1;
}
/* ------------------------------------------------------
            更改参数状态
--------------------------------------------------------- */
void ORA::Update_Param_Status(unsigned short wMsgCode)
{
	EXEC SQL BEGIN DECLARE SECTION;
	char 		msgtype[5];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(msgtype,0x00,sizeof(msgtype));
	sprintf(msgtype,"%04X",wMsgCode);
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 1
		       WHERE  PARAMETER_STATUS = 0 AND PARAMETER_TYPE = :msgtype;
	EXEC SQL UPDATE T_PARAMETER_CTRL 
	         SET PARAMETER_STATUS = 0
		       WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :msgtype;
  EXEC SQL COMMIT;
}

/* ------------------------------------------------------
            删除参数状态为2的参数
--------------------------------------------------------- */
void ORA::Delete_Param_Status(int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          c_paraCtrlId[9];	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(c_paraCtrlId,0x00,sizeof(c_paraCtrlId));
	strcpy(c_paraCtrlId,CConfig::ms_MlcLineList[lineIndex].LINE_NID);	

	EXEC SQL SELECT PARAMETER_NBR INTO :para_pointer
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' 
	         AND PARAMETER_STATUS = 2
	         AND PARAMETER_CTRL_NID = :c_paraCtrlId;
	
	EXEC SQL DELETE FROM TBL_PM_0015_VERSION_CTRL 	WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0001_LINE 					WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0002_STATION 				WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0004_EXCHANGE 			WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0005_CUMULATE 			WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0005_TICKET 				WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0006_STATION_ZONE 	WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0007_ZONE_FARE 			WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0008_ZONE_FARE 			WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0009_SALE_FARE 			WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_000A_SOIVENIR_SALE 	WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0011_HOLIDAY 				WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0012_PEAK 					WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0013_FORM 					WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0013_MAIN 					WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0016_MAIN 					WHERE PARAMETER_NBR = :para_pointer;
	EXEC SQL DELETE FROM TBL_PM_0017_PARA 					WHERE PARAMETER_NBR = :para_pointer;		
	EXEC SQL DELETE FROM T_PARAMETER_CTRL 					WHERE PARAMETER_NBR = :para_pointer;

  EXEC SQL COMMIT;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0015(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamVer[15];			  /* ---  --- */
	char						b_ParamValidTime[15];	/* ---  --- */
	unsigned short	w_ParamType;			    /* ---  --- */
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para_0015_1        	m_Para_0015_1;
	Para_0015_2        	m_Para_0015_2;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para_0015_1,0x00,sizeof(Para_0015_1));
	m_Para_0015_1 = *(Para_0015_1 *)(recvbuf+sizeof(MsgHead));
	memset(b_ParamVer,0x00,sizeof(b_ParamVer));
	for(i=0;i<sizeof(m_Para_0015_1.b_ParamVer);i++)
		sprintf(b_ParamVer+2*i,"%02X",m_Para_0015_1.b_ParamVer[i]);
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	for(i=0;i<sizeof(m_Para_0015_1.b_ParamValidTime);i++)
		sprintf(b_ParamValidTime+2*i,"%02X",m_Para_0015_1.b_ParamValidTime[i]);
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",filename,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);	
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;		
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:b_ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::dwordtowin(m_Para_0015_1.dw_ParamRecords);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para_0015_2,0x00,sizeof(Para_0015_2));
		m_Para_0015_2 = *(Para_0015_2 *)(recvbuf + sizeof(MsgHead) + sizeof(Para_0015_1) + j * sizeof(Para_0015_2));
		w_ParamType = CommonFuncs::wordtowin(m_Para_0015_2.w_ParamType);
		memset(c_MsgCode,0x00,sizeof(c_MsgCode));
		sprintf(c_MsgCode,"%04X",w_ParamType);
		memset(b_ParamVer,0x00,sizeof(b_ParamVer));
		for(i = 0;i < sizeof(m_Para_0015_2.b_ParamVer);i++)
			sprintf(b_ParamVer+2*i,"%02X",m_Para_0015_2.b_ParamVer[i]);
		
		EXEC SQL INSERT INTO TBL_PM_0015_VERSION_CTRL (PARAMETER_NBR,PACKET_SEQ,PARA_TYPE,PARA_VERSION)
												                    VALUES(:para_pointer,:para_pointer,:c_MsgCode,:b_ParamVer);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0001_LINE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																										
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0001(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];		/* ---  --- */
	int 						PARTICIPANT_ID;		/* ---  --- */
	char            CENTER_CODE[3];		/* ---  --- */
	char          	LINE_ID[3];			/* ---  --- */
	char  					LINE_NAME_CN[41];			/* ---  --- */
	char						LINE_NAME_EN[41];		/* ---  --- */
	char						LINE_NAME_EN_SIMP[41];			/* ---  --- */
	char						UP_FIRST_TIME[7];				/* ---  --- */
	char						UP_LAST_TIME[7];				/* ---  --- */
	char						DOWN_FIRST_TIME[7];				/* ---  --- */
	char						DOWN_LAST_TIME[7];				/* ---  --- */
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0001_Head       m_Para0001_Head;
	Para0001_Record     m_Para0001_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);

	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	
	/* ---  参数头 --- */
	memset(&m_Para0001_Head,0x00,sizeof(Para0001_Head));
	m_Para0001_Head = *(Para0001_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0001_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0001_Head.ParamVer[i]);
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	EXEC SQL DELETE FROM TBL_SS_LINE_INFO;

	ParamRecords = 	CommonFuncs::wordtowin(m_Para0001_Head.Records);		
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0001_Record,0x00,sizeof(Para0001_Record));
		m_Para0001_Record = *(Para0001_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0001_Head) + j * sizeof(Para0001_Record));
		PARTICIPANT_ID = (int)m_Para0001_Record.PARTICIPANT_ID;
		memset(CENTER_CODE,0x00,sizeof(CENTER_CODE));
		sprintf(CENTER_CODE,"%02X",m_Para0001_Record.CENTER_CODE);
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Para0001_Record.LINE_ID);
		memset(temp,0x00,sizeof(temp));
		memcpy(temp,m_Para0001_Record.LINE_NAME_CN,sizeof(m_Para0001_Record.LINE_NAME_CN));
		memset(LINE_NAME_CN,0x00,sizeof(LINE_NAME_CN));
		CommonFuncs::delspace(LINE_NAME_CN,temp);
		memset(temp,0x00,sizeof(temp));
		memcpy(temp,m_Para0001_Record.LINE_NAME_EN_SIMP,sizeof(m_Para0001_Record.LINE_NAME_EN_SIMP));
		memset(LINE_NAME_EN_SIMP,0x00,sizeof(LINE_NAME_EN_SIMP));
		CommonFuncs::delspace(LINE_NAME_EN_SIMP,temp);
		memset(temp,0x00,sizeof(temp));
		memcpy(temp,m_Para0001_Record.LINE_NAME_EN,sizeof(m_Para0001_Record.LINE_NAME_EN));
		memset(LINE_NAME_EN,0x00,sizeof(LINE_NAME_EN));
		CommonFuncs::delspace(LINE_NAME_EN,temp);

		memset(UP_FIRST_TIME,0x00,sizeof(UP_FIRST_TIME));
		for(i = 0;i < sizeof(m_Para0001_Record.UP_FIRST_TIME);i++)
			sprintf(UP_FIRST_TIME+2*i,"%02X",m_Para0001_Record.UP_FIRST_TIME[i]);
		memset(UP_LAST_TIME,0x00,sizeof(UP_LAST_TIME));
		for(i = 0;i < sizeof(m_Para0001_Record.UP_LAST_TIME);i++)
			sprintf(UP_LAST_TIME+2*i,"%02X",m_Para0001_Record.UP_LAST_TIME[i]);
		memset(DOWN_FIRST_TIME,0x00,sizeof(DOWN_FIRST_TIME));
		for(i = 0;i < sizeof(m_Para0001_Record.DOWN_FIRST_TIME);i++)
			sprintf(DOWN_FIRST_TIME+2*i,"%02X",m_Para0001_Record.DOWN_FIRST_TIME[i]);
		memset(DOWN_LAST_TIME,0x00,sizeof(DOWN_LAST_TIME));
		for(i = 0;i < sizeof(m_Para0001_Record.DOWN_LAST_TIME);i++)
			sprintf(DOWN_LAST_TIME+2*i,"%02X",m_Para0001_Record.DOWN_LAST_TIME[i]);
		EXEC SQL INSERT INTO TBL_PM_0001_LINE (PARAMETER_NBR,PACKET_SEQ,PARTICIPANT_ID,CENTER_CODE,
		                                       LINE_ID,LINE_NAME_CN,LINE_NAME_EN,LINE_NAME_EN_SIMP,
		                                       UP_FIRST_TIME,UP_LAST_TIME,DOWN_FIRST_TIME,DOWN_LAST_TIME)
												            VALUES(:para_pointer,:para_pointer,:PARTICIPANT_ID,:CENTER_CODE,
		                                       :LINE_ID,:LINE_NAME_CN,:LINE_NAME_EN,:LINE_NAME_EN_SIMP,
		                                       :UP_FIRST_TIME,:UP_LAST_TIME,:DOWN_FIRST_TIME,:DOWN_LAST_TIME);

		EXEC SQL INSERT INTO TBL_SS_LINE_INFO(LINE_ID,LINE_NAME_CN,LINE_NAME_EN,LINE_NAME_EN_SIMP)
						VALUES(:LINE_ID,:LINE_NAME_CN,:LINE_NAME_EN,:LINE_NAME_EN_SIMP);
                                          
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0001_LINE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			
			return 0;
		}														
	}
	EXEC SQL COMMIT;

	free(recvbuf);
	recvbuf = NULL;

	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0002(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];					/* ---  --- */
	char						STATION_NID[5];				/* ---  --- */
	char  					STATION_NAME_CN[41];	/* ---  --- */
	char						STATION_NAME_EN[41];		/* ---  --- */
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0002_Head       m_Para0002_Head;
	Para0002_Record     m_Para0002_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0002_Head,0x00,sizeof(Para0002_Head));
	m_Para0002_Head = *(Para0002_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0002_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0002_Head.ParamVer[i]);
			
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	EXEC SQL 	DELETE FROM TBL_SS_STATION_INFO; 	
        
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0002_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0002_Record,0x00,sizeof(Para0002_Record));
		m_Para0002_Record = *(Para0002_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0002_Head) + j * sizeof(Para0002_Record));
		memset(temp,0x00,sizeof(temp));
		memcpy(temp,m_Para0002_Record.STATION_NAME_CN,sizeof(m_Para0002_Record.STATION_NAME_CN));
		memset(STATION_NAME_CN,0x00,sizeof(STATION_NAME_CN));
		CommonFuncs::delspace(STATION_NAME_CN,temp);
		memset(temp,0x00,sizeof(temp));
		memcpy(temp,m_Para0002_Record.STATION_NAME_EN,sizeof(m_Para0002_Record.STATION_NAME_EN));
		memset(STATION_NAME_EN,0x00,sizeof(STATION_NAME_EN));
		CommonFuncs::delspace(STATION_NAME_EN,temp);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Para0002_Record.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Para0002_Record.STATION_NID[i]);
		
		EXEC SQL INSERT INTO TBL_PM_0002_STATION (PARAMETER_NBR,PACKET_SEQ,STATION_NID,STATION_NAME_CN,STATION_NAME_EN)
												            VALUES(:para_pointer,:para_pointer,:STATION_NID,:STATION_NAME_CN,:STATION_NAME_EN);
		
		EXEC SQL INSERT INTO TBL_SS_STATION_INFO (LINE_ID,STATION_NID,STATION_NAME_CN,STATION_NAME_EN)
												            VALUES(SUBSTR(:STATION_NID,1,2),:STATION_NID,:STATION_NAME_CN,:STATION_NAME_EN);
         
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0002_STATION ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}														
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0004(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];					/* ---  --- */
	
	char						STATION_NID[5];			
	char  					ORIG_LINE_ID[3];		
	char						DEST_LINE_ID[3];	
	unsigned short 	EXCHANGE_TIME;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0004_Head       m_Para0004_Head;
	Para0004_Record     m_Para0004_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0004_Head,0x00,sizeof(Para0004_Head));
	m_Para0004_Head = *(Para0004_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0004_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0004_Head.ParamVer[i]);
			
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0004_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0004_Record,0x00,sizeof(Para0004_Record));
		m_Para0004_Record = *(Para0004_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0004_Head) + j * sizeof(Para0004_Record));
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Para0004_Record.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Para0004_Record.STATION_NID[i]);
		memset(ORIG_LINE_ID,0x00,sizeof(ORIG_LINE_ID));
		sprintf(ORIG_LINE_ID,"%02X",m_Para0004_Record.ORIG_LINE_ID);
		memset(DEST_LINE_ID,0x00,sizeof(DEST_LINE_ID));
		sprintf(DEST_LINE_ID,"%02X",m_Para0004_Record.DEST_LINE_ID);
		EXCHANGE_TIME = CommonFuncs::wordtowin(m_Para0004_Record.EXCHANGE_TIME);
		
		EXEC SQL INSERT INTO TBL_PM_0004_EXCHANGE (PARAMETER_NBR,PACKET_SEQ,STATION_NID,ORIG_LINE_ID,DEST_LINE_ID,EXCHANGE_TIME)
												                VALUES(:para_pointer,:para_pointer,:STATION_NID,:ORIG_LINE_ID,:DEST_LINE_ID,:EXCHANGE_TIME);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0004_EXCHANGE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}														
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0005(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;		
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];
	char						ParamVer[15];		
	
	char						TICKET_TYPE[5];	
	char						TICKET_NAME[51];	
	char						TICKET_CLASS[3];	
	char						NORMAL_VALUE[3];	
	char						HOLIDAY_VALUE[3];	
	char						WEEKEND_VALUE[3];	
	char						PRAK_VALUE[3];	
	char						CTRL_BITMAP1[3];	
	char						CTRL_BITMAP2[3];	
	char						CTRL_BITMAP3[3];	
	char						CTRL_BITMAP4[3];	
	unsigned int		REFUND_MAX_VALUE;		
	char						LIGHT_INDEX[3];
	int 						i_MAX_COUNT_PER_DAY;
	unsigned short	INOUT_MAX_PERIOD;		
	unsigned int		MAX_OVERDRAFT;	
	unsigned short	FREE_IN_UPDATE_MAX_PERIOD;		
	unsigned short	FREE_OUT_UPDATE_MAX_PERIOD;		
	char						VALID_TYPE[3];	
	unsigned int		VALID_VALUE;	
	int						  i_VALID_PRE_DAYS;	
	char 						VALID_START_DATE[9];
	char 						VALIE_END_DATE[9];
	unsigned int		DISCOUNT_PERCENT;		
	unsigned int		DISCOUNT_VALUE;		
	unsigned int		MIN_VALUE;		
	unsigned int		MAX_VALUE;		
	unsigned int		LOAD_MIN_VLAUE;			
	unsigned int		LOAD_MAX_VALUE;	
	unsigned int		INIT_SALE_DISCOUNT;		
	unsigned int		LOAD_VALUE;		
	unsigned int		LOAD_COUNT;		
	unsigned int		DEPOSIT;		
	unsigned int		REFUND_FEE;		
	unsigned int		CHANGE_TICKET_FEE;		
	unsigned int		LOST_PENALTY;		
	unsigned int		DAMAGE_PENALTY;		
	unsigned int		TIMEOUT_PENALTY;		
	unsigned int		IN_UPDATE_VALUE;		
	unsigned int		OUT_UPDATE_VALUE;		
	char						VALUE_TYPE[3];
	char						AWARD_MODE[3];
	int 						i_UNITED_AWARD_INDUSTRY;		
	unsigned short	UNITED_AWARD_PERIOD;	
	char						UNITED_AWARD_TYPE[3];		
	unsigned int		UNITED_AWARD_VALUE;	
	char						CUMULATE_AWARD_TYPE[8];	
	char						CUMULATE_TYPE[3];	
	
	unsigned int		CUMULATE_VALUE;			
	unsigned int		CUMULATE_AWARD_VALUE;	

	unsigned int		INOUT_VALUE;	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0005_Head       m_Para0005_Head;
	Para0005_Record_1   m_Para0005_Record_1;
	Para0005_Record_2   m_Para0005_Record_2;
	Para0005_Record_3   m_Para0005_Record_3;
	unsigned int      	ParamRecords_1,ParamRecords_2;
	int               	i,j,k;
	unsigned char       *recvbuf,*p;
	struct stat         buf;
	int                 buflen,readlen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0005_Head,0x00,sizeof(Para0005_Head));
	m_Para0005_Head = *(Para0005_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0005_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0005_Head.ParamVer[i]);
			
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
		
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	EXEC SQL 	DELETE FROM TBL_SS_TICKET_TYPE;
 
	p = recvbuf + sizeof(MsgHead) + sizeof(Para0005_Head);			
	readlen = 0;		
	ParamRecords_1 = 	CommonFuncs::wordtowin(m_Para0005_Head.Records);				
	for(j=0;j<ParamRecords_1;j++)
	{
		memset(&m_Para0005_Record_1,0x00,sizeof(Para0005_Record_1));
		m_Para0005_Record_1 = *(Para0005_Record_1 *)(p+readlen);
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Para0005_Record_1.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Para0005_Record_1.TICKET_TYPE[i]);
		memset(TICKET_NAME,0x00,sizeof(TICKET_NAME));
		memcpy(TICKET_NAME,m_Para0005_Record_1.TICKET_NAME,sizeof(m_Para0005_Record_1.TICKET_NAME));
		memset(TICKET_CLASS,0x00,sizeof(TICKET_CLASS));
		sprintf(TICKET_CLASS,"%02X",m_Para0005_Record_1.TICKET_CLASS);
		memset(NORMAL_VALUE,0x00,sizeof(NORMAL_VALUE));
		sprintf(NORMAL_VALUE,"%02X",m_Para0005_Record_1.NORMAL_VALUE);
		memset(HOLIDAY_VALUE,0x00,sizeof(HOLIDAY_VALUE));
		sprintf(HOLIDAY_VALUE,"%02X",m_Para0005_Record_1.HOLIDAY_VALUE);
		memset(WEEKEND_VALUE,0x00,sizeof(WEEKEND_VALUE));
		sprintf(WEEKEND_VALUE,"%02X",m_Para0005_Record_1.WEEKEND_VALUE);
		memset(PRAK_VALUE,0x00,sizeof(PRAK_VALUE));
		sprintf(PRAK_VALUE,"%02X",m_Para0005_Record_1.PRAK_VALUE);
		memset(CTRL_BITMAP1,0x00,sizeof(CTRL_BITMAP1));
		sprintf(CTRL_BITMAP1,"%02X",m_Para0005_Record_1.CTRL_BITMAP1);
		memset(CTRL_BITMAP2,0x00,sizeof(CTRL_BITMAP2));
		sprintf(CTRL_BITMAP2,"%02X",m_Para0005_Record_1.CTRL_BITMAP2);
		memset(CTRL_BITMAP3,0x00,sizeof(CTRL_BITMAP3));
		sprintf(CTRL_BITMAP3,"%02X",m_Para0005_Record_1.CTRL_BITMAP3);
		memset(CTRL_BITMAP4,0x00,sizeof(CTRL_BITMAP4));
		sprintf(CTRL_BITMAP4,"%02X",m_Para0005_Record_1.CTRL_BITMAP4);
		REFUND_MAX_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.REFUND_MAX_VALUE);
		memset(LIGHT_INDEX,0x00,sizeof(LIGHT_INDEX));
		sprintf(LIGHT_INDEX,"%02X",m_Para0005_Record_1.LIGHT_INDEX);
		i_MAX_COUNT_PER_DAY = (int)m_Para0005_Record_1.i_MAX_COUNT_PER_DAY;
		INOUT_MAX_PERIOD = CommonFuncs::wordtowin(m_Para0005_Record_1.INOUT_MAX_PERIOD);
		MAX_OVERDRAFT = CommonFuncs::dwordtowin(m_Para0005_Record_1.MAX_OVERDRAFT);
		FREE_IN_UPDATE_MAX_PERIOD = CommonFuncs::wordtowin(m_Para0005_Record_1.FREE_IN_UPDATE_MAX_PERIOD);
		FREE_OUT_UPDATE_MAX_PERIOD = CommonFuncs::wordtowin(m_Para0005_Record_1.FREE_OUT_UPDATE_MAX_PERIOD);
		memset(VALID_TYPE,0x00,sizeof(VALID_TYPE));
		sprintf(VALID_TYPE,"%02X",m_Para0005_Record_1.VALID_TYPE);
		VALID_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.VALID_VALUE);
		i_VALID_PRE_DAYS = (int)m_Para0005_Record_1.i_VALID_PRE_DAYS;
		memset(VALID_START_DATE,0x00,sizeof(VALID_START_DATE));
		for(i = 0;i < sizeof(m_Para0005_Record_1.VALID_START_DATE);i++)
			sprintf(VALID_START_DATE+2*i,"%02X",m_Para0005_Record_1.VALID_START_DATE[i]);
		memset(VALIE_END_DATE,0x00,sizeof(VALIE_END_DATE));
		for(i = 0;i < sizeof(m_Para0005_Record_1.VALIE_END_DATE);i++)
			sprintf(VALIE_END_DATE+2*i,"%02X",m_Para0005_Record_1.VALIE_END_DATE[i]);
		DISCOUNT_PERCENT = CommonFuncs::dwordtowin(m_Para0005_Record_1.DISCOUNT_PERCENT);
		DISCOUNT_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.DISCOUNT_VALUE);
		MIN_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.MIN_VALUE);
		MAX_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.MAX_VALUE);
		LOAD_MIN_VLAUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.LOAD_MIN_VLAUE);
		LOAD_MAX_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.LOAD_MAX_VALUE);
		INIT_SALE_DISCOUNT = CommonFuncs::dwordtowin(m_Para0005_Record_1.INIT_SALE_DISCOUNT);
		LOAD_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.LOAD_VALUE);
		LOAD_COUNT = CommonFuncs::dwordtowin(m_Para0005_Record_1.LOAD_COUNT);
		DEPOSIT = CommonFuncs::dwordtowin(m_Para0005_Record_1.DEPOSIT);
		REFUND_FEE = CommonFuncs::dwordtowin(m_Para0005_Record_1.REFUND_FEE);
		CHANGE_TICKET_FEE = CommonFuncs::dwordtowin(m_Para0005_Record_1.CHANGE_TICKET_FEE);
		LOST_PENALTY = CommonFuncs::dwordtowin(m_Para0005_Record_1.LOST_PENALTY);
		DAMAGE_PENALTY = CommonFuncs::dwordtowin(m_Para0005_Record_1.DAMAGE_PENALTY);
		TIMEOUT_PENALTY = CommonFuncs::dwordtowin(m_Para0005_Record_1.TIMEOUT_PENALTY);
		IN_UPDATE_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.IN_UPDATE_VALUE);
		OUT_UPDATE_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.OUT_UPDATE_VALUE);
		memset(VALUE_TYPE,0x00,sizeof(VALUE_TYPE));
		sprintf(VALUE_TYPE,"%02X",m_Para0005_Record_1.VALUE_TYPE);
		memset(AWARD_MODE,0x00,sizeof(AWARD_MODE));
		sprintf(AWARD_MODE,"%02X",m_Para0005_Record_1.AWARD_MODE);
		i_UNITED_AWARD_INDUSTRY = (int)m_Para0005_Record_1.i_UNITED_AWARD_INDUSTRY;
		UNITED_AWARD_PERIOD = CommonFuncs::wordtowin(m_Para0005_Record_1.UNITED_AWARD_PERIOD);
		memset(UNITED_AWARD_TYPE,0x00,sizeof(UNITED_AWARD_TYPE));
		sprintf(UNITED_AWARD_TYPE,"%02X",m_Para0005_Record_1.UNITED_AWARD_TYPE);
		UNITED_AWARD_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_1.UNITED_AWARD_VALUE);
		memset(CUMULATE_AWARD_TYPE,0x00,sizeof(CUMULATE_AWARD_TYPE));
		sprintf(CUMULATE_AWARD_TYPE,"%02X",m_Para0005_Record_1.CUMULATE_AWARD_TYPE);
		memset(CUMULATE_TYPE,0x00,sizeof(CUMULATE_TYPE));
		sprintf(CUMULATE_TYPE,"%02X",m_Para0005_Record_1.CUMULATE_TYPE);
		ParamRecords_2 = CommonFuncs::wordtowin(m_Para0005_Record_1.Records);
		for(k=0;k<ParamRecords_2;k++)
		{
			memset(&m_Para0005_Record_2,0x00,sizeof(Para0005_Record_2));
			m_Para0005_Record_2  = *(Para0005_Record_2 *)(p+readlen+sizeof(Para0005_Record_1)+k*sizeof(Para0005_Record_2));
			CUMULATE_VALUE       = CommonFuncs::dwordtowin(m_Para0005_Record_2.CUMULATE_VALUE);
			CUMULATE_AWARD_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_2.CUMULATE_AWARD_VALUE);
			EXEC SQL INSERT INTO TBL_PM_0005_CUMULATE (PARAMETER_NBR,PACKET_SEQ,TICKET_TYPE,CUMULATE_VALUE,CUMULATE_AWARD_VALUE)
												                 VALUES(:para_pointer,:para_pointer,:TICKET_TYPE,:CUMULATE_VALUE,:CUMULATE_AWARD_VALUE);
			if(sqlca.sqlcode !=0 )
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"%s:TBL_PM_0005_CUMULATE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				EXEC SQL ROLLBACK;
				free(recvbuf);
				recvbuf = NULL;
				return 0;
			}
		}
		memset(&m_Para0005_Record_3,0x00,sizeof(Para0005_Record_3));
		m_Para0005_Record_3  = *(Para0005_Record_3 *)(p+readlen+sizeof(Para0005_Record_1)+ParamRecords_2*sizeof(Para0005_Record_2));
		INOUT_VALUE = CommonFuncs::dwordtowin(m_Para0005_Record_3.INOUT_VALUE);  
		EXEC SQL INSERT INTO TBL_PM_0005_TICKET (PARAMETER_NBR,PACKET_SEQ,TICKET_TYPE,TICKET_NAME,TICKET_CLASS,
                                              NORMAL_VALUE,HOLIDAY_VALUE,WEEKEND_VALUE,PRAK_VALUE,CTRL_BITMAP1,
                                              CTRL_BITMAP2,CTRL_BITMAP3,CTRL_BITMAP4,REFUND_MAX_VALUE,LIGHT_INDEX,
                                              MAX_COUNT_PER_DAY,INOUT_MAX_PERIOD,MAX_OVERDRAFT,FREE_IN_UPDATE_MAX_PERIOD,FREE_OUT_UPDATE_MAX_PERIOD,
                                              VALID_TYPE,VALID_VALUE,VALID_PRE_DAYS,VALID_START_DATE,VALIE_END_DATE,
                                              DISCOUNT_PERCENT,DISCOUNT_VALUE,MIN_VALUE,MAX_VALUE,LOAD_MIN_VLAUE,
                                              LOAD_MAX_VALUE,INIT_SALE_DISCOUNT,LOAD_VALUE,LOAD_COUNT,DEPOSIT,
                                              REFUND_FEE,CHANGE_TICKET_FEE,LOST_PENALTY,DAMAGE_PENALTY,TIMEOUT_PENALTY,
                                              IN_UPDATE_VALUE,OUT_UPDATE_VALUE,VALUE_TYPE,AWARD_MODE,UNITED_AWARD_INDUSTRY,
                                              UNITED_AWARD_PERIOD,UNITED_AWARD_TYPE,UNITED_AWARD_VALUE,CUMULATE_TYPE,
                                              INOUT_VALUE)
												               VALUES(:para_pointer,:para_pointer,:TICKET_TYPE,:TICKET_NAME,:TICKET_CLASS,
                                              :NORMAL_VALUE,:HOLIDAY_VALUE,:WEEKEND_VALUE,:PRAK_VALUE,:CTRL_BITMAP1,
                                              :CTRL_BITMAP2,:CTRL_BITMAP3,:CTRL_BITMAP4,:REFUND_MAX_VALUE,:LIGHT_INDEX,
                                              :i_MAX_COUNT_PER_DAY,:INOUT_MAX_PERIOD,:MAX_OVERDRAFT,:FREE_IN_UPDATE_MAX_PERIOD,:FREE_OUT_UPDATE_MAX_PERIOD,
                                              :VALID_TYPE,:VALID_VALUE,:i_VALID_PRE_DAYS,:VALID_START_DATE,:VALIE_END_DATE,
                                              :DISCOUNT_PERCENT,:DISCOUNT_VALUE,:MIN_VALUE,:MAX_VALUE,:LOAD_MIN_VLAUE,
                                              :LOAD_MAX_VALUE,:INIT_SALE_DISCOUNT,:LOAD_VALUE,:LOAD_COUNT,:DEPOSIT,
                                              :REFUND_FEE,:CHANGE_TICKET_FEE,:LOST_PENALTY,:DAMAGE_PENALTY,:TIMEOUT_PENALTY,
                                              :IN_UPDATE_VALUE,:OUT_UPDATE_VALUE,:VALUE_TYPE,:AWARD_MODE,:i_UNITED_AWARD_INDUSTRY,
                                              :UNITED_AWARD_PERIOD,:UNITED_AWARD_TYPE,:UNITED_AWARD_VALUE,:CUMULATE_TYPE,
                                              :INOUT_VALUE);
                                              
    EXEC SQL INSERT INTO TBL_SS_TICKET_TYPE(TICKET_TYPE,TICKET_NAME,TICKET_CLASS)
   												 VALUES(:TICKET_TYPE,:TICKET_NAME,:TICKET_CLASS);
 
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0005_TICKET ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}
		/* ---  下条记录 --- */										               
		readlen = readlen + sizeof(Para0005_Record_1) + ParamRecords_2*sizeof(Para0005_Record_2) + sizeof(Para0005_Record_3);
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0006(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];		/* ---  --- */
	
	char						ORIG_STATION_NID[5];	
	char						DESC_STATION_NID[5];	
	int 						FARE_ZONE_CODE;		
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0006_Head       m_Para0006_Head;
	Para0006_Record     m_Para0006_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0006_Head,0x00,sizeof(Para0006_Head));
	m_Para0006_Head = *(Para0006_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0006_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0006_Head.ParamVer[i]);
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::dwordtowin(m_Para0006_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0006_Record,0x00,sizeof(Para0006_Record));
		m_Para0006_Record = *(Para0006_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0006_Head) + j * sizeof(Para0006_Record));
		memset(ORIG_STATION_NID,0x00,sizeof(ORIG_STATION_NID));
		for(i = 0;i < sizeof(m_Para0006_Record.ORIG_STATION_NID);i++)
			sprintf(ORIG_STATION_NID+2*i,"%02X",m_Para0006_Record.ORIG_STATION_NID[i]);
		memset(DESC_STATION_NID,0x00,sizeof(DESC_STATION_NID));
		for(i = 0;i < sizeof(m_Para0006_Record.DESC_STATION_NID);i++)
			sprintf(DESC_STATION_NID+2*i,"%02X",m_Para0006_Record.DESC_STATION_NID[i]);
		FARE_ZONE_CODE = (int)m_Para0006_Record.FARE_ZONE_CODE;
		EXEC SQL INSERT INTO TBL_PM_0006_STATION_ZONE (PARAMETER_NBR,PACKET_SEQ,ORIG_STATION_NID,DESC_STATION_NID,FARE_ZONE_CODE)
												                   VALUES(:para_pointer,:para_pointer,:ORIG_STATION_NID,:DESC_STATION_NID,:FARE_ZONE_CODE);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0006_STATION_ZONE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0007(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];		/* ---  --- */
	
	int							ZONE_CODE;	
	char						ZONE_NAME[16];	
	unsigned short	FARE_VALUE_1;		
	unsigned short	FARE_VALUE_2;		
	unsigned short	FARE_VALUE_3;		
	unsigned short	FARE_VALUE_4;		
	unsigned short	FARE_VALUE_5;		
	unsigned short	FARE_VALUE_6;		
	unsigned short	FARE_VALUE_7;		
	unsigned short	FARE_VALUE_8;		
	unsigned short	FARE_VALUE_9;		
	unsigned short	FARE_VALUE_10;		
	unsigned short	FARE_VALUE_11;		
	unsigned short	FARE_VALUE_12;		
	unsigned short	FARE_VALUE_13;		
	unsigned short	FARE_VALUE_14;		
	unsigned short	FARE_VALUE_15;		
	unsigned short	FARE_VALUE_16;			
	unsigned short	STRANDED_MAX_PERIOD;	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0007_Head       m_Para0007_Head;
	Para0007_Record     m_Para0007_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0007_Head,0x00,sizeof(Para0007_Head));
	m_Para0007_Head = *(Para0007_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0007_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0007_Head.ParamVer[i]);
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0007_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0007_Record,0x00,sizeof(Para0007_Record));
		m_Para0007_Record = *(Para0007_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0007_Head) + j * sizeof(Para0007_Record));
		ZONE_CODE = (int)m_Para0007_Record.ZONE_CODE;
		memset(ZONE_NAME,0x00,sizeof(ZONE_NAME));
		memcpy(ZONE_NAME,m_Para0007_Record.ZONE_NAME,sizeof(m_Para0007_Record.ZONE_NAME));
		FARE_VALUE_1 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_1);
		FARE_VALUE_2 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_2);
		FARE_VALUE_3 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_3);
		FARE_VALUE_4 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_4);
		FARE_VALUE_5 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_5);
		FARE_VALUE_6 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_6);
		FARE_VALUE_7 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_7);
		FARE_VALUE_8 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_8);
		FARE_VALUE_9 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_9);
		FARE_VALUE_10 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_10);
		FARE_VALUE_11 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_11);
		FARE_VALUE_12 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_12);
		FARE_VALUE_13 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_13);
		FARE_VALUE_14 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_14);
		FARE_VALUE_15 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_15);
		FARE_VALUE_16 = CommonFuncs::wordtowin(m_Para0007_Record.FARE_VALUE_16);
		STRANDED_MAX_PERIOD = CommonFuncs::wordtowin(m_Para0007_Record.STRANDED_MAX_PERIOD);
		EXEC SQL INSERT INTO TBL_PM_0007_ZONE_FARE (PARAMETER_NBR,PACKET_SEQ,ZONE_CODE,ZONE_NAME,
                                                FARE_VALUE_1,FARE_VALUE_2,FARE_VALUE_3,FARE_VALUE_4,
                                                FARE_VALUE_5,FARE_VALUE_6,FARE_VALUE_7,FARE_VALUE_8,
                                                FARE_VALUE_9,FARE_VALUE_10,FARE_VALUE_11,FARE_VALUE_12,
                                                FARE_VALUE_13,FARE_VALUE_14,FARE_VALUE_15,FARE_VALUE_16,
                                                STRANDED_MAX_PERIOD)
												                   VALUES(:para_pointer,:para_pointer,:ZONE_CODE,:ZONE_NAME,
												                          :FARE_VALUE_1,:FARE_VALUE_2,:FARE_VALUE_3,:FARE_VALUE_4,
                                                	:FARE_VALUE_5,:FARE_VALUE_6,:FARE_VALUE_7,:FARE_VALUE_8,
                                                	:FARE_VALUE_9,:FARE_VALUE_10,:FARE_VALUE_11,:FARE_VALUE_12,
                                                	:FARE_VALUE_13,:FARE_VALUE_14,:FARE_VALUE_15,:FARE_VALUE_16,
												                          :STRANDED_MAX_PERIOD);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0007_ZONE_FARE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																										
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0008(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;		
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];
	char						ParamVer[15];		
	
	int							ZONE_CODE;			
	char						TICKET_TYPE[5];
	
	unsigned short	RIDES;			
	unsigned short	SALE_VALUE;	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0008_Head       m_Para0008_Head;
	Para0008_Record_1   m_Para0008_Record_1;
	Para0008_Record_2   m_Para0008_Record_2;
	unsigned int      	ParamRecords_1,ParamRecords_2;
	int               	i,j,k;
	unsigned char       *recvbuf,*p;
	struct stat         buf;
	int                 buflen,readlen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0008_Head,0x00,sizeof(Para0008_Head));
	m_Para0008_Head = *(Para0008_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0008_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0008_Head.ParamVer[i]);
			
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
		
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	p = recvbuf + sizeof(MsgHead) + sizeof(Para0008_Head);			
	readlen = 0;		
	ParamRecords_1 = 	CommonFuncs::wordtowin(m_Para0008_Head.Records);				
	for(j=0;j<ParamRecords_1;j++)
	{
		memset(&m_Para0008_Record_1,0x00,sizeof(Para0008_Record_1));
		m_Para0008_Record_1 = *(Para0008_Record_1 *)(p+readlen);
		ZONE_CODE = (int)m_Para0008_Record_1.ZONE_CODE;
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Para0008_Record_1.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Para0008_Record_1.TICKET_TYPE[i]);
		ParamRecords_2 = CommonFuncs::wordtowin(m_Para0008_Record_1.Records);
		for(k=0;k<ParamRecords_2;k++)
		{
			memset(&m_Para0008_Record_2,0x00,sizeof(Para0008_Record_2));
			m_Para0008_Record_2  = *(Para0008_Record_2 *)(p+readlen+sizeof(Para0008_Record_1)+k*sizeof(Para0008_Record_2));
			RIDES       = CommonFuncs::wordtowin(m_Para0008_Record_2.RIDES);
			SALE_VALUE  = CommonFuncs::wordtowin(m_Para0008_Record_2.SALE_VALUE);
			EXEC SQL INSERT INTO TBL_PM_0008_ZONE_FARE(PARAMETER_NBR,PACKET_SEQ,   ZONE_CODE, TICKET_TYPE, COUNT, SALE_VALUE)
												                  VALUES(:para_pointer,:para_pointer,:ZONE_CODE,:TICKET_TYPE,:RIDES,:SALE_VALUE);
			if(sqlca.sqlcode !=0 )
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"%s:TBL_PM_0008_ZONE_FARE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				EXEC SQL ROLLBACK;
				free(recvbuf);
				recvbuf = NULL;
				return 0;
			}
		}
		/* ---  下条记录 --- */										               
		readlen = readlen + sizeof(Para0008_Record_1) + ParamRecords_2*sizeof(Para0008_Record_2);
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0009(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];		/* ---  --- */
	
	int							ZONE_CODE;			
	char						TICKET_TYPE[5];
	unsigned short  SALE_VALUE;	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0009_Head       m_Para0009_Head;
	Para0009_Record     m_Para0009_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0009_Head,0x00,sizeof(Para0009_Head));
	m_Para0009_Head = *(Para0009_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0009_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0009_Head.ParamVer[i]);
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0009_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0009_Record,0x00,sizeof(Para0009_Record));
		m_Para0009_Record = *(Para0009_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0009_Head) + j * sizeof(Para0009_Record));
		ZONE_CODE = (int)m_Para0009_Record.ZONE_CODE;
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Para0009_Record.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Para0009_Record.TICKET_TYPE[i]);
		SALE_VALUE = CommonFuncs::wordtowin(m_Para0009_Record.SALE_VALUE);
		EXEC SQL INSERT INTO TBL_PM_0009_SALE_FARE (PARAMETER_NBR,PACKET_SEQ,ZONE_CODE,TICKET_TYPE,SALE_VALUE)
												                 VALUES(:para_pointer,:para_pointer,:ZONE_CODE,:TICKET_TYPE,:SALE_VALUE);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0009_SALE_FARE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_000A(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];		/* ---  --- */
	
	char						TICKET_TYPE[5];			
	char						START_TICKET_NO[11];
	char						END_TICKET_NO[11];
	unsigned short  SALE_VALUE;
	char            MEMO[101];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para000A_Head       m_Para000A_Head;
	Para000A_Record     m_Para000A_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para000A_Head,0x00,sizeof(Para000A_Head));
	m_Para000A_Head = *(Para000A_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para000A_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para000A_Head.ParamVer[i]);
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para000A_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para000A_Record,0x00,sizeof(Para000A_Record));
		m_Para000A_Record = *(Para000A_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para000A_Head) + j * sizeof(Para000A_Record));
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Para000A_Record.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Para000A_Record.TICKET_TYPE[i]);
		memset(START_TICKET_NO,0x00,sizeof(START_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000A_Record.START_TICKET_NO);i++)
			sprintf(START_TICKET_NO+2*i,"%02X",m_Para000A_Record.START_TICKET_NO[i]);
		memset(END_TICKET_NO,0x00,sizeof(END_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000A_Record.END_TICKET_NO);i++)
			sprintf(END_TICKET_NO+2*i,"%02X",m_Para000A_Record.END_TICKET_NO[i]);
		SALE_VALUE = CommonFuncs::wordtowin(m_Para000A_Record.SALE_VALUE);
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Para000A_Record.MEMO,sizeof(m_Para000A_Record.MEMO));
		EXEC SQL INSERT INTO TBL_PM_000A_SOIVENIR_SALE (PARAMETER_NBR,PACKET_SEQ,TICKET_TYPE,START_TICKET_NO,END_TICKET_NO,SALE_VALUE,MEMO)
												                 VALUES(:para_pointer,:para_pointer,:TICKET_TYPE,:START_TICKET_NO,:END_TICKET_NO,:SALE_VALUE,:MEMO);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000A_SOIVENIR_SALE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0011(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];					/* ---  --- */
	
	char						HOLIDAY_DATE[9];			
	int   					HOLIDAY_TYPE;		
	unsigned short 	EXCHANGE_TIME;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0011_Head       m_Para0011_Head;
	Para0011_Record     m_Para0011_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0011_Head,0x00,sizeof(Para0011_Head));
	m_Para0011_Head = *(Para0011_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0011_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0011_Head.ParamVer[i]);
			
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0011_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0011_Record,0x00,sizeof(Para0011_Record));
		m_Para0011_Record = *(Para0011_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0011_Head) + j * sizeof(Para0011_Record));
		memset(HOLIDAY_DATE,0x00,sizeof(HOLIDAY_DATE));
		for(i = 0;i < sizeof(m_Para0011_Record.HOLIDAY_DATE);i++)
			sprintf(HOLIDAY_DATE+2*i,"%02X",m_Para0011_Record.HOLIDAY_DATE[i]);
		HOLIDAY_TYPE = (int)m_Para0011_Record.HOLIDAY_TYPE;
		
		EXEC SQL INSERT INTO TBL_PM_0011_HOLIDAY (PARAMETER_NBR,PACKET_SEQ,HOLIDAY_DATE,HOLIDAY_TYPE)
												                VALUES(:para_pointer,:para_pointer,:HOLIDAY_DATE,:HOLIDAY_TYPE);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0011_HOLIDAY ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}														
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0012(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];					/* ---  --- */
	
	char						START_TIME[7];		
	char						END_TIME[7];	
	unsigned short 	EXCHANGE_TIME;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0012_Head       m_Para0012_Head;
	Para0012_Record     m_Para0012_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0012_Head,0x00,sizeof(Para0012_Head));
	m_Para0012_Head = *(Para0012_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0012_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0012_Head.ParamVer[i]);
			
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0012_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0012_Record,0x00,sizeof(Para0012_Record));
		m_Para0012_Record = *(Para0012_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0012_Head) + j * sizeof(Para0012_Record));
		memset(START_TIME,0x00,sizeof(START_TIME));
		for(i = 0;i < sizeof(m_Para0012_Record.START_TIME);i++)
			sprintf(START_TIME+2*i,"%02X",m_Para0012_Record.START_TIME[i]);
		memset(END_TIME,0x00,sizeof(END_TIME));
		for(i = 0;i < sizeof(m_Para0012_Record.END_TIME);i++)
			sprintf(END_TIME+2*i,"%02X",m_Para0012_Record.END_TIME[i]);
		
		EXEC SQL INSERT INTO TBL_PM_0012_PEAK (PARAMETER_NBR,PACKET_SEQ,START_TIME,END_TIME)
												                VALUES(:para_pointer,:para_pointer,:START_TIME,:END_TIME);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0012_PEAK ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}														
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0013(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];		/* ---  --- */
	
	char						LINE_ID[3];				
	int   					LANG_VER;			
	unsigned int		PIC_LENGTH;
	
	char						NODE_TYPE[3];			
	char  					NODE_ID[3];		
	char  					NODE_PROPERTIE[5];	
	unsigned int		X_POINT;
	unsigned int		Y_POINT;
	unsigned int		BUTTON_WIDTH;
	unsigned int		BUTTON_HEIGHT;
	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0013_Head       m_Para0013_Head;
	Para0013_Record_1   m_Para0013_Record_1;
	Para0013_Record_2   m_Para0013_Record_2;
	Para0013_Record_3   m_Para0013_Record_3;
	int      						Records_1,Records_2;
	int               	i,j,k;
	unsigned char       *recvbuf,*p;
	struct stat         buf;
	int                 buflen,readlen;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0013_Head,0x00,sizeof(Para0013_Head));
	m_Para0013_Head = *(Para0013_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0013_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0013_Head.ParamVer[i]);
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	/* ---  参数体 --- */
	p = recvbuf + sizeof(MsgHead) + sizeof(Para0013_Head);			
	readlen = 0;		
	Records_1 = (int)m_Para0013_Head.Records_1;			
	for(j=0;j<Records_1;j++)
	{
		memset(&m_Para0013_Record_1,0x00,sizeof(Para0013_Record_1));
		m_Para0013_Record_1 = *(Para0013_Record_1 *)(p+readlen);
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Para0013_Record_1.LINE_ID);
		LANG_VER = (int)m_Para0013_Record_1.LANG_VER;
		PIC_LENGTH = CommonFuncs::dwordtowin(m_Para0013_Record_1.PIC_LENGTH);
		readlen = readlen + sizeof(Para0013_Record_1) + PIC_LENGTH;
		EXEC SQL INSERT INTO TBL_PM_0013_MAIN (PARAMETER_NBR,PACKET_SEQ,LINE_ID,LANG_VER,PIC_LENGTH)
												            VALUES(:para_pointer,:para_pointer,:LINE_ID,:LANG_VER,:PIC_LENGTH);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0013_MAIN ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}
		
		memset(&m_Para0013_Record_2,0x00,sizeof(Para0013_Record_2));
		m_Para0013_Record_2 = *(Para0013_Record_2 *)(p+readlen);
		readlen = readlen + sizeof(Para0013_Record_2);
		
		Records_2 = CommonFuncs::dwordtowin(m_Para0013_Record_2.Records_2);
		for(k=0;k<Records_2;k++)
		{
			memset(&m_Para0013_Record_3,0x00,sizeof(Para0013_Record_3));
			m_Para0013_Record_3  = *(Para0013_Record_3 *)(p+readlen);
			memset(NODE_TYPE,0x00,sizeof(NODE_TYPE));
			sprintf(NODE_TYPE,"%02X",m_Para0013_Record_3.NODE_TYPE);
			memset(NODE_ID,0x00,sizeof(NODE_ID));
			sprintf(NODE_ID,"%02X",m_Para0013_Record_3.NODE_ID);
			memset(NODE_PROPERTIE,0x00,sizeof(NODE_PROPERTIE));
			for(i=0;i<sizeof(m_Para0013_Record_3.NODE_PROPERTIE);i++)
				sprintf(NODE_PROPERTIE+2*i,"%02X",m_Para0013_Record_3.NODE_PROPERTIE[i]);
			X_POINT       = CommonFuncs::dwordtowin(m_Para0013_Record_3.X_POINT);
			Y_POINT 			= CommonFuncs::dwordtowin(m_Para0013_Record_3.Y_POINT);
			BUTTON_WIDTH  = CommonFuncs::dwordtowin(m_Para0013_Record_3.BUTTON_WIDTH);
			BUTTON_HEIGHT = CommonFuncs::dwordtowin(m_Para0013_Record_3.BUTTON_HEIGHT);
			readlen = readlen + sizeof(Para0013_Record_3);
			EXEC SQL INSERT INTO TBL_PM_0013_FORM (PARAMETER_NBR,PACKET_SEQ,LINE_ID,NODE_TYPE,
			                                       NODE_ID,NODE_PROPERTIE,X_POINT,Y_POINT,
			                                       BUTTON_WIDTH,BUTTON_HEIGHT)
												              VALUES(:para_pointer,:para_pointer,:LINE_ID,:NODE_TYPE,
			                                       :NODE_ID,:NODE_PROPERTIE,:X_POINT,:Y_POINT,
			                                       :BUTTON_WIDTH,:BUTTON_HEIGHT);
			if(sqlca.sqlcode !=0 )
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"%s:TBL_PM_0013_FORM ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				EXEC SQL ROLLBACK;
				free(recvbuf);
				recvbuf = NULL;
				return 0;
			}
		}
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0016(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];
	char						ParamVer[15];
	char						SoftVersion[25];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0016_Head       m_Para0016_Head;
	int               	i;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	
	/* ---  参数头 --- */
	memset(&m_Para0016_Head,0x00,sizeof(Para0016_Head));
	m_Para0016_Head = *(Para0016_Head *)(recvbuf+sizeof(MsgHead));
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0016_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0016_Head.ParamVer[i]);
	
	memset(SoftVersion,0x00,sizeof(SoftVersion));
	memcpy(SoftVersion,m_Para0016_Head.SoftVersion,sizeof(m_Para0016_Head.SoftVersion));	
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	EXEC SQL INSERT INTO TBL_PM_0016_MAIN (PARAMETER_NBR,PACKET_SEQ,CRW_MAIN_VERSION)
											            VALUES(:para_pointer,:para_pointer,:SoftVersion);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:TBL_PM_0016_MAIN ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
	
		EXEC SQL ROLLBACK;
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}												
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
	return 1;
}



/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0017(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];
	char						ParamVer[15];
	int 						FILE_NBR;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0017_Head       m_Para0017_Head;
	int               	i;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	
	/* ---  参数头 --- */
	memset(&m_Para0017_Head,0x00,sizeof(Para0017_Head));
	m_Para0017_Head = *(Para0017_Head *)(recvbuf+sizeof(MsgHead));
	
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0017_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0017_Head.ParamVer[i]);
		
	FILE_NBR = m_Para0017_Head.b_records;

	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS') INTO para_pointer,:b_ParamValidTime
	         FROM T_PARAMETER_CTRL 
	         WHERE PARAMETER_TYPE = '0015' AND PARAMETER_STATUS = 2;
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	EXEC SQL INSERT INTO TBL_PM_0017_PARA (PARAMETER_NBR,PACKET_SEQ,FILE_NBR)
											            VALUES(:para_pointer,:para_pointer,:FILE_NBR);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:TBL_PM_0017_PARA ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
	
		EXEC SQL ROLLBACK;
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}												
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
	return 1;
}



/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0018(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						b_ParamValidTime[15];	/* ---  --- */
	char						ParamVer[15];		/* ---  --- */
	
  char							LINE_ID[3];			
  char							STATION_NID[5];			
  char							RUNMODE_CODE[3];	
  char  						OCCUR_TIME[15];			
  char							SHIFT_TIME[15];			
  char							AFFECT_TIME[15];	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0018_Head       m_Para0018_Head;
	Para0018_Record     m_Para0018_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0018_Head,0x00,sizeof(Para0018_Head));
	m_Para0018_Head = *(Para0018_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0018_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0018_Head.ParamVer[i]);
	memset(b_ParamValidTime,0x00,sizeof(b_ParamValidTime));
	for(i=0;i<sizeof(m_Para0018_Head.ParamVer);i++)
		sprintf(b_ParamValidTime+2*i,"%02X",m_Para0018_Head.ParamVer[i]);
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,TO_DATE(:b_ParamValidTime,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0018_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0018_Record,0x00,sizeof(Para0018_Record));
		m_Para0018_Record = *(Para0018_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0018_Head) + j * sizeof(Para0018_Record));
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Para0018_Record.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Para0018_Record.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Para0018_Record.STATION_NID[i]);
		memset(RUNMODE_CODE,0x00,sizeof(RUNMODE_CODE));
		sprintf(RUNMODE_CODE,"%02X",m_Para0018_Record.RUNMODE_CODE);
		memset(OCCUR_TIME,0x00,sizeof(OCCUR_TIME));
		for(i = 0;i < sizeof(m_Para0018_Record.OCCUR_TIME);i++)
			sprintf(OCCUR_TIME+2*i,"%02X",m_Para0018_Record.OCCUR_TIME[i]);
		memset(SHIFT_TIME,0x00,sizeof(SHIFT_TIME));
		for(i = 0;i < sizeof(m_Para0018_Record.SHIFT_TIME);i++)
			sprintf(SHIFT_TIME+2*i,"%02X",m_Para0018_Record.SHIFT_TIME[i]);
		memset(AFFECT_TIME,0x00,sizeof(AFFECT_TIME));
		for(i = 0;i < sizeof(m_Para0018_Record.AFFECT_TIME);i++)
			sprintf(AFFECT_TIME+2*i,"%02X",m_Para0018_Record.AFFECT_TIME[i]);
		EXEC SQL INSERT INTO TBL_PM_0018_RUNMODE (PARAMETER_NBR,PACKET_SEQ,LINE_ID,STATION_NID,RUNMODE_CODE,
                                              OCCUR_TIME,
                                              SHIFT_TIME,
                                              AFFECT_TIME)
												               VALUES(:para_pointer,:para_pointer,:LINE_ID,:STATION_NID,:RUNMODE_CODE,
                                              TO_DATE(:OCCUR_TIME,'YYYYMMDDHH24MISS'),
                                              TO_DATE(:SHIFT_TIME,'YYYYMMDDHH24MISS'),
                                              TO_DATE(:AFFECT_TIME,'YYYYMMDDHH24MISS'));
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0018_RUNMODE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																											
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0019(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
		
	char						ParamVer[15];		/* ---  --- */
	
	char						DIREC_CODE[5];			
	char  					DIREC_NAME[41];		
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0019_Head       m_Para0019_Head;
	Para0019_Record     m_Para0019_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<7;i++)
			sprintf(ParamVer+2*i,"%02X",m_msghead.b_PkgID[i+4]);
	/* ---  参数头 --- */
	memset(&m_Para0019_Head,0x00,sizeof(Para0019_Head));
	m_Para0019_Head = *(Para0019_Head *)(recvbuf+sizeof(MsgHead));
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	EXEC SQL DELETE FROM TBL_SS_TICKET_DIRECTORY;
     
	ParamRecords = 	CommonFuncs::wordtowin(m_Para0019_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para0019_Record,0x00,sizeof(Para0019_Record));
		m_Para0019_Record = *(Para0019_Record *)(recvbuf + sizeof(MsgHead) + sizeof(Para0019_Head) + j * sizeof(Para0019_Record));
		memset(DIREC_CODE,0x00,sizeof(DIREC_CODE));
		for(i = 0;i < sizeof(m_Para0019_Record.DIREC_CODE);i++)
			sprintf(DIREC_CODE+2*i,"%02X",m_Para0019_Record.DIREC_CODE[i]);
		memset(DIREC_NAME,0x00,sizeof(DIREC_NAME));
		memcpy(DIREC_NAME,m_Para0019_Record.DIREC_NAME,sizeof(m_Para0019_Record.DIREC_NAME));
		EXEC SQL INSERT INTO TBL_PM_0019_TICKET_DIRECTORY (PARAMETER_NBR,PACKET_SEQ,   DIREC_CODE, DIREC_NAME)
												                        VALUES(:para_pointer,:para_pointer,:DIREC_CODE,:DIREC_NAME);
												                        
		EXEC SQL INSERT INTO TBL_SS_TICKET_DIRECTORY(DIREC_CODE, DIREC_NAME)
												                  VALUES(:DIREC_CODE,:DIREC_NAME);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_0019_TICKET_DIRECTORY ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																											
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_001A(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
		
	char						ParamVer[15];		/* ---  --- */
	
	unsigned short	FILE_MAX_RECORD;		
	unsigned short	COMMIT_INTERVAL;	
	unsigned short	AUDIT_INTERVAL;	
	unsigned short	DEVICE_INTERVAL;	
	char            LOAD_AUTH_IP[9];	
	unsigned short	LOAD_AUTH_PORT;
	int             SEND_COUNT;	
	char            CLEAR_SHIFT_TIME[5];	
	char            TRANS_SHIFT_TIME[5];	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para001A_Record     m_Para001A_Record;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<7;i++)
			sprintf(ParamVer+2*i,"%02X",m_msghead.b_PkgID[i+4]);
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);

	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	memset(&m_Para001A_Record,0x00,sizeof(Para001A_Record));
	m_Para001A_Record = *(Para001A_Record *)(recvbuf + sizeof(MsgHead));
	FILE_MAX_RECORD = CommonFuncs::wordtowin(m_Para001A_Record.FILE_MAX_RECORD);
	COMMIT_INTERVAL = CommonFuncs::wordtowin(m_Para001A_Record.COMMIT_INTERVAL);
	AUDIT_INTERVAL = CommonFuncs::wordtowin(m_Para001A_Record.AUDIT_INTERVAL);
	DEVICE_INTERVAL = CommonFuncs::wordtowin(m_Para001A_Record.DEVICE_INTERVAL);
	memset(LOAD_AUTH_IP,0x00,sizeof(LOAD_AUTH_IP));
	for(i = 0;i < sizeof(m_Para001A_Record.LOAD_AUTH_IP);i++)
		sprintf(LOAD_AUTH_IP+2*i,"%02X",m_Para001A_Record.LOAD_AUTH_IP[i]);
	LOAD_AUTH_PORT = CommonFuncs::wordtowin(m_Para001A_Record.LOAD_AUTH_PORT);
	SEND_COUNT =(int) m_Para001A_Record.SEND_COUNT;
	memset(CLEAR_SHIFT_TIME,0x00,sizeof(CLEAR_SHIFT_TIME));
	for(i = 0;i < sizeof(m_Para001A_Record.CLEAR_SHIFT_TIME);i++)
		sprintf(CLEAR_SHIFT_TIME+2*i,"%02X",m_Para001A_Record.CLEAR_SHIFT_TIME[i]);
	memset(TRANS_SHIFT_TIME,0x00,sizeof(TRANS_SHIFT_TIME));
	for(i = 0;i < sizeof(m_Para001A_Record.TRANS_SHIFT_TIME);i++)
		sprintf(TRANS_SHIFT_TIME+2*i,"%02X",m_Para001A_Record.TRANS_SHIFT_TIME[i]);
	EXEC SQL INSERT INTO TBL_PM_001A_COMM (PARAMETER_NBR,PACKET_SEQ,FILE_MAX_RECORD,COMMIT_INTERVAL,
																				 AUDIT_INTERVAL,DEVICE_INTERVAL,LOAD_AUTH_IP,LOAD_AUTH_PORT,SEND_COUNT,
																			   CLEAR_SHIFT_TIME,TRANS_SHIFT_TIME)
												          VALUES(:para_pointer,:para_pointer,:FILE_MAX_RECORD,:COMMIT_INTERVAL,
																				 :AUDIT_INTERVAL,:DEVICE_INTERVAL,:LOAD_AUTH_IP,:LOAD_AUTH_PORT,:SEND_COUNT,
																			   :CLEAR_SHIFT_TIME,:TRANS_SHIFT_TIME);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:TBL_PM_001A_COMM ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}																												
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0401(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0401_Head       m_Para0401_Head;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0401_Head,0x00,sizeof(Para0401_Head));
	m_Para0401_Head = *(Para0401_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0401_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0401_Head.ParamVer[i]);
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0402(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0402_Head       m_Para0402_Head;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0402_Head,0x00,sizeof(Para0402_Head));
	m_Para0402_Head = *(Para0402_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0402_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0402_Head.ParamVer[i]);
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	return 1;
}


/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0403(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0403_Head       m_Para0403_Head;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0403_Head,0x00,sizeof(Para0403_Head));
	m_Para0403_Head = *(Para0403_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0403_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0403_Head.ParamVer[i]);
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	return 1;
}


/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_0406(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para0406_Head       m_Para0406_Head;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para0406_Head,0x00,sizeof(Para0406_Head));
	m_Para0406_Head = *(Para0406_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para0406_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para0406_Head.ParamVer[i]);
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_000B(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	char  					BLACKLIST_CLASS[3];
	unsigned short  wRecords_1;
	unsigned short  wRecords_2;
	
	char						TICKET_NO[11];		/* ---  --- */
	char  					BLACKLIST_USAGE[3];
	char            BLACKLIST_TYPE[3];
	int   					ADD_FLAG;
	char  					SALE_ACTION_FLAG[3];
	char  					TVM_ACTION_FLAG[3];
	
	char						START_TICKET_NO[11];		/* ---  --- */
	char  					END_TICKET_NO[11];
	char            CHECK_ACTION_FLAG[3];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para000B_Head       m_Para000B_Head;
	Para000B_Record_1   m_Para000B_Record_1;
	Para000B_Record_2   m_Para000B_Record_2;
	Para000B_Record_3   m_Para000B_Record_3;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para000B_Head,0x00,sizeof(Para000B_Head));
	m_Para000B_Head = *(Para000B_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para000B_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para000B_Head.ParamVer[i]);
	memset(BLACKLIST_CLASS,0x00,sizeof(BLACKLIST_CLASS));
	sprintf(BLACKLIST_CLASS,"%02X",m_Para000B_Head.BLACKLIST_CLASS);
	
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",filename,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
	
		free(recvbuf);
		recvbuf = NULL;
		
		return 0;
	}
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	wRecords_1 = CommonFuncs::wordtowin(m_Para000B_Head.wRecords_1);									
	for(j=0;j<wRecords_1;j++)
	{
		memset(&m_Para000B_Record_1,0x00,sizeof(Para000B_Record_1));
		m_Para000B_Record_1 = *(Para000B_Record_1 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000B_Head) + j * sizeof(Para000B_Record_1));
		memset(TICKET_NO,0x00,sizeof(TICKET_NO));
		for(i = 0;i < sizeof(m_Para000B_Record_1.TICKET_NO);i++)
			sprintf(TICKET_NO+2*i,"%02X",m_Para000B_Record_1.TICKET_NO[i]);
		memset(BLACKLIST_USAGE,0x00,sizeof(BLACKLIST_USAGE));
		sprintf(BLACKLIST_USAGE,"%02X",m_Para000B_Record_1.BLACKLIST_USAGE);
		memset(BLACKLIST_TYPE,0x00,sizeof(BLACKLIST_TYPE));
		sprintf(BLACKLIST_TYPE,"%02X",m_Para000B_Record_1.BLACKLIST_TYPE);
		ADD_FLAG = (int)m_Para000B_Record_1.ADD_FLAG;
		memset(SALE_ACTION_FLAG,0x00,sizeof(SALE_ACTION_FLAG));
		sprintf(SALE_ACTION_FLAG,"%02X",m_Para000B_Record_1.SALE_ACTION_FLAG);
		memset(TVM_ACTION_FLAG,0x00,sizeof(TVM_ACTION_FLAG));
		sprintf(TVM_ACTION_FLAG,"%02X",m_Para000B_Record_1.TVM_ACTION_FLAG);
		EXEC SQL INSERT INTO TBL_PM_000B_BLACKLIST_SINGLE(PARAMETER_NBR,PACKET_SEQ,BLACKLIST_CLASS,TICKET_NO,BLACKLIST_USAGE,
                                                      BLACKLIST_TYPE,ADD_FLAG,SALE_ACTION_FLAG,TVM_ACTION_FLAG)
												                 VALUES(:para_pointer,:para_pointer,:BLACKLIST_CLASS,:TICKET_NO,:BLACKLIST_USAGE,
                                                :BLACKLIST_TYPE,:ADD_FLAG,:SALE_ACTION_FLAG,:TVM_ACTION_FLAG);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000B_BLACKLIST_SINGLE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	/* ---  参数体 --- */
	wRecords_2 = 	CommonFuncs::wordtowin(m_Para000B_Head.wRecords_2);									
	for(j=0;j<wRecords_2;j++)
	{
		memset(&m_Para000B_Record_2,0x00,sizeof(Para000B_Record_2));
		m_Para000B_Record_2 = *(Para000B_Record_2 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000B_Head) + 
		                                             wRecords_1 * sizeof(Para000B_Record_1) + j * sizeof(Para000B_Record_2));
		memset(START_TICKET_NO,0x00,sizeof(START_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000B_Record_2.START_TICKET_NO);i++)
			sprintf(START_TICKET_NO+2*i,"%02X",m_Para000B_Record_2.START_TICKET_NO[i]);
		memset(END_TICKET_NO,0x00,sizeof(END_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000B_Record_2.END_TICKET_NO);i++)
			sprintf(END_TICKET_NO+2*i,"%02X",m_Para000B_Record_2.END_TICKET_NO[i]);
		memset(BLACKLIST_USAGE,0x00,sizeof(BLACKLIST_USAGE));
		sprintf(BLACKLIST_USAGE,"%02X",m_Para000B_Record_2.BLACKLIST_USAGE);
		memset(BLACKLIST_TYPE,0x00,sizeof(BLACKLIST_TYPE));
		sprintf(BLACKLIST_TYPE,"%02X",m_Para000B_Record_2.BLACKLIST_TYPE);
		memset(SALE_ACTION_FLAG,0x00,sizeof(SALE_ACTION_FLAG));
		sprintf(SALE_ACTION_FLAG,"%02X",m_Para000B_Record_2.SALE_ACTION_FLAG);
		memset(CHECK_ACTION_FLAG,0x00,sizeof(CHECK_ACTION_FLAG));
		sprintf(CHECK_ACTION_FLAG,"%02X",m_Para000B_Record_2.CHECK_ACTION_FLAG);
		EXEC SQL INSERT INTO TBL_PM_000B_BLACKLIST_RANGE(PARAMETER_NBR,PACKET_SEQ,BLACKLIST_CLASS,START_TICKET_NO,END_TICKET_NO,
		                                                 BLACKLIST_USAGE,BLACKLIST_TYPE,SALE_ACTION_FLAG,CHECK_ACTION_FLAG)
												                      VALUES(:para_pointer,:para_pointer,:BLACKLIST_CLASS,:START_TICKET_NO,:END_TICKET_NO,
                                                     :BLACKLIST_USAGE,:BLACKLIST_TYPE,:SALE_ACTION_FLAG,:CHECK_ACTION_FLAG);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000B_BLACKLIST_RANGE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_000C(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
		
	char						SAM_ID[13];			
	char  					TVM_ACTION_FLAG[3];		
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para000C_Head       m_Para000C_Head;
	Para000C_Record_1   m_Para000C_Record_1;
	unsigned int      	ParamRecords;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para000C_Head,0x00,sizeof(Para000C_Head));
	m_Para000C_Head = *(Para000C_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para000C_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para000C_Head.ParamVer[i]);
		
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",c_MsgCode,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	ParamRecords = 	CommonFuncs::wordtowin(m_Para000C_Head.Records);									
	for(j=0;j<ParamRecords;j++)
	{
		memset(&m_Para000C_Record_1,0x00,sizeof(Para000C_Record_1));
		m_Para000C_Record_1 = *(Para000C_Record_1 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000C_Head) + j * sizeof(Para000C_Record_1));
		memset(SAM_ID,0x00,sizeof(SAM_ID));
		for(i = 0;i < sizeof(m_Para000C_Record_1.SAM_ID);i++)
			sprintf(SAM_ID+2*i,"%02X",m_Para000C_Record_1.SAM_ID[i]);
		memset(TVM_ACTION_FLAG,0x00,sizeof(TVM_ACTION_FLAG));
		sprintf(TVM_ACTION_FLAG,"%02X",m_Para000C_Record_1.TVM_ACTION_FLAG);
		EXEC SQL INSERT INTO TBL_PM_000C_BLACKLIST (PARAMETER_NBR,PACKET_SEQ,   SAM_ID, TVM_ACTION_FLAG)
												                 VALUES(:para_pointer,:para_pointer,:SAM_ID,:TVM_ACTION_FLAG);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000C_BLACKLIST ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																											
	}
  
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_000D(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	char  					BLACKLIST_CLASS[3];
	unsigned short  wRecords_1;
	unsigned short  wRecords_2;
	
	char						TICKET_NO[17];		/* ---  --- */
	char  					BLACKLIST_USAGE[3];
	char            BLACKLIST_TYPE[3];
	int   					ADD_FLAG;
	char  					SALE_ACTION_FLAG[3];
	char  					TVM_ACTION_FLAG[3];
	
	char						START_TICKET_NO[17];		/* ---  --- */
	char  					END_TICKET_NO[17];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para000D_Head       m_Para000D_Head;
	Para000D_Record_1   m_Para000D_Record_1;
	Para000D_Record_2   m_Para000D_Record_2;
	Para000D_Record_3   m_Para000D_Record_3;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para000D_Head,0x00,sizeof(Para000D_Head));
	m_Para000D_Head = *(Para000D_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para000D_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para000D_Head.ParamVer[i]);
	memset(BLACKLIST_CLASS,0x00,sizeof(BLACKLIST_CLASS));
	sprintf(BLACKLIST_CLASS,"%02X",m_Para000D_Head.BLACKLIST_CLASS);
	
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",filename,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
	
		free(recvbuf);
		recvbuf = NULL;
		
		return 0;
	}
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	wRecords_1 = 	CommonFuncs::wordtowin(m_Para000D_Head.wRecords_1);									
	for(j=0;j<wRecords_1;j++)
	{
		memset(&m_Para000D_Record_1,0x00,sizeof(Para000D_Record_1));
		m_Para000D_Record_1 = *(Para000D_Record_1 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000D_Head) + j * sizeof(Para000D_Record_1));
		memset(TICKET_NO,0x00,sizeof(TICKET_NO));
		for(i = 0;i < sizeof(m_Para000D_Record_1.TICKET_NO);i++)
			sprintf(TICKET_NO+2*i,"%02X",m_Para000D_Record_1.TICKET_NO[i]);
		memset(BLACKLIST_USAGE,0x00,sizeof(BLACKLIST_USAGE));
		sprintf(BLACKLIST_USAGE,"%02X",m_Para000D_Record_1.BLACKLIST_USAGE);
		memset(BLACKLIST_TYPE,0x00,sizeof(BLACKLIST_TYPE));
		sprintf(BLACKLIST_TYPE,"%02X",m_Para000D_Record_1.BLACKLIST_TYPE);
		ADD_FLAG = (int)m_Para000D_Record_1.ADD_FLAG;
		memset(SALE_ACTION_FLAG,0x00,sizeof(SALE_ACTION_FLAG));
		sprintf(SALE_ACTION_FLAG,"%02X",m_Para000D_Record_1.SALE_ACTION_FLAG);
		memset(TVM_ACTION_FLAG,0x00,sizeof(TVM_ACTION_FLAG));
		sprintf(TVM_ACTION_FLAG,"%02X",m_Para000D_Record_1.TVM_ACTION_FLAG);
		EXEC SQL INSERT INTO TBL_PM_000D_BLACKLIST_SINGLE(PARAMETER_NBR,PACKET_SEQ,BLACKLIST_CLASS,TICKET_NO,BLACKLIST_USAGE,
                                                      BLACKLIST_TYPE,ADD_FLAG,SALE_ACTION_FLAG,TVM_ACTION_FLAG)
												                 VALUES(:para_pointer,:para_pointer,:BLACKLIST_CLASS,:TICKET_NO,:BLACKLIST_USAGE,
                                                :BLACKLIST_TYPE,:ADD_FLAG,:SALE_ACTION_FLAG,:TVM_ACTION_FLAG);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000D_BLACKLIST_SINGLE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	/* ---  参数体 --- */
	wRecords_2 = 	CommonFuncs::wordtowin(m_Para000D_Head.wRecords_2);									
	for(j=0;j<wRecords_2;j++)
	{
		memset(&m_Para000D_Record_2,0x00,sizeof(Para000D_Record_2));
		m_Para000D_Record_2 = *(Para000D_Record_2 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000D_Head) + 
		                                             wRecords_1 * sizeof(Para000D_Record_1) + j * sizeof(Para000D_Record_2));
		memset(START_TICKET_NO,0x00,sizeof(START_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000D_Record_2.START_TICKET_NO);i++)
			sprintf(START_TICKET_NO+2*i,"%02X",m_Para000D_Record_2.START_TICKET_NO[i]);
		memset(END_TICKET_NO,0x00,sizeof(END_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000D_Record_2.END_TICKET_NO);i++)
			sprintf(END_TICKET_NO+2*i,"%02X",m_Para000D_Record_2.END_TICKET_NO[i]);
		memset(BLACKLIST_USAGE,0x00,sizeof(BLACKLIST_USAGE));
		sprintf(BLACKLIST_USAGE,"%02X",m_Para000D_Record_2.BLACKLIST_USAGE);
		memset(BLACKLIST_TYPE,0x00,sizeof(BLACKLIST_TYPE));
		sprintf(BLACKLIST_TYPE,"%02X",m_Para000D_Record_2.BLACKLIST_TYPE);
		memset(SALE_ACTION_FLAG,0x00,sizeof(SALE_ACTION_FLAG));
		sprintf(SALE_ACTION_FLAG,"%02X",m_Para000D_Record_2.SALE_ACTION_FLAG);
		memset(TVM_ACTION_FLAG,0x00,sizeof(TVM_ACTION_FLAG));
		sprintf(TVM_ACTION_FLAG,"%02X",m_Para000D_Record_2.TVM_ACTION_FLAG);
		EXEC SQL INSERT INTO TBL_PM_000D_BLACKLIST_RANGE(PARAMETER_NBR,PACKET_SEQ,BLACKLIST_CLASS,START_TICKET_NO,END_TICKET_NO,
		                                                 BLACKLIST_USAGE,BLACKLIST_TYPE,SALE_ACTION_FLAG,TVM_ACTION_FLAG)
												                      VALUES(:para_pointer,:para_pointer,:BLACKLIST_CLASS,:START_TICKET_NO,:END_TICKET_NO,
                                                     :BLACKLIST_USAGE,:BLACKLIST_TYPE,:SALE_ACTION_FLAG,:TVM_ACTION_FLAG);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000D_BLACKLIST_RANGE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
	
 
	
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_000E(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	char  					BLACKLIST_CLASS[3];
	unsigned short  wRecords_1;
	unsigned short  wRecords_2;
	
	char						TICKET_NO[11];		/* ---  --- */
	char  					BLACKLIST_USAGE[3];
	char            BLACKLIST_TYPE[3];
	int   					ADD_FLAG;
	char  					SALE_ACTION_FLAG[3];
	char            TVM_ACTION_FLAG[3];
	
	char						START_TICKET_NO[11];		/* ---  --- */
	char  					END_TICKET_NO[11];
	char  					CHECK_ACTION_FLAG[3];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para000E_Head       m_Para000E_Head;
	Para000E_Record_1   m_Para000E_Record_1;
	Para000E_Record_2   m_Para000E_Record_2;
	Para000E_Record_3   m_Para000E_Record_3;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	char                temp[50];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para000E_Head,0x00,sizeof(Para000E_Head));
	m_Para000E_Head = *(Para000E_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para000E_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para000E_Head.ParamVer[i]);
	memset(BLACKLIST_CLASS,0x00,sizeof(BLACKLIST_CLASS));
	sprintf(BLACKLIST_CLASS,"%02X",m_Para000E_Head.BLACKLIST_CLASS);
	
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",filename,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
	
		free(recvbuf);
		recvbuf = NULL;
		
		return 0;
	}
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	wRecords_1 = CommonFuncs::wordtowin(m_Para000E_Head.wRecords_1);									
	for(j=0;j<wRecords_1;j++)
	{
		memset(&m_Para000E_Record_1,0x00,sizeof(Para000E_Record_1));
		m_Para000E_Record_1 = *(Para000E_Record_1 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000E_Head) + j * sizeof(Para000E_Record_1));
		memset(TICKET_NO,0x00,sizeof(TICKET_NO));
		for(i = 0;i < sizeof(m_Para000E_Record_1.TICKET_NO);i++)
			sprintf(TICKET_NO+2*i,"%02X",m_Para000E_Record_1.TICKET_NO[i]);
		memset(BLACKLIST_USAGE,0x00,sizeof(BLACKLIST_USAGE));
		sprintf(BLACKLIST_USAGE,"%02X",m_Para000E_Record_1.BLACKLIST_USAGE);
		memset(BLACKLIST_TYPE,0x00,sizeof(BLACKLIST_TYPE));
		sprintf(BLACKLIST_TYPE,"%02X",m_Para000E_Record_1.BLACKLIST_TYPE);
		ADD_FLAG = (int)m_Para000E_Record_1.ADD_FLAG;
		memset(SALE_ACTION_FLAG,0x00,sizeof(SALE_ACTION_FLAG));
		sprintf(SALE_ACTION_FLAG,"%02X",m_Para000E_Record_1.SALE_ACTION_FLAG);
		memset(TVM_ACTION_FLAG,0x00,sizeof(TVM_ACTION_FLAG));
		sprintf(TVM_ACTION_FLAG,"%02X",m_Para000E_Record_1.TVM_ACTION_FLAG);
		EXEC SQL INSERT INTO TBL_PM_000E_BLACKLIST_SINGLE(PARAMETER_NBR,PACKET_SEQ,BLACKLIST_CLASS,TICKET_NO,BLACKLIST_USAGE,
                                                      BLACKLIST_TYPE,ADD_FLAG,SALE_ACTION_FLAG,TVM_ACTION_FLAG)
												                 VALUES(:para_pointer,:para_pointer,:BLACKLIST_CLASS,:TICKET_NO,:BLACKLIST_USAGE,
                                                :BLACKLIST_TYPE,:ADD_FLAG,:SALE_ACTION_FLAG,:TVM_ACTION_FLAG);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000E_BLACKLIST_SINGLE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	/* ---  参数体 --- */
	wRecords_2 = CommonFuncs::wordtowin(m_Para000E_Head.wRecords_2);									
	for(j=0;j<wRecords_2;j++)
	{
		memset(&m_Para000E_Record_2,0x00,sizeof(Para000E_Record_2));
		m_Para000E_Record_2 = *(Para000E_Record_2 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000E_Head) + 
		                                             wRecords_1 * sizeof(Para000E_Record_1) + j * sizeof(Para000E_Record_2));
		memset(START_TICKET_NO,0x00,sizeof(START_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000E_Record_2.START_TICKET_NO);i++)
			sprintf(START_TICKET_NO+2*i,"%02X",m_Para000E_Record_2.START_TICKET_NO[i]);
		memset(END_TICKET_NO,0x00,sizeof(END_TICKET_NO));
		for(i = 0;i < sizeof(m_Para000E_Record_2.END_TICKET_NO);i++)
			sprintf(END_TICKET_NO+2*i,"%02X",m_Para000E_Record_2.END_TICKET_NO[i]);
		memset(BLACKLIST_USAGE,0x00,sizeof(BLACKLIST_USAGE));
		sprintf(BLACKLIST_USAGE,"%02X",m_Para000E_Record_2.BLACKLIST_USAGE);
		memset(BLACKLIST_TYPE,0x00,sizeof(BLACKLIST_TYPE));
		sprintf(BLACKLIST_TYPE,"%02X",m_Para000E_Record_2.BLACKLIST_TYPE);
		memset(SALE_ACTION_FLAG,0x00,sizeof(SALE_ACTION_FLAG));
		sprintf(SALE_ACTION_FLAG,"%02X",m_Para000E_Record_2.SALE_ACTION_FLAG);
		memset(CHECK_ACTION_FLAG,0x00,sizeof(CHECK_ACTION_FLAG));
		sprintf(CHECK_ACTION_FLAG,"%02X",m_Para000E_Record_2.CHECK_ACTION_FLAG);
		EXEC SQL INSERT INTO TBL_PM_000E_BLACKLIST_RANGE(PARAMETER_NBR,PACKET_SEQ,BLACKLIST_CLASS,START_TICKET_NO,END_TICKET_NO,
		                                                 BLACKLIST_USAGE,BLACKLIST_TYPE,SALE_ACTION_FLAG,CHECK_ACTION_FLAG)
												                      VALUES(:para_pointer,:para_pointer,:BLACKLIST_CLASS,:START_TICKET_NO,:END_TICKET_NO,
                                                     :BLACKLIST_USAGE,:BLACKLIST_TYPE,:SALE_ACTION_FLAG,:CHECK_ACTION_FLAG);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000E_BLACKLIST_RANGE ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            返回值说明：0 正常 1 错误
--------------------------------------------------------- */
int ORA::insert_into_000F(char *filename,int lineIndex)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int 		para_pointer;
	char          	localid[9];
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	
	char						ParamVer[15];		/* ---  --- */
	unsigned short  wRecords_1;
	
	char						WHITE_LIST_CODE[17];		/* ---  --- */
	char  					WHITE_LIST_INFO[33];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					  m_msghead;
	Para000F_Head       m_Para000F_Head;
	Para000F_Record_1   m_Para000F_Record_1;
	int               	i,j;
	unsigned char       *recvbuf;
	struct stat         buf;
	int                 buflen;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	/* ---  读取文件 --- */
	buflen = stat(filename,&buf);
	if(buflen != 0)
	{
		return 1;
	}
	buflen = buf.st_size;
	recvbuf = (unsigned char*)malloc(buflen);
	memset(recvbuf,0x00,buflen);
	CommonFuncs::ReadFileBuffer(filename,(char*)recvbuf);
	
	/* ---  参数类型 --- */
	m_msghead = *(MsgHead *)(recvbuf);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ---  参数头 --- */
	memset(&m_Para000F_Head,0x00,sizeof(Para000F_Head));
	m_Para000F_Head = *(Para000F_Head *)(recvbuf+sizeof(MsgHead));
	memset(ParamVer,0x00,sizeof(ParamVer));
	for(i=0;i<sizeof(m_Para000F_Head.ParamVer);i++)
		sprintf(ParamVer+2*i,"%02X",m_Para000F_Head.ParamVer[i]);
	
	EXEC SQL SELECT SEQ_PARAMETER_POINTER.nextval INTO :para_pointer FROM DUAL ;
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:SEQ ERROR:%d\n",filename,sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
	
		free(recvbuf);
		recvbuf = NULL;
		
		return 0;
	}
		
	memset(localid,0x00,sizeof(localid));
	strcpy(localid,CConfig::ms_MlcLineList[lineIndex].LINE_NID);
	
	EXEC SQL UPDATE T_PARAMETER_CTRL
		       SET    PARAMETER_STATUS = 3
		       WHERE  PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :c_MsgCode;	
	EXEC SQL INSERT INTO T_PARAMETER_CTRL (PARAMETER_NBR,PARAMETER_NAME,PARAMETER_TYPE,PARAMETER_VERSION,
	                                       PARAMETER_STATUS,PARAMETER_CTRL_NID,EFFECTIVE_TIME) 
					                        VALUES(:para_pointer,TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),:c_MsgCode,:ParamVer,
					                               2,:localid,SYSDATE);
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"%s:t_parameter_ctrl ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		
		free(recvbuf);
		recvbuf = NULL;
		return 0;
	}
	/* ---  参数体 --- */
	wRecords_1 = 	CommonFuncs::wordtowin(m_Para000F_Head.Records);									
	for(j=0;j<wRecords_1;j++)
	{
		memset(&m_Para000F_Record_1,0x00,sizeof(Para000F_Record_1));
		m_Para000F_Record_1 = *(Para000F_Record_1 *)(recvbuf + sizeof(MsgHead) + sizeof(Para000F_Head) + j * sizeof(Para000F_Record_1));
		memset(WHITE_LIST_CODE,0x00,sizeof(WHITE_LIST_CODE));
		for(i = 0;i < sizeof(m_Para000F_Record_1.WHITE_LIST_CODE);i++)
			sprintf(WHITE_LIST_CODE+2*i,"%02X",m_Para000F_Record_1.WHITE_LIST_CODE[i]);
		memset(WHITE_LIST_INFO,0x00,sizeof(WHITE_LIST_INFO));
		for(i = 0;i < sizeof(m_Para000F_Record_1.WHITE_LIST_INFO);i++)
			sprintf(WHITE_LIST_INFO+2*i,"%02X",m_Para000F_Record_1.WHITE_LIST_INFO[i]);
		EXEC SQL INSERT INTO TBL_PM_000F_WHITELIST(PARAMETER_NBR,PACKET_SEQ,WHITE_LIST_CODE,WHITE_LIST_INFO)
												               VALUES(:para_pointer,:para_pointer,:WHITE_LIST_CODE,:WHITE_LIST_INFO);
		if(sqlca.sqlcode !=0 )
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg,"%s:TBL_PM_000F_WHITELIST ERROR:%s\n",filename,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			EXEC SQL ROLLBACK;
			free(recvbuf);
			recvbuf = NULL;
			return 0;
		}																												
	}
	
	EXEC SQL COMMIT;
	
	free(recvbuf);
	recvbuf = NULL;
 
	return 1;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_1001(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	int             count;
	
	char 						LINE_ID[3];				/* ---  --- */
	char 						STATION_NID[5];			/* ---  --- */
	char 						DEVICE_TYPE[3];				/* ---  --- */
	char 						DEVICE_NID[9];				/* ---  --- */
	char 						LAST_DEVICE_NID[9];			/* ---  --- */
	char 						LAST_STATION_NID[5];		/* ---  --- */
	char 						SALE_DEVICE_NID[9];			/* ---  --- */
	char 						SALE_TIME[15];			/* ---  --- */
	char 						CARD_ID[11];				/* ---  --- */
	char 						CARD_PHY_ID[17];			/* ---  --- */
	unsigned int  	INIT_ID;			/* ---  --- */
	char 						TICKET_TYPE[5];			/* ---  --- */
	char 						TRANS_TYPE[3];				/* ---  --- */
	char 						PAYMENT_METHOD[3];			/* ---  --- */
	unsigned int  	TRANS_VALUE;			/* ---  --- */
	unsigned int  	DISCOUNT;	/* ---  --- */
	unsigned int  	VALUE_OVERAGE;	/* ---  --- */
	char 						TRANS_TIME[15];			/* ---  --- */
	char 						LAST_TRANS_TIME[15];	/* ---  --- */
	unsigned short 	CARD_NBR;		/* ---  --- */
	unsigned int  	DEVICE_TRACE_NBR;				/* ---  --- */
	char 						SAM_ID[13];				/* ---  --- */
	unsigned int  	SAM_NBR;			/* ---  --- */
	char  					CRW_ID[5];				/* ---  --- */
	unsigned int  	CRW_NBR;			/* ---  --- */
	char 						TAC[9];					/* ---  --- */
	char 						OPERATOR_ID[9];			/* ---  --- */
	char 						RUN_MODE[3];			/* ---  --- */
	int 						MODE_DATA;			/* ---  --- */
	int 						IS_TEST;				/* ---  --- */
	char 						REL_CARD_ID[11];				/* ---  --- */
	
	int             SLOT_ID;
	char            TRANS_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j;
	Trans_1001_1   		m_Trans_1001_1;
	Trans_1001_2 			m_Trans_1001_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	int               rtn;
	char              tmp_time[30];
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	memset(&m_Trans_1001_1,0x00,sizeof(Trans_1001_1));
	m_Trans_1001_1 = *(Trans_1001_1 *)(recvbuf + sizeof(MsgHead));
	count = CommonFuncs::wordtowin(m_Trans_1001_1.w_Records);
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_1001_1) + count * sizeof(Trans_1001_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[1];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1001 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC,RECORD_NUM)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC,:count);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1101 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
			
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_1001_2,0x00,sizeof(Trans_1001_2));
		m_Trans_1001_2 = *(Trans_1001_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_1001_1)+sizeof(Trans_1001_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_1001_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1001_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_1001_2.STATION_NID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_1001_2.DEVICE_TYPE);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1001_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_1001_2.DEVICE_NID[i]);
		memset(LAST_DEVICE_NID,0x00,sizeof(LAST_DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1001_2.LAST_DEVICE_NID);i++)
			sprintf(LAST_DEVICE_NID+2*i,"%02X",m_Trans_1001_2.LAST_DEVICE_NID[i]);
		memset(LAST_STATION_NID,0x00,sizeof(LAST_STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1001_2.LAST_STATION_NID);i++)
			sprintf(LAST_STATION_NID+2*i,"%02X",m_Trans_1001_2.LAST_STATION_NID[i]);
		memset(SALE_DEVICE_NID,0x00,sizeof(SALE_DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1001_2.SALE_DEVICE_NID);i++)
			sprintf(SALE_DEVICE_NID+2*i,"%02X",m_Trans_1001_2.SALE_DEVICE_NID[i]);
		memset(SALE_TIME,0x00,sizeof(SALE_TIME));
		for(i = 0;i < sizeof(m_Trans_1001_2.SALE_TIME);i++)
			sprintf(SALE_TIME+2*i,"%02X",m_Trans_1001_2.SALE_TIME[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_1001_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_1001_2.CARD_ID[i]);
		memset(CARD_PHY_ID,0x00,sizeof(CARD_PHY_ID));
		for(i = 0;i < sizeof(m_Trans_1001_2.CARD_PHY_ID);i++)
			sprintf(CARD_PHY_ID+2*i,"%02X",m_Trans_1001_2.CARD_PHY_ID[i]);
		INIT_ID = CommonFuncs::dwordtowin(m_Trans_1001_2.INIT_ID);
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_1001_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_1001_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_1001_2.TRANS_TYPE);
		memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
		sprintf(PAYMENT_METHOD,"%02X",m_Trans_1001_2.PAYMENT_METHOD);
		TRANS_VALUE = CommonFuncs::dwordtowin(m_Trans_1001_2.TRANS_VALUE);
		DISCOUNT = CommonFuncs::dwordtowin(m_Trans_1001_2.DISCOUNT);
		VALUE_OVERAGE = CommonFuncs::dwordtowin(m_Trans_1001_2.VALUE_OVERAGE);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1001_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_1001_2.TRANS_TIME[i]);
		memset(LAST_TRANS_TIME,0x00,sizeof(LAST_TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1001_2.LAST_TRANS_TIME);i++)
			sprintf(LAST_TRANS_TIME+2*i,"%02X",m_Trans_1001_2.LAST_TRANS_TIME[i]);
		CARD_NBR = CommonFuncs::wordtowin(m_Trans_1001_2.CARD_NBR);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_1001_2.DEVICE_TRACE_NBR);
		memset(SAM_ID,0x00,sizeof(SAM_ID));
		for(i = 0;i < sizeof(m_Trans_1001_2.SAM_ID);i++)
			sprintf(SAM_ID+2*i,"%02X",m_Trans_1001_2.SAM_ID[i]);
		SAM_NBR = CommonFuncs::dwordtowin(m_Trans_1001_2.SAM_NBR);
		memset(CRW_ID,0x00,sizeof(CRW_ID));
		for(i = 0;i < sizeof(m_Trans_1001_2.CRW_ID);i++)
			sprintf(CRW_ID+2*i,"%02X",m_Trans_1001_2.CRW_ID[i]);
		CRW_NBR = CommonFuncs::dwordtowin(m_Trans_1001_2.CRW_NBR);
		memset(TAC,0x00,sizeof(TAC));
		for(i = 0;i < sizeof(m_Trans_1001_2.TAC);i++)
			sprintf(TAC+2*i,"%02X",m_Trans_1001_2.TAC[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_1001_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_1001_2.OPERATOR_ID[i]);
		memset(RUN_MODE,0x00,sizeof(RUN_MODE));
		sprintf(RUN_MODE,"%02X",m_Trans_1001_2.RUN_MODE);
		MODE_DATA = (int)m_Trans_1001_2.MODE_DATA;
		IS_TEST = (int)m_Trans_1001_2.IS_TEST;
		memset(REL_CARD_ID,0x00,sizeof(REL_CARD_ID));
		for(i = 0;i < sizeof(m_Trans_1001_2.REL_CARD_ID);i++)
			sprintf(REL_CARD_ID+2*i,"%02X",m_Trans_1001_2.REL_CARD_ID[i]);
		/* ----- 时间格式转换 ---*/
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,SALE_TIME);
		rtn = CTime::CheckTimeFormat(SALE_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,SALE_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,LAST_TRANS_TIME);
		rtn = CTime::CheckTimeFormat(LAST_TRANS_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,LAST_TRANS_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		/* --- 入库 ---*/
		EXEC SQL INSERT INTO TBL_TRANS_1001_SJT_TEMP(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                     LAST_STATION_NID,SALE_DEVICE_NID,SALE_TIME,CARD_ID,CARD_PHY_ID,INIT_ID,			
	                                     TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,TRANS_VALUE,DISCOUNT,VALUE_OVERAGE,	
	                                     TRANS_TIME,LAST_TRANS_TIME,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                     CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,MODE_DATA,IS_TEST,REL_CARD_ID)
		                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
	                                     :LAST_STATION_NID,:SALE_DEVICE_NID,TO_DATE(:SALE_TIME,'YYYYMMDDHH24MISS'),:CARD_ID,:CARD_PHY_ID,:INIT_ID,			
	                                     :TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,:TRANS_VALUE,:DISCOUNT,:VALUE_OVERAGE,	
	                                     TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
	                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:MODE_DATA,:IS_TEST,:REL_CARD_ID);
		EXEC SQL INSERT INTO TBL_TRANS_1001_SJT(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                     LAST_STATION_NID,SALE_DEVICE_NID,SALE_TIME,CARD_ID,CARD_PHY_ID,INIT_ID,			
	                                     TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,TRANS_VALUE,DISCOUNT,VALUE_OVERAGE,	
	                                     TRANS_TIME,LAST_TRANS_TIME,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                     CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,MODE_DATA,IS_TEST,REL_CARD_ID)
		                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
	                                     :LAST_STATION_NID,:SALE_DEVICE_NID,TO_DATE(:SALE_TIME,'YYYYMMDDHH24MISS'),:CARD_ID,:CARD_PHY_ID,:INIT_ID,			
	                                     :TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,:TRANS_VALUE,:DISCOUNT,:VALUE_OVERAGE,	
	                                     TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
	                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:MODE_DATA,:IS_TEST,:REL_CARD_ID);
		
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_1001(第%d条记录)ErrorCode(TBL_TRANS_1001_SJT) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			EXEC SQL INSERT INTO TBL_TRANS_1001_SJT_ERROR(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                     LAST_STATION_NID,SALE_DEVICE_NID,SALE_TIME,CARD_ID,CARD_PHY_ID,INIT_ID,			
	                                     TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,TRANS_VALUE,DISCOUNT,VALUE_OVERAGE,	
	                                     TRANS_TIME,LAST_TRANS_TIME,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                     CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,MODE_DATA,IS_TEST,REL_CARD_ID)
		                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
	                                     :LAST_STATION_NID,:SALE_DEVICE_NID,TO_DATE(:SALE_TIME,'YYYYMMDDHH24MISS'),:CARD_ID,:CARD_PHY_ID,:INIT_ID,			
	                                     :TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,:TRANS_VALUE,:DISCOUNT,:VALUE_OVERAGE,	
	                                     TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
	                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:MODE_DATA,:IS_TEST,:REL_CARD_ID);
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_1001(第%d条记录)ErrorCode(TBL_TRANS_1001_SJT_ERROR) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				/* ----- 写入错误文件---*/
				/*memset(errorbuf,0x00,sizeof(errorbuf));
				memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
				memcpy(errorbuf+sizeof(MsgHead),&m_Trans_1001_1,sizeof(Trans_1001_1));
				memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_1001_1),&m_Trans_1001_2,sizeof(Trans_1001_2));
				errorlen = sizeof(MsgHead)+sizeof(Trans_1001_1)+sizeof(Trans_1001_2);*/
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,(unsigned char*)&m_Trans_1001_2,sizeof(Trans_1001_2));
			}
		}
		else
		{
			memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
			EXEC SQL SELECT TO_CHAR(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-2/24,'YYYYMMDD') INTO :TRANS_DATE FROM DUAL;
			SLOT_ID = 0;
			EXEC SQL SELECT (TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-TRUNC(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')))*86400 / 300 
				       INTO :SLOT_ID
				       FROM DUAL; 
			if(strcmp(TRANS_TYPE,"09") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1001',:TICKET_TYPE,:DEVICE_NID,1,0);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1001 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else if(strcmp(TRANS_TYPE,"0A") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1001',:TICKET_TYPE,:DEVICE_NID,0,1);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1001 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else if(strcmp(TRANS_TYPE,"04") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM,SALE_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1001',:TICKET_TYPE,:DEVICE_NID,0,0,1);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1001 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
		}                        
	}
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_1002(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	int             count;
	
	char 						LINE_ID[3];				/* ---  --- */
	char 						STATION_NID[5];			/* ---  --- */
	char 						DEVICE_TYPE[3];				/* ---  --- */
	char 						DEVICE_NID[9];				/* ---  --- */
	char 						LAST_DEVICE_NID[9];			/* ---  --- */
	char 						LAST_STATION_NID[5];		/* ---  --- */
	char 						CARD_ID[11];				/* ---  --- */
	char 						CARD_PHY_ID[17];			/* ---  --- */
	char 						CARD_VER[3];				/* ---  --- */
	char 						ALGORITHM_FLAG[3];					/* ---  --- */
	char 						TICKET_TYPE[5];			/* ---  --- */
	char 						TRANS_TYPE[3];				/* ---  --- */
	char 						PAYMENT_METHOD[3];			/* ---  --- */
	char 						VALUE_TYPE[3];				/* ---  --- */
	unsigned int  	TRANS_VALUE;			/* ---  --- */
	unsigned short  TRANS_RIDE;	/* ---  --- */
	unsigned int  	DEPOSIT;	/* ---  --- */
	int  	TRANS_POST_VALUE;		/* ---  --- */
	unsigned short 	TRANS_POST_RIDE;		/* ---  --- */
	unsigned int  	DISCOUNT;	/* ---  --- */
	unsigned int 	  OVERDRAFT_LIMIT_VALUE;			/* ---  --- */
	unsigned int  	CURRENT_ACC_RIDE;				/* ---  --- */
	unsigned int  	SUM_ACC_RIDE;				/* ---  --- */
	unsigned int  	CURRENT_ACC_VALUE;				/* ---  --- */
	unsigned int  	SUM_ACC_VALUE;				/* ---  --- */
	unsigned int  	TRANS_FEE;				/* ---  --- */
	char 	          VALID_DATE[9];				/* ---  --- */
	char 						TRANS_TIME[15];			/* ---  --- */
	char 						LAST_TRANS_TIME[15];	/* ---  --- */
	char 						ACC_START_TIME[15];	/* ---  --- */
	unsigned short  LAST_CARD_NBR;	/* ---  --- */
	unsigned short 	CARD_NBR;		/* ---  --- */
	unsigned int  	DEVICE_TRACE_NBR;				/* ---  --- */
	char 						SAM_ID[13];				/* ---  --- */
	unsigned int  	SAM_NBR;			/* ---  --- */
	char  					CRW_ID[5];				/* ---  --- */
	unsigned int  	CRW_NBR;			/* ---  --- */
	char 						TAC[9];					/* ---  --- */
	char 						OPERATOR_ID[9];			/* ---  --- */
	char 						RUN_MODE[3];			/* ---  --- */
	char 						RELE_CARD_NO[11];				/* ---  --- */
	char 						RELE_APPLY_NO[25];				/* ---  --- */
	int 						MODE_DATA;			/* ---  --- */
	int 						IS_TEST;				/* ---  --- */
	
	int             SLOT_ID;
	char            TRANS_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j;
	Trans_1002_1   		m_Trans_1002_1;
	Trans_1002_2 			m_Trans_1002_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	int               rtn;
	char              tmp_time[30];
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	memset(&m_Trans_1002_1,0x00,sizeof(Trans_1002_1));
	m_Trans_1002_1 = *(Trans_1002_1 *)(recvbuf + sizeof(MsgHead));
	count = CommonFuncs::wordtowin(m_Trans_1002_1.w_Records);
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_1002_1) + count * sizeof(Trans_1002_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[2];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC,RECORD_NUM)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC,:count);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
			
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_1002_2,0x00,sizeof(Trans_1002_2));
		m_Trans_1002_2 = *(Trans_1002_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_1002_1)+sizeof(Trans_1002_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_1002_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1002_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_1002_2.STATION_NID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_1002_2.DEVICE_TYPE);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1002_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_1002_2.DEVICE_NID[i]);
		memset(LAST_DEVICE_NID,0x00,sizeof(LAST_DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1002_2.LAST_DEVICE_NID);i++)
			sprintf(LAST_DEVICE_NID+2*i,"%02X",m_Trans_1002_2.LAST_DEVICE_NID[i]);
		memset(LAST_STATION_NID,0x00,sizeof(LAST_STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1002_2.LAST_STATION_NID);i++)
			sprintf(LAST_STATION_NID+2*i,"%02X",m_Trans_1002_2.LAST_STATION_NID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_1002_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_1002_2.CARD_ID[i]);
		memset(CARD_PHY_ID,0x00,sizeof(CARD_PHY_ID));
		for(i = 0;i < sizeof(m_Trans_1002_2.CARD_PHY_ID);i++)
			sprintf(CARD_PHY_ID+2*i,"%02X",m_Trans_1002_2.CARD_PHY_ID[i]);
		memset(CARD_VER,0x00,sizeof(CARD_VER));
		sprintf(CARD_VER,"%02X",m_Trans_1002_2.CARD_VER);
		memset(ALGORITHM_FLAG,0x00,sizeof(ALGORITHM_FLAG));
		sprintf(ALGORITHM_FLAG,"%02X",m_Trans_1002_2.ALGORITHM_FLAG);
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_1002_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_1002_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_1002_2.TRANS_TYPE);
		memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
		sprintf(PAYMENT_METHOD,"%02X",m_Trans_1002_2.PAYMENT_METHOD);
		memset(VALUE_TYPE,0x00,sizeof(VALUE_TYPE));
		sprintf(VALUE_TYPE,"%02X",m_Trans_1002_2.VALUE_TYPE);
		TRANS_VALUE = CommonFuncs::dwordtowin(m_Trans_1002_2.TRANS_VALUE);
		TRANS_RIDE = CommonFuncs::wordtowin(m_Trans_1002_2.TRANS_RIDE);
		DEPOSIT = CommonFuncs::dwordtowin(m_Trans_1002_2.DEPOSIT);
		TRANS_POST_VALUE = CommonFuncs::ByteToInt(m_Trans_1002_2.TRANS_POST_VALUE,sizeof(m_Trans_1002_2.TRANS_POST_VALUE));
		TRANS_POST_RIDE = CommonFuncs::wordtowin(m_Trans_1002_2.TRANS_POST_RIDE);
		DISCOUNT = CommonFuncs::dwordtowin(m_Trans_1002_2.DISCOUNT);
		OVERDRAFT_LIMIT_VALUE = CommonFuncs::dwordtowin(m_Trans_1002_2.OVERDRAFT_LIMIT_VALUE);
		CURRENT_ACC_RIDE = CommonFuncs::dwordtowin(m_Trans_1002_2.CURRENT_ACC_RIDE);
		SUM_ACC_RIDE = CommonFuncs::dwordtowin(m_Trans_1002_2.SUM_ACC_RIDE);
		CURRENT_ACC_VALUE = CommonFuncs::dwordtowin(m_Trans_1002_2.CURRENT_ACC_VALUE);
		SUM_ACC_VALUE = CommonFuncs::dwordtowin(m_Trans_1002_2.SUM_ACC_VALUE);
		TRANS_FEE = CommonFuncs::dwordtowin(m_Trans_1002_2.TRANS_FEE);
		memset(VALID_DATE,0x00,sizeof(VALID_DATE));
		for(i = 0;i < sizeof(m_Trans_1002_2.VALID_DATE);i++)
			sprintf(VALID_DATE+2*i,"%02X",m_Trans_1002_2.VALID_DATE[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1002_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_1002_2.TRANS_TIME[i]);
		memset(LAST_TRANS_TIME,0x00,sizeof(LAST_TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1002_2.LAST_TRANS_TIME);i++)
			sprintf(LAST_TRANS_TIME+2*i,"%02X",m_Trans_1002_2.LAST_TRANS_TIME[i]);
		memset(ACC_START_TIME,0x00,sizeof(ACC_START_TIME));
		for(i = 0;i < sizeof(m_Trans_1002_2.ACC_START_TIME);i++)
			sprintf(ACC_START_TIME+2*i,"%02X",m_Trans_1002_2.ACC_START_TIME[i]);
		LAST_CARD_NBR = CommonFuncs::wordtowin(m_Trans_1002_2.LAST_CARD_NBR);
		CARD_NBR = CommonFuncs::wordtowin(m_Trans_1002_2.CARD_NBR);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_1002_2.DEVICE_TRACE_NBR);
		memset(SAM_ID,0x00,sizeof(SAM_ID));
		for(i = 0;i < sizeof(m_Trans_1002_2.SAM_ID);i++)
			sprintf(SAM_ID+2*i,"%02X",m_Trans_1002_2.SAM_ID[i]);
		SAM_NBR = CommonFuncs::dwordtowin(m_Trans_1002_2.SAM_NBR);
		memset(CRW_ID,0x00,sizeof(CRW_ID));
		for(i = 0;i < sizeof(m_Trans_1002_2.CRW_ID);i++)
			sprintf(CRW_ID+2*i,"%02X",m_Trans_1002_2.CRW_ID[i]);
		CRW_NBR = CommonFuncs::dwordtowin(m_Trans_1002_2.CRW_NBR);
		memset(TAC,0x00,sizeof(TAC));
		for(i = 0;i < sizeof(m_Trans_1002_2.TAC);i++)
			sprintf(TAC+2*i,"%02X",m_Trans_1002_2.TAC[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_1002_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_1002_2.OPERATOR_ID[i]);
		memset(RUN_MODE,0x00,sizeof(RUN_MODE));
		sprintf(RUN_MODE,"%02X",m_Trans_1002_2.RUN_MODE);
		memset(RELE_CARD_NO,0x00,sizeof(RELE_CARD_NO));
		for(i = 0;i < sizeof(m_Trans_1002_2.RELE_CARD_NO);i++)
			sprintf(RELE_CARD_NO+2*i,"%02X",m_Trans_1002_2.RELE_CARD_NO[i]);
		memset(RELE_APPLY_NO,0x00,sizeof(RELE_APPLY_NO));
		for(i = 0;i < sizeof(m_Trans_1002_2.RELE_APPLY_NO);i++)
			sprintf(RELE_APPLY_NO+2*i,"%02X",m_Trans_1002_2.RELE_APPLY_NO[i]);
		MODE_DATA = (int)m_Trans_1002_2.MODE_DATA;
		IS_TEST = (int)m_Trans_1002_2.IS_TEST;
		/* ----- 时间格式转换 ---*/
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,ACC_START_TIME);
		rtn = CTime::CheckTimeFormat(ACC_START_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,ACC_START_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,LAST_TRANS_TIME);
		rtn = CTime::CheckTimeFormat(LAST_TRANS_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,LAST_TRANS_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		/* --- 入库 ---*/
		EXEC SQL INSERT INTO TBL_TRANS_1002_SVT_TEMP(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                               LAST_STATION_NID,CARD_ID,CARD_PHY_ID,CARD_VER,ALGORITHM_FLAG,TICKET_TYPE,			
	                                               TRANS_TYPE,PAYMENT_METHOD,VALUE_TYPE,TRANS_VALUE,TRANS_RIDE,DEPOSIT,					
	                                               TRANS_POST_VALUE,TRANS_POST_RIDE,DISCOUNT,OVERDRAFT_LIMIT_VALUE,CURRENT_ACC_RIDE,SUM_ACC_RIDE,				
	                                               CURRENT_ACC_VALUE,SUM_ACC_VALUE,TRANS_FEE,VALID_DATE,TRANS_TIME,LAST_TRANS_TIME,	
	                                               ACC_START_TIME,LAST_CARD_NBR,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                               CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,RELE_CARD_NO,				
	                                               RELE_APPLY_NO,MODE_DATA,IS_TEST)
						                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
					                                     :LAST_STATION_NID,:CARD_ID,:CARD_PHY_ID,:CARD_VER,:ALGORITHM_FLAG,:TICKET_TYPE,			
					                                     :TRANS_TYPE,:PAYMENT_METHOD,:VALUE_TYPE,:TRANS_VALUE,:TRANS_RIDE,:DEPOSIT,					
					                                     :TRANS_POST_VALUE,:TRANS_POST_RIDE,:DISCOUNT,:OVERDRAFT_LIMIT_VALUE,:CURRENT_ACC_RIDE,:SUM_ACC_RIDE,				
					                                     :CURRENT_ACC_VALUE,:SUM_ACC_VALUE,:TRANS_FEE,:VALID_DATE,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),	
					                                     TO_DATE(:ACC_START_TIME,'YYYYMMDDHH24MISS'),:LAST_CARD_NBR,:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
					                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:RELE_CARD_NO,				
					                                     :RELE_APPLY_NO,:MODE_DATA,:IS_TEST);
		EXEC SQL INSERT INTO TBL_TRANS_1002_SVT(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                               LAST_STATION_NID,CARD_ID,CARD_PHY_ID,CARD_VER,ALGORITHM_FLAG,TICKET_TYPE,			
	                                               TRANS_TYPE,PAYMENT_METHOD,VALUE_TYPE,TRANS_VALUE,TRANS_RIDE,DEPOSIT,					
	                                               TRANS_POST_VALUE,TRANS_POST_RIDE,DISCOUNT,OVERDRAFT_LIMIT_VALUE,CURRENT_ACC_RIDE,SUM_ACC_RIDE,				
	                                               CURRENT_ACC_VALUE,SUM_ACC_VALUE,TRANS_FEE,VALID_DATE,TRANS_TIME,LAST_TRANS_TIME,	
	                                               ACC_START_TIME,LAST_CARD_NBR,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                               CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,RELE_CARD_NO,				
	                                               RELE_APPLY_NO,MODE_DATA,IS_TEST)
						                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
					                                     :LAST_STATION_NID,:CARD_ID,:CARD_PHY_ID,:CARD_VER,:ALGORITHM_FLAG,:TICKET_TYPE,			
					                                     :TRANS_TYPE,:PAYMENT_METHOD,:VALUE_TYPE,:TRANS_VALUE,:TRANS_RIDE,:DEPOSIT,					
					                                     :TRANS_POST_VALUE,:TRANS_POST_RIDE,:DISCOUNT,:OVERDRAFT_LIMIT_VALUE,:CURRENT_ACC_RIDE,:SUM_ACC_RIDE,				
					                                     :CURRENT_ACC_VALUE,:SUM_ACC_VALUE,:TRANS_FEE,:VALID_DATE,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),	
					                                     TO_DATE(:ACC_START_TIME,'YYYYMMDDHH24MISS'),:LAST_CARD_NBR,:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
					                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:RELE_CARD_NO,				
					                                     :RELE_APPLY_NO,:MODE_DATA,:IS_TEST);
		
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_1002(第%d条记录)ErrorCode(TBL_TRANS_1002_SVT) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			EXEC SQL INSERT INTO TBL_TRANS_1002_SVT_ERROR(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                               LAST_STATION_NID,CARD_ID,CARD_PHY_ID,CARD_VER,ALGORITHM_FLAG,TICKET_TYPE,			
	                                               TRANS_TYPE,PAYMENT_METHOD,VALUE_TYPE,TRANS_VALUE,TRANS_RIDE,DEPOSIT,					
	                                               TRANS_POST_VALUE,TRANS_POST_RIDE,DISCOUNT,OVERDRAFT_LIMIT_VALUE,CURRENT_ACC_RIDE,SUM_ACC_RIDE,				
	                                               CURRENT_ACC_VALUE,SUM_ACC_VALUE,TRANS_FEE,VALID_DATE,TRANS_TIME,LAST_TRANS_TIME,	
	                                               ACC_START_TIME,LAST_CARD_NBR,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                               CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,RELE_CARD_NO,				
	                                               RELE_APPLY_NO,MODE_DATA,IS_TEST)
						                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
					                                     :LAST_STATION_NID,:CARD_ID,:CARD_PHY_ID,:CARD_VER,:ALGORITHM_FLAG,:TICKET_TYPE,			
					                                     :TRANS_TYPE,:PAYMENT_METHOD,:VALUE_TYPE,:TRANS_VALUE,:TRANS_RIDE,:DEPOSIT,					
					                                     :TRANS_POST_VALUE,:TRANS_POST_RIDE,:DISCOUNT,:OVERDRAFT_LIMIT_VALUE,:CURRENT_ACC_RIDE,:SUM_ACC_RIDE,				
					                                     :CURRENT_ACC_VALUE,:SUM_ACC_VALUE,:TRANS_FEE,:VALID_DATE,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),	
					                                     TO_DATE(:ACC_START_TIME,'YYYYMMDDHH24MISS'),:LAST_CARD_NBR,:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
					                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:RELE_CARD_NO,				
					                                     :RELE_APPLY_NO,:MODE_DATA,:IS_TEST);
			
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_1002(第%d条记录)ErrorCode(TBL_TRANS_1002_SVT_ERROR) is %d, error message is %s\n",filename,j,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				/* ----- 写入错误文件---*/
				/*memset(errorbuf,0x00,sizeof(errorbuf));
				memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
				memcpy(errorbuf+sizeof(MsgHead),&m_Trans_1002_1,sizeof(Trans_1002_1));
				memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_1002_1),&m_Trans_1002_2,sizeof(Trans_1002_2));
				errorlen = sizeof(MsgHead)+sizeof(Trans_1002_1)+sizeof(Trans_1002_2);*/
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,(unsigned char*)&m_Trans_1002_2,sizeof(Trans_1002_2));
			}
		}  
		else
		{
			memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
			EXEC SQL SELECT TO_CHAR(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-2/24,'YYYYMMDD') INTO :TRANS_DATE FROM DUAL;
			SLOT_ID = 0;
			EXEC SQL SELECT (TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-TRUNC(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')))*86400 / 300 
				       INTO :SLOT_ID
				       FROM DUAL; 
			if(strcmp(TRANS_TYPE,"09") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1002',:TICKET_TYPE,:DEVICE_NID,1,0);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1002 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else if(strcmp(TRANS_TYPE,"0A") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1002',:TICKET_TYPE,:DEVICE_NID,0,1);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1002 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else
			{
				;
			}
		}                      
	}
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_1003(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	int             count;
	
	char 						LINE_ID[3];				/* ---  --- */
	char 						STATION_NID[5];			/* ---  --- */
	char 						DEVICE_TYPE[3];				/* ---  --- */
	char 						DEVICE_NID[9];				/* ---  --- */
	char 						LAST_DEVICE_NID[9];			/* ---  --- */
	char 						LAST_STATION_NID[5];		/* ---  --- */
	char 						CARD_ID[11];				/* ---  --- */
	char 						CARD_PHY_ID[17];			/* ---  --- */
	char 						ALGORITHM_FLAG[3];					/* ---  --- */
	char 						TICKET_TYPE[5];			/* ---  --- */
	char 						TRANS_TYPE[3];				/* ---  --- */
	char 						PAYMENT_METHOD[3];			/* ---  --- */
	unsigned int  	TRANS_VALUE;			/* ---  --- */
	unsigned int  	DEPOSIT;	/* ---  --- */
	int  	          TRANS_POST_VALUE;		/* ---  --- */
	unsigned int  	DISCOUNT;	/* ---  --- */
	unsigned int  	TRANS_FEE;				/* ---  --- */
	char 						TRANS_TIME[15];			/* ---  --- */
	char 						RELE_CARD_NO[11];			/* ---  --- */
	char 						LAST_TRANS_TIME[15];	/* ---  --- */
	unsigned short  LAST_CARD_NBR;	/* ---  --- */
	unsigned short 	CARD_NBR;		/* ---  --- */
	unsigned int  	DEVICE_TRACE_NBR;				/* ---  --- */
	char 						SAM_ID[13];				/* ---  --- */
	unsigned int  	SAM_NBR;			/* ---  --- */
	char  					CRW_ID[5];				/* ---  --- */
	unsigned int  	CRW_NBR;			/* ---  --- */
	char 						TAC[9];					/* ---  --- */
	char 						OPERATOR_ID[9];			/* ---  --- */
	char 						RUN_MODE[3];			/* ---  --- */
	int 						MODE_DATA;			/* ---  --- */
	int 						IS_TEST;				/* ---  --- */
	
	int             SLOT_ID;
	char            TRANS_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];

	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[3];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	MsgHead 					m_msghead;
	int           		i,j;
	Trans_1003_1   		m_Trans_1003_1;
	Trans_1003_2 			m_Trans_1003_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	int               rtn;
	char              tmp_time[30];
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	memset(&m_Trans_1003_1,0x00,sizeof(Trans_1003_1));
	m_Trans_1003_1 = *(Trans_1003_1 *)(recvbuf + sizeof(MsgHead));
	count = CommonFuncs::wordtowin(m_Trans_1003_1.w_Records);
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_1003_1) + count * sizeof(Trans_1003_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		

	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1003 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC,RECORD_NUM)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC,:count);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1003 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
			
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_1003_2,0x00,sizeof(Trans_1003_2));
		m_Trans_1003_2 = *(Trans_1003_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_1003_1)+sizeof(Trans_1003_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_1003_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1003_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_1003_2.STATION_NID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_1003_2.DEVICE_TYPE);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1003_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_1003_2.DEVICE_NID[i]);
		memset(LAST_DEVICE_NID,0x00,sizeof(LAST_DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1003_2.LAST_DEVICE_NID);i++)
			sprintf(LAST_DEVICE_NID+2*i,"%02X",m_Trans_1003_2.LAST_DEVICE_NID[i]);
		memset(LAST_STATION_NID,0x00,sizeof(LAST_STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1003_2.LAST_STATION_NID);i++)
			sprintf(LAST_STATION_NID+2*i,"%02X",m_Trans_1003_2.LAST_STATION_NID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_1003_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_1003_2.CARD_ID[i]);
		memset(CARD_PHY_ID,0x00,sizeof(CARD_PHY_ID));
		for(i = 0;i < sizeof(m_Trans_1003_2.CARD_PHY_ID);i++)
			sprintf(CARD_PHY_ID+2*i,"%02X",m_Trans_1003_2.CARD_PHY_ID[i]);
		memset(ALGORITHM_FLAG,0x00,sizeof(ALGORITHM_FLAG));
		sprintf(ALGORITHM_FLAG,"%02X",m_Trans_1003_2.ALGORITHM_FLAG);
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_1003_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_1003_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_1003_2.TRANS_TYPE);
		memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
		sprintf(PAYMENT_METHOD,"%02X",m_Trans_1003_2.PAYMENT_METHOD);
		TRANS_VALUE = CommonFuncs::dwordtowin(m_Trans_1003_2.TRANS_VALUE);
		DEPOSIT = CommonFuncs::dwordtowin(m_Trans_1003_2.DEPOSIT);
		TRANS_POST_VALUE = CommonFuncs::ByteToInt(m_Trans_1003_2.TRANS_POST_VALUE,sizeof(m_Trans_1003_2.TRANS_POST_VALUE));
		DISCOUNT = CommonFuncs::dwordtowin(m_Trans_1003_2.DISCOUNT);
		TRANS_FEE = CommonFuncs::dwordtowin(m_Trans_1003_2.TRANS_FEE);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1003_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_1003_2.TRANS_TIME[i]);
		memset(RELE_CARD_NO,0x00,sizeof(RELE_CARD_NO));
		for(i = 0;i < sizeof(m_Trans_1003_2.RELE_CARD_NO);i++)
			sprintf(RELE_CARD_NO+2*i,"%02X",m_Trans_1003_2.RELE_CARD_NO[i]);
		memset(LAST_TRANS_TIME,0x00,sizeof(LAST_TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1003_2.LAST_TRANS_TIME);i++)
			sprintf(LAST_TRANS_TIME+2*i,"%02X",m_Trans_1003_2.LAST_TRANS_TIME[i]);
		LAST_CARD_NBR = CommonFuncs::wordtowin(m_Trans_1003_2.LAST_CARD_NBR);
		CARD_NBR = CommonFuncs::wordtowin(m_Trans_1003_2.CARD_NBR);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_1003_2.DEVICE_TRACE_NBR);
		memset(SAM_ID,0x00,sizeof(SAM_ID));
		for(i = 0;i < sizeof(m_Trans_1003_2.SAM_ID);i++)
			sprintf(SAM_ID+2*i,"%02X",m_Trans_1003_2.SAM_ID[i]);
		SAM_NBR = CommonFuncs::dwordtowin(m_Trans_1003_2.SAM_NBR);
		memset(CRW_ID,0x00,sizeof(CRW_ID));
		for(i = 0;i < sizeof(m_Trans_1003_2.CRW_ID);i++)
			sprintf(CRW_ID+2*i,"%02X",m_Trans_1003_2.CRW_ID[i]);
		CRW_NBR = CommonFuncs::dwordtowin(m_Trans_1003_2.CRW_NBR);
		memset(TAC,0x00,sizeof(TAC));
		for(i = 0;i < sizeof(m_Trans_1003_2.TAC);i++)
			sprintf(TAC+2*i,"%02X",m_Trans_1003_2.TAC[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_1003_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_1003_2.OPERATOR_ID[i]);
		memset(RUN_MODE,0x00,sizeof(RUN_MODE));
		sprintf(RUN_MODE,"%02X",m_Trans_1003_2.RUN_MODE);
		MODE_DATA = (int)m_Trans_1003_2.MODE_DATA;
		IS_TEST = (int)m_Trans_1003_2.IS_TEST;
		/* ----- 时间格式转换 ---*/
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,LAST_TRANS_TIME);
		rtn = CTime::CheckTimeFormat(LAST_TRANS_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,LAST_TRANS_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		/* --- 入库 ---*/
		EXEC SQL INSERT INTO TBL_TRANS_1003_PERL_TEMP(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                               LAST_STATION_NID,CARD_ID,CARD_PHY_ID,ALGORITHM_FLAG,TICKET_TYPE,			
	                                               TRANS_TYPE,PAYMENT_METHOD,TRANS_VALUE,DEPOSIT,					
	                                               TRANS_POST_VALUE,DISCOUNT,				
	                                               TRANS_FEE,TRANS_TIME,RELE_CARD_NO,LAST_TRANS_TIME,	
	                                               LAST_CARD_NBR,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                               CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,MODE_DATA,IS_TEST)
						                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
					                                     :LAST_STATION_NID,:CARD_ID,:CARD_PHY_ID,:ALGORITHM_FLAG,:TICKET_TYPE,			
					                                     :TRANS_TYPE,:PAYMENT_METHOD,:TRANS_VALUE,:DEPOSIT,					
					                                     :TRANS_POST_VALUE,:DISCOUNT,				
					                                     :TRANS_FEE,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),:RELE_CARD_NO,TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),	
					                                     :LAST_CARD_NBR,:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
					                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:MODE_DATA,:IS_TEST);
		EXEC SQL INSERT INTO TBL_TRANS_1003_PERL(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                               LAST_STATION_NID,CARD_ID,CARD_PHY_ID,ALGORITHM_FLAG,TICKET_TYPE,			
	                                               TRANS_TYPE,PAYMENT_METHOD,TRANS_VALUE,DEPOSIT,					
	                                               TRANS_POST_VALUE,DISCOUNT,				
	                                               TRANS_FEE,TRANS_TIME,RELE_CARD_NO,LAST_TRANS_TIME,	
	                                               LAST_CARD_NBR,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                               CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,MODE_DATA,IS_TEST)
						                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
					                                     :LAST_STATION_NID,:CARD_ID,:CARD_PHY_ID,:ALGORITHM_FLAG,:TICKET_TYPE,			
					                                     :TRANS_TYPE,:PAYMENT_METHOD,:TRANS_VALUE,:DEPOSIT,					
					                                     :TRANS_POST_VALUE,:DISCOUNT,				
					                                     :TRANS_FEE,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),:RELE_CARD_NO,TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),	
					                                     :LAST_CARD_NBR,:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
					                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:MODE_DATA,:IS_TEST);
		
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:TRANS_TIME(%s),LAST_TRANS_TIME(%s)\n",filename,TRANS_TIME,LAST_TRANS_TIME);
			CLog::WriteAppLog(oplogmsg);
		
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_1003(第%d条记录)ErrorCode(TBL_TRANS_1003_PERL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			EXEC SQL INSERT INTO TBL_TRANS_1003_PERL_ERROR(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,LAST_DEVICE_NID,			
	                                               LAST_STATION_NID,CARD_ID,CARD_PHY_ID,ALGORITHM_FLAG,TICKET_TYPE,			
	                                               TRANS_TYPE,PAYMENT_METHOD,TRANS_VALUE,DEPOSIT,					
	                                               TRANS_POST_VALUE,DISCOUNT,				
	                                               TRANS_FEE,TRANS_TIME,RELE_CARD_NO,LAST_TRANS_TIME,	
	                                               LAST_CARD_NBR,CARD_NBR,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,			
	                                               CRW_ID,CRW_NBR,TAC,OPERATOR_ID,RUN_MODE,MODE_DATA,IS_TEST)
						                            VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:LAST_DEVICE_NID,			
					                                     :LAST_STATION_NID,:CARD_ID,:CARD_PHY_ID,:ALGORITHM_FLAG,:TICKET_TYPE,			
					                                     :TRANS_TYPE,:PAYMENT_METHOD,:TRANS_VALUE,:DEPOSIT,					
					                                     :TRANS_POST_VALUE,:DISCOUNT,				
					                                     :TRANS_FEE,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),:RELE_CARD_NO,TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),	
					                                     :LAST_CARD_NBR,:CARD_NBR,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,			
					                                     :CRW_ID,:CRW_NBR,:TAC,:OPERATOR_ID,:RUN_MODE,:MODE_DATA,:IS_TEST);
			
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_1003(第%d条记录)ErrorCode(TBL_TRANS_1003_PERL_ERROR) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				/* ----- 写入错误文件---*/
				/*memset(errorbuf,0x00,sizeof(errorbuf));
				memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
				memcpy(errorbuf+sizeof(MsgHead),&m_Trans_1003_1,sizeof(Trans_1003_1));
				memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_1003_1),&m_Trans_1003_2,sizeof(Trans_1003_2));
				errorlen = sizeof(MsgHead)+sizeof(Trans_1003_1)+sizeof(Trans_1003_2);*/
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,(unsigned char*)&m_Trans_1003_2,sizeof(Trans_1003_2));
			}
		} 
		else
		{
			memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
			EXEC SQL SELECT TO_CHAR(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-2/24,'YYYYMMDD') INTO :TRANS_DATE FROM DUAL;
			SLOT_ID = 0;
			EXEC SQL SELECT (TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-TRUNC(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')))*86400 / 300 
				       INTO :SLOT_ID
				       FROM DUAL; 
			if(strcmp(TRANS_TYPE,"09") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1003',:TICKET_TYPE,:DEVICE_NID,1,0);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1003 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else if(strcmp(TRANS_TYPE,"0A") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1003',:TICKET_TYPE,:DEVICE_NID,0,1);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1003 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else
			{
				;
			}
		}                       
	}
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_1004(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	int             count;
	
	char 						LINE_ID[3];				/* ---  --- */
	char 						STATION_NID[5];			/* ---  --- */
	char 						DEVICE_TYPE[3];				/* ---  --- */
	char 						DEVICE_NID[9];				/* ---  --- */
	char 						LAST_DEVICE_NID[9];			/* ---  --- */
	char 						LAST_STATION_NID[5];		/* ---  --- */
	char 						ACCOUNT_NBR[5];			/* ---  --- */
	char 						BUSINESS_ID[3];			/* ---  --- */
	char 						ACCOUNT_NO[21];				/* ---  --- */
	char 						CHARGING_METHOD[3];			/* ---  --- */
	int           	ENTRY_EXIT_FLAG;			/* ---  --- */
	char 						TICKET_TYPE[5];			/* ---  --- */
	char 						TRANS_TYPE[3];				/* ---  --- */
	char 						PAYMENT_METHOD[3];			/* ---  --- */
	unsigned int  	TRANS_VALUE;			/* ---  --- */
	char            VALID_DATE[5];	/* ---  --- */
	int  	          ODA35_LEN;	/* ---  --- */
	char 						TRANS_TIME[15];			/* ---  --- */
	char 						LAST_TRANS_TIME[15];	/* ---  --- */
	int           	ODA55_LEN;		/* ---  --- */
	char            DEVICE_TRACE_NBR[17];				/* ---  --- */
	char 						SAM_ID[13];				/* ---  --- */
	unsigned int  	SAM_NBR;			/* ---  --- */
	char  					CRW_ID[5];				/* ---  --- */
	unsigned int  	CRW_NBR;			/* ---  --- */
	char 						ODA35[41];					/* ---  --- */
	char 						OPERATOR_ID[9];			/* ---  --- */
	char 						RUN_MODE[3];			/* ---  --- */
	int 						MODE_DATA;			/* ---  --- */
	char 						AUTHENTICATION_FLAG[3];				/* ---  --- */
	char 						PLATFORM_TRACE_NBR[19];				/* ---  --- */
	char            ODA55[249];			/* ---  --- */
	
	int             SLOT_ID;
	char            TRANS_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j;
	Trans_1004_1   		m_Trans_1004_1;
	Trans_1004_2 			m_Trans_1004_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	int               rtn;
	char              tmp_time[30];
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	memset(&m_Trans_1004_1,0x00,sizeof(Trans_1004_1));
	m_Trans_1004_1 = *(Trans_1004_1 *)(recvbuf + sizeof(MsgHead));
	count = CommonFuncs::wordtowin(m_Trans_1004_1.w_Records);
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_1004_1) + count * sizeof(Trans_1004_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[4];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1004 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC,RECORD_NUM)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
												                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC,:count);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1004 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
			
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_1004_2,0x00,sizeof(Trans_1004_2));
		m_Trans_1004_2 = *(Trans_1004_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_1004_1)+sizeof(Trans_1004_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_1004_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1004_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_1004_2.STATION_NID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_1004_2.DEVICE_TYPE);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1004_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_1004_2.DEVICE_NID[i]);
		memset(LAST_DEVICE_NID,0x00,sizeof(LAST_DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1004_2.LAST_DEVICE_NID);i++)
			sprintf(LAST_DEVICE_NID+2*i,"%02X",m_Trans_1004_2.LAST_DEVICE_NID[i]);
		memset(LAST_STATION_NID,0x00,sizeof(LAST_STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1004_2.LAST_STATION_NID);i++)
			sprintf(LAST_STATION_NID+2*i,"%02X",m_Trans_1004_2.LAST_STATION_NID[i]);
		memset(ACCOUNT_NBR,0x00,sizeof(ACCOUNT_NBR));
		for(i = 0;i < sizeof(m_Trans_1004_2.ACCOUNT_NBR);i++)
			sprintf(ACCOUNT_NBR+2*i,"%02X",m_Trans_1004_2.ACCOUNT_NBR[i]);
		memset(BUSINESS_ID,0x00,sizeof(BUSINESS_ID));
		sprintf(BUSINESS_ID,"%02X",m_Trans_1004_2.BUSINESS_ID);
		memset(ACCOUNT_NO,0x00,sizeof(ACCOUNT_NO));
		for(i = 0;i < sizeof(m_Trans_1004_2.ACCOUNT_NO);i++)
			sprintf(ACCOUNT_NO+2*i,"%02X",m_Trans_1004_2.ACCOUNT_NO[i]);
		memset(CHARGING_METHOD,0x00,sizeof(CHARGING_METHOD));
		sprintf(CHARGING_METHOD,"%02X",m_Trans_1004_2.CHARGING_METHOD);
		ENTRY_EXIT_FLAG = (int)m_Trans_1004_2.ENTRY_EXIT_FLAG;
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_1004_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_1004_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_1004_2.TRANS_TYPE);
		memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
		sprintf(PAYMENT_METHOD,"%02X",m_Trans_1004_2.PAYMENT_METHOD);
		TRANS_VALUE = CommonFuncs::dwordtowin(m_Trans_1004_2.TRANS_VALUE);
		memset(VALID_DATE,0x00,sizeof(VALID_DATE));
		for(i = 0;i < sizeof(m_Trans_1004_2.VALID_DATE);i++)
			sprintf(VALID_DATE+2*i,"%02X",m_Trans_1004_2.VALID_DATE[i]);
		ODA35_LEN = (int)m_Trans_1004_2.ODA35_LEN;
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1004_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_1004_2.TRANS_TIME[i]);
		memset(LAST_TRANS_TIME,0x00,sizeof(LAST_TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1004_2.LAST_TRANS_TIME);i++)
			sprintf(LAST_TRANS_TIME+2*i,"%02X",m_Trans_1004_2.LAST_TRANS_TIME[i]);
		ODA55_LEN = (int)m_Trans_1004_2.ODA55_LEN;
		memset(DEVICE_TRACE_NBR,0x00,sizeof(DEVICE_TRACE_NBR));
		for(i = 0;i < sizeof(m_Trans_1004_2.DEVICE_TRACE_NBR);i++)
			sprintf(DEVICE_TRACE_NBR+2*i,"%02X",m_Trans_1004_2.DEVICE_TRACE_NBR[i]);
		memset(SAM_ID,0x00,sizeof(SAM_ID));
		for(i = 0;i < sizeof(m_Trans_1004_2.SAM_ID);i++)
			sprintf(SAM_ID+2*i,"%02X",m_Trans_1004_2.SAM_ID[i]);
		SAM_NBR = CommonFuncs::dwordtowin(m_Trans_1004_2.SAM_NBR);
		memset(CRW_ID,0x00,sizeof(CRW_ID));
		for(i = 0;i < sizeof(m_Trans_1004_2.CRW_ID);i++)
			sprintf(CRW_ID+2*i,"%02X",m_Trans_1004_2.CRW_ID[i]);
		CRW_NBR = CommonFuncs::dwordtowin(m_Trans_1004_2.CRW_NBR);
		memset(ODA35,0x00,sizeof(ODA35));
		for(i = 0;i < sizeof(m_Trans_1004_2.ODA35);i++)
			sprintf(ODA35+2*i,"%02X",m_Trans_1004_2.ODA35[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_1004_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_1004_2.OPERATOR_ID[i]);
		memset(RUN_MODE,0x00,sizeof(RUN_MODE));
		sprintf(RUN_MODE,"%02X",m_Trans_1004_2.RUN_MODE);
		MODE_DATA = (int)m_Trans_1004_2.MODE_DATA;
		memset(AUTHENTICATION_FLAG,0x00,sizeof(AUTHENTICATION_FLAG));
		sprintf(AUTHENTICATION_FLAG,"%02X",m_Trans_1004_2.AUTHENTICATION_FLAG);
		memset(PLATFORM_TRACE_NBR,0x00,sizeof(PLATFORM_TRACE_NBR));
		for(i = 0;i < sizeof(m_Trans_1004_2.PLATFORM_TRACE_NBR);i++)
			sprintf(PLATFORM_TRACE_NBR+2*i,"%02X",m_Trans_1004_2.PLATFORM_TRACE_NBR[i]);
		memset(ODA55,0x00,sizeof(ODA55));
		for(i = 0;i < sizeof(m_Trans_1004_2.ODA55);i++)
			sprintf(ODA55+2*i,"%02X",m_Trans_1004_2.ODA55[i]);
		/* ----- 时间格式转换 ---*/
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,LAST_TRANS_TIME);
		rtn = CTime::CheckTimeFormat(LAST_TRANS_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,LAST_TRANS_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		/* --- 入库 ---*/
		EXEC SQL INSERT INTO TBL_TRANS_1004_UNION_PAY_TEMP(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                   LAST_DEVICE_NID,LAST_STATION_NID,ACCOUNT_NBR,BUSINESS_ID,ACCOUNT_NO,
		                                                   CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                   TRANS_VALUE,VALID_DATE,ODA35_LEN,	
	                                                     TRANS_TIME,LAST_TRANS_TIME,
	                                                     ODA55_LEN,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,ODA55,			
	                                                     CRW_ID,CRW_NBR,ODA35,OPERATOR_ID,RUN_MODE,
	                                                     MODE_DATA,AUTHENTICATION_FLAG,PLATFORM_TRACE_NBR,
	                                                     DEVICE_TRACE_NBR_INT)
		                                           VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                                  :LAST_DEVICE_NID,:LAST_STATION_NID,:ACCOUNT_NBR,:BUSINESS_ID,:ACCOUNT_NO,
		                                                  :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                                  :TRANS_VALUE,:VALID_DATE,:ODA35_LEN,	
	                                                    TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                    :ODA55_LEN,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:ODA55,			
	                                                    :CRW_ID,:CRW_NBR,:ODA35,:OPERATOR_ID,:RUN_MODE,
	                                                    :MODE_DATA,:AUTHENTICATION_FLAG,:PLATFORM_TRACE_NBR,
	                                                    TO_NUMBER(:DEVICE_TRACE_NBR));
	                                                    //TO_NUMBER(:DEVICE_TRACE_NBR,'XXXXXXXXXXXXXXXX')
		EXEC SQL INSERT INTO TBL_TRANS_1004_UNION_PAY(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                   LAST_DEVICE_NID,LAST_STATION_NID,ACCOUNT_NBR,BUSINESS_ID,ACCOUNT_NO,
		                                                   CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                   TRANS_VALUE,VALID_DATE,ODA35_LEN,	
	                                                     TRANS_TIME,LAST_TRANS_TIME,
	                                                     ODA55_LEN,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,ODA55,			
	                                                     CRW_ID,CRW_NBR,ODA35,OPERATOR_ID,RUN_MODE,
	                                                     MODE_DATA,AUTHENTICATION_FLAG,PLATFORM_TRACE_NBR,
	                                                     DEVICE_TRACE_NBR_INT)
		                                           VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                                  :LAST_DEVICE_NID,:LAST_STATION_NID,:ACCOUNT_NBR,:BUSINESS_ID,:ACCOUNT_NO,
		                                                  :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                                  :TRANS_VALUE,:VALID_DATE,:ODA35_LEN,	
	                                                    TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                    :ODA55_LEN,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:ODA55,			
	                                                    :CRW_ID,:CRW_NBR,:ODA35,:OPERATOR_ID,:RUN_MODE,
	                                                    :MODE_DATA,:AUTHENTICATION_FLAG,:PLATFORM_TRACE_NBR,
	                                                    TO_NUMBER(:DEVICE_TRACE_NBR));
		
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_1004(第%d条记录)ErrorCode(TBL_TRANS_1004_UNION_PAY) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			EXEC SQL INSERT INTO TBL_TRANS_1004_UNION_PAY_ERROR(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                   LAST_DEVICE_NID,LAST_STATION_NID,ACCOUNT_NBR,BUSINESS_ID,ACCOUNT_NO,
		                                                   CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                   TRANS_VALUE,VALID_DATE,ODA35_LEN,	
	                                                     TRANS_TIME,LAST_TRANS_TIME,
	                                                     ODA55_LEN,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,ODA55,			
	                                                     CRW_ID,CRW_NBR,ODA35,OPERATOR_ID,RUN_MODE,
	                                                     MODE_DATA,AUTHENTICATION_FLAG,PLATFORM_TRACE_NBR,
	                                                     DEVICE_TRACE_NBR_INT)
		                                           VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                                  :LAST_DEVICE_NID,:LAST_STATION_NID,:ACCOUNT_NBR,:BUSINESS_ID,:ACCOUNT_NO,
		                                                  :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                                  :TRANS_VALUE,:VALID_DATE,:ODA35_LEN,	
	                                                    TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                    :ODA55_LEN,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:ODA55,			
	                                                    :CRW_ID,:CRW_NBR,:ODA35,:OPERATOR_ID,:RUN_MODE,
	                                                    :MODE_DATA,:AUTHENTICATION_FLAG,:PLATFORM_TRACE_NBR,
	                                                    TO_NUMBER(:DEVICE_TRACE_NBR));
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_1004(第%d条记录)ErrorCode(TBL_TRANS_1004_UNION_PAY_ERROR) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				/* ----- 写入错误文件---*/
				/*memset(errorbuf,0x00,sizeof(errorbuf));
				memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
				memcpy(errorbuf+sizeof(MsgHead),&m_Trans_1004_1,sizeof(Trans_1004_1));
				memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_1004_1),&m_Trans_1004_2,sizeof(Trans_1004_2));
				errorlen = sizeof(MsgHead)+sizeof(Trans_1004_1)+sizeof(Trans_1004_2);*/
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,(unsigned char*)&m_Trans_1004_2,sizeof(Trans_1004_2));
			}
		} 
		else
		{
			memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
			EXEC SQL SELECT TO_CHAR(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-2/24,'YYYYMMDD') INTO :TRANS_DATE FROM DUAL;
			SLOT_ID = 0;
			EXEC SQL SELECT (TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-TRUNC(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')))*86400 / 300 
				       INTO :SLOT_ID
				       FROM DUAL; 
			if(strcmp(TRANS_TYPE,"09") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1004',:TICKET_TYPE,:DEVICE_NID,1,0);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1004 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else if(strcmp(TRANS_TYPE,"0A") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1004',:TICKET_TYPE,:DEVICE_NID,0,1);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1004 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else
			{
				;
			}
		}                       
	}
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_1005(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	int             count;
	
	char 						LINE_ID[3];				/* ---  --- */
	char 						STATION_NID[5];			/* ---  --- */
	char 						DEVICE_TYPE[3];				/* ---  --- */
	char 						DEVICE_NID[9];				/* ---  --- */
	char 						LAST_DEVICE_NID[9];			/* ---  --- */
	char 						LAST_STATION_NID[5];		/* ---  --- */
	char 						MECHANISM_ID[9];			/* ---  --- */
	char 						INDUSTRY_RANGE[5];			/* ---  --- */
	char 						QR_ID[17];				/* ---  --- */
	char 						CHARGING_METHOD[3];			/* ---  --- */
	int           	ENTRY_EXIT_FLAG;			/* ---  --- */
	char 						TICKET_TYPE[5];			/* ---  --- */
	char 						TRANS_TYPE[3];				/* ---  --- */
	char 						PAYMENT_METHOD[3];			/* ---  --- */
	unsigned int  	TRANS_VALUE;			/* ---  --- */
	char            QR_VALID_DATE[15];	/* ---  --- */
	int  	          ENTRY_EXIT_LIMIT;	/* ---  --- */
	char 						TRANS_TIME[15];			/* ---  --- */
	char 						LAST_TRANS_TIME[15];	/* ---  --- */
	char           	BUSINESS_ID[3];		/* ---  --- */
	char            DEVICE_TRACE_NBR[17];				/* ---  --- */
	char 						SAM_ID[13];				/* ---  --- */
	unsigned int  	SAM_NBR;			/* ---  --- */
	char  					CRW_ID[5];				/* ---  --- */
	unsigned int  	CRW_NBR;			/* ---  --- */
	char 						APP_ID[17];					/* ---  --- */
	char 						OPERATOR_ID[9];			/* ---  --- */
	char 						RUN_MODE[3];			/* ---  --- */
	int 						MODE_DATA;			/* ---  --- */
	char 						USER_ID[17];				/* ---  --- */
	char 						QR_CREATE_DATE[15];				/* ---  --- */
	char            JOURNEY_ID[17];			/* ---  --- */
	
	int             SLOT_ID;
	char            TRANS_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j;
	Trans_1005_1   		m_Trans_1005_1;
	Trans_1005_2 			m_Trans_1005_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	int               rtn;
	char              tmp_time[30];
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	memset(&m_Trans_1005_1,0x00,sizeof(Trans_1005_1));
	m_Trans_1005_1 = *(Trans_1005_1 *)(recvbuf + sizeof(MsgHead));
	count = CommonFuncs::wordtowin(m_Trans_1005_1.w_Records);
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_1005_1) + count * sizeof(Trans_1005_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[5];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1005 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC,RECORD_NUM)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC,:count);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1005 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
			
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_1005_2,0x00,sizeof(Trans_1005_2));
		m_Trans_1005_2 = *(Trans_1005_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_1005_1)+sizeof(Trans_1005_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_1005_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1005_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_1005_2.STATION_NID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_1005_2.DEVICE_TYPE);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1005_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_1005_2.DEVICE_NID[i]);
		memset(LAST_DEVICE_NID,0x00,sizeof(LAST_DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1005_2.LAST_DEVICE_NID);i++)
			sprintf(LAST_DEVICE_NID+2*i,"%02X",m_Trans_1005_2.LAST_DEVICE_NID[i]);
		memset(LAST_STATION_NID,0x00,sizeof(LAST_STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1005_2.LAST_STATION_NID);i++)
			sprintf(LAST_STATION_NID+2*i,"%02X",m_Trans_1005_2.LAST_STATION_NID[i]);
		memset(MECHANISM_ID,0x00,sizeof(MECHANISM_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.MECHANISM_ID);i++)
			sprintf(MECHANISM_ID+2*i,"%02X",m_Trans_1005_2.MECHANISM_ID[i]);
		memset(INDUSTRY_RANGE,0x00,sizeof(INDUSTRY_RANGE));
		for(i = 0;i < sizeof(m_Trans_1005_2.INDUSTRY_RANGE);i++)
			sprintf(INDUSTRY_RANGE+2*i,"%02X",m_Trans_1005_2.INDUSTRY_RANGE[i]);
		memset(QR_ID,0x00,sizeof(QR_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.QR_ID);i++)
			sprintf(QR_ID+2*i,"%02X",m_Trans_1005_2.QR_ID[i]);
		memset(CHARGING_METHOD,0x00,sizeof(CHARGING_METHOD));
		sprintf(CHARGING_METHOD,"%02X",m_Trans_1005_2.CHARGING_METHOD);
		ENTRY_EXIT_FLAG = (int)m_Trans_1005_2.ENTRY_EXIT_FLAG;
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_1005_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_1005_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_1005_2.TRANS_TYPE);
		memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
		sprintf(PAYMENT_METHOD,"%02X",m_Trans_1005_2.PAYMENT_METHOD);
		TRANS_VALUE = CommonFuncs::dwordtowin(m_Trans_1005_2.TRANS_VALUE);
		memset(QR_VALID_DATE,0x00,sizeof(QR_VALID_DATE));
		for(i = 0;i < sizeof(m_Trans_1005_2.QR_VALID_DATE);i++)
			sprintf(QR_VALID_DATE+2*i,"%02X",m_Trans_1005_2.QR_VALID_DATE[i]);
		ENTRY_EXIT_LIMIT = (int)m_Trans_1005_2.ENTRY_EXIT_LIMIT;
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1005_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_1005_2.TRANS_TIME[i]);
		memset(LAST_TRANS_TIME,0x00,sizeof(LAST_TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1005_2.LAST_TRANS_TIME);i++)
			sprintf(LAST_TRANS_TIME+2*i,"%02X",m_Trans_1005_2.LAST_TRANS_TIME[i]);
		memset(BUSINESS_ID,0x00,sizeof(BUSINESS_ID));
		sprintf(BUSINESS_ID,"%02X",m_Trans_1005_2.BUSINESS_ID);
		memset(DEVICE_TRACE_NBR,0x00,sizeof(DEVICE_TRACE_NBR));
		for(i = 0;i < sizeof(m_Trans_1005_2.DEVICE_TRACE_NBR);i++)
			sprintf(DEVICE_TRACE_NBR+2*i,"%02X",m_Trans_1005_2.DEVICE_TRACE_NBR[i]);
		memset(SAM_ID,0x00,sizeof(SAM_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.SAM_ID);i++)
			sprintf(SAM_ID+2*i,"%02X",m_Trans_1005_2.SAM_ID[i]);
		SAM_NBR = CommonFuncs::dwordtowin(m_Trans_1005_2.SAM_NBR);
		memset(CRW_ID,0x00,sizeof(CRW_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.CRW_ID);i++)
			sprintf(CRW_ID+2*i,"%02X",m_Trans_1005_2.CRW_ID[i]);
		CRW_NBR = CommonFuncs::dwordtowin(m_Trans_1005_2.CRW_NBR);
		memset(APP_ID,0x00,sizeof(APP_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.APP_ID);i++)
			sprintf(APP_ID+2*i,"%02X",m_Trans_1005_2.APP_ID[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_1005_2.OPERATOR_ID[i]);
		memset(RUN_MODE,0x00,sizeof(RUN_MODE));
		sprintf(RUN_MODE,"%02X",m_Trans_1005_2.RUN_MODE);
		MODE_DATA = (int)m_Trans_1005_2.MODE_DATA;
		memset(USER_ID,0x00,sizeof(USER_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.USER_ID);i++)
			sprintf(USER_ID+2*i,"%02X",m_Trans_1005_2.USER_ID[i]);
		memset(QR_CREATE_DATE,0x00,sizeof(QR_CREATE_DATE));
		for(i = 0;i < sizeof(m_Trans_1005_2.QR_CREATE_DATE);i++)
			sprintf(QR_CREATE_DATE+2*i,"%02X",m_Trans_1005_2.QR_CREATE_DATE[i]);
		memset(JOURNEY_ID,0x00,sizeof(JOURNEY_ID));
		for(i = 0;i < sizeof(m_Trans_1005_2.JOURNEY_ID);i++)
			sprintf(JOURNEY_ID+2*i,"%02X",m_Trans_1005_2.JOURNEY_ID[i]);
		/* ----- 时间格式转换 ---*/
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,LAST_TRANS_TIME);
		rtn = CTime::CheckTimeFormat(LAST_TRANS_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,LAST_TRANS_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		/* --- 入库 ---*/
		EXEC SQL INSERT INTO TBL_TRANS_1005_QR_PAY_TEMP(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                LAST_DEVICE_NID,LAST_STATION_NID,MECHANISM_ID,INDUSTRY_RANGE,QR_ID,
		                                                CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                TRANS_VALUE,QR_VALID_DATE,ENTRY_EXIT_LIMIT,	
	                                                  TRANS_TIME,LAST_TRANS_TIME,
	                                                  BUSINESS_ID,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,JOURNEY_ID,			
	                                                  CRW_ID,CRW_NBR,APP_ID,OPERATOR_ID,RUN_MODE,
	                                                  MODE_DATA,USER_ID,QR_CREATE_DATE,
	                                                  DEVICE_TRACE_NBR_INT)
		                                        VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                               :LAST_DEVICE_NID,:LAST_STATION_NID,:MECHANISM_ID,:INDUSTRY_RANGE,:QR_ID,
		                                               :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                               :TRANS_VALUE,:QR_VALID_DATE,:ENTRY_EXIT_LIMIT,	
	                                                 TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                 :BUSINESS_ID,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:JOURNEY_ID,			
	                                                 :CRW_ID,:CRW_NBR,:APP_ID,:OPERATOR_ID,:RUN_MODE,
	                                                 :MODE_DATA,:USER_ID,:QR_CREATE_DATE,
	                                                 TO_NUMBER(:DEVICE_TRACE_NBR));
		EXEC SQL INSERT INTO TBL_TRANS_1005_QR_PAY(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                LAST_DEVICE_NID,LAST_STATION_NID,MECHANISM_ID,INDUSTRY_RANGE,QR_ID,
		                                                CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                TRANS_VALUE,QR_VALID_DATE,ENTRY_EXIT_LIMIT,	
	                                                  TRANS_TIME,LAST_TRANS_TIME,
	                                                  BUSINESS_ID,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,JOURNEY_ID,			
	                                                  CRW_ID,CRW_NBR,APP_ID,OPERATOR_ID,RUN_MODE,
	                                                  MODE_DATA,USER_ID,QR_CREATE_DATE,
	                                                  DEVICE_TRACE_NBR_INT)
		                                        VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                               :LAST_DEVICE_NID,:LAST_STATION_NID,:MECHANISM_ID,:INDUSTRY_RANGE,:QR_ID,
		                                               :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                               :TRANS_VALUE,:QR_VALID_DATE,:ENTRY_EXIT_LIMIT,	
	                                                 TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                 :BUSINESS_ID,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:JOURNEY_ID,			
	                                                 :CRW_ID,:CRW_NBR,:APP_ID,:OPERATOR_ID,:RUN_MODE,
	                                                 :MODE_DATA,:USER_ID,:QR_CREATE_DATE,
	                                                 TO_NUMBER(:DEVICE_TRACE_NBR));
		
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_1005(第%d条记录)ErrorCode(TBL_TRANS_1005_QR_PAY) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			EXEC SQL INSERT INTO TBL_TRANS_1005_QR_PAY_ERROR(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                LAST_DEVICE_NID,LAST_STATION_NID,MECHANISM_ID,INDUSTRY_RANGE,QR_ID,
		                                                CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                TRANS_VALUE,QR_VALID_DATE,ENTRY_EXIT_LIMIT,	
	                                                  TRANS_TIME,LAST_TRANS_TIME,
	                                                  BUSINESS_ID,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,JOURNEY_ID,			
	                                                  CRW_ID,CRW_NBR,APP_ID,OPERATOR_ID,RUN_MODE,
	                                                  MODE_DATA,USER_ID,QR_CREATE_DATE,
	                                                  DEVICE_TRACE_NBR_INT)
		                                        VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                               :LAST_DEVICE_NID,:LAST_STATION_NID,:MECHANISM_ID,:INDUSTRY_RANGE,:QR_ID,
		                                               :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                               :TRANS_VALUE,:QR_VALID_DATE,:ENTRY_EXIT_LIMIT,	
	                                                 TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                 :BUSINESS_ID,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:JOURNEY_ID,			
	                                                 :CRW_ID,:CRW_NBR,:APP_ID,:OPERATOR_ID,:RUN_MODE,
	                                                 :MODE_DATA,:USER_ID,:QR_CREATE_DATE,
	                                                 TO_NUMBER(:DEVICE_TRACE_NBR));
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_1005(第%d条记录)ErrorCode(TBL_TRANS_1005_QR_PAY_ERROR) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				/* ----- 写入错误文件---*/
				/*memset(errorbuf,0x00,sizeof(errorbuf));
				memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
				memcpy(errorbuf+sizeof(MsgHead),&m_Trans_1005_1,sizeof(Trans_1005_1));
				memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_1005_1),&m_Trans_1005_2,sizeof(Trans_1005_2));
				errorlen = sizeof(MsgHead)+sizeof(Trans_1005_1)+sizeof(Trans_1005_2);*/
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,(unsigned char*)&m_Trans_1005_2,sizeof(Trans_1005_2));
			}
		} 
		else
		{
			memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
			EXEC SQL SELECT TO_CHAR(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-2/24,'YYYYMMDD') INTO :TRANS_DATE FROM DUAL;
			SLOT_ID = 0;
			EXEC SQL SELECT (TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-TRUNC(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')))*86400 / 300 
				       INTO :SLOT_ID
				       FROM DUAL; 
			if(strcmp(TRANS_TYPE,"09") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1005',:TICKET_TYPE,:DEVICE_NID,1,0);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1005 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else if(strcmp(TRANS_TYPE,"0A") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:SLOT_ID,:LINE_ID,:STATION_NID,
                                                 '1005',:TICKET_TYPE,:DEVICE_NID,0,1);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1005 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else
			{
				;
			}
		}                       
	}
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}


/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_1006(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	int             count;
	
	char 						LINE_ID[3];				/* ---  --- */
	char 						STATION_NID[5];			/* ---  --- */
	char 						DEVICE_TYPE[3];				/* ---  --- */
	char 						DEVICE_NID[9];				/* ---  --- */
	char 						LAST_DEVICE_NID[9];			/* ---  --- */
	char 						LAST_STATION_NID[5];		/* ---  --- */
	char 						MECHANISM_ID[9];			/* ---  --- */
	char 						QR_ID[17];				/* ---  --- */
	char 						CHARGING_METHOD[3];			/* ---  --- */
	int           	ENTRY_EXIT_FLAG;			/* ---  --- */
	char 						TICKET_TYPE[5];			/* ---  --- */
	char 						TRANS_TYPE[3];				/* ---  --- */
	char 						PAYMENT_METHOD[3];			/* ---  --- */
	unsigned int  	TRANS_VALUE;			/* ---  --- */
	char            QR_VALID_DATE[15];	/* ---  --- */
	char 						TRANS_TIME[15];			/* ---  --- */
	char 						LAST_TRANS_TIME[15];	/* ---  --- */
	char           	BUSINESS_ID[3];		/* ---  --- */
	char            DEVICE_TRACE_NBR[17];				/* ---  --- */
	unsigned int    DEVICE_TRACE_NBR_INT;
	char 						SAM_ID[13];				/* ---  --- */
	unsigned int  	SAM_NBR;			/* ---  --- */
	char  					CRW_ID[5];				/* ---  --- */
	unsigned int  	CRW_NBR;			/* ---  --- */
	char 						OPERATOR_ID[9];			/* ---  --- */
	char 						RUN_MODE[3];			/* ---  --- */
	int 						MODE_DATA;			/* ---  --- */
	char 						USER_ID[21];				/* ---  --- */
	char 						QR_CREATE_DATE[15];				/* ---  --- */
	char            JOURNEY_ID[17];			/* ---  --- */
	
	int             SLOT_ID;
	char            TRANS_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	MsgHead 					m_msghead;
	int           		i,j;
	Trans_1006_1   		m_Trans_1006_1;
	Trans_1006_2 			m_Trans_1006_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	int               rtn;
	char              tmp_time[30];

	char oplogmsg[1024];
		
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
		
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	  = CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	memset(&m_Trans_1006_1,0x00,sizeof(Trans_1006_1));
	m_Trans_1006_1 = *(Trans_1006_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_1006_1.w_Records);
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_1006_1) + count * sizeof(Trans_1006_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[6];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1006 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC,RECORD_NUM)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC,:count);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_1006 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
			
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_1006_2,0x00,sizeof(Trans_1006_2));
		m_Trans_1006_2 = *(Trans_1006_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_1006_1)+sizeof(Trans_1006_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_1006_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1006_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_1006_2.STATION_NID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_1006_2.DEVICE_TYPE);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1006_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_1006_2.DEVICE_NID[i]);
		memset(LAST_DEVICE_NID,0x00,sizeof(LAST_DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_1006_2.LAST_DEVICE_NID);i++)
			sprintf(LAST_DEVICE_NID+2*i,"%02X",m_Trans_1006_2.LAST_DEVICE_NID[i]);
		memset(LAST_STATION_NID,0x00,sizeof(LAST_STATION_NID));
		for(i = 0;i < sizeof(m_Trans_1006_2.LAST_STATION_NID);i++)
			sprintf(LAST_STATION_NID+2*i,"%02X",m_Trans_1006_2.LAST_STATION_NID[i]);
		memset(MECHANISM_ID,0x00,sizeof(MECHANISM_ID));
		for(i = 0;i < sizeof(m_Trans_1006_2.MECHANISM_ID);i++)
			sprintf(MECHANISM_ID+2*i,"%02X",m_Trans_1006_2.MECHANISM_ID[i]);
		memset(QR_ID,0x00,sizeof(QR_ID));
		for(i = 0;i < sizeof(m_Trans_1006_2.QR_ID);i++)
			sprintf(QR_ID+2*i,"%02X",m_Trans_1006_2.QR_ID[i]);
		memset(CHARGING_METHOD,0x00,sizeof(CHARGING_METHOD));
		sprintf(CHARGING_METHOD,"%02X",m_Trans_1006_2.CHARGING_METHOD);
		ENTRY_EXIT_FLAG = (int)m_Trans_1006_2.ENTRY_EXIT_FLAG;
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_1006_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_1006_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_1006_2.TRANS_TYPE);
		memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
		sprintf(PAYMENT_METHOD,"%02X",m_Trans_1006_2.PAYMENT_METHOD);
		TRANS_VALUE = CommonFuncs::dwordtowin(m_Trans_1006_2.TRANS_VALUE);
		memset(QR_VALID_DATE,0x00,sizeof(QR_VALID_DATE));
		for(i = 0;i < sizeof(m_Trans_1006_2.QR_VALID_DATE);i++)
			sprintf(QR_VALID_DATE+2*i,"%02X",m_Trans_1006_2.QR_VALID_DATE[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1006_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_1006_2.TRANS_TIME[i]);
		memset(LAST_TRANS_TIME,0x00,sizeof(LAST_TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_1006_2.LAST_TRANS_TIME);i++)
			sprintf(LAST_TRANS_TIME+2*i,"%02X",m_Trans_1006_2.LAST_TRANS_TIME[i]);
		memset(BUSINESS_ID,0x00,sizeof(BUSINESS_ID));
		sprintf(BUSINESS_ID,"%02X",m_Trans_1006_2.BUSINESS_ID);
		memset(DEVICE_TRACE_NBR,0x00,sizeof(DEVICE_TRACE_NBR));
		for(i = 0;i < sizeof(m_Trans_1006_2.DEVICE_TRACE_NBR);i++)
			sprintf(DEVICE_TRACE_NBR+2*i,"%02X",m_Trans_1006_2.DEVICE_TRACE_NBR[i]);

		memset(SAM_ID,0x00,sizeof(SAM_ID));
		for(i = 0;i < sizeof(m_Trans_1006_2.SAM_ID);i++)
			sprintf(SAM_ID+2*i,"%02X",m_Trans_1006_2.SAM_ID[i]);
		SAM_NBR = CommonFuncs::dwordtowin(m_Trans_1006_2.SAM_NBR);
		memset(CRW_ID,0x00,sizeof(CRW_ID));
		for(i = 0;i < sizeof(m_Trans_1006_2.CRW_ID);i++)
			sprintf(CRW_ID+2*i,"%02X",m_Trans_1006_2.CRW_ID[i]);
		CRW_NBR = CommonFuncs::dwordtowin(m_Trans_1006_2.CRW_NBR);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_1006_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_1006_2.OPERATOR_ID[i]);
		memset(RUN_MODE,0x00,sizeof(RUN_MODE));
		sprintf(RUN_MODE,"%02X",m_Trans_1006_2.RUN_MODE);
		MODE_DATA = (int)m_Trans_1006_2.MODE_DATA;
		memset(USER_ID,0x00,sizeof(USER_ID));
		for(i = 0;i < sizeof(m_Trans_1006_2.USER_ID);i++)
			sprintf(USER_ID+2*i,"%02X",m_Trans_1006_2.USER_ID[i]);
		memset(QR_CREATE_DATE,0x00,sizeof(QR_CREATE_DATE));
		for(i = 0;i < sizeof(m_Trans_1006_2.QR_CREATE_DATE);i++)
			sprintf(QR_CREATE_DATE+2*i,"%02X",m_Trans_1006_2.QR_CREATE_DATE[i]);
		memset(JOURNEY_ID,0x00,sizeof(JOURNEY_ID));
		for(i = 0;i < sizeof(m_Trans_1006_2.JOURNEY_ID);i++)
			sprintf(JOURNEY_ID+2*i,"%02X",m_Trans_1006_2.JOURNEY_ID[i]);
		/* ----- 时间格式转换 ---*/
		memset(tmp_time,0x00,sizeof(tmp_time));
		strcpy(tmp_time,LAST_TRANS_TIME);
		rtn = CTime::CheckTimeFormat(LAST_TRANS_TIME);
		if(rtn == 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:第%d条记录,LAST_TRANS_TIME时间:%s格式错误\n",filename,j,tmp_time);
			CLog::WriteAppLog(oplogmsg);
		}
		/* --- 入库 ---*/
		EXEC SQL INSERT INTO TBL_TRANS_1006_QR_PAY_TEMP(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                LAST_DEVICE_NID,LAST_STATION_NID,MECHANISM_ID,QR_ID,
		                                                CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                TRANS_VALUE,QR_VALID_DATE,	
	                                                  TRANS_TIME,LAST_TRANS_TIME,
	                                                  BUSINESS_ID,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,JOURNEY_ID,			
	                                                  CRW_ID,CRW_NBR,OPERATOR_ID,RUN_MODE,
	                                                  MODE_DATA,USER_ID,QR_CREATE_DATE,DEVICE_TRACE_NBR_INT)
		                                        VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                               :LAST_DEVICE_NID,:LAST_STATION_NID,:MECHANISM_ID,:QR_ID,
		                                               :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                               :TRANS_VALUE,:QR_VALID_DATE,	
	                                                 TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                 :BUSINESS_ID,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:JOURNEY_ID,			
	                                                 :CRW_ID,:CRW_NBR,:OPERATOR_ID,:RUN_MODE,
	                                                 :MODE_DATA,:USER_ID,:QR_CREATE_DATE, TO_NUMBER(:DEVICE_TRACE_NBR));
		EXEC SQL INSERT INTO TBL_TRANS_1006_QR_PAY(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                LAST_DEVICE_NID,LAST_STATION_NID,MECHANISM_ID,QR_ID,
		                                                CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                TRANS_VALUE,QR_VALID_DATE,	
	                                                  TRANS_TIME,LAST_TRANS_TIME,
	                                                  BUSINESS_ID,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,JOURNEY_ID,			
	                                                  CRW_ID,CRW_NBR,OPERATOR_ID,RUN_MODE,
	                                                  MODE_DATA,USER_ID,QR_CREATE_DATE,DEVICE_TRACE_NBR_INT)
		                                        VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                               :LAST_DEVICE_NID,:LAST_STATION_NID,:MECHANISM_ID,:QR_ID,
		                                               :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                               :TRANS_VALUE,:QR_VALID_DATE,	
	                                                 TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                 :BUSINESS_ID,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:JOURNEY_ID,			
	                                                 :CRW_ID,:CRW_NBR,:OPERATOR_ID,:RUN_MODE,
	                                                 :MODE_DATA,:USER_ID,:QR_CREATE_DATE, TO_NUMBER(:DEVICE_TRACE_NBR));
		
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_1006(第%d条记录)ErrorCode(TBL_TRANS_1006_QR_PAY) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			EXEC SQL INSERT INTO TBL_TRANS_1006_QR_PAY_ERROR(PACKET_SEQ,LINE_ID,STATION_NID,DEVICE_TYPE,DEVICE_NID,
		                                                LAST_DEVICE_NID,LAST_STATION_NID,MECHANISM_ID,QR_ID,
		                                                CHARGING_METHOD,ENTRY_EXIT_FLAG,TICKET_TYPE,TRANS_TYPE,PAYMENT_METHOD,
		                                                TRANS_VALUE,QR_VALID_DATE,	
	                                                  TRANS_TIME,LAST_TRANS_TIME,
	                                                  BUSINESS_ID,DEVICE_TRACE_NBR,SAM_ID,SAM_NBR,JOURNEY_ID,			
	                                                  CRW_ID,CRW_NBR,OPERATOR_ID,RUN_MODE,
	                                                  MODE_DATA,USER_ID,QR_CREATE_DATE,DEVICE_TRACE_NBR_INT)
		                                        VALUES(:msg_pointer,:LINE_ID,:STATION_NID,:DEVICE_TYPE,:DEVICE_NID,
		                                               :LAST_DEVICE_NID,:LAST_STATION_NID,:MECHANISM_ID,:QR_ID,
		                                               :CHARGING_METHOD,:ENTRY_EXIT_FLAG,:TICKET_TYPE,:TRANS_TYPE,:PAYMENT_METHOD,
		                                               :TRANS_VALUE,:QR_VALID_DATE,	
	                                                 TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:LAST_TRANS_TIME,'YYYYMMDDHH24MISS'),
	                                                 :BUSINESS_ID,:DEVICE_TRACE_NBR,:SAM_ID,:SAM_NBR,:JOURNEY_ID,			
	                                                 :CRW_ID,:CRW_NBR,:OPERATOR_ID,:RUN_MODE,
	                                                 :MODE_DATA,:USER_ID,:QR_CREATE_DATE, TO_NUMBER(:DEVICE_TRACE_NBR));
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_1006(第%d条记录)ErrorCode(TBL_TRANS_1006_QR_PAY_ERROR) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
		
				/* ----- 写入错误文件---*/
				/*memset(errorbuf,0x00,sizeof(errorbuf));
				memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
				memcpy(errorbuf+sizeof(MsgHead),&m_Trans_1006_1,sizeof(Trans_1006_1));
				memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_1006_1),&m_Trans_1006_2,sizeof(Trans_1006_2));
				errorlen = sizeof(MsgHead)+sizeof(Trans_1006_1)+sizeof(Trans_1006_2);*/
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,(unsigned char*)&m_Trans_1006_2,sizeof(Trans_1006_2));
			}
		} 
		else
		{
			memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
			EXEC SQL SELECT TO_CHAR(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-2/24,'YYYYMMDD') INTO :TRANS_DATE FROM DUAL;
			SLOT_ID = 0;
			EXEC SQL SELECT (TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')-TRUNC(TO_DATE(:TRANS_TIME,'YYYYMMDD HH24:MI:SS')))*86400 / 300 
				       INTO :SLOT_ID
				       FROM DUAL; 
			if(strcmp(TRANS_TYPE,"09") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:LINE_ID,:SLOT_ID,:STATION_NID,
                                                 '1006',:TICKET_TYPE,:DEVICE_NID,1,0);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1006 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else if(strcmp(TRANS_TYPE,"0A") == 0)
			{
				EXEC SQL INSERT INTO TBL_BATCH_ENTRY_EXIT_DETAIL(TRANS_DATE,SETTLE_DATE,SLOT_ID,LINE_NID,STATION_NID,
				                                        TICKET_CATEGORY, TICKET_TYPE,DEVICE_NID,ENTRY_NUM,EXIT_NUM)
                                          VALUES(:TRANS_DATE,TO_CHAR(SYSDATE-2/24,'YYYYMMDD'),:LINE_ID,:SLOT_ID,:STATION_NID,
                                                 '1006',:TICKET_TYPE,:DEVICE_NID,0,1);
				if(sqlca.sqlcode != 0)
				{
					memset(oplogmsg,0x00,sizeof(oplogmsg));
					sprintf(oplogmsg, "%s:insert_into_1006 ErrorCode(TBL_BATCH_ENTRY_EXIT_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					CLog::WriteAppLog(oplogmsg);
				}
			}
			else
			{
				;
			}
		}                       
	}
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}



/* ------------------------------------------------------
            生成2001参数
--------------------------------------------------------- */
void ORA::create2001file(const char *c_recvid,const char *c_date)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	int           	ParamRecords;
	char 						CENTER_NID[3];
  char          	SETTLE_DATE[9];
  char            OBJECTION_MEMO[201];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead	       		m_MsgHead;
	Trans_2001_1 			m_Trans_2001_1;
	Trans_2001_2   		*m_Trans_2001_2;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	unsigned int 			sessionnum;
	char        			c_PkgID[30];
	BYTE         			b_PkgID;
	char              *stopstring;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	strcpy(SETTLE_DATE,c_date);
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_RC_2001_OBJECTION
		 WHERE SETTLE_DATE = :SETTLE_DATE;
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create2001file(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	/* -------- 包体头 ---------- */
	memset(&m_Trans_2001_1,0x00,sizeof(Trans_2001_1));
	m_Trans_2001_1.w_Records 		= CommonFuncs::wordtowin(ParamRecords);
	
	m_Trans_2001_2 = (Trans_2001_2*)malloc(ParamRecords * sizeof(Trans_2001_2));
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_2001_Record CURSOR FOR SELECT CENTER_NID,OBJECTION_MEMO
		                                          FROM   TBL_RC_2001_OBJECTION
		                                          WHERE SETTLE_DATE = :SETTLE_DATE;                              
	EXEC SQL OPEN SQL_2001_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create2001file(OPEN SQL_2001_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Trans_2001_2);
		m_Trans_2001_2 = NULL;
		return;
	}
	index = 0;
	for(;;)
	{
		memset(CENTER_NID,0x00,sizeof(CENTER_NID));
		memset(OBJECTION_MEMO,0x00,sizeof(OBJECTION_MEMO));
		EXEC SQL FETCH SQL_2001_Record INTO :CENTER_NID,:OBJECTION_MEMO;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create2001param(FETCH SQL_2001_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_2001_Record;
				free(m_Trans_2001_2);
				m_Trans_2001_2 = NULL;
				return;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Trans_2001_2[index],0x00,sizeof(Trans_2001_2 ));
		m_Trans_2001_2[index].CENTER_NID = (BYTE)strtoul(CENTER_NID,&stopstring,16);
		CommonFuncs::chartobyte(SETTLE_DATE,(char*)m_Trans_2001_2[index].SETTLE_DATE,sizeof(m_Trans_2001_2[index].SETTLE_DATE));
		memcpy(m_Trans_2001_2[index].OBJECTION_MEMO,OBJECTION_MEMO,sizeof(m_Trans_2001_2[index].OBJECTION_MEMO));
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_2001_Record;	
	
	bodylen = sizeof(Trans_2001_1)+ParamRecords*sizeof(Trans_2001_2);
	/* -------- 生成包头 ---------- */
	sessionnum = get_session_number();
	b_PkgID = (BYTE)get_pkg_number();
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	CPackage::Create_Pkg_Head(b_PkgID,&m_MsgHead,bodylen,0x2001,sessionnum,CConfig::g_ACCIDCode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Trans_2001_1,sizeof(Trans_2001_1));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Trans_2001_1)+index*sizeof(Trans_2001_2),&m_Trans_2001_2[index],sizeof(Trans_2001_2));
	}
	/* --- 生成文件于发送目录 --- */
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%s%02X_%04X_%s",CConfig::SendFilePath_ACC,CConfig::g_CCIDCode[0],0x2001,c_PkgID);
	CommonFuncs::WriteBufferFile("wb",filename,(char*)filebuf,filelen);
	/* -------- 内存释放 ---------- */
	free(m_Trans_2001_2);
	m_Trans_2001_2 = NULL;
	free(filebuf);
	filebuf = NULL;
	free(packagebody);
	packagebody = NULL;
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "清分异议文件%s生成成功\n",filename);
	CLog::WriteAppLog(oplogmsg);
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2002(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						CARD_ID[11];
  char 						CARD_PHY_ID[17];
  char          	TRANS_TIME[15];
  unsigned short 	CARD_NBR;
  char           	DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	char 	          CHECK_RESULT[3];
	char 	          DATA_TYPE[3];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2002_1   		m_Trans_2002_1;
	Trans_2002_2 			m_Trans_2002_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2002_1,0x00,sizeof(Trans_2002_1));
	m_Trans_2002_1 = *(Trans_2002_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2002_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2002_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2002_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2002_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_2002_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2002_1) + count * sizeof(Trans_2002_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2002_2,0x00,sizeof(Trans_2002_2));
		m_Trans_2002_2 = *(Trans_2002_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2002_1)+sizeof(Trans_2002_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2002_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2002_2.FILE_ID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_2002_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_2002_2.CARD_ID[i]);
		memset(CARD_PHY_ID,0x00,sizeof(CARD_PHY_ID));
		for(i = 0;i < sizeof(m_Trans_2002_2.CARD_PHY_ID);i++)
			sprintf(CARD_PHY_ID+2*i,"%02X",m_Trans_2002_2.CARD_PHY_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_2002_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_2002_2.TRANS_TIME[i]);
		CARD_NBR = CommonFuncs::wordtowin(m_Trans_2002_2.CARD_NBR);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2002_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2002_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_2002_2.DEVICE_TRACE_NBR);
		memset(CHECK_RESULT,0x00,sizeof(CHECK_RESULT));
		sprintf(CHECK_RESULT,"%02X",m_Trans_2002_2.CHECK_RESULT);
		memset(DATA_TYPE,0x00,sizeof(DATA_TYPE));
		sprintf(DATA_TYPE,"%02X",m_Trans_2002_2.DATA_TYPE);               
		EXEC SQL INSERT INTO TBL_RC_2002_DOUBT_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,CARD_ID,CARD_PHY_ID,TRANS_TIME,
                                                  CARD_NBR,DEVICE_NID,DEVICE_TRACE_NBR,CHECK_RESULT,DATA_TYPE)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:CARD_ID,:CARD_PHY_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :CARD_NBR,:DEVICE_NID,:DEVICE_TRACE_NBR,:CHECK_RESULT,:DATA_TYPE);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2002(第%d条记录)ErrorCode(TBL_RC_2002_DOUBT_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2002_1,sizeof(Trans_2002_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2002_1),&m_Trans_2002_2,sizeof(Trans_2002_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2002_1)+sizeof(Trans_2002_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2009(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						CARD_ID[11];
  char 						CARD_PHY_ID[17];
  char          	TRANS_TIME[15];
  unsigned short 	CARD_NBR;
  char           	DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	char 	          CHECK_RESULT[3];
	char 	          DATA_TYPE[3];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2009_1   		m_Trans_2009_1;
	Trans_2009_2 			m_Trans_2009_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2009_1,0x00,sizeof(Trans_2009_1));
	m_Trans_2009_1 = *(Trans_2009_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2009_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2009_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2009_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2009_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_2009_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2009_1) + count * sizeof(Trans_2009_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2009 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2009 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2009_2,0x00,sizeof(Trans_2009_2));
		m_Trans_2009_2 = *(Trans_2009_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2009_1)+sizeof(Trans_2009_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2009_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2009_2.FILE_ID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_2009_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_2009_2.CARD_ID[i]);
		memset(CARD_PHY_ID,0x00,sizeof(CARD_PHY_ID));
		for(i = 0;i < sizeof(m_Trans_2009_2.CARD_PHY_ID);i++)
			sprintf(CARD_PHY_ID+2*i,"%02X",m_Trans_2009_2.CARD_PHY_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_2009_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_2009_2.TRANS_TIME[i]);
		CARD_NBR = CommonFuncs::wordtowin(m_Trans_2009_2.CARD_NBR);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2009_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2009_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_2009_2.DEVICE_TRACE_NBR);
		memset(CHECK_RESULT,0x00,sizeof(CHECK_RESULT));
		sprintf(CHECK_RESULT,"%02X",m_Trans_2009_2.CHECK_RESULT);
		memset(DATA_TYPE,0x00,sizeof(DATA_TYPE));
		sprintf(DATA_TYPE,"%02X",m_Trans_2009_2.DATA_TYPE);
		EXEC SQL INSERT INTO TBL_RC_2009_DOUBT_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,CARD_ID,CARD_PHY_ID,TRANS_TIME,
                                                  CARD_NBR,DEVICE_NID,DEVICE_TRACE_NBR,CHECK_RESULT,DATA_TYPE)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:CARD_ID,:CARD_PHY_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :CARD_NBR,:DEVICE_NID,:DEVICE_TRACE_NBR,:CHECK_RESULT,:DATA_TYPE);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2009(第%d条记录)ErrorCode(TBL_RC_2009_DOUBT_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2009_1,sizeof(Trans_2009_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2009_1),&m_Trans_2009_2,sizeof(Trans_2009_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2009_1)+sizeof(Trans_2009_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2003(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	char 						RESETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						CARD_ID[11];
  char 						CARD_PHY_ID[17];
  char          	TRANS_TIME[15];
  unsigned short 	CARD_NBR;
  char   					DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2003_1   		m_Trans_2003_1;
	Trans_2003_2 			m_Trans_2003_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2003_1,0x00,sizeof(Trans_2003_1));
	m_Trans_2003_1 = *(Trans_2003_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2003_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2003_1.SETTLE_DATE[i]);
	memset(RESETTLE_DATE,0x00,sizeof(RESETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2003_1.RESETTLE_DATE);i++)
		sprintf(RESETTLE_DATE+2*i,"%02X",m_Trans_2003_1.RESETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2003_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2003_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_2003_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2003_1) + count * sizeof(Trans_2003_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2003 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2003 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2003_2,0x00,sizeof(Trans_2003_2));
		m_Trans_2003_2 = *(Trans_2003_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2003_1)+sizeof(Trans_2003_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2003_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2003_2.FILE_ID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_2003_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_2003_2.CARD_ID[i]);
		memset(CARD_PHY_ID,0x00,sizeof(CARD_PHY_ID));
		for(i = 0;i < sizeof(m_Trans_2003_2.CARD_PHY_ID);i++)
			sprintf(CARD_PHY_ID+2*i,"%02X",m_Trans_2003_2.CARD_PHY_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_2003_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_2003_2.TRANS_TIME[i]);
		CARD_NBR = CommonFuncs::wordtowin(m_Trans_2003_2.CARD_NBR);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2003_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2003_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_2003_2.DEVICE_TRACE_NBR);
		EXEC SQL INSERT INTO TBL_RC_2003_RESETTLE_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,RESETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,CARD_ID,CARD_PHY_ID,TRANS_TIME,
                                                  CARD_NBR,DEVICE_NID,DEVICE_TRACE_NBR)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:RESETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:CARD_ID,:CARD_PHY_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :CARD_NBR,:DEVICE_NID,:DEVICE_TRACE_NBR);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2003(第%d条记录)ErrorCode(TBL_RC_2003_RESETTLE_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2003_1,sizeof(Trans_2003_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2003_1),&m_Trans_2003_2,sizeof(Trans_2003_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2003_1)+sizeof(Trans_2003_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}


/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_200A(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	char 						RESETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						CARD_ID[11];
  char 						CARD_PHY_ID[17];
  char          	TRANS_TIME[15];
  unsigned short 	CARD_NBR;
  char   					DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_200A_1   		m_Trans_200A_1;
	Trans_200A_2 			m_Trans_200A_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_200A_1,0x00,sizeof(Trans_200A_1));
	m_Trans_200A_1 = *(Trans_200A_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_200A_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_200A_1.SETTLE_DATE[i]);
	memset(RESETTLE_DATE,0x00,sizeof(RESETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_200A_1.RESETTLE_DATE);i++)
		sprintf(RESETTLE_DATE+2*i,"%02X",m_Trans_200A_1.RESETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_200A_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_200A_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_200A_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_200A_1) + count * sizeof(Trans_200A_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_200A ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_200A ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_200A_2,0x00,sizeof(Trans_200A_2));
		m_Trans_200A_2 = *(Trans_200A_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_200A_1)+sizeof(Trans_200A_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_200A_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_200A_2.FILE_ID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_200A_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_200A_2.CARD_ID[i]);
		memset(CARD_PHY_ID,0x00,sizeof(CARD_PHY_ID));
		for(i = 0;i < sizeof(m_Trans_200A_2.CARD_PHY_ID);i++)
			sprintf(CARD_PHY_ID+2*i,"%02X",m_Trans_200A_2.CARD_PHY_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_200A_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_200A_2.TRANS_TIME[i]);
		CARD_NBR = CommonFuncs::wordtowin(m_Trans_200A_2.CARD_NBR);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_200A_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_200A_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_200A_2.DEVICE_TRACE_NBR);
		EXEC SQL INSERT INTO TBL_RC_200A_RESETTLE_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,RESETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,CARD_ID,CARD_PHY_ID,TRANS_TIME,
                                                  CARD_NBR,DEVICE_NID,DEVICE_TRACE_NBR)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:RESETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:CARD_ID,:CARD_PHY_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :CARD_NBR,:DEVICE_NID,:DEVICE_TRACE_NBR);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_200A(第%d条记录)ErrorCode(TBL_RC_200A_RESETTLE_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_200A_1,sizeof(Trans_200A_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_200A_1),&m_Trans_200A_2,sizeof(Trans_200A_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_200A_1)+sizeof(Trans_200A_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2004(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	unsigned int 		TRANS_COUNT;
	unsigned int 		NORMAL_COUNT;
	unsigned int 		NORMAL_AMOUNT;
	unsigned int 		DOUBT_COUNT;
	unsigned int 		DOUBT_AMOUNT;
	unsigned int 		RESETTLE_COUNT;
	unsigned int 		RESETTLE_AMOUNT;
	unsigned int 		DELAY_SETTLE_COUNT;
	unsigned int 		DELAY_SETTLE_AMOUNT;
	unsigned int 		FEE;
	unsigned int 		ADJUST_AMOUNT;
	char				 		ADJUST_REASON[100];
	char        		ADJUST_TIME[7];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2004_1   		m_Trans_2004_1;
	Trans_2004_2 			m_Trans_2004_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2004_1,0x00,sizeof(Trans_2004_1));
	m_Trans_2004_1 = *(Trans_2004_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2004_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2004_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2004_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2004_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_2004_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2004_1) + count * sizeof(Trans_2004_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2004 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2004 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2004_2,0x00,sizeof(Trans_2004_2));
		m_Trans_2004_2 = *(Trans_2004_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2004_1)+sizeof(Trans_2004_2)*j); 
		/* ----- 结构变量赋值 ---*/
		TRANS_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2004_2.TRANS_COUNT);
		NORMAL_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2004_2.NORMAL_COUNT);
		NORMAL_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_2004_2.NORMAL_AMOUNT);
		DOUBT_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2004_2.DOUBT_COUNT);
		DOUBT_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_2004_2.DOUBT_AMOUNT);
		RESETTLE_COUNT 			= CommonFuncs::dwordtowin(m_Trans_2004_2.RESETTLE_COUNT);
		RESETTLE_AMOUNT 		= CommonFuncs::dwordtowin(m_Trans_2004_2.RESETTLE_AMOUNT);
		DELAY_SETTLE_COUNT 	= CommonFuncs::dwordtowin(m_Trans_2004_2.DELAY_SETTLE_COUNT);
		DELAY_SETTLE_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2004_2.DELAY_SETTLE_AMOUNT);
		FEE 								= CommonFuncs::dwordtowin(m_Trans_2004_2.FEE);
		ADJUST_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_2004_2.ADJUST_AMOUNT);
		memset(ADJUST_REASON,0x00,sizeof(ADJUST_REASON));
		memcpy(ADJUST_REASON,m_Trans_2004_2.ADJUST_REASON,sizeof(m_Trans_2004_2.ADJUST_REASON));
		memset(ADJUST_TIME,0x00,sizeof(ADJUST_TIME));
		for(i = 0;i < sizeof(m_Trans_2004_2.ADJUST_TIME);i++)
			sprintf(ADJUST_TIME+2*i,"%02X",m_Trans_2004_2.ADJUST_TIME[i]);
		EXEC SQL INSERT INTO TBL_RC_2004_SETTLE_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  TRANS_COUNT,NORMAL_COUNT,NORMAL_AMOUNT,DOUBT_COUNT,
                                                  DOUBT_AMOUNT,RESETTLE_COUNT,RESETTLE_AMOUNT,DELAY_SETTLE_COUNT,
                                                  DELAY_SETTLE_AMOUNT,FEE,ADJUST_AMOUNT,ADJUST_REASON,
                                                  ADJUST_TIME)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TRANS_COUNT,:NORMAL_COUNT,:NORMAL_AMOUNT,:DOUBT_COUNT,
                                                  :DOUBT_AMOUNT,:RESETTLE_COUNT,:RESETTLE_AMOUNT,:DELAY_SETTLE_COUNT,
                                                  :DELAY_SETTLE_AMOUNT,:FEE,:ADJUST_AMOUNT,:ADJUST_REASON,
                                                  TO_DATE(:ADJUST_TIME,'YYYYMMDDHH24MISS'));
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2004(第%d条记录)ErrorCode(TBL_RC_2004_SETTLE_DATA) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2004_1,sizeof(Trans_2004_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2004_1),&m_Trans_2004_2,sizeof(Trans_2004_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2004_1)+sizeof(Trans_2004_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2008(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	unsigned int 		TRANS_COUNT;
	unsigned int 		NORMAL_COUNT;
	unsigned int 		NORMAL_AMOUNT;
	unsigned int 		DOUBT_COUNT;
	unsigned int 		DOUBT_AMOUNT;
	unsigned int 		RESETTLE_COUNT;
	unsigned int 		RESETTLE_AMOUNT;
	unsigned int 		DELAY_SETTLE_COUNT;
	unsigned int 		DELAY_SETTLE_AMOUNT;
	unsigned int 		FEE;
	unsigned int 		ADJUST_AMOUNT;
	char				 		ADJUST_REASON[100];
	char        		ADJUST_TIME[7];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2008_1   		m_Trans_2008_1;
	Trans_2008_2 			m_Trans_2008_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2008_1,0x00,sizeof(Trans_2008_1));
	m_Trans_2008_1 = *(Trans_2008_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2008_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2008_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2008_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2008_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_2008_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2008_1) + count * sizeof(Trans_2008_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2008 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2008 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2008_2,0x00,sizeof(Trans_2008_2));
		m_Trans_2008_2 = *(Trans_2008_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2008_1)+sizeof(Trans_2008_2)*j); 
		/* ----- 结构变量赋值 ---*/
		TRANS_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2008_2.TRANS_COUNT);
		NORMAL_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2008_2.NORMAL_COUNT);
		NORMAL_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_2008_2.NORMAL_AMOUNT);
		DOUBT_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2008_2.DOUBT_COUNT);
		DOUBT_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_2008_2.DOUBT_AMOUNT);
		RESETTLE_COUNT 			= CommonFuncs::dwordtowin(m_Trans_2008_2.RESETTLE_COUNT);
		RESETTLE_AMOUNT 		= CommonFuncs::dwordtowin(m_Trans_2008_2.RESETTLE_AMOUNT);
		DELAY_SETTLE_COUNT 	= CommonFuncs::dwordtowin(m_Trans_2008_2.DELAY_SETTLE_COUNT);
		DELAY_SETTLE_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2008_2.DELAY_SETTLE_AMOUNT);
		FEE 								= CommonFuncs::dwordtowin(m_Trans_2008_2.FEE);
		ADJUST_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_2008_2.ADJUST_AMOUNT);
		memset(ADJUST_REASON,0x00,sizeof(ADJUST_REASON));
		memcpy(ADJUST_REASON,m_Trans_2008_2.ADJUST_REASON,sizeof(m_Trans_2008_2.ADJUST_REASON));
		memset(ADJUST_TIME,0x00,sizeof(ADJUST_TIME));
		for(i = 0;i < sizeof(m_Trans_2008_2.ADJUST_TIME);i++)
			sprintf(ADJUST_TIME+2*i,"%02X",m_Trans_2008_2.ADJUST_TIME[i]);
		EXEC SQL INSERT INTO TBL_RC_2008_SETTLE_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  TRANS_COUNT,NORMAL_COUNT,NORMAL_AMOUNT,DOUBT_COUNT,
                                                  DOUBT_AMOUNT,RESETTLE_COUNT,RESETTLE_AMOUNT,DELAY_SETTLE_COUNT,
                                                  DELAY_SETTLE_AMOUNT,FEE,ADJUST_AMOUNT,ADJUST_REASON,
                                                  ADJUST_TIME)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TRANS_COUNT,:NORMAL_COUNT,:NORMAL_AMOUNT,:DOUBT_COUNT,
                                                  :DOUBT_AMOUNT,:RESETTLE_COUNT,:RESETTLE_AMOUNT,:DELAY_SETTLE_COUNT,
                                                  :DELAY_SETTLE_AMOUNT,:FEE,:ADJUST_AMOUNT,:ADJUST_REASON,
                                                  TO_DATE(:ADJUST_TIME,'YYYYMMDDHH24MISS'));
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2008(第%d条记录)ErrorCode(TBL_RC_2008_SETTLE_DATA) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2008_1,sizeof(Trans_2008_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2008_1),&m_Trans_2008_2,sizeof(Trans_2008_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2008_1)+sizeof(Trans_2008_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2005(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						TICKET_TYPE[5];
	char 						TRANS_TYPE[3];
	unsigned int 		UPLOAD_COUNT_TODAY;
	unsigned int 		UPLOAD_AMOUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_COUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_AMOUNT_TODAY;
	unsigned int 		DOUBT_COUNT_TODAY;
	unsigned int 		DOUBT_AMOUNT_TODAY;
	unsigned int 		UNI_COUNT_TODAY;
	unsigned int 		UNI_AMOUNT_TODAY;
	unsigned int 		DELAY_COUNT_TODAY;
	unsigned int 		DALAY_AMOUNT_TODAY;
	unsigned int 		DOUBT_RESETTLE_COUNT_YES;
	unsigned int 		DOUBT_RESETTLE_AMOUNT_YES;
	unsigned int 		UNI_RESETTLE_COUNT_YES;
	unsigned int 		UNI_RESETTLE_AMOUNT_YES;
	unsigned int 		DELAY_RESETTLE_COUNT_YES;
	unsigned int 		DELAY_RESETTLE_AMOUNT_YES;
	unsigned int 		TRANS_AMOUNT_TODAY;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2005_1   		m_Trans_2005_1;
	Trans_2005_2 			m_Trans_2005_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2005_1,0x00,sizeof(Trans_2005_1));
	m_Trans_2005_1 = *(Trans_2005_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2005_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2005_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2005_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2005_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_2005_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2005_1) + count * sizeof(Trans_2005_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2005 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2005 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2005_2,0x00,sizeof(Trans_2005_2));
		m_Trans_2005_2 = *(Trans_2005_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2005_1)+sizeof(Trans_2005_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_2005_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_2005_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_2005_2.TRANS_TYPE);
		UPLOAD_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2005_2.UPLOAD_COUNT_TODAY);
		UPLOAD_AMOUNT_TODAY 			= CommonFuncs::dwordtowin(m_Trans_2005_2.UPLOAD_AMOUNT_TODAY);
		UPLOAD_SETTLE_COUNT_TODAY = CommonFuncs::dwordtowin(m_Trans_2005_2.UPLOAD_SETTLE_COUNT_TODAY);
		UPLOAD_SETTLE_AMOUNT_TODAY= CommonFuncs::dwordtowin(m_Trans_2005_2.UPLOAD_SETTLE_AMOUNT_TODAY);
		DOUBT_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2005_2.DOUBT_COUNT_TODAY);
		DOUBT_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2005_2.DOUBT_AMOUNT_TODAY);
		UNI_COUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_2005_2.UNI_COUNT_TODAY);
		UNI_AMOUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_2005_2.UNI_AMOUNT_TODAY);
		DELAY_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2005_2.DELAY_COUNT_TODAY);
		DALAY_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2005_2.DALAY_AMOUNT_TODAY);
		DOUBT_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2005_2.DOUBT_RESETTLE_COUNT_YES);
		DOUBT_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_2005_2.DOUBT_RESETTLE_AMOUNT_YES);
		UNI_RESETTLE_COUNT_YES 		= CommonFuncs::dwordtowin(m_Trans_2005_2.UNI_RESETTLE_COUNT_YES);
		UNI_RESETTLE_AMOUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2005_2.UNI_RESETTLE_AMOUNT_YES);
		DELAY_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2005_2.DELAY_RESETTLE_COUNT_YES);
		DELAY_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_2005_2.DELAY_RESETTLE_AMOUNT_YES);
		TRANS_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2005_2.TRANS_AMOUNT_TODAY);
		EXEC SQL INSERT INTO TBL_RC_2005_CLEAR_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  TICKET_TYPE,TRANS_TYPE,UPLOAD_COUNT_TODAY,UPLOAD_AMOUNT_TODAY,
                                                  UPLOAD_SETTLE_COUNT_TODAY,UPLOAD_SETTLE_AMOUNT_TODAY,DOUBT_COUNT_TODAY,DOUBT_AMOUNT_TODAY,
                                                  UNI_COUNT_TODAY,UNI_AMOUNT_TODAY,DELAY_COUNT_TODAY,DALAY_AMOUNT_TODAY,
                                                  DOUBT_RESETTLE_COUNT_YES,DOUBT_RESETTLE_AMOUNT_YES,UNI_RESETTLE_COUNT_YES,UNI_RESETTLE_AMOUNT_YES,
                                                  DELAY_RESETTLE_COUNT_YES,DELAY_RESETTLE_AMOUNT_YES,TRANS_AMOUNT_TODAY)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TICKET_TYPE,:TRANS_TYPE,:UPLOAD_COUNT_TODAY,:UPLOAD_AMOUNT_TODAY,
                                                  :UPLOAD_SETTLE_COUNT_TODAY,:UPLOAD_SETTLE_AMOUNT_TODAY,:DOUBT_COUNT_TODAY,:DOUBT_AMOUNT_TODAY,
                                                  :UNI_COUNT_TODAY,:UNI_AMOUNT_TODAY,:DELAY_COUNT_TODAY,:DALAY_AMOUNT_TODAY,
                                                  :DOUBT_RESETTLE_COUNT_YES,:DOUBT_RESETTLE_AMOUNT_YES,:UNI_RESETTLE_COUNT_YES,:UNI_RESETTLE_AMOUNT_YES,
                                                  :DELAY_RESETTLE_COUNT_YES,:DELAY_RESETTLE_AMOUNT_YES,:TRANS_AMOUNT_TODAY);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2005(第%d条记录)ErrorCode(TBL_RC_2005_CLEAR_DATA) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2005_1,sizeof(Trans_2005_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2005_1),&m_Trans_2005_2,sizeof(Trans_2005_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2005_1)+sizeof(Trans_2005_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_200B(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						TICKET_TYPE[5];
	char 						TRANS_TYPE[3];
	unsigned int 		UPLOAD_COUNT_TODAY;
	unsigned int 		UPLOAD_AMOUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_COUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_AMOUNT_TODAY;
	unsigned int 		DOUBT_COUNT_TODAY;
	unsigned int 		DOUBT_AMOUNT_TODAY;
	unsigned int 		UNI_COUNT_TODAY;
	unsigned int 		UNI_AMOUNT_TODAY;
	unsigned int 		DELAY_COUNT_TODAY;
	unsigned int 		DALAY_AMOUNT_TODAY;
	unsigned int 		DOUBT_RESETTLE_COUNT_YES;
	unsigned int 		DOUBT_RESETTLE_AMOUNT_YES;
	unsigned int 		UNI_RESETTLE_COUNT_YES;
	unsigned int 		UNI_RESETTLE_AMOUNT_YES;
	unsigned int 		DELAY_RESETTLE_COUNT_YES;
	unsigned int 		DELAY_RESETTLE_AMOUNT_YES;
	char            PERL_SETTLE_DATE[9];
	unsigned int 		TRANS_AMOUNT_TODAY;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_200B_1   		m_Trans_200B_1;
	Trans_200B_2 			m_Trans_200B_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_200B_1,0x00,sizeof(Trans_200B_1));
	m_Trans_200B_1 = *(Trans_200B_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_200B_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_200B_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_200B_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_200B_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_200B_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_200B_1) + count * sizeof(Trans_200B_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_200B ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_200B ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_200B_2,0x00,sizeof(Trans_200B_2));
		m_Trans_200B_2 = *(Trans_200B_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_200B_1)+sizeof(Trans_200B_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_200B_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_200B_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_200B_2.TRANS_TYPE);
		UPLOAD_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_200B_2.UPLOAD_COUNT_TODAY);
		UPLOAD_AMOUNT_TODAY 			= CommonFuncs::dwordtowin(m_Trans_200B_2.UPLOAD_AMOUNT_TODAY);
		UPLOAD_SETTLE_COUNT_TODAY = CommonFuncs::dwordtowin(m_Trans_200B_2.UPLOAD_SETTLE_COUNT_TODAY);
		UPLOAD_SETTLE_AMOUNT_TODAY= CommonFuncs::dwordtowin(m_Trans_200B_2.UPLOAD_SETTLE_AMOUNT_TODAY);
		DOUBT_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_200B_2.DOUBT_COUNT_TODAY);
		DOUBT_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_200B_2.DOUBT_AMOUNT_TODAY);
		UNI_COUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_200B_2.UNI_COUNT_TODAY);
		UNI_AMOUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_200B_2.UNI_AMOUNT_TODAY);
		DELAY_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_200B_2.DELAY_COUNT_TODAY);
		DALAY_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_200B_2.DALAY_AMOUNT_TODAY);
		DOUBT_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_200B_2.DOUBT_RESETTLE_COUNT_YES);
		DOUBT_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_200B_2.DOUBT_RESETTLE_AMOUNT_YES);
		UNI_RESETTLE_COUNT_YES 		= CommonFuncs::dwordtowin(m_Trans_200B_2.UNI_RESETTLE_COUNT_YES);
		UNI_RESETTLE_AMOUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_200B_2.UNI_RESETTLE_AMOUNT_YES);
		DELAY_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_200B_2.DELAY_RESETTLE_COUNT_YES);
		DELAY_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_200B_2.DELAY_RESETTLE_AMOUNT_YES);
		TRANS_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_200B_2.TRANS_AMOUNT_TODAY);
		memset(PERL_SETTLE_DATE,0x00,sizeof(PERL_SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_200B_2.PERL_SETTLE_DATE);i++)
			sprintf(PERL_SETTLE_DATE+2*i,"%02X",m_Trans_200B_2.PERL_SETTLE_DATE[i]);
		EXEC SQL INSERT INTO TBL_RC_200B_CLEAR_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  TICKET_TYPE,TRANS_TYPE,UPLOAD_COUNT_TODAY,UPLOAD_AMOUNT_TODAY,
                                                  UPLOAD_SETTLE_COUNT_TODAY,UPLOAD_SETTLE_AMOUNT_TODAY,DOUBT_COUNT_TODAY,DOUBT_AMOUNT_TODAY,
                                                  UNI_COUNT_TODAY,UNI_AMOUNT_TODAY,DELAY_COUNT_TODAY,DALAY_AMOUNT_TODAY,
                                                  DOUBT_RESETTLE_COUNT_YES,DOUBT_RESETTLE_AMOUNT_YES,UNI_RESETTLE_COUNT_YES,UNI_RESETTLE_AMOUNT_YES,
                                                  DELAY_RESETTLE_COUNT_YES,DELAY_RESETTLE_AMOUNT_YES,PERL_SETTLE_DATE,TRANS_AMOUNT_TODAY)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TICKET_TYPE,:TRANS_TYPE,:UPLOAD_COUNT_TODAY,:UPLOAD_AMOUNT_TODAY,
                                                  :UPLOAD_SETTLE_COUNT_TODAY,:UPLOAD_SETTLE_AMOUNT_TODAY,:DOUBT_COUNT_TODAY,:DOUBT_AMOUNT_TODAY,
                                                  :UNI_COUNT_TODAY,:UNI_AMOUNT_TODAY,:DELAY_COUNT_TODAY,:DALAY_AMOUNT_TODAY,
                                                  :DOUBT_RESETTLE_COUNT_YES,:DOUBT_RESETTLE_AMOUNT_YES,:UNI_RESETTLE_COUNT_YES,:UNI_RESETTLE_AMOUNT_YES,
                                                  :DELAY_RESETTLE_COUNT_YES,:DELAY_RESETTLE_AMOUNT_YES,:PERL_SETTLE_DATE,:TRANS_AMOUNT_TODAY);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_200B(第%d条记录)ErrorCode(TBL_RC_200B_CLEAR_DATA) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_200B_1,sizeof(Trans_200B_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_200B_1),&m_Trans_200B_2,sizeof(Trans_200B_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_200B_1)+sizeof(Trans_200B_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2006(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
  char 	          CENTER_NID[3];
  
	char 						LINE_ID[3];
	char 						STATION_NID[5];
  char 						DEVICE_TYPE[3];
  char   					DEVICE_NID[9];
	char 						TICKET_CLASS[3];
	unsigned int 		START_TRACE_NBR;
	unsigned int 		END_TRACE_NBR;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2006_1   		m_Trans_2006_1;
	Trans_2006_2 			m_Trans_2006_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2006_1,0x00,sizeof(Trans_2006_1));
	m_Trans_2006_1 = *(Trans_2006_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2006_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2006_1.SETTLE_DATE[i]);
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2006_1.CENTER_NID);
	count = CommonFuncs::wordtowin(m_Trans_2006_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2006_1) + count * sizeof(Trans_2006_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2006 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2006 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2006_2,0x00,sizeof(Trans_2006_2));
		m_Trans_2006_2 = *(Trans_2006_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2006_1)+sizeof(Trans_2006_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_2006_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_2006_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_2006_2.STATION_NID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_2006_2.DEVICE_TYPE);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2006_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2006_2.DEVICE_NID[i]);
		memset(TICKET_CLASS,0x00,sizeof(TICKET_CLASS));
		sprintf(TICKET_CLASS,"%02X",m_Trans_2006_2.TICKET_CLASS);
		START_TRACE_NBR 		= CommonFuncs::dwordtowin(m_Trans_2006_2.START_TRACE_NBR);
		END_TRACE_NBR 			= CommonFuncs::dwordtowin(m_Trans_2006_2.END_TRACE_NBR);
		EXEC SQL INSERT INTO TBL_RC_2006_DEVICE_NBR (PACKET_SEQ,LINE_NID,SETTLE_DATE,CENTER_NID,LINE_ID,
                                                 STATION_NID,DEVICE_TYPE,DEVICE_NID,TICKET_CLASS,
                                                 START_TRACE_NBR,END_TRACE_NBR)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:CENTER_NID,:LINE_ID,
                                                 :STATION_NID,:DEVICE_TYPE,:DEVICE_NID,:TICKET_CLASS,
                                                 :START_TRACE_NBR,:END_TRACE_NBR);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2006(第%d条记录)ErrorCode(TBL_RC_2006_DEVICE_NBR) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2006_1,sizeof(Trans_2006_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2006_1),&m_Trans_2006_2,sizeof(Trans_2006_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2006_1)+sizeof(Trans_2006_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2007(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
	char 						UPLOAD_TIME[15];
	char 						MEASURE_TIME[15];
	char 						SETTLE_TIME[15];
	char 						SETTLE_DATE[9];
	char 						FILE_TYPE[3];
	char 						FILE_STATUS[3];
	unsigned int 		ROW_NUM;
	unsigned int 		MEASURE_ROW_NUM;
	unsigned int 		NORMAL_ROW_NUM;
	unsigned int 		DOUBT_ROW_NUM;
	unsigned int 		TEST_NUM;
	unsigned int 		SETTLE_ERROR_ROW_NUM;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2007_1   		m_Trans_2007_1;
	Trans_2007_2 			m_Trans_2007_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 固定部? ---*/
	memset(&m_Trans_2007_1,0x00,sizeof(Trans_2007_1));
	m_Trans_2007_1 = *(Trans_2007_1 *)(recvbuf + sizeof(MsgHead));
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2007_1.CENTER_NID);
	count =  CommonFuncs::wordtowin(m_Trans_2007_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2007_1) + count * sizeof(Trans_2007_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2007 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2007 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2007_2,0x00,sizeof(Trans_2007_2));
		m_Trans_2007_2 = *(Trans_2007_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2007_1)+sizeof(Trans_2007_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2007_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2007_2.FILE_ID[i]);
		memset(UPLOAD_TIME,0x00,sizeof(UPLOAD_TIME));
		for(i = 0;i < sizeof(m_Trans_2007_2.UPLOAD_TIME);i++)
			sprintf(UPLOAD_TIME+2*i,"%02X",m_Trans_2007_2.UPLOAD_TIME[i]);
		memset(MEASURE_TIME,0x00,sizeof(MEASURE_TIME));
		for(i = 0;i < sizeof(m_Trans_2007_2.MEASURE_TIME);i++)
			sprintf(MEASURE_TIME+2*i,"%02X",m_Trans_2007_2.MEASURE_TIME[i]);
		memset(SETTLE_TIME,0x00,sizeof(SETTLE_TIME));
		for(i = 0;i < sizeof(m_Trans_2007_2.SETTLE_TIME);i++)
			sprintf(SETTLE_TIME+2*i,"%02X",m_Trans_2007_2.SETTLE_TIME[i]);
		memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_2007_2.SETTLE_DATE);i++)
			sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2007_2.SETTLE_DATE[i]);
		memset(FILE_TYPE,0x00,sizeof(FILE_TYPE));
		sprintf(FILE_TYPE,"%02X",m_Trans_2007_2.FILE_TYPE);
		memset(FILE_STATUS,0x00,sizeof(FILE_STATUS));
		sprintf(FILE_STATUS,"%02X",m_Trans_2007_2.FILE_STATUS);
		ROW_NUM 									= CommonFuncs::dwordtowin(m_Trans_2007_2.ROW_NUM);
		MEASURE_ROW_NUM 					= CommonFuncs::dwordtowin(m_Trans_2007_2.MEASURE_ROW_NUM);
		NORMAL_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_2007_2.NORMAL_ROW_NUM);
		DOUBT_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_2007_2.DOUBT_ROW_NUM);
		TEST_NUM 									= CommonFuncs::dwordtowin(m_Trans_2007_2.TEST_NUM);
		SETTLE_ERROR_ROW_NUM 			= CommonFuncs::dwordtowin(m_Trans_2007_2.SETTLE_ERROR_ROW_NUM);
		EXEC SQL INSERT INTO TBL_RC_2007_PKG_DETAIL (PACKET_SEQ,LINE_NID,CENTER_NID,FILE_ID,
                                                 UPLOAD_TIME,
                                                 MEASURE_TIME,
                                                 SETTLE_TIME,
                                                 SETTLE_DATE,FILE_TYPE,FILE_STATUS,ROW_NUM,
                                                 MEASURE_ROW_NUM,NORMAL_ROW_NUM,DOUBT_ROW_NUM,TEST_NUM,SETTLE_ERROR_ROW_NUM)
		                                       VALUES(:msg_pointer,:b_DestID,:CENTER_NID,:FILE_ID,
                                                 TO_DATE(:UPLOAD_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:MEASURE_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:SETTLE_TIME,'YYYYMMDDHH24MISS'),
                                                 :SETTLE_DATE,:FILE_TYPE,:FILE_STATUS,:ROW_NUM,
                                                 :MEASURE_ROW_NUM,:NORMAL_ROW_NUM,:DOUBT_ROW_NUM,:TEST_NUM,:SETTLE_ERROR_ROW_NUM);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2007(第%d条记录)ErrorCode(TBL_RC_2007_PKG_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2007_1,sizeof(Trans_2007_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2007_1),&m_Trans_2007_2,sizeof(Trans_2007_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2007_1)+sizeof(Trans_2007_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_200C(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
	char 						UPLOAD_TIME[15];
	char 						MEASURE_TIME[15];
	char 						SETTLE_TIME[15];
	char 						SETTLE_DATE[9];
	char 						FILE_TYPE[3];
	char 						FILE_STATUS[3];
	unsigned int 		ROW_NUM;
	unsigned int 		MEASURE_ROW_NUM;
	unsigned int 		NORMAL_ROW_NUM;
	unsigned int 		DOUBT_ROW_NUM;
	unsigned int 		TEST_NUM;
	unsigned int 		SETTLE_ERROR_ROW_NUM;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_200C_1   		m_Trans_200C_1;
	Trans_200C_2 			m_Trans_200C_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_200C_1,0x00,sizeof(Trans_200C_1));
	m_Trans_200C_1 = *(Trans_200C_1 *)(recvbuf + sizeof(MsgHead));
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_200C_1.CENTER_NID);
	count =  CommonFuncs::wordtowin(m_Trans_200C_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_200C_1) + count * sizeof(Trans_200C_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_200C ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_200C ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_200C_2,0x00,sizeof(Trans_200C_2));
		m_Trans_200C_2 = *(Trans_200C_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_200C_1)+sizeof(Trans_200C_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_200C_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_200C_2.FILE_ID[i]);
		memset(UPLOAD_TIME,0x00,sizeof(UPLOAD_TIME));
		for(i = 0;i < sizeof(m_Trans_200C_2.UPLOAD_TIME);i++)
			sprintf(UPLOAD_TIME+2*i,"%02X",m_Trans_200C_2.UPLOAD_TIME[i]);
		memset(MEASURE_TIME,0x00,sizeof(MEASURE_TIME));
		for(i = 0;i < sizeof(m_Trans_200C_2.MEASURE_TIME);i++)
			sprintf(MEASURE_TIME+2*i,"%02X",m_Trans_200C_2.MEASURE_TIME[i]);
		memset(SETTLE_TIME,0x00,sizeof(SETTLE_TIME));
		for(i = 0;i < sizeof(m_Trans_200C_2.SETTLE_TIME);i++)
			sprintf(SETTLE_TIME+2*i,"%02X",m_Trans_200C_2.SETTLE_TIME[i]);
		memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_200C_2.SETTLE_DATE);i++)
			sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_200C_2.SETTLE_DATE[i]);
		memset(FILE_TYPE,0x00,sizeof(FILE_TYPE));
		sprintf(FILE_TYPE,"%02X",m_Trans_200C_2.FILE_TYPE);
		memset(FILE_STATUS,0x00,sizeof(FILE_STATUS));
		sprintf(FILE_STATUS,"%02X",m_Trans_200C_2.FILE_STATUS);
		ROW_NUM 									= CommonFuncs::dwordtowin(m_Trans_200C_2.ROW_NUM);
		MEASURE_ROW_NUM 					= CommonFuncs::dwordtowin(m_Trans_200C_2.MEASURE_ROW_NUM);
		NORMAL_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_200C_2.NORMAL_ROW_NUM);
		DOUBT_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_200C_2.DOUBT_ROW_NUM);
		TEST_NUM 									= CommonFuncs::dwordtowin(m_Trans_200C_2.TEST_NUM);
		SETTLE_ERROR_ROW_NUM 			= CommonFuncs::dwordtowin(m_Trans_200C_2.SETTLE_ERROR_ROW_NUM);
		EXEC SQL INSERT INTO TBL_RC_200C_PKG_DETAIL (PACKET_SEQ,LINE_NID,CENTER_NID,FILE_ID,
                                                 UPLOAD_TIME,
                                                 MEASURE_TIME,
                                                 SETTLE_TIME,
                                                 SETTLE_DATE,FILE_TYPE,FILE_STATUS,ROW_NUM,
                                                 MEASURE_ROW_NUM,NORMAL_ROW_NUM,DOUBT_ROW_NUM,TEST_NUM,SETTLE_ERROR_ROW_NUM)
		                                       VALUES(:msg_pointer,:b_DestID,:CENTER_NID,:FILE_ID,
                                                 TO_DATE(:UPLOAD_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:MEASURE_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:SETTLE_TIME,'YYYYMMDDHH24MISS'),
                                                 :SETTLE_DATE,:FILE_TYPE,:FILE_STATUS,:ROW_NUM,
                                                 :MEASURE_ROW_NUM,:NORMAL_ROW_NUM,:DOUBT_ROW_NUM,:TEST_NUM,:SETTLE_ERROR_ROW_NUM);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_200C(第%d条记录)ErrorCode(TBL_RC_200C_PKG_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_200C_1,sizeof(Trans_200C_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_200C_1),&m_Trans_200C_2,sizeof(Trans_200C_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_200C_1)+sizeof(Trans_200C_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2011(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						CARD_ID[21];
  char          	TRANS_TIME[15];
  char           	DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	char 	          CHECK_RESULT[3];
	char 	          DATA_TYPE[3];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2011_1   		m_Trans_2011_1;
	Trans_2011_2 			m_Trans_2011_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2011_1,0x00,sizeof(Trans_2011_1));
	m_Trans_2011_1 = *(Trans_2011_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2011_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2011_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2011_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2011_1.CENTER_NID);
	count = CommonFuncs::dwordtowin(m_Trans_2011_1.dw_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2011_1) + count * sizeof(Trans_2011_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2011 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2011 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2011_2,0x00,sizeof(Trans_2011_2));
		m_Trans_2011_2 = *(Trans_2011_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2011_1)+sizeof(Trans_2011_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2011_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2011_2.FILE_ID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_2011_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_2011_2.CARD_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_2011_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_2011_2.TRANS_TIME[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2011_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2011_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_2011_2.DEVICE_TRACE_NBR);
		memset(CHECK_RESULT,0x00,sizeof(CHECK_RESULT));
		sprintf(CHECK_RESULT,"%02X",m_Trans_2011_2.CHECK_RESULT);
		memset(DATA_TYPE,0x00,sizeof(DATA_TYPE));
		sprintf(DATA_TYPE,"%02X",m_Trans_2011_2.DATA_TYPE);
		EXEC SQL INSERT INTO TBL_RC_2011_DOUBT_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,CARD_ID,TRANS_TIME,
                                                  DEVICE_NID,DEVICE_TRACE_NBR,CHECK_RESULT,DATA_TYPE)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:CARD_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :DEVICE_NID,:DEVICE_TRACE_NBR,:CHECK_RESULT,:DATA_TYPE);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2011(第%d条记录)ErrorCode(TBL_RC_2011_DOUBT_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2011_1,sizeof(Trans_2011_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2011_1),&m_Trans_2011_2,sizeof(Trans_2011_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2011_1)+sizeof(Trans_2011_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2016(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						USER_ID[17];
  char          	TRANS_TIME[15];
  char           	DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	char 	          CHECK_RESULT[3];
	char 	          DATA_TYPE[3];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2016_1   		m_Trans_2016_1;
	Trans_2016_2 			m_Trans_2016_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2016_1,0x00,sizeof(Trans_2016_1));
	m_Trans_2016_1 = *(Trans_2016_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2016_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2016_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2016_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2016_1.CENTER_NID);
	count = CommonFuncs::dwordtowin(m_Trans_2016_1.dw_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2016_1) + count * sizeof(Trans_2016_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2016 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2016 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2016_2,0x00,sizeof(Trans_2016_2));
		m_Trans_2016_2 = *(Trans_2016_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2016_1)+sizeof(Trans_2016_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2016_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2016_2.FILE_ID[i]);
		memset(USER_ID,0x00,sizeof(USER_ID));
		for(i = 0;i < sizeof(m_Trans_2016_2.USER_ID);i++)
			sprintf(USER_ID+2*i,"%02X",m_Trans_2016_2.USER_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_2016_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_2016_2.TRANS_TIME[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2016_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2016_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_2016_2.DEVICE_TRACE_NBR);
		memset(CHECK_RESULT,0x00,sizeof(CHECK_RESULT));
		sprintf(CHECK_RESULT,"%02X",m_Trans_2016_2.CHECK_RESULT);
		memset(DATA_TYPE,0x00,sizeof(DATA_TYPE));
		sprintf(DATA_TYPE,"%02X",m_Trans_2016_2.DATA_TYPE);
		EXEC SQL INSERT INTO TBL_RC_2016_DOUBT_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,USER_ID,TRANS_TIME,
                                                  DEVICE_NID,DEVICE_TRACE_NBR,CHECK_RESULT,DATA_TYPE)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:USER_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :DEVICE_NID,:DEVICE_TRACE_NBR,:CHECK_RESULT,:DATA_TYPE);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2016(第%d条记录)ErrorCode(TBL_RC_2016_DOUBT_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2016_1,sizeof(Trans_2016_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2016_1),&m_Trans_2016_2,sizeof(Trans_2016_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2016_1)+sizeof(Trans_2016_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2012(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	char 						RESETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						CARD_ID[21];
  char          	TRANS_TIME[15];
  char   					DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2012_1   		m_Trans_2012_1;
	Trans_2012_2 			m_Trans_2012_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2012_1,0x00,sizeof(Trans_2012_1));
	m_Trans_2012_1 = *(Trans_2012_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2012_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2012_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2012_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2012_1.CENTER_NID);
	count = CommonFuncs::dwordtowin(m_Trans_2012_1.dw_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2012_1) + count * sizeof(Trans_2012_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2012 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2012 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2012_2,0x00,sizeof(Trans_2012_2));
		m_Trans_2012_2 = *(Trans_2012_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2012_1)+sizeof(Trans_2012_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2012_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2012_2.FILE_ID[i]);
		memset(CARD_ID,0x00,sizeof(CARD_ID));
		for(i = 0;i < sizeof(m_Trans_2012_2.CARD_ID);i++)
			sprintf(CARD_ID+2*i,"%02X",m_Trans_2012_2.CARD_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_2012_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_2012_2.TRANS_TIME[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2012_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2012_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_2012_2.DEVICE_TRACE_NBR);
		memset(RESETTLE_DATE,0x00,sizeof(RESETTLE_DATE));
		for(i=0;i<sizeof(m_Trans_2012_2.RESETTLE_DATE);i++)
			sprintf(RESETTLE_DATE+2*i,"%02X",m_Trans_2012_2.RESETTLE_DATE[i]);
		EXEC SQL INSERT INTO TBL_RC_2012_RESETTLE_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,RESETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,CARD_ID,TRANS_TIME,
                                                  DEVICE_NID,DEVICE_TRACE_NBR)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:RESETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:CARD_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :DEVICE_NID,:DEVICE_TRACE_NBR);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2012(第%d条记录)ErrorCode(TBL_RC_2012_RESETTLE_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2012_1,sizeof(Trans_2012_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2012_1),&m_Trans_2012_2,sizeof(Trans_2012_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2012_1)+sizeof(Trans_2012_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2017(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	char 						RESETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
  char 						USER_ID[17];
  char          	TRANS_TIME[15];
  char   					DEVICE_NID[9];
	unsigned int 		DEVICE_TRACE_NBR;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2017_1   		m_Trans_2017_1;
	Trans_2017_2 			m_Trans_2017_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2017_1,0x00,sizeof(Trans_2017_1));
	m_Trans_2017_1 = *(Trans_2017_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2017_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2017_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2017_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2017_1.CENTER_NID);
	count = CommonFuncs::dwordtowin(m_Trans_2017_1.dw_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2017_1) + count * sizeof(Trans_2017_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2017 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2017 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2017_2,0x00,sizeof(Trans_2017_2));
		m_Trans_2017_2 = *(Trans_2017_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2017_1)+sizeof(Trans_2017_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2017_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2017_2.FILE_ID[i]);
		memset(USER_ID,0x00,sizeof(USER_ID));
		for(i = 0;i < sizeof(m_Trans_2017_2.USER_ID);i++)
			sprintf(USER_ID+2*i,"%02X",m_Trans_2017_2.USER_ID[i]);
		memset(TRANS_TIME,0x00,sizeof(TRANS_TIME));
		for(i = 0;i < sizeof(m_Trans_2017_2.TRANS_TIME);i++)
			sprintf(TRANS_TIME+2*i,"%02X",m_Trans_2017_2.TRANS_TIME[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_2017_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_2017_2.DEVICE_NID[i]);
		DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_2017_2.DEVICE_TRACE_NBR);
		memset(RESETTLE_DATE,0x00,sizeof(RESETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_2017_2.RESETTLE_DATE);i++)
			sprintf(RESETTLE_DATE+2*i,"%02X",m_Trans_2017_2.RESETTLE_DATE[i]);
		EXEC SQL INSERT INTO TBL_RC_2017_RESETTLE_DETAIL(PACKET_SEQ,LINE_NID,SETTLE_DATE,RESETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  FILE_ID,USER_ID,TRANS_TIME,
                                                  DEVICE_NID,DEVICE_TRACE_NBR)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:RESETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :FILE_ID,:USER_ID,TO_DATE(:TRANS_TIME,'YYYYMMDDHH24MISS'),
                                                  :DEVICE_NID,:DEVICE_TRACE_NBR);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2017(第%d条记录)ErrorCode(TBL_RC_2017_RESETTLE_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2017_1,sizeof(Trans_2017_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2017_1),&m_Trans_2017_2,sizeof(Trans_2017_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2017_1)+sizeof(Trans_2017_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2013(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						TICKET_TYPE[5];
	char 						TRANS_TYPE[3];
	unsigned int 		UPLOAD_COUNT_TODAY;
	unsigned int 		UPLOAD_AMOUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_COUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_AMOUNT_TODAY;
	unsigned int 		DOUBT_COUNT_TODAY;
	unsigned int 		DOUBT_AMOUNT_TODAY;
	unsigned int 		UNI_COUNT_TODAY;
	unsigned int 		UNI_AMOUNT_TODAY;
	unsigned int 		DELAY_COUNT_TODAY;
	unsigned int 		DALAY_AMOUNT_TODAY;
	unsigned int 		DOUBT_RESETTLE_COUNT_YES;
	unsigned int 		DOUBT_RESETTLE_AMOUNT_YES;
	unsigned int 		UNI_RESETTLE_COUNT_YES;
	unsigned int 		UNI_RESETTLE_AMOUNT_YES;
	unsigned int 		DELAY_RESETTLE_COUNT_YES;
	unsigned int 		DELAY_RESETTLE_AMOUNT_YES;
	unsigned int 		TRANS_AMOUNT_TODAY;
	char            UNION_PAY_SETTLE_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2013_1   		m_Trans_2013_1;
	Trans_2013_2 			m_Trans_2013_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2013_1,0x00,sizeof(Trans_2013_1));
	m_Trans_2013_1 = *(Trans_2013_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2013_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2013_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2013_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2013_1.CENTER_NID);
	count =  CommonFuncs::wordtowin(m_Trans_2013_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2013_1) + count * sizeof(Trans_2013_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2013 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2013 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2013_2,0x00,sizeof(Trans_2013_2));
		m_Trans_2013_2 = *(Trans_2013_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2013_1)+sizeof(Trans_2013_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_2013_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_2013_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_2013_2.TRANS_TYPE);
		UPLOAD_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2013_2.UPLOAD_COUNT_TODAY);
		UPLOAD_AMOUNT_TODAY 			= CommonFuncs::dwordtowin(m_Trans_2013_2.UPLOAD_AMOUNT_TODAY);
		UPLOAD_SETTLE_COUNT_TODAY = CommonFuncs::dwordtowin(m_Trans_2013_2.UPLOAD_SETTLE_COUNT_TODAY);
		UPLOAD_SETTLE_AMOUNT_TODAY= CommonFuncs::dwordtowin(m_Trans_2013_2.UPLOAD_SETTLE_AMOUNT_TODAY);
		DOUBT_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2013_2.DOUBT_COUNT_TODAY);
		DOUBT_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2013_2.DOUBT_AMOUNT_TODAY);
		UNI_COUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_2013_2.UNI_COUNT_TODAY);
		UNI_AMOUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_2013_2.UNI_AMOUNT_TODAY);
		DELAY_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2013_2.DELAY_COUNT_TODAY);
		DALAY_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2013_2.DALAY_AMOUNT_TODAY);
		DOUBT_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2013_2.DOUBT_RESETTLE_COUNT_YES);
		DOUBT_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_2013_2.DOUBT_RESETTLE_AMOUNT_YES);
		UNI_RESETTLE_COUNT_YES 		= CommonFuncs::dwordtowin(m_Trans_2013_2.UNI_RESETTLE_COUNT_YES);
		UNI_RESETTLE_AMOUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2013_2.UNI_RESETTLE_AMOUNT_YES);
		DELAY_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2013_2.DELAY_RESETTLE_COUNT_YES);
		DELAY_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_2013_2.DELAY_RESETTLE_AMOUNT_YES);
		TRANS_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2013_2.TRANS_AMOUNT_TODAY);
		memset(UNION_PAY_SETTLE_DATE,0x00,sizeof(UNION_PAY_SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_2013_2.UNION_PAY_SETTLE_DATE);i++)
			sprintf(UNION_PAY_SETTLE_DATE+2*i,"%02X",m_Trans_2013_2.UNION_PAY_SETTLE_DATE[i]);
		EXEC SQL INSERT INTO TBL_RC_2013_CLEAR_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  TICKET_TYPE,TRANS_TYPE,UPLOAD_COUNT_TODAY,UPLOAD_AMOUNT_TODAY,
                                                  UPLOAD_SETTLE_COUNT_TODAY,UPLOAD_SETTLE_AMOUNT_TODAY,DOUBT_COUNT_TODAY,DOUBT_AMOUNT_TODAY,
                                                  UNI_COUNT_TODAY,UNI_AMOUNT_TODAY,DELAY_COUNT_TODAY,DALAY_AMOUNT_TODAY,
                                                  DOUBT_RESETTLE_COUNT_YES,DOUBT_RESETTLE_AMOUNT_YES,UNI_RESETTLE_COUNT_YES,UNI_RESETTLE_AMOUNT_YES,
                                                  DELAY_RESETTLE_COUNT_YES,DELAY_RESETTLE_AMOUNT_YES,TRANS_AMOUNT_TODAY,UNION_PAY_SETTLE_DATE)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TICKET_TYPE,:TRANS_TYPE,:UPLOAD_COUNT_TODAY,:UPLOAD_AMOUNT_TODAY,
                                                  :UPLOAD_SETTLE_COUNT_TODAY,:UPLOAD_SETTLE_AMOUNT_TODAY,:DOUBT_COUNT_TODAY,:DOUBT_AMOUNT_TODAY,
                                                  :UNI_COUNT_TODAY,:UNI_AMOUNT_TODAY,:DELAY_COUNT_TODAY,:DALAY_AMOUNT_TODAY,
                                                  :DOUBT_RESETTLE_COUNT_YES,:DOUBT_RESETTLE_AMOUNT_YES,:UNI_RESETTLE_COUNT_YES,:UNI_RESETTLE_AMOUNT_YES,
                                                  :DELAY_RESETTLE_COUNT_YES,:DELAY_RESETTLE_AMOUNT_YES,:TRANS_AMOUNT_TODAY,:UNION_PAY_SETTLE_DATE);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2013(第%d条记录)ErrorCode(TBL_RC_2013_CLEAR_DATA) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2013_1,sizeof(Trans_2013_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2013_1),&m_Trans_2013_2,sizeof(Trans_2013_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2013_1)+sizeof(Trans_2013_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2018(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	char 						TICKET_TYPE[5];
	char 						TRANS_TYPE[3];
	unsigned int 		UPLOAD_COUNT_TODAY;
	unsigned int 		UPLOAD_AMOUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_COUNT_TODAY;
	unsigned int 		UPLOAD_SETTLE_AMOUNT_TODAY;
	unsigned int 		DOUBT_COUNT_TODAY;
	unsigned int 		DOUBT_AMOUNT_TODAY;
	unsigned int 		UNI_COUNT_TODAY;
	unsigned int 		UNI_AMOUNT_TODAY;
	unsigned int 		DELAY_COUNT_TODAY;
	unsigned int 		DALAY_AMOUNT_TODAY;
	unsigned int 		DOUBT_RESETTLE_COUNT_YES;
	unsigned int 		DOUBT_RESETTLE_AMOUNT_YES;
	unsigned int 		UNI_RESETTLE_COUNT_YES;
	unsigned int 		UNI_RESETTLE_AMOUNT_YES;
	unsigned int 		DELAY_RESETTLE_COUNT_YES;
	unsigned int 		DELAY_RESETTLE_AMOUNT_YES;
	unsigned int 		TRANS_AMOUNT_TODAY;
	char            QR_PAY_SETTLE_DATE[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2018_1   		m_Trans_2018_1;
	Trans_2018_2 			m_Trans_2018_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2018_1,0x00,sizeof(Trans_2018_1));
	m_Trans_2018_1 = *(Trans_2018_1 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2018_1.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2018_1.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2018_1.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2018_1.CENTER_NID);
	count =  CommonFuncs::wordtowin(m_Trans_2018_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2018_1) + count * sizeof(Trans_2018_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2018 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2018 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2018_2,0x00,sizeof(Trans_2018_2));
		m_Trans_2018_2 = *(Trans_2018_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2018_1)+sizeof(Trans_2018_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_2018_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_2018_2.TICKET_TYPE[i]);
		memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
		sprintf(TRANS_TYPE,"%02X",m_Trans_2018_2.TRANS_TYPE);
		UPLOAD_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2018_2.UPLOAD_COUNT_TODAY);
		UPLOAD_AMOUNT_TODAY 			= CommonFuncs::dwordtowin(m_Trans_2018_2.UPLOAD_AMOUNT_TODAY);
		UPLOAD_SETTLE_COUNT_TODAY = CommonFuncs::dwordtowin(m_Trans_2018_2.UPLOAD_SETTLE_COUNT_TODAY);
		UPLOAD_SETTLE_AMOUNT_TODAY= CommonFuncs::dwordtowin(m_Trans_2018_2.UPLOAD_SETTLE_AMOUNT_TODAY);
		DOUBT_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2018_2.DOUBT_COUNT_TODAY);
		DOUBT_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2018_2.DOUBT_AMOUNT_TODAY);
		UNI_COUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_2018_2.UNI_COUNT_TODAY);
		UNI_AMOUNT_TODAY 					= CommonFuncs::dwordtowin(m_Trans_2018_2.UNI_AMOUNT_TODAY);
		DELAY_COUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2018_2.DELAY_COUNT_TODAY);
		DALAY_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2018_2.DALAY_AMOUNT_TODAY);
		DOUBT_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2018_2.DOUBT_RESETTLE_COUNT_YES);
		DOUBT_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_2018_2.DOUBT_RESETTLE_AMOUNT_YES);
		UNI_RESETTLE_COUNT_YES 		= CommonFuncs::dwordtowin(m_Trans_2018_2.UNI_RESETTLE_COUNT_YES);
		UNI_RESETTLE_AMOUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2018_2.UNI_RESETTLE_AMOUNT_YES);
		DELAY_RESETTLE_COUNT_YES 	= CommonFuncs::dwordtowin(m_Trans_2018_2.DELAY_RESETTLE_COUNT_YES);
		DELAY_RESETTLE_AMOUNT_YES = CommonFuncs::dwordtowin(m_Trans_2018_2.DELAY_RESETTLE_AMOUNT_YES);
		TRANS_AMOUNT_TODAY 				= CommonFuncs::dwordtowin(m_Trans_2018_2.TRANS_AMOUNT_TODAY);
		memset(QR_PAY_SETTLE_DATE,0x00,sizeof(QR_PAY_SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_2018_2.QR_PAY_SETTLE_DATE);i++)
			sprintf(QR_PAY_SETTLE_DATE+2*i,"%02X",m_Trans_2018_2.QR_PAY_SETTLE_DATE[i]);
		EXEC SQL INSERT INTO TBL_RC_2018_CLEAR_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                  TICKET_TYPE,TRANS_TYPE,UPLOAD_COUNT_TODAY,UPLOAD_AMOUNT_TODAY,
                                                  UPLOAD_SETTLE_COUNT_TODAY,UPLOAD_SETTLE_AMOUNT_TODAY,DOUBT_COUNT_TODAY,DOUBT_AMOUNT_TODAY,
                                                  UNI_COUNT_TODAY,UNI_AMOUNT_TODAY,DELAY_COUNT_TODAY,DALAY_AMOUNT_TODAY,
                                                  DOUBT_RESETTLE_COUNT_YES,DOUBT_RESETTLE_AMOUNT_YES,UNI_RESETTLE_COUNT_YES,UNI_RESETTLE_AMOUNT_YES,
                                                  DELAY_RESETTLE_COUNT_YES,DELAY_RESETTLE_AMOUNT_YES,TRANS_AMOUNT_TODAY,QR_PAY_SETTLE_DATE)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TICKET_TYPE,:TRANS_TYPE,:UPLOAD_COUNT_TODAY,:UPLOAD_AMOUNT_TODAY,
                                                  :UPLOAD_SETTLE_COUNT_TODAY,:UPLOAD_SETTLE_AMOUNT_TODAY,:DOUBT_COUNT_TODAY,:DOUBT_AMOUNT_TODAY,
                                                  :UNI_COUNT_TODAY,:UNI_AMOUNT_TODAY,:DELAY_COUNT_TODAY,:DALAY_AMOUNT_TODAY,
                                                  :DOUBT_RESETTLE_COUNT_YES,:DOUBT_RESETTLE_AMOUNT_YES,:UNI_RESETTLE_COUNT_YES,:UNI_RESETTLE_AMOUNT_YES,
                                                  :DELAY_RESETTLE_COUNT_YES,:DELAY_RESETTLE_AMOUNT_YES,:TRANS_AMOUNT_TODAY,:QR_PAY_SETTLE_DATE);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2018(第%d条记录)ErrorCode(TBL_RC_2018_CLEAR_DATA) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2018_1,sizeof(Trans_2018_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2018_1),&m_Trans_2018_2,sizeof(Trans_2018_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2018_1)+sizeof(Trans_2018_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2014(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
	char 						UPLOAD_TIME[15];
	char 						MEASURE_TIME[15];
	char 						SETTLE_TIME[15];
	char 						SETTLE_DATE[9];
	char 						FILE_TYPE[3];
	char 						FILE_STATUS[3];
	unsigned int 		ROW_NUM;
	unsigned int 		MEASURE_ROW_NUM;
	unsigned int 		NORMAL_ROW_NUM;
	unsigned int 		DOUBT_ROW_NUM;
	unsigned int 		TEST_NUM;
	unsigned int 		SETTLE_ERROR_ROW_NUM;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2014_1   		m_Trans_2014_1;
	Trans_2014_2 			m_Trans_2014_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2014_1,0x00,sizeof(Trans_2014_1));
	m_Trans_2014_1 = *(Trans_2014_1 *)(recvbuf + sizeof(MsgHead));
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2014_1.CENTER_NID);
	count =  CommonFuncs::wordtowin(m_Trans_2014_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2014_1) + count * sizeof(Trans_2014_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2014 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2014 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2014_2,0x00,sizeof(Trans_2014_2));
		m_Trans_2014_2 = *(Trans_2014_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2014_1)+sizeof(Trans_2014_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2014_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2014_2.FILE_ID[i]);
		memset(UPLOAD_TIME,0x00,sizeof(UPLOAD_TIME));
		for(i = 0;i < sizeof(m_Trans_2014_2.UPLOAD_TIME);i++)
			sprintf(UPLOAD_TIME+2*i,"%02X",m_Trans_2014_2.UPLOAD_TIME[i]);
		memset(MEASURE_TIME,0x00,sizeof(MEASURE_TIME));
		for(i = 0;i < sizeof(m_Trans_2014_2.MEASURE_TIME);i++)
			sprintf(MEASURE_TIME+2*i,"%02X",m_Trans_2014_2.MEASURE_TIME[i]);
		memset(SETTLE_TIME,0x00,sizeof(SETTLE_TIME));
		for(i = 0;i < sizeof(m_Trans_2014_2.SETTLE_TIME);i++)
			sprintf(SETTLE_TIME+2*i,"%02X",m_Trans_2014_2.SETTLE_TIME[i]);
		memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_2014_2.SETTLE_DATE);i++)
			sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2014_2.SETTLE_DATE[i]);
		memset(FILE_TYPE,0x00,sizeof(FILE_TYPE));
		sprintf(FILE_TYPE,"%02X",m_Trans_2014_2.FILE_TYPE);
		memset(FILE_STATUS,0x00,sizeof(FILE_STATUS));
		sprintf(FILE_STATUS,"%02X",m_Trans_2014_2.FILE_STATUS);
		ROW_NUM 									= CommonFuncs::dwordtowin(m_Trans_2014_2.ROW_NUM);
		MEASURE_ROW_NUM 					= CommonFuncs::dwordtowin(m_Trans_2014_2.MEASURE_ROW_NUM);
		NORMAL_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_2014_2.NORMAL_ROW_NUM);
		DOUBT_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_2014_2.DOUBT_ROW_NUM);
		TEST_NUM 									= CommonFuncs::dwordtowin(m_Trans_2014_2.TEST_NUM);
		SETTLE_ERROR_ROW_NUM 			= CommonFuncs::dwordtowin(m_Trans_2014_2.SETTLE_ERROR_ROW_NUM);
		EXEC SQL INSERT INTO TBL_RC_2014_PKG_DETAIL (PACKET_SEQ,LINE_NID,CENTER_NID,FILE_ID,
                                                 UPLOAD_TIME,
                                                 MEASURE_TIME,
                                                 SETTLE_TIME,
                                                 SETTLE_DATE,FILE_TYPE,FILE_STATUS,ROW_NUM,
                                                 MEASURE_ROW_NUM,NORMAL_ROW_NUM,DOUBT_ROW_NUM,TEST_NUM,SETTLE_ERROR_ROW_NUM)
		                                       VALUES(:msg_pointer,:b_DestID,:CENTER_NID,:FILE_ID,
                                                 TO_DATE(:UPLOAD_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:MEASURE_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:SETTLE_TIME,'YYYYMMDDHH24MISS'),
                                                 :SETTLE_DATE,:FILE_TYPE,:FILE_STATUS,:ROW_NUM,
                                                 :MEASURE_ROW_NUM,:NORMAL_ROW_NUM,:DOUBT_ROW_NUM,:TEST_NUM,:SETTLE_ERROR_ROW_NUM);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2014(第%d条记录)ErrorCode(TBL_RC_2014_PKG_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2014_1,sizeof(Trans_2014_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2014_1),&m_Trans_2014_2,sizeof(Trans_2014_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2014_1)+sizeof(Trans_2014_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2019(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char 	          CENTER_NID[3];
  
	char 						FILE_ID[25];
	char 						UPLOAD_TIME[15];
	char 						MEASURE_TIME[15];
	char 						SETTLE_TIME[15];
	char 						SETTLE_DATE[9];
	char 						FILE_TYPE[3];
	char 						FILE_STATUS[3];
	unsigned int 		ROW_NUM;
	unsigned int 		MEASURE_ROW_NUM;
	unsigned int 		NORMAL_ROW_NUM;
	unsigned int 		DOUBT_ROW_NUM;
	unsigned int 		TEST_NUM;
	unsigned int 		SETTLE_ERROR_ROW_NUM;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_2019_1   		m_Trans_2019_1;
	Trans_2019_2 			m_Trans_2019_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2019_1,0x00,sizeof(Trans_2019_1));
	m_Trans_2019_1 = *(Trans_2019_1 *)(recvbuf + sizeof(MsgHead));
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2019_1.CENTER_NID);
	count =  CommonFuncs::wordtowin(m_Trans_2019_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2019_1) + count * sizeof(Trans_2019_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2019 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2019 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_2019_2,0x00,sizeof(Trans_2019_2));
		m_Trans_2019_2 = *(Trans_2019_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_2019_1)+sizeof(Trans_2019_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(FILE_ID,0x00,sizeof(FILE_ID));
		for(i = 0;i < sizeof(m_Trans_2019_2.FILE_ID);i++)
			sprintf(FILE_ID+2*i,"%02X",m_Trans_2019_2.FILE_ID[i]);
		memset(UPLOAD_TIME,0x00,sizeof(UPLOAD_TIME));
		for(i = 0;i < sizeof(m_Trans_2019_2.UPLOAD_TIME);i++)
			sprintf(UPLOAD_TIME+2*i,"%02X",m_Trans_2019_2.UPLOAD_TIME[i]);
		memset(MEASURE_TIME,0x00,sizeof(MEASURE_TIME));
		for(i = 0;i < sizeof(m_Trans_2019_2.MEASURE_TIME);i++)
			sprintf(MEASURE_TIME+2*i,"%02X",m_Trans_2019_2.MEASURE_TIME[i]);
		memset(SETTLE_TIME,0x00,sizeof(SETTLE_TIME));
		for(i = 0;i < sizeof(m_Trans_2019_2.SETTLE_TIME);i++)
			sprintf(SETTLE_TIME+2*i,"%02X",m_Trans_2019_2.SETTLE_TIME[i]);
		memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_2019_2.SETTLE_DATE);i++)
			sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2019_2.SETTLE_DATE[i]);
		memset(FILE_TYPE,0x00,sizeof(FILE_TYPE));
		sprintf(FILE_TYPE,"%02X",m_Trans_2019_2.FILE_TYPE);
		memset(FILE_STATUS,0x00,sizeof(FILE_STATUS));
		sprintf(FILE_STATUS,"%02X",m_Trans_2019_2.FILE_STATUS);
		ROW_NUM 									= CommonFuncs::dwordtowin(m_Trans_2019_2.ROW_NUM);
		MEASURE_ROW_NUM 					= CommonFuncs::dwordtowin(m_Trans_2019_2.MEASURE_ROW_NUM);
		NORMAL_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_2019_2.NORMAL_ROW_NUM);
		DOUBT_ROW_NUM 						= CommonFuncs::dwordtowin(m_Trans_2019_2.DOUBT_ROW_NUM);
		TEST_NUM 									= CommonFuncs::dwordtowin(m_Trans_2019_2.TEST_NUM);
		SETTLE_ERROR_ROW_NUM 			= CommonFuncs::dwordtowin(m_Trans_2019_2.SETTLE_ERROR_ROW_NUM);
		EXEC SQL INSERT INTO TBL_RC_2019_PKG_DETAIL (PACKET_SEQ,LINE_NID,CENTER_NID,FILE_ID,
                                                 UPLOAD_TIME,
                                                 MEASURE_TIME,
                                                 SETTLE_TIME,
                                                 SETTLE_DATE,FILE_TYPE,FILE_STATUS,ROW_NUM,
                                                 MEASURE_ROW_NUM,NORMAL_ROW_NUM,DOUBT_ROW_NUM,TEST_NUM,SETTLE_ERROR_ROW_NUM)
		                                       VALUES(:msg_pointer,:b_DestID,:CENTER_NID,:FILE_ID,
                                                 TO_DATE(:UPLOAD_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:MEASURE_TIME,'YYYYMMDDHH24MISS'),
                                                 TO_DATE(:SETTLE_TIME,'YYYYMMDDHH24MISS'),
                                                 :SETTLE_DATE,:FILE_TYPE,:FILE_STATUS,:ROW_NUM,
                                                 :MEASURE_ROW_NUM,:NORMAL_ROW_NUM,:DOUBT_ROW_NUM,:TEST_NUM,:SETTLE_ERROR_ROW_NUM);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_2019(第%d条记录)ErrorCode(TBL_RC_2019_PKG_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2019_1,sizeof(Trans_2019_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_2019_1),&m_Trans_2019_2,sizeof(Trans_2019_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_2019_1)+sizeof(Trans_2019_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据庖斐? -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2010(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	unsigned int 		TRANS_COUNT;
	unsigned int 		NORMAL_COUNT;
	unsigned int 		NORMAL_ACTUAL_AMOUNT;
	unsigned int 		NORMAL_SHOULD_AMOUNT;
	unsigned int 		NORMAL_DISCOUNT_AMOUNT;
	unsigned int 		DOUBT_COUNT;
	unsigned int 		DOUBT_AMOUNT;
	unsigned int 		RESETTLE_COUNT;
	unsigned int 		RESETTLE_AMOUNT;
	unsigned int 		DELAY_SETTLE_COUNT;
	unsigned int 		DELAY_SETTLE_AMOUNT;
	unsigned int 		FEE;
	unsigned int 		ADJUST_AMOUNT;
	char				 		ADJUST_REASON[100];
	char        		ADJUST_TIME[7];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_2010 			  m_Trans_2010;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2010,0x00,sizeof(Trans_2010));
	m_Trans_2010 = *(Trans_2010 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2010.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2010.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2010.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2010.CENTER_NID);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2010);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2010 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2010 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ----- 结构变量赋值 ---*/
	TRANS_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2010.TRANS_COUNT);
	NORMAL_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2010.NORMAL_COUNT);
	NORMAL_ACTUAL_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2010.NORMAL_ACTUAL_AMOUNT);
	NORMAL_SHOULD_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2010.NORMAL_SHOULD_AMOUNT);
	NORMAL_DISCOUNT_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2010.NORMAL_DISCOUNT_AMOUNT);
	DOUBT_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2010.DOUBT_COUNT);
	DOUBT_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_2010.DOUBT_AMOUNT);
	RESETTLE_COUNT 			= CommonFuncs::dwordtowin(m_Trans_2010.RESETTLE_COUNT);
	RESETTLE_AMOUNT 		= CommonFuncs::dwordtowin(m_Trans_2010.RESETTLE_AMOUNT);
	DELAY_SETTLE_COUNT 	= CommonFuncs::dwordtowin(m_Trans_2010.DELAY_SETTLE_COUNT);
	DELAY_SETTLE_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2010.DELAY_SETTLE_AMOUNT);
	FEE 								= CommonFuncs::dwordtowin(m_Trans_2010.FEE);
	ADJUST_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_2010.ADJUST_AMOUNT);
	memset(ADJUST_REASON,0x00,sizeof(ADJUST_REASON));
	memcpy(ADJUST_REASON,m_Trans_2010.ADJUST_REASON,sizeof(m_Trans_2010.ADJUST_REASON));
	memset(ADJUST_TIME,0x00,sizeof(ADJUST_TIME));
	for(i = 0;i < sizeof(m_Trans_2010.ADJUST_TIME);i++)
		sprintf(ADJUST_TIME+2*i,"%02X",m_Trans_2010.ADJUST_TIME[i]);
	EXEC SQL INSERT INTO TBL_RC_2010_SETTLE_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                TRANS_COUNT,NORMAL_COUNT,DOUBT_COUNT,
                                                DOUBT_AMOUNT,RESETTLE_COUNT,RESETTLE_AMOUNT,DELAY_SETTLE_COUNT,
                                                DELAY_SETTLE_AMOUNT,FEE,ADJUST_AMOUNT,ADJUST_REASON,
                                                ADJUST_TIME,NORMAL_ACTUAL_AMOUNT,NORMAL_SHOULD_AMOUNT,NORMAL_DISCOUNT_AMOUNT)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TRANS_COUNT,:NORMAL_COUNT,:DOUBT_COUNT,
                                                  :DOUBT_AMOUNT,:RESETTLE_COUNT,:RESETTLE_AMOUNT,:DELAY_SETTLE_COUNT,
                                                  :DELAY_SETTLE_AMOUNT,:FEE,:ADJUST_AMOUNT,:ADJUST_REASON,
                                                  TO_DATE(:ADJUST_TIME,'YYYYMMDDHH24MISS'),:NORMAL_ACTUAL_AMOUNT,:NORMAL_SHOULD_AMOUNT,:NORMAL_DISCOUNT_AMOUNT);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2010 ErrorCode(TBL_RC_2010_SETTLE_DATA) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		memset(errorbuf,0x00,sizeof(errorbuf));
		memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
		memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2010,sizeof(Trans_2010));
		errorlen = sizeof(MsgHead)+sizeof(Trans_2010);
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		
		EXEC SQL ROLLBACK;
	} 
	else                  
		EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_2015(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char 						SETTLE_DATE[9];
	int           	SETTLE_TYPE;
  char 	          CENTER_NID[3];
  
	unsigned int 		TRANS_COUNT;
	unsigned int 		NORMAL_COUNT;
	unsigned int 		NORMAL_ACTUAL_AMOUNT;
	unsigned int 		NORMAL_SHOULD_AMOUNT;
	unsigned int 		NORMAL_DISCOUNT_AMOUNT;
	unsigned int 		DOUBT_COUNT;
	unsigned int 		DOUBT_AMOUNT;
	unsigned int 		RESETTLE_COUNT;
	unsigned int 		RESETTLE_AMOUNT;
	unsigned int 		DELAY_SETTLE_COUNT;
	unsigned int 		DELAY_SETTLE_AMOUNT;
	unsigned int 		FEE;
	unsigned int 		ADJUST_AMOUNT;
	char				 		ADJUST_REASON[100];
	char        		ADJUST_TIME[7];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_2015 			  m_Trans_2015;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_2015,0x00,sizeof(Trans_2015));
	m_Trans_2015 = *(Trans_2015 *)(recvbuf + sizeof(MsgHead));
	memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
	for(i=0;i<sizeof(m_Trans_2015.SETTLE_DATE);i++)
		sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_2015.SETTLE_DATE[i]);
	SETTLE_TYPE = (int)m_Trans_2015.SETTLE_TYPE;
	memset(CENTER_NID,0x00,sizeof(CENTER_NID));
	sprintf(CENTER_NID,"%02X",m_Trans_2015.CENTER_NID);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_2015);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2015 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2015 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ----- 结构变量赋值 ---*/
	TRANS_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2015.TRANS_COUNT);
	NORMAL_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2015.NORMAL_COUNT);
	NORMAL_ACTUAL_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2015.NORMAL_ACTUAL_AMOUNT);
	NORMAL_SHOULD_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2015.NORMAL_SHOULD_AMOUNT);
	NORMAL_DISCOUNT_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2015.NORMAL_DISCOUNT_AMOUNT);
	DOUBT_COUNT 				= CommonFuncs::dwordtowin(m_Trans_2015.DOUBT_COUNT);
	DOUBT_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_2015.DOUBT_AMOUNT);
	RESETTLE_COUNT 			= CommonFuncs::dwordtowin(m_Trans_2015.RESETTLE_COUNT);
	RESETTLE_AMOUNT 		= CommonFuncs::dwordtowin(m_Trans_2015.RESETTLE_AMOUNT);
	DELAY_SETTLE_COUNT 	= CommonFuncs::dwordtowin(m_Trans_2015.DELAY_SETTLE_COUNT);
	DELAY_SETTLE_AMOUNT = CommonFuncs::dwordtowin(m_Trans_2015.DELAY_SETTLE_AMOUNT);
	FEE 								= CommonFuncs::dwordtowin(m_Trans_2015.FEE);
	ADJUST_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_2015.ADJUST_AMOUNT);
	memset(ADJUST_REASON,0x00,sizeof(ADJUST_REASON));
	memcpy(ADJUST_REASON,m_Trans_2015.ADJUST_REASON,sizeof(m_Trans_2015.ADJUST_REASON));
	memset(ADJUST_TIME,0x00,sizeof(ADJUST_TIME));
	for(i = 0;i < sizeof(m_Trans_2015.ADJUST_TIME);i++)
		sprintf(ADJUST_TIME+2*i,"%02X",m_Trans_2015.ADJUST_TIME[i]);
	EXEC SQL INSERT INTO TBL_RC_2015_SETTLE_DATA (PACKET_SEQ,LINE_NID,SETTLE_DATE,SETTLE_TYPE,CENTER_NID,
                                                TRANS_COUNT,NORMAL_COUNT,DOUBT_COUNT,
                                                DOUBT_AMOUNT,RESETTLE_COUNT,RESETTLE_AMOUNT,DELAY_SETTLE_COUNT,
                                                DELAY_SETTLE_AMOUNT,FEE,ADJUST_AMOUNT,ADJUST_REASON,
                                                ADJUST_TIME,NORMAL_ACTUAL_AMOUNT,NORMAL_SHOULD_AMOUNT,NORMAL_DISCOUNT_AMOUNT)
		                                       VALUES(:msg_pointer,:b_DestID,:SETTLE_DATE,:SETTLE_TYPE,:CENTER_NID,
                                                  :TRANS_COUNT,:NORMAL_COUNT,:DOUBT_COUNT,
                                                  :DOUBT_AMOUNT,:RESETTLE_COUNT,:RESETTLE_AMOUNT,:DELAY_SETTLE_COUNT,
                                                  :DELAY_SETTLE_AMOUNT,:FEE,:ADJUST_AMOUNT,:ADJUST_REASON,
                                                  TO_DATE(:ADJUST_TIME,'YYYYMMDDHH24MISS'),:NORMAL_ACTUAL_AMOUNT,:NORMAL_SHOULD_AMOUNT,:NORMAL_DISCOUNT_AMOUNT);
		if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_2015 ErrorCode(TBL_RC_2015_SETTLE_DATA) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		memset(errorbuf,0x00,sizeof(errorbuf));
		memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
		memcpy(errorbuf+sizeof(MsgHead),&m_Trans_2015,sizeof(Trans_2015));
		errorlen = sizeof(MsgHead)+sizeof(Trans_2015);
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		
		EXEC SQL ROLLBACK;
	} 
	else                  
		EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_7001(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	int           	ParamRecords;
  char          	DEVICE_NID[9];
	char            ParamVer[15];
	char            READER1[33];
	char            READER2[33];
  char          	LINE_NID[3];	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_7001_1 			m_Trans_7001_1;
	Trans_7001_2 			m_Trans_7001_2;
	BYTE          		*p;
	int								recordCounts;
		
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	
	memset(&m_Trans_7001_1,0x00,sizeof(Trans_7001_1));
	m_Trans_7001_1 = *(Trans_7001_1 *)(recvbuf + sizeof(MsgHead));
	recordCounts = CommonFuncs::wordtowin(m_Trans_7001_1.w_Records);
 
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_7001_1) + recordCounts * sizeof(Trans_7001_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	//EXEC SQL SELECT SEQ_STATUS_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_7001 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_7001 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		EXEC SQL ROLLBACK;
		return msg_pointer;
	}
	
	/* ----- 包体入库 ---*/
	for(int j = 0;j < recordCounts ;j++)
	{
		memset(&m_Trans_7001_2,0x00,sizeof(Trans_7001_2));
		m_Trans_7001_2 = *(Trans_7001_2 *)(recvbuf + sizeof(MsgHead) + sizeof(Trans_7001_1) + j * sizeof(Trans_7001_2));
		
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i=0;i<sizeof(m_Trans_7001_2.SLE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_7001_2.SLE_NID[i]);
			
		memset(ParamVer,0x00,sizeof(ParamVer));
		for(i = 0;i < sizeof(m_Trans_7001_2.ParamVer);i++)
			sprintf(ParamVer + 2 * i,"%02X",m_Trans_7001_2.ParamVer[i]);
 
		memset(READER1,0x00,sizeof(READER1));
		memcpy(READER1,m_Trans_7001_2.READER1,sizeof(m_Trans_7001_2.READER1));
 			
		memset(READER2,0x00,sizeof(READER2));
		memcpy(READER2,m_Trans_7001_2.READER2,sizeof(m_Trans_7001_2.READER2));			
 
		EXEC SQL INSERT INTO TBL_MN_7001_DEVICE (PACKET_SEQ,DEVICE_NID,MASTER_PARA_INDEX,CRWA_PROG_INDEX,CRWB_PROG_INDEX)
					                VALUES(:msg_pointer,:DEVICE_NID,:ParamVer,:READER1,:READER2);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_7001 ErrorCode(TBL_MN_7001_DEVICE) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			
			/* ----- 写入错误文件---*/
			EXEC SQL ROLLBACK;
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
			break;
		}
		else
		{
		}
	}
	
	EXEC SQL COMMIT;
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_7002(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	int           	ParamRecords;
 
	char            ParamVer[15];
 
  char          	LINE_NID[3];	
  char          	STATION_NID[5];
  char            DEVICE_TYPE[3];          	 
 	int           	NORMAL_COUNT;
 	int           	OFFLINE_COUNT;
 	int           	FAIL_COUNT;
 
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_7002_1 			m_Trans_7002_1;
	Trans_7002_2 			m_Trans_7002_2;
	BYTE          		*p;
	int								recordCounts;
		
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	
	memset(&m_Trans_7002_1,0x00,sizeof(Trans_7002_1));
	m_Trans_7002_1 = *(Trans_7002_1 *)(recvbuf + sizeof(MsgHead));
	recordCounts = CommonFuncs::wordtowin(m_Trans_7002_1.w_Records);
 
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_7002_1) + recordCounts * sizeof(Trans_7002_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_7002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_7002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		EXEC SQL ROLLBACK;
		return msg_pointer;
	}
	
	memset(LINE_NID,0x00,sizeof(LINE_NID));
	sprintf(LINE_NID,"%02X",m_Trans_7002_1.CC_NID);
 
	/* ----- 包体入库 ---*/
	for(int j = 0;j < recordCounts ;j++)
	{
		memset(&m_Trans_7002_2,0x00,sizeof(Trans_7002_2));
		m_Trans_7002_2 = *(Trans_7002_2 *)(recvbuf + sizeof(MsgHead) + sizeof(Trans_7002_1) + j * sizeof(Trans_7002_2));
		
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i=0;i<sizeof(m_Trans_7002_2.SC_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_7002_2.SC_NID[i]);

		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_7002_2.SLE_TYPE);	 

		NORMAL_COUNT = CommonFuncs::wordtowin(m_Trans_7002_2.Right_Count);
		OFFLINE_COUNT = CommonFuncs::wordtowin(m_Trans_7002_2.Offline_Count);		 
		FAIL_COUNT = CommonFuncs::wordtowin(m_Trans_7002_2.Failure_Count);
		 		
		EXEC SQL INSERT INTO TBL_MN_7002_DEVICESTAT (PACKET_SEQ,LINE_NID,STATION_NID,DEVICE_TYPE,NORMAL_COUNT,OFFLINE_COUNT,FAIL_COUNT)
					                VALUES(:msg_pointer,:LINE_NID,:STATION_NID,:DEVICE_TYPE,:NORMAL_COUNT,:OFFLINE_COUNT,:FAIL_COUNT);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_7002 ErrorCode(TBL_MN_7002_DEVICESTAT) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			
			/* ----- 写入错误文件---*/
			EXEC SQL ROLLBACK;
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
			break;
		}
		else
		{
		}
	}
	
	EXEC SQL COMMIT;
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_7010(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char           	c_TransTime[50];
	char           	tmp_TransTime[50],MAX_TransTime[50];
	char	        	DEVICE_NID[9];	
	char           	EventCode[9];
	
	int     				eventlevel;
	char            eventname[200],tmp_eventname[200];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_7010_1  		m_Trans_7010_1;
	Trans_7010_2 			m_Trans_7010_2;
	BYTE          		*p;
	int								gap;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	memset(&m_Trans_7010_1,0x00,sizeof(Trans_7010_1));
	m_Trans_7010_1 = *(Trans_7010_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_7010_1.w_Records);
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_7010_1) + count * sizeof(Trans_7010_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[10];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;

	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_7010 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_7010 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		EXEC SQL ROLLBACK;
		return msg_pointer;
	}
	
	/* ----- 包体固定部分 ---*/	
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i = 0;i < sizeof(m_Trans_7010_1.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_7010_1.DEVICE_NID[i]);
				
	memset(c_TransTime,0x00,sizeof(c_TransTime));
	for(i = 0;i < sizeof(m_Trans_7010_1.OCCUR_TIME);i++)
		sprintf(c_TransTime+2*i,"%02X",m_Trans_7010_1.OCCUR_TIME[i]);
			
	eventlevel = (int)	m_Trans_7010_1.DEVICE_STATUS;	
				
	/* ----- 最新状态上报时间 ---*/
	memset(tmp_TransTime,0x00,sizeof(tmp_TransTime));
	EXEC SQL SELECT TO_CHAR(MAX(OCCUR_TIME),'YYYYMMDDHH24MISS') INTO :tmp_TransTime
					 FROM TBL_MN_7010_STATUS 
					 WHERE DEVICE_NID = :DEVICE_NID;
	if(sqlca.sqlcode  != 0)
	{
		strcpy(tmp_TransTime,"19700101000000");
	} 
	memset(MAX_TransTime,0x00,sizeof(MAX_TransTime));
	CommonFuncs::delspace(MAX_TransTime,tmp_TransTime);
	gap = (int)(CTime::GetGmtTime(MAX_TransTime) - CTime::GetGmtTime(c_TransTime));
	/* ---- 上报时间大于最后一笔时间 ---*/
	if(gap <= 0)
	{		
		/* ---- 更新最新状态 ---*/
		EXEC SQL DELETE FROM T_MONITOR_DEVSTAT WHERE DEVICE_NID = :DEVICE_NID;
		EXEC SQL INSERT INTO T_MONITOR_DEVSTAT(CREATE_TIME,EVENT_LEVEL,
				                                   DEVICE_NID,OCCUR_TIME)
				                            VALUES(SYSDATE,:eventlevel,
				                                   :DEVICE_NID,to_date(:c_TransTime,'YYYYMMDDHH24MISS'));	
		
		/*------更新综合监控信息-----*/	
		ISCS::UpdateDeviceStatus(m_Trans_7010_1.DEVICE_NID,eventlevel);	
		
		
		/* ----- 清除所有未清除故障及状态明细入库 ---*/
		EXEC SQL DELETE FROM T_MONITOR_FAILURE WHERE DEVICE_NID = :DEVICE_NID;
		
		/*----将设备整机状态插入到 T_MONITOR_FAILURE HHJT_CJP 20201026---*/
		EXEC SQL DELETE FROM T_MONITOR_FAILURE
					   WHERE 	DEVICE_NID = :DEVICE_NID
					   	AND		EVENT_CODE = 'FFFFFFFF';		                                   
		EXEC SQL INSERT INTO T_MONITOR_FAILURE(OCCUR_TIME,EVENT_LEVEL,
			                                           DEVICE_NID,EVENT_CODE,EVENT_NAME)
			                                    VALUES(to_date(:c_TransTime,'YYYYMMDDHH24MISS'),:eventlevel,
		                                             :DEVICE_NID,'FFFFFFFF','设备整机状态');	
 
		for(j=0;j<count;j++)
		{
		  memset(&m_Trans_7010_2,0x00,sizeof(Trans_7010_2));
			m_Trans_7010_2 = *(Trans_7010_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_7010_1)+sizeof(Trans_7010_2)*j); 

			memset(EventCode,0x00,sizeof(EventCode));
			for(i = 0;i < sizeof(m_Trans_7010_2.EventCode);i++)
				sprintf(EventCode+2*i,"%02X",m_Trans_7010_2.EventCode[i]);
				
			memset(eventname,0x00,sizeof(eventname));
			EXEC SQL SELECT EVENT_LEVEL,CODE_DESC_CN INTO :eventlevel,:eventname FROM TBL_SS_DEVICE_EVENT WHERE DEVICE_EVENT = :EventCode;
			if(sqlca.sqlcode != 0)
			{
				eventlevel = 0;
				strcpy(eventname,"未定义");
			} 
			memset(tmp_eventname,0x00,sizeof(tmp_eventname));
			CommonFuncs::delspace(tmp_eventname,eventname);

		 	EXEC SQL INSERT INTO TBL_MN_7010_STATUS(MSG_POINTER,OCCUR_TIME,
			                                   DEVICE_NID,EVENT_FLAG,DEVICE_EVENT)
			                            VALUES(:msg_pointer,to_date(:c_TransTime,'YYYYMMDDHH24MISS'),
			                                   :DEVICE_NID,0,:EventCode);
		 
		 	EXEC SQL INSERT INTO TBL_MN_7010_STATUS_HIS(MSG_POINTER,OCCUR_TIME,
			                                   DEVICE_NID,EVENT_FLAG,DEVICE_EVENT)
			                            VALUES(:msg_pointer,to_date(:c_TransTime,'YYYYMMDDHH24MISS'),
			                                   :DEVICE_NID,0,:EventCode);	 
		 
		 	EXEC SQL INSERT INTO T_MONITOR_FAILURE(OCCUR_TIME,EVENT_LEVEL,
				                                           DEVICE_NID,EVENT_CODE,EVENT_NAME)
				                                    VALUES(to_date(:c_TransTime,'YYYYMMDDHH24MISS'),:eventlevel,
			                                             :DEVICE_NID,:EventCode,:tmp_eventname);
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s(第%d条记录):insert_into_7010 (T_MONITOR_FAILURE) Error,SLEID is %s,ErrorCode is %d\n",filename,j,DEVICE_NID,sqlca.sqlcode);
				CLog::WriteAppLog(oplogmsg); 
				
				continue;
			}
		}                       
	}
	else
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:状态上报滞后:(SLEID is %s,最后一次上报时间:%s比本次上报时间%s超前%d秒)\n",filename,DEVICE_NID,MAX_TransTime,c_TransTime,gap);
		CLog::WriteAppLog(oplogmsg);
		
		memset(c_TransTime,0x00,sizeof(c_TransTime));
		CTime::GetStringTime(c_TransTime);
		gap = (int)(CTime::GetGmtTime(MAX_TransTime) - CTime::GetGmtTime(c_TransTime));
		if(gap > 15 * 60)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:删除时间超前状态:(SLEID is %s,最后一次上报时间:%s比当前时间%s超前%d秒)\n",filename,DEVICE_NID,MAX_TransTime,c_TransTime,gap);
			CLog::WriteAppLog(oplogmsg);
			EXEC SQL DELETE FROM TBL_MN_7010_STATUS WHERE OCCUR_TIME > (SYSDATE+15*60/86400) AND DEVICE_NID = :DEVICE_NID;
			EXEC SQL DELETE FROM T_MONITOR_FAILURE WHERE OCCUR_TIME > (SYSDATE+15*60/86400) AND DEVICE_NID = :DEVICE_NID;
		}
	}
 
	EXEC SQL COMMIT;
	
	return msg_pointer;
}




/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_4001(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer,tmp_msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char  					DEVICE_NID[9];					
	char  					OPERATOR_ID[9];		
	char  					DEVICE_TYPE[3];
	char  					CRW_NO[5];
	char 	 					PSAM_NO[13];	
	char  					CHANGE_TYPE[3];		
	char  					CHANGE_MEMO[51];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j,k,x;
	unsigned short      wRecords,wRecords_1,wRecords_2;
	Trans_4001_Head			m_Trans_4001_Head;
	Trans_4001_Record_1 m_Trans_4001_Record_1;
	Trans_4001_Record_2 m_Trans_4001_Record_2;
	Trans_4001_Record_3 m_Trans_4001_Record_3;
	Trans_4001_Record_4 m_Trans_4001_Record_4;
	BYTE          			*p;
	char                temp[51];
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4001 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4001 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ----- 删除设备原有记录 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_4001_Head);
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i = 0;i < sizeof(m_Trans_4001_Record_1.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",*(p+i));
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen - 50;
	memset(temp,0x00,sizeof(temp));
	memcpy(temp,p,50);
	memset(CHANGE_MEMO,0x00,sizeof(CHANGE_MEMO));
	CommonFuncs::delspace(CHANGE_MEMO,temp);
	tmp_msg_pointer = 0;
	EXEC SQL SELECT PACKET_SEQ INTO :tmp_msg_pointer 
		         FROM TBL_DM_4001_DEVICE 
		            WHERE DEVICE_NID = :DEVICE_NID AND RTRIM(CHANGE_MEMO,' ') = :CHANGE_MEMO;
	EXEC SQL DELETE FROM TBL_DM_4001_DEVICE WHERE PACKET_SEQ = :tmp_msg_pointer;
	EXEC SQL DELETE FROM TBL_DM_4001_CRW WHERE PACKET_SEQ = :tmp_msg_pointer;
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_4001_Head,0x00,sizeof(Trans_4001_Head));
	m_Trans_4001_Head = *(Trans_4001_Head *)p;
	wRecords = 	 CommonFuncs::wordtowin(m_Trans_4001_Head.wRecords);	
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_4001_Head);			
	for(j=0;j<wRecords;j++)
	{
		memset(&m_Trans_4001_Record_1,0x00,sizeof(Trans_4001_Record_1));
		m_Trans_4001_Record_1 = *(Trans_4001_Record_1 *)p;
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_4001_Record_1.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_4001_Record_1.DEVICE_NID[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_4001_Record_1.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_4001_Record_1.OPERATOR_ID[i]);
		memset(DEVICE_TYPE,0x00,sizeof(DEVICE_TYPE));
		sprintf(DEVICE_TYPE,"%02X",m_Trans_4001_Record_1.DEVICE_TYPE);
		wRecords_1 =  CommonFuncs::wordtowin(m_Trans_4001_Record_1.wRecords_1);
		p = p + sizeof(Trans_4001_Record_1);
		for(k=0;k<wRecords_1;k++)
		{
			memset(&m_Trans_4001_Record_2,0x00,sizeof(Trans_4001_Record_2));
			m_Trans_4001_Record_2  = *(Trans_4001_Record_2 *)p;
			memset(CRW_NO,0x00,sizeof(CRW_NO));
			for(i = 0;i < sizeof(m_Trans_4001_Record_2.CRW_NO);i++)
				sprintf(CRW_NO+2*i,"%02X",m_Trans_4001_Record_2.CRW_NO[i]);
			wRecords_2 =  CommonFuncs::wordtowin(m_Trans_4001_Record_2.wRecords_2);
			p = p + sizeof(Trans_4001_Record_2);
			for(x=0;x<wRecords_2;x++)
			{
				memset(&m_Trans_4001_Record_3,0x00,sizeof(Trans_4001_Record_3));
				m_Trans_4001_Record_3  = *(Trans_4001_Record_3 *)p;
				memset(PSAM_NO,0x00,sizeof(PSAM_NO));
				for(i = 0;i < sizeof(m_Trans_4001_Record_3.PSAM_NO);i++)
					sprintf(PSAM_NO+2*i,"%02X",m_Trans_4001_Record_3.PSAM_NO[i]);
				p = p + sizeof(Trans_4001_Record_3);
				
				EXEC SQL INSERT INTO TBL_DM_4001_CRW(PACKET_SEQ,DEVICE_NID,OPERATOR_ID,CRW_NO,PSAM_NO)
				                              VALUES(:msg_pointer,:DEVICE_NID,:OPERATOR_ID,:CRW_NO,:PSAM_NO);
			}
		}
		memset(&m_Trans_4001_Record_4,0x00,sizeof(Trans_4001_Record_4));
		m_Trans_4001_Record_4  = *(Trans_4001_Record_4 *)p;
		memset(CHANGE_TYPE,0x00,sizeof(CHANGE_TYPE));
		sprintf(CHANGE_TYPE,"%02X",m_Trans_4001_Record_4.CHANGE_TYPE);
		memset(temp,0x00,sizeof(temp));
		memcpy(temp,m_Trans_4001_Record_4.CHANGE_MEMO,sizeof(m_Trans_4001_Record_4.CHANGE_MEMO));
		memset(CHANGE_MEMO,0x00,sizeof(CHANGE_MEMO));
		CommonFuncs::delspace(CHANGE_MEMO,temp);
		EXEC SQL INSERT INTO TBL_DM_4001_DEVICE(PACKET_SEQ,DEVICE_NID,OPERATOR_ID,DEVICE_TYPE,CHANGE_TYPE,CHANGE_MEMO)
				                             VALUES(:msg_pointer,:DEVICE_NID,:OPERATOR_ID,:DEVICE_TYPE,:CHANGE_TYPE,:CHANGE_MEMO);
		p = p + sizeof(Trans_4001_Record_4);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4001 ErrorCode(TBL_DM_4001_DEVICE) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_4002(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char  					DEVICE_NID[9];			
	char  					OPERATOR_ID[9];	
	char  					CHANGE_TIME[15];	
	unsigned int 		CHANGE_SEQ;		
	char  					OPERATE_TYPE[3];	
	char  					CASHBOX_ID[9];	
	char  					LOC_ID[3];				
	char  					CHANGE_STATUS[3];
	
	char  					BILL_TYPE[3];
	int   					BILL_COUNT;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 Records;
	Trans_4002_Head			m_Trans_4002_Head;
	Trans_4002_Record m_Trans_4002_Record;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_4002_Head,0x00,sizeof(Trans_4002_Head));
	m_Trans_4002_Head = *(Trans_4002_Head *)p;
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i = 0;i < sizeof(m_Trans_4002_Head.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_4002_Head.DEVICE_NID[i]);
	memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
	for(i = 0;i < sizeof(m_Trans_4002_Head.OPERATOR_ID);i++)
		sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_4002_Head.OPERATOR_ID[i]);
	memset(CHANGE_TIME,0x00,sizeof(CHANGE_TIME));
	for(i = 0;i < sizeof(m_Trans_4002_Head.CHANGE_TIME);i++)
		sprintf(CHANGE_TIME+2*i,"%02X",m_Trans_4002_Head.CHANGE_TIME[i]);
	CHANGE_SEQ = 	CommonFuncs::dwordtowin(m_Trans_4002_Head.CHANGE_SEQ);	
	memset(OPERATE_TYPE,0x00,sizeof(OPERATE_TYPE));
	sprintf(OPERATE_TYPE,"%02X",m_Trans_4002_Head.OPERATE_TYPE);
	memset(CASHBOX_ID,0x00,sizeof(CASHBOX_ID));
	for(i = 0;i < sizeof(m_Trans_4002_Head.CASHBOX_ID);i++)
		sprintf(CASHBOX_ID+2*i,"%02X",m_Trans_4002_Head.CASHBOX_ID[i]);
	memset(LOC_ID,0x00,sizeof(LOC_ID));
	sprintf(LOC_ID,"%02X",m_Trans_4002_Head.LOC_ID);
	memset(CHANGE_STATUS,0x00,sizeof(CHANGE_STATUS));
	sprintf(CHANGE_STATUS,"%02X",m_Trans_4002_Head.CHANGE_STATUS);
	Records = CommonFuncs::dwordtowin(m_Trans_4002_Head.Records);	
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_4002_Head);	
				
	for(j=0;j<Records;j++)
	{
		memset(&m_Trans_4002_Record,0x00,sizeof(Trans_4002_Record));
		m_Trans_4002_Record = *(Trans_4002_Record *)p;
		memset(BILL_TYPE,0x00,sizeof(BILL_TYPE));
		sprintf(BILL_TYPE,"%02X",m_Trans_4002_Record.BILL_TYPE);
		BILL_COUNT = CommonFuncs::dwordtowin(m_Trans_4002_Record.BILL_COUNT);	
		
		EXEC SQL INSERT INTO TBL_DM_4002_CASHBOX(PACKET_SEQ,DEVICE_NID,OPERATOR_ID,CHANGE_TIME,CHANGE_SEQ,
                                             OPERATE_TYPE,CASHBOX_ID,LOC_ID,CHANGE_STATUS,BILL_TYPE,BILL_COUNT)
				                             VALUES(:msg_pointer,:DEVICE_NID,:OPERATOR_ID,TO_DATE(:CHANGE_TIME,'YYYYMMDDHH24MISS'),:CHANGE_SEQ,
                                            :OPERATE_TYPE,:CASHBOX_ID,:LOC_ID,:CHANGE_STATUS,:BILL_TYPE,:BILL_COUNT);
		p = p + sizeof(Trans_4002_Record);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4002 ErrorCode(TBL_DM_4002_CASHBOX) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_4003(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char  					DEVICE_NID[9];			
	char  					OPERATOR_ID[9];	
	char  					CHANGE_TIME[15];	
	unsigned int 		CHANGE_SEQ;		
	char  					OPERATE_TYPE[3];	
	char  					TICKETBOX_ID[9];	
	char  					LOC_ID[3];				
	char  					TICKET_TYPE[5];
	
	int   					TICKET_COUNT;
	char  					CHANGE_STATUS[3];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i;
	Trans_4003			    m_Trans_4003;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4003 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4003 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_4003,0x00,sizeof(Trans_4003));
	m_Trans_4003 = *(Trans_4003 *)p;
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i = 0;i < sizeof(m_Trans_4003.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_4003.DEVICE_NID[i]);
	memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
	for(i = 0;i < sizeof(m_Trans_4003.OPERATOR_ID);i++)
		sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_4003.OPERATOR_ID[i]);
	memset(CHANGE_TIME,0x00,sizeof(CHANGE_TIME));
	for(i = 0;i < sizeof(m_Trans_4003.CHANGE_TIME);i++)
		sprintf(CHANGE_TIME+2*i,"%02X",m_Trans_4003.CHANGE_TIME[i]);
	CHANGE_SEQ = 	CommonFuncs::dwordtowin(m_Trans_4003.CHANGE_SEQ);	
	memset(OPERATE_TYPE,0x00,sizeof(OPERATE_TYPE));
	sprintf(OPERATE_TYPE,"%02X",m_Trans_4003.OPERATE_TYPE);
	memset(TICKETBOX_ID,0x00,sizeof(TICKETBOX_ID));
	for(i = 0;i < sizeof(m_Trans_4003.TICKETBOX_ID);i++)
		sprintf(TICKETBOX_ID+2*i,"%02X",m_Trans_4003.TICKETBOX_ID[i]);
	memset(LOC_ID,0x00,sizeof(LOC_ID));
	sprintf(LOC_ID,"%02X",m_Trans_4003.LOC_ID);
	memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
	for(i = 0;i < sizeof(m_Trans_4003.TICKET_TYPE);i++)
		sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_4003.TICKET_TYPE[i]);
	TICKET_COUNT = 	CommonFuncs::dwordtowin(m_Trans_4003.TICKET_COUNT);	
	memset(CHANGE_STATUS,0x00,sizeof(CHANGE_STATUS));
	sprintf(CHANGE_STATUS,"%02X",m_Trans_4003.CHANGE_STATUS);
		
	EXEC SQL INSERT INTO TBL_DM_4003_TICKETBOX(PACKET_SEQ,DEVICE_NID,OPERATOR_ID,CHANGE_TIME,CHANGE_SEQ,
                                             OPERATE_TYPE,TICKETBOX_ID,LOC_ID,TICKET_TYPE,TICKET_COUNT,CHANGE_STATUS)
				                              VALUES(:msg_pointer,:DEVICE_NID,:OPERATOR_ID,TO_DATE(:CHANGE_TIME,'YYYYMMDDHH24MISS'),:CHANGE_SEQ,
                                             :OPERATE_TYPE,:TICKETBOX_ID,:LOC_ID,:TICKET_TYPE,:TICKET_COUNT,:CHANGE_STATUS);
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_4003 ErrorCode(TBL_DM_4003_TICKETBOX) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5001(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char					CURRENT_TIME[15];
	char					DEVICE_NID[9];
	unsigned int	CURRENT_TRANS_NBR;
	unsigned int	SJT_SALE_COUNT;
	unsigned int	SJT_SALE_AMOUNT;
	unsigned int	SVT_LOAD_COUNT;
	unsigned int	SVT_LOAD_AMOUNT;
	unsigned int	PERL_LOAD_COUNT;
	unsigned int	PERL_LOAD_AMOUNT;
	unsigned int	COIN_RECV_COUNT;
	unsigned int	COIN_RECV_AMOUNT;
	unsigned int	CASH_RECV_COUNT;
	unsigned int	CASH_RECV_AMOUNT;
	unsigned int	COIN_BOX1_RECLAIM;
	unsigned int	COIN_BOX2_RECLAIM;
	unsigned int	COIN_BOX1_CHANGE;
	unsigned int	COIN_BOX2_CHANGE;
	unsigned int	COIN_BOX1_CHANGE_CYCLE;
	unsigned int	COIN_BOX2_CHANGE_CYCLE;
	unsigned int	CASH_BOX1_RECLAIM;
	unsigned int	CASH_BOX2_RECLAIM;
	unsigned int	CASH_BOX3_RECLAIM;
	unsigned int	CASH_BOX4_RECLAIM;
	unsigned int	CASH_BOX1_CHANGE;
	unsigned int	CASH_BOX2_CHANGE;
	unsigned int	CASH_BOX3_CHANGE;
	unsigned int	CASH_BOX4_CHANGE;
	unsigned int	CASH_BOX1_CHANGE_CYCLE;
	unsigned int	CASH_BOX2_CHANGE_CYCLE;
	unsigned int	CASH_BOX3_CHANGE_CYCLE;
	unsigned int	CASH_BOX4_CHANGE_CYCLE;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_5001_2 			m_Trans_5001_2;
	BYTE          		*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5001_1) + sizeof(Trans_5001_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[7];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5001 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5001 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ----- 包体入库 ---*/
	memset(&m_Trans_5001_2,0x00,sizeof(Trans_5001_2));
	m_Trans_5001_2 = *(Trans_5001_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_5001_1));
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i=0;i<sizeof(m_Trans_5001_2.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5001_2.DEVICE_NID[i]);
	memset(CURRENT_TIME,0x00,sizeof(CURRENT_TIME));
	for(i=0;i<sizeof(m_Trans_5001_2.CURRENT_TIME);i++)
		sprintf(CURRENT_TIME+2*i,"%02X",m_Trans_5001_2.CURRENT_TIME[i]);
		
	CURRENT_TRANS_NBR 		  = CommonFuncs::dwordtowin(m_Trans_5001_2.CURRENT_TRANS_NBR);
	SJT_SALE_COUNT 					= CommonFuncs::dwordtowin(m_Trans_5001_2.SJT_SALE_COUNT);
	SJT_SALE_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_5001_2.SJT_SALE_AMOUNT);
	SVT_LOAD_COUNT 					= CommonFuncs::dwordtowin(m_Trans_5001_2.SVT_LOAD_COUNT);
	SVT_LOAD_AMOUNT				  = CommonFuncs::dwordtowin(m_Trans_5001_2.SVT_LOAD_AMOUNT);
	PERL_LOAD_COUNT 				= CommonFuncs::dwordtowin(m_Trans_5001_2.PERL_LOAD_COUNT);
	PERL_LOAD_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_5001_2.PERL_LOAD_AMOUNT);
	COIN_RECV_COUNT 				= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_RECV_COUNT);
	COIN_RECV_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_RECV_AMOUNT);
	CASH_RECV_COUNT 				= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_RECV_COUNT);
	CASH_RECV_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_RECV_AMOUNT);
	COIN_BOX1_RECLAIM 			= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_BOX1_RECLAIM);
	COIN_BOX2_RECLAIM 			= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_BOX2_RECLAIM);
	COIN_BOX1_CHANGE 				= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_BOX1_CHANGE);
	COIN_BOX2_CHANGE 				= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_BOX2_CHANGE);
	COIN_BOX1_CHANGE_CYCLE 	= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_BOX1_CHANGE_CYCLE);
	COIN_BOX2_CHANGE_CYCLE 	= CommonFuncs::dwordtowin(m_Trans_5001_2.COIN_BOX2_CHANGE_CYCLE);
	CASH_BOX1_RECLAIM 			= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX1_RECLAIM);
	CASH_BOX2_RECLAIM 			= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX2_RECLAIM);
	CASH_BOX3_RECLAIM 			= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX3_RECLAIM);
	CASH_BOX4_RECLAIM 			= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX4_RECLAIM);
	CASH_BOX1_CHANGE 				= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX1_CHANGE);
	CASH_BOX2_CHANGE 				= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX2_CHANGE);
	CASH_BOX3_CHANGE 				= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX3_CHANGE);
	CASH_BOX4_CHANGE 				= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX4_CHANGE);
	CASH_BOX1_CHANGE_CYCLE 	= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX1_CHANGE_CYCLE);
	CASH_BOX2_CHANGE_CYCLE 	= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX2_CHANGE_CYCLE);
	CASH_BOX3_CHANGE_CYCLE 	= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX3_CHANGE_CYCLE);
	CASH_BOX4_CHANGE_CYCLE 	= CommonFuncs::dwordtowin(m_Trans_5001_2.CASH_BOX4_CHANGE_CYCLE);

	EXEC SQL INSERT INTO TBL_MN_5001_TVM (PACKET_SEQ,CURRENT_TIME,DEVICE_NID,CURRENT_TRANS_NBR,SJT_SALE_COUNT,
                                   SJT_SALE_AMOUNT,SVT_LOAD_COUNT,SVT_LOAD_AMOUNT,PERL_LOAD_COUNT,PERL_LOAD_AMOUNT,
                                   COIN_RECV_COUNT,COIN_RECV_AMOUNT,CASH_RECV_COUNT,CASH_RECV_AMOUNT,COIN_BOX1_RECLAIM,
                                   COIN_BOX2_RECLAIM,COIN_BOX1_CHANGE,COIN_BOX2_CHANGE,COIN_BOX1_CHANGE_CYCLE,COIN_BOX2_CHANGE_CYCLE,
                                   CASH_BOX1_RECLAIM,CASH_BOX2_RECLAIM,CASH_BOX3_RECLAIM,CASH_BOX4_RECLAIM,
                                   CASH_BOX1_CHANGE,CASH_BOX2_CHANGE,CASH_BOX3_CHANGE,CASH_BOX4_CHANGE,
                                   CASH_BOX1_CHANGE_CYCLE,CASH_BOX2_CHANGE_CYCLE,CASH_BOX3_CHANGE_CYCLE,CASH_BOX4_CHANGE_CYCLE)
				                    VALUES(:msg_pointer,TO_DATE(:CURRENT_TIME,'YYYYMMDDHH24MISS'),:DEVICE_NID,:CURRENT_TRANS_NBR,:SJT_SALE_COUNT,
                                   :SJT_SALE_AMOUNT,:SVT_LOAD_COUNT,:SVT_LOAD_AMOUNT,:PERL_LOAD_COUNT,:PERL_LOAD_AMOUNT,
                                   :COIN_RECV_COUNT,:COIN_RECV_AMOUNT,:CASH_RECV_COUNT,:CASH_RECV_AMOUNT,:COIN_BOX1_RECLAIM,
                                   :COIN_BOX2_RECLAIM,:COIN_BOX1_CHANGE,:COIN_BOX2_CHANGE,:COIN_BOX1_CHANGE_CYCLE,:COIN_BOX2_CHANGE_CYCLE,
                                   :CASH_BOX1_RECLAIM,:CASH_BOX2_RECLAIM,:CASH_BOX3_RECLAIM,:CASH_BOX4_RECLAIM,
                                   :CASH_BOX1_CHANGE,:CASH_BOX2_CHANGE,:CASH_BOX3_CHANGE,:CASH_BOX4_CHANGE,
                                   :CASH_BOX1_CHANGE_CYCLE,:CASH_BOX2_CHANGE_CYCLE,:CASH_BOX3_CHANGE_CYCLE,:CASH_BOX4_CHANGE_CYCLE);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5001 ErrorCode(TBL_MN_5001_TVM) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5002(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char					CURRENT_TIME[15];
	char					DEVICE_NID[9];
	unsigned int	CURRENT_TRANS_NBR;
	char          OPERATOR_ID[9];
	unsigned int	SJT_SALE_COUNT;
	unsigned int	SJT_SALE_AMOUNT;
	unsigned int	SJT_UPDATE_COUNT;
	unsigned int	SJT_UPDATE_AMOUNT;
	unsigned int	SJT_REFUND_COUNT;
	unsigned int	SJT_REFUND_AMOUNT;
	unsigned int	SVT_LOAD_COUNT;
	unsigned int	SVT_LOAD_AMOUNT;
	unsigned int	SVT_OFFSET_COUNT;
	unsigned int	SVT_OFFSET_AMOUNT;
	unsigned int	SVT_REFUND_COUNT;
	unsigned int	SVT_REFUND_AMOUNT;
	unsigned int	TICKET_MEASURE_COUNT;
	unsigned int	TICKET_MEASURE_AMOUNT;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_5002_2 				m_Trans_5002_2;
	BYTE          		*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5002_1) + sizeof(Trans_5002_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[8];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ----- 包体入库 ---*/
	memset(&m_Trans_5002_2,0x00,sizeof(Trans_5002_2));
	m_Trans_5002_2 = *(Trans_5002_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_5002_1));
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i=0;i<sizeof(m_Trans_5002_2.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5002_2.DEVICE_NID[i]);
	memset(CURRENT_TIME,0x00,sizeof(CURRENT_TIME));
	for(i=0;i<sizeof(m_Trans_5002_2.CURRENT_TIME);i++)
		sprintf(CURRENT_TIME+2*i,"%02X",m_Trans_5002_2.CURRENT_TIME[i]);
	memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
	for(i=0;i<sizeof(m_Trans_5002_2.OPERATOR_ID);i++)
		sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_5002_2.OPERATOR_ID[i]);
		
	CURRENT_TRANS_NBR 			= CommonFuncs::dwordtowin(m_Trans_5002_2.CURRENT_TRANS_NBR);
	SJT_SALE_COUNT 					= CommonFuncs::dwordtowin(m_Trans_5002_2.SJT_SALE_COUNT);
	SJT_SALE_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_5002_2.SJT_SALE_AMOUNT);
	SJT_UPDATE_COUNT 				= CommonFuncs::dwordtowin(m_Trans_5002_2.SJT_UPDATE_COUNT);
	SJT_UPDATE_AMOUNT			  = CommonFuncs::dwordtowin(m_Trans_5002_2.SJT_UPDATE_AMOUNT);
	SJT_REFUND_COUNT 				= CommonFuncs::dwordtowin(m_Trans_5002_2.SJT_REFUND_COUNT);
	SJT_REFUND_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_5002_2.SJT_REFUND_AMOUNT);
	SVT_LOAD_COUNT 				  = CommonFuncs::dwordtowin(m_Trans_5002_2.SVT_LOAD_COUNT);
	SVT_LOAD_AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_5002_2.SVT_LOAD_AMOUNT);
	SVT_OFFSET_COUNT 				= CommonFuncs::dwordtowin(m_Trans_5002_2.SVT_OFFSET_COUNT);
	SVT_OFFSET_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_5002_2.SVT_OFFSET_AMOUNT);
	SVT_REFUND_COUNT 			  = CommonFuncs::dwordtowin(m_Trans_5002_2.SVT_REFUND_COUNT);
	SVT_REFUND_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_5002_2.SVT_REFUND_AMOUNT);
	TICKET_MEASURE_COUNT 		= CommonFuncs::dwordtowin(m_Trans_5002_2.TICKET_MEASURE_COUNT);
	TICKET_MEASURE_AMOUNT 	= CommonFuncs::dwordtowin(m_Trans_5002_2.TICKET_MEASURE_AMOUNT);

	EXEC SQL INSERT INTO TBL_MN_5002_BOM (PACKET_SEQ,CURRENT_TIME,DEVICE_NID,CURRENT_TRANS_NBR,OPERATOR_ID,
                                   SJT_SALE_COUNT,SJT_SALE_AMOUNT,SJT_UPDATE_COUNT,SJT_UPDATE_AMOUNT,SJT_REFUND_COUNT,
                                   SJT_REFUND_AMOUNT,SVT_LOAD_COUNT,SVT_LOAD_AMOUNT,SVT_OFFSET_COUNT,SVT_OFFSET_AMOUNT,
                                   SVT_REFUND_COUNT,SVT_REFUND_AMOUNT,TICKET_MEASURE_COUNT,TICKET_MEASURE_AMOUNT)
				                    VALUES(:msg_pointer,TO_DATE(:CURRENT_TIME,'YYYYMMDDHH24MISS'),:DEVICE_NID,:CURRENT_TRANS_NBR,:OPERATOR_ID,
                                   :SJT_SALE_COUNT,:SJT_SALE_AMOUNT,:SJT_UPDATE_COUNT,:SJT_UPDATE_AMOUNT,:SJT_REFUND_COUNT,
                                   :SJT_REFUND_AMOUNT,:SVT_LOAD_COUNT,:SVT_LOAD_AMOUNT,:SVT_OFFSET_COUNT,:SVT_OFFSET_AMOUNT,
                                   :SVT_REFUND_COUNT,:SVT_REFUND_AMOUNT,:TICKET_MEASURE_COUNT,:TICKET_MEASURE_AMOUNT);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5002 ErrorCode(TBL_MN_5002_BOM) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5003(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char					CURRENT_TIME[15];
	char					DEVICE_NID[9];
	unsigned int	CURRENT_TRANS_NBR;
	unsigned int	IN_NUM;
	unsigned int	OUT_NUM;
	unsigned int	OUT_AMOUNT;
	unsigned int	RECYCLE_TICKET_COUNT;
	unsigned int	INVALID_NUM;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_5003_2 				m_Trans_5003_2;
	BYTE          		*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5003_1) + sizeof(Trans_5003_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[9];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5003 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5003 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ----- 包体入库 ---*/
	memset(&m_Trans_5003_2,0x00,sizeof(Trans_5003_2));
	m_Trans_5003_2 = *(Trans_5003_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_5003_1));
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i=0;i<sizeof(m_Trans_5003_2.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5003_2.DEVICE_NID[i]);
	memset(CURRENT_TIME,0x00,sizeof(CURRENT_TIME));
	for(i=0;i<sizeof(m_Trans_5003_2.CURRENT_TIME);i++)
		sprintf(CURRENT_TIME+2*i,"%02X",m_Trans_5003_2.CURRENT_TIME[i]);
	
	CURRENT_TRANS_NBR 		        = CommonFuncs::dwordtowin(m_Trans_5003_2.CURRENT_TRANS_NBR);	
	IN_NUM 												= CommonFuncs::dwordtowin(m_Trans_5003_2.IN_NUM);
	OUT_NUM 		 				 				  = CommonFuncs::dwordtowin(m_Trans_5003_2.OUT_NUM);
	OUT_AMOUNT 	 				  				= CommonFuncs::dwordtowin(m_Trans_5003_2.OUT_AMOUNT);
	RECYCLE_TICKET_COUNT					= CommonFuncs::dwordtowin(m_Trans_5003_2.RECYCLE_TICKET_COUNT);
	INVALID_NUM 							    = CommonFuncs::dwordtowin(m_Trans_5003_2.INVALID_NUM);

	EXEC SQL INSERT INTO TBL_MN_5003_AG (PACKET_SEQ,CURRENT_TIME,DEVICE_NID,CURRENT_TRANS_NBR,
	                                     IN_NUM,OUT_NUM,OUT_AMOUNT,RECYCLE_TICKET_COUNT,INVALID_NUM)
				                        VALUES(:msg_pointer,TO_DATE(:CURRENT_TIME,'YYYYMMDDHH24MISS'),:DEVICE_NID,:CURRENT_TRANS_NBR,
				                               :IN_NUM,:OUT_NUM,:OUT_AMOUNT,:RECYCLE_TICKET_COUNT,:INVALID_NUM);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5003 ErrorCode(TBL_MN_5003_AG) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5004(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char    			DEVICE_NID[9];		
	unsigned int 	SETTLE_NBR;	
	char  				RUN_DATE[9];
	char  				SETTLE_START_DATE[15];		
	char  				SETTLE_END_DATE[15];	
	char  				SETTLE_OPERATOR_ID[9];	
	int 	REAL_INCOME_ACCOUNT;
	unsigned int 	UNBUSSINESS_INCOME_NUM;
	unsigned int 	UNBUSINESS_INCOME_AMOUNT;
	unsigned int 	UNBUSINESS_PAY_NUM;
	unsigned int 	UNBUSINESS_PAY_AMOUNT;
	unsigned int 	FREE_OUT_NUM;
	unsigned int 	PAY_OUT_NUM;
	unsigned int 	PAY_OUT_AMOUNT;
	unsigned int 	WASTE_NUM;
	unsigned int 	FAULT_NUM;	
	unsigned int 	FAULT_AMOUNT;
	
	char 					TICKET_TYPE[5];
	unsigned int 	PAY_UPDATE_NUM;
	unsigned int 	PAY_UPDATE_AMOUNT;
	unsigned int 	FREE_UPDATE_NUM;
	unsigned int 	FREE_UPDATE_AMOUNT;
	
	char 					SETTLE_DATE[9];
	char 					OPERATOR_ID[9];
	char 					TICKET_TYPE_1[5];
	char 					TRANS_TYPE[3];
	char 					TRANS_SUBTYPE[3];
	unsigned int 	TRANS_NUM;
	unsigned int 	DEPOSIT_VALUE;
	unsigned int 	TRANS_AMOUNT;
	unsigned int 	TRANS_FEE;
	unsigned int 	CARD_COST;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j,k;
	unsigned short      wRecords;
	unsigned int 				dw_Records_1,dw_Records_2;
	Trans_5004_Head			m_Trans_5004_Head;
	Trans_5004_Record_1 m_Trans_5004_Record_1;
	Trans_5004_Record_2 m_Trans_5004_Record_2;
	Trans_5004_Record_3 m_Trans_5004_Record_3;
	Trans_5004_Record_4 m_Trans_5004_Record_4;
	Trans_5004_Record_5 m_Trans_5004_Record_5;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5004 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5004 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_5004_Head,0x00,sizeof(Trans_5004_Head));
	m_Trans_5004_Head = *(Trans_5004_Head *)p;
	wRecords = 	 CommonFuncs::wordtowin(m_Trans_5004_Head.w_Records);	
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5004_Head);			
	for(j=0;j<wRecords;j++)
	{
		memset(&m_Trans_5004_Record_1,0x00,sizeof(Trans_5004_Record_1));
		m_Trans_5004_Record_1 = *(Trans_5004_Record_1 *)p;
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_5004_Record_1.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5004_Record_1.DEVICE_NID[i]);
		SETTLE_NBR = CommonFuncs::dwordtowin(m_Trans_5004_Record_1.SETTLE_NBR);
		memset(RUN_DATE,0x00,sizeof(RUN_DATE));
		for(i = 0;i < sizeof(m_Trans_5004_Record_1.RUN_DATE);i++)
			sprintf(RUN_DATE+2*i,"%02X",m_Trans_5004_Record_1.RUN_DATE[i]);
		memset(SETTLE_START_DATE,0x00,sizeof(SETTLE_START_DATE));
		for(i = 0;i < sizeof(m_Trans_5004_Record_1.SETTLE_START_DATE);i++)
			sprintf(SETTLE_START_DATE+2*i,"%02X",m_Trans_5004_Record_1.SETTLE_START_DATE[i]);
		memset(SETTLE_END_DATE,0x00,sizeof(SETTLE_END_DATE));
		for(i = 0;i < sizeof(m_Trans_5004_Record_1.SETTLE_END_DATE);i++)
			sprintf(SETTLE_END_DATE+2*i,"%02X",m_Trans_5004_Record_1.SETTLE_END_DATE[i]);
		memset(SETTLE_OPERATOR_ID,0x00,sizeof(SETTLE_OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_5004_Record_1.SETTLE_OPERATOR_ID);i++)
			sprintf(SETTLE_OPERATOR_ID+2*i,"%02X",m_Trans_5004_Record_1.SETTLE_OPERATOR_ID[i]);
		REAL_INCOME_ACCOUNT			 	= CommonFuncs::ByteToInt(m_Trans_5004_Record_1.REAL_INCOME_ACCOUNT,sizeof(m_Trans_5004_Record_1.REAL_INCOME_ACCOUNT));
		UNBUSSINESS_INCOME_NUM 		= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.UNBUSSINESS_INCOME_NUM);
		UNBUSINESS_INCOME_AMOUNT 	= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.UNBUSINESS_INCOME_AMOUNT);
		UNBUSINESS_PAY_NUM 				= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.UNBUSINESS_PAY_NUM);
		UNBUSINESS_PAY_AMOUNT 		= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.UNBUSINESS_PAY_AMOUNT);
		FREE_OUT_NUM 							= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.FREE_OUT_NUM);
		PAY_OUT_NUM 							= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.PAY_OUT_NUM);
		PAY_OUT_AMOUNT 						= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.PAY_OUT_AMOUNT);
		WASTE_NUM 								= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.WASTE_NUM);
		FAULT_NUM   							= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.FAULT_NUM);
		FAULT_AMOUNT 							= CommonFuncs::dwordtowin(m_Trans_5004_Record_1.FAULT_AMOUNT);
		EXEC SQL INSERT INTO TBL_MN_5004_BOM(PACKET_SEQ,DEVICE_NID,SETTLE_NBR,RUN_DATE,
                                         SETTLE_START_DATE,SETTLE_END_DATE,
                                         SETTLE_OPERATOR_ID,REAL_INCOME_ACCOUNT,UNBUSSINESS_INCOME_NUM,
                                         UNBUSINESS_INCOME_AMOUNT,UNBUSINESS_PAY_NUM,UNBUSINESS_PAY_AMOUNT,
                                         FREE_OUT_NUM,PAY_OUT_NUM,PAY_OUT_AMOUNT,WASTE_NUM,FAULT_NUM,FAULT_AMOUNT)
				                          VALUES(:msg_pointer,:DEVICE_NID,:SETTLE_NBR,:RUN_DATE,
                                         TO_DATE(:SETTLE_START_DATE,'YYYYMMDDHH24MISS'),TO_DATE(:SETTLE_END_DATE,'YYYYMMDDHH24MISS'),
                                         :SETTLE_OPERATOR_ID,:REAL_INCOME_ACCOUNT,:UNBUSSINESS_INCOME_NUM,
                                         :UNBUSINESS_INCOME_AMOUNT,:UNBUSINESS_PAY_NUM,:UNBUSINESS_PAY_AMOUNT,
                                         :FREE_OUT_NUM,:PAY_OUT_NUM,:PAY_OUT_AMOUNT,:WASTE_NUM,:FAULT_NUM,:FAULT_AMOUNT);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_5004 ErrorCode(TBL_MN_5004_BOM) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
			
			/* ----- 写入错误文件---*/
			EXEC SQL ROLLBACK;
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
			
			return msg_pointer;
		}
		
		p = p + sizeof(Trans_5004_Record_1);
		memset(&m_Trans_5004_Record_2,0x00,sizeof(Trans_5004_Record_2));
		m_Trans_5004_Record_2 = *(Trans_5004_Record_2 *)p;
		dw_Records_1 = CommonFuncs::dwordtowin(m_Trans_5004_Record_2.dw_Records_1);
		p = p + sizeof(Trans_5004_Record_2);
		for(k=0;k<dw_Records_1;k++)
		{
			memset(&m_Trans_5004_Record_3,0x00,sizeof(Trans_5004_Record_3));
			m_Trans_5004_Record_3  = *(Trans_5004_Record_3 *)p;
			memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
			for(i = 0;i < sizeof(m_Trans_5004_Record_3.TICKET_TYPE);i++)
				sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_5004_Record_3.TICKET_TYPE[i]);
			PAY_UPDATE_NUM 				= CommonFuncs::dwordtowin(m_Trans_5004_Record_3.PAY_UPDATE_NUM);
			PAY_UPDATE_AMOUNT 		= CommonFuncs::dwordtowin(m_Trans_5004_Record_3.PAY_UPDATE_AMOUNT);
			FREE_UPDATE_NUM 			= CommonFuncs::dwordtowin(m_Trans_5004_Record_3.FREE_UPDATE_NUM);
			FREE_UPDATE_AMOUNT 		= CommonFuncs::dwordtowin(m_Trans_5004_Record_3.FREE_UPDATE_AMOUNT);
			EXEC SQL INSERT INTO TBL_MN_5004_BOM_TICKET(PACKET_SEQ,DEVICE_NID,SETTLE_NBR,RUN_DATE,
                                           SETTLE_OPERATOR_ID,TICKET_TYPE,PAY_UPDATE_NUM,
                                           PAY_UPDATE_AMOUNT,FREE_UPDATE_NUM,FREE_UPDATE_AMOUNT)
				                            VALUES(:msg_pointer,:DEVICE_NID,:SETTLE_NBR,:RUN_DATE,
                                           :SETTLE_OPERATOR_ID,:TICKET_TYPE,:PAY_UPDATE_NUM,
                                           :PAY_UPDATE_AMOUNT,:FREE_UPDATE_NUM,:FREE_UPDATE_AMOUNT);
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_5004 ErrorCode(TBL_MN_5004_BOM_TICKET) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				
				/* ----- 写入错误文件---*/
				EXEC SQL ROLLBACK;
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
				
				return msg_pointer;
			}                              
			p = p + sizeof(Trans_5004_Record_3);
		}
		m_Trans_5004_Record_4  = *(Trans_5004_Record_4 *)p;
		dw_Records_2 = CommonFuncs::dwordtowin(m_Trans_5004_Record_4.dw_Records_2);
		p = p + sizeof(Trans_5004_Record_4);
		for(k=0;k<dw_Records_2;k++)
		{
			memset(&m_Trans_5004_Record_5,0x00,sizeof(Trans_5004_Record_5));
			m_Trans_5004_Record_5  = *(Trans_5004_Record_5 *)p;
			memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
			for(i = 0;i < sizeof(m_Trans_5004_Record_5.SETTLE_DATE);i++)
				sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_5004_Record_5.SETTLE_DATE[i]);
			memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
			for(i = 0;i < sizeof(m_Trans_5004_Record_5.OPERATOR_ID);i++)
				sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_5004_Record_5.OPERATOR_ID[i]);
			memset(TICKET_TYPE_1,0x00,sizeof(TICKET_TYPE_1));
			for(i = 0;i < sizeof(m_Trans_5004_Record_5.TICKET_TYPE);i++)
				sprintf(TICKET_TYPE_1+2*i,"%02X",m_Trans_5004_Record_5.TICKET_TYPE[i]);
			memset(TRANS_TYPE,0x00,sizeof(TRANS_TYPE));
			sprintf(TRANS_TYPE,"%02X",m_Trans_5004_Record_5.TRANS_TYPE);
			memset(TRANS_SUBTYPE,0x00,sizeof(TRANS_SUBTYPE));
			sprintf(TRANS_SUBTYPE,"%02X",m_Trans_5004_Record_5.TRANS_SUBTYPE);
			TRANS_NUM 				= CommonFuncs::dwordtowin(m_Trans_5004_Record_5.TRANS_NUM);
			DEPOSIT_VALUE 		= CommonFuncs::dwordtowin(m_Trans_5004_Record_5.DEPOSIT_VALUE);
			TRANS_AMOUNT 			= CommonFuncs::dwordtowin(m_Trans_5004_Record_5.TRANS_AMOUNT);
			TRANS_FEE 				= CommonFuncs::dwordtowin(m_Trans_5004_Record_5.TRANS_FEE);
			CARD_COST					= CommonFuncs::dwordtowin(m_Trans_5004_Record_5.CARD_COST);
			EXEC SQL INSERT INTO TBL_MN_5004_BOM_SETTLE(PACKET_SEQ,DEVICE_NID,SETTLE_NBR,RUN_DATE,
                                                  SETTLE_OPERATOR_ID,SETTLE_DATE,OPERATOR_ID,TICKET_TYPE,
                                                  TRANS_TYPE,TRANS_SUBTYPE,TRANS_NUM,DEPOSIT_VALUE,
                                                  TRANS_AMOUNT,TRANS_FEE,CARD_COST)
				                                   VALUES(:msg_pointer,:DEVICE_NID,:SETTLE_NBR,:RUN_DATE,
                                                  :SETTLE_OPERATOR_ID,:SETTLE_DATE,:OPERATOR_ID,:TICKET_TYPE_1,
                                                  :TRANS_TYPE,:TRANS_SUBTYPE,:TRANS_NUM,:DEPOSIT_VALUE,
                                                  :TRANS_AMOUNT,:TRANS_FEE,:CARD_COST);
			if(sqlca.sqlcode != 0)
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg, "%s:insert_into_5004 ErrorCode(TBL_MN_5004_BOM_SETTLE) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
					
				/* ----- 写入错误文件---*/
				EXEC SQL ROLLBACK;
				COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
					
				return msg_pointer;
			}	                              
			p = p + sizeof(Trans_5004_Record_5);
		}
	}
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5005(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char  				DEVICE_NID[9];
	char  				OPERATOR_ID[9];
	char  				SETTLE_DATE[9];		
	unsigned int 	SETTLE_SEQ;		
	char  				START_SETTLE_TIME[15];		
	char  				END_SETTLE_TIME[15];	
	unsigned int 	CASH_SALE_COUNT;
	unsigned int 	CASH_SALE_AMOUNT;
	unsigned int 	SVT_SALE_COUNT;
	unsigned int 	SVT_SALE_AMOUNT;
	unsigned int 	SVT_LOAD_COUNT;
	unsigned int 	SVT_LOAD_AMOUNT;
	unsigned int 	PERL_LOAD_COUNT;
	unsigned int 	PERL_LOAD_AMOUNT;
	unsigned int 	BANKCARD_LOAD_COUNT;
	unsigned int 	BANKCARD_LOAD_AMOUNT;
	unsigned int 	DEBITCARD_LOAD_COUNT;
	unsigned int 	DEBITCARD_LOAD_AMOUNT;
	unsigned int 	CREDITCARD_LOAD_COUNT;
	unsigned int 	CREDITCARD_LOAD_AMOUNT;
	unsigned int 	ERROR_TRANS_COUNT;
	unsigned int 	ERROR_TRANS_AMOUNT;
	unsigned int 	PRE_COIN_REMAIN_AMOUNT;
	unsigned int 	COIN_SUPPLY_AMOUNT;
	unsigned int 	RECYCLE_COIN_AMOUNT;
	unsigned int 	IN_COIN_AMOUNT;
	unsigned int 	RECLAIM_COIN_AMOUNT;
	unsigned int 	COIN_REMAIN_AMOUNT;
	unsigned int 	PRE_CASH_REMAIN_AMOUNT;
	unsigned int 	CASH_SUPPLY_AMOUNT;
	unsigned int 	CASH_RECYCLE_AMOUNT;
	unsigned int 	IN_CASH_AMOUNT;
	unsigned int 	RECLAIM_CASH_AMOUNT;
	unsigned int 	CASH_REMAIN_AMOUNT;
	unsigned int 	PRE_TICKET_REMAIN;
	unsigned int 	DAMAGE_SJT_COUNT;
	unsigned int 	TICKET_SUPPLY_COUNT;
	unsigned int 	TICKET_SALE_COUNT;
	unsigned int 	TICKET_RECYCLE_COUNT;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 w_Records;
	Trans_5005_Head			m_Trans_5005_Head;
	Trans_5005_Record_1 m_Trans_5005_Record_1;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5005 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5005 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_5005_Head,0x00,sizeof(Trans_5005_Head));
	m_Trans_5005_Head = *(Trans_5005_Head *)p;
	w_Records =  CommonFuncs::wordtowin(m_Trans_5005_Head.w_Records);	
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_5005_Head);			
	for(j=0;j<w_Records;j++)
	{
		memset(&m_Trans_5005_Record_1,0x00,sizeof(Trans_5005_Record_1));
		m_Trans_5005_Record_1 = *(Trans_5005_Record_1 *)p;
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_5005_Record_1.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5005_Record_1.DEVICE_NID[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_5005_Record_1.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_5005_Record_1.OPERATOR_ID[i]);
		memset(SETTLE_DATE,0x00,sizeof(SETTLE_DATE));
		for(i = 0;i < sizeof(m_Trans_5005_Record_1.SETTLE_DATE);i++)
			sprintf(SETTLE_DATE+2*i,"%02X",m_Trans_5005_Record_1.SETTLE_DATE[i]);
		SETTLE_SEQ = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.SETTLE_SEQ);	
		memset(START_SETTLE_TIME,0x00,sizeof(START_SETTLE_TIME));
		for(i = 0;i < sizeof(m_Trans_5005_Record_1.START_SETTLE_TIME);i++)
			sprintf(START_SETTLE_TIME+2*i,"%02X",m_Trans_5005_Record_1.START_SETTLE_TIME[i]);
		memset(END_SETTLE_TIME,0x00,sizeof(END_SETTLE_TIME));
		for(i = 0;i < sizeof(m_Trans_5005_Record_1.END_SETTLE_TIME);i++)
			sprintf(END_SETTLE_TIME+2*i,"%02X",m_Trans_5005_Record_1.END_SETTLE_TIME[i]);
		CASH_SALE_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.CASH_SALE_COUNT);
		CASH_SALE_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.CASH_SALE_AMOUNT);
		SVT_SALE_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.SVT_SALE_COUNT);
		SVT_SALE_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.SVT_SALE_AMOUNT);
		SVT_LOAD_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.SVT_LOAD_COUNT);
		SVT_LOAD_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.SVT_LOAD_AMOUNT);
		PERL_LOAD_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.PERL_LOAD_COUNT);
		PERL_LOAD_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.PERL_LOAD_AMOUNT);
		BANKCARD_LOAD_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.BANKCARD_LOAD_COUNT);
		BANKCARD_LOAD_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.BANKCARD_LOAD_AMOUNT);
		DEBITCARD_LOAD_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.DEBITCARD_LOAD_COUNT);
		DEBITCARD_LOAD_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.DEBITCARD_LOAD_AMOUNT);
		CREDITCARD_LOAD_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.CREDITCARD_LOAD_COUNT);
		CREDITCARD_LOAD_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.CREDITCARD_LOAD_AMOUNT);
		ERROR_TRANS_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.ERROR_TRANS_COUNT);
		ERROR_TRANS_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.ERROR_TRANS_AMOUNT);
		PRE_COIN_REMAIN_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.PRE_COIN_REMAIN_AMOUNT);
		COIN_SUPPLY_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.COIN_SUPPLY_AMOUNT);
		RECYCLE_COIN_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.RECYCLE_COIN_AMOUNT);
		IN_COIN_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.IN_COIN_AMOUNT);
		RECLAIM_COIN_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.RECLAIM_COIN_AMOUNT);
		COIN_REMAIN_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.COIN_REMAIN_AMOUNT);
		PRE_CASH_REMAIN_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.PRE_CASH_REMAIN_AMOUNT);
		CASH_SUPPLY_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.CASH_SUPPLY_AMOUNT);
		CASH_RECYCLE_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.CASH_RECYCLE_AMOUNT);
		IN_CASH_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.IN_CASH_AMOUNT);
		RECLAIM_CASH_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.RECLAIM_CASH_AMOUNT);
		CASH_REMAIN_AMOUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.CASH_REMAIN_AMOUNT);
		PRE_TICKET_REMAIN = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.PRE_TICKET_REMAIN);
		DAMAGE_SJT_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.DAMAGE_SJT_COUNT);
		TICKET_SUPPLY_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.TICKET_SUPPLY_COUNT);
		TICKET_SALE_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.TICKET_SALE_COUNT);
		TICKET_RECYCLE_COUNT = CommonFuncs::dwordtowin(m_Trans_5005_Record_1.TICKET_RECYCLE_COUNT);
		
		EXEC SQL INSERT INTO TBL_MN_5005_TVM(PACKET_SEQ,DEVICE_NID,OPERATOR_ID,SETTLE_DATE,SETTLE_SEQ,
                                             START_SETTLE_TIME,END_SETTLE_TIME,
                                             CASH_SALE_COUNT,CASH_SALE_AMOUNT,SVT_SALE_COUNT,SVT_SALE_AMOUNT,
                                             SVT_LOAD_COUNT,SVT_LOAD_AMOUNT,PERL_LOAD_COUNT,PERL_LOAD_AMOUNT,
																						 BANKCARD_LOAD_COUNT,BANKCARD_LOAD_AMOUNT,DEBITCARD_LOAD_COUNT,DEBITCARD_LOAD_AMOUNT,
                                             CREDITCARD_LOAD_COUNT,CREDITCARD_LOAD_AMOUNT,ERROR_TRANS_COUNT,ERROR_TRANS_AMOUNT,
                                             PRE_COIN_REMAIN_AMOUNT,COIN_SUPPLY_AMOUNT,RECYCLE_COIN_AMOUNT,IN_COIN_AMOUNT,
                                             RECLAIM_COIN_AMOUNT,COIN_REMAIN_AMOUNT,PRE_CASH_REMAIN_AMOUNT,CASH_SUPPLY_AMOUNT,
                                             CASH_RECYCLE_AMOUNT,IN_CASH_AMOUNT,RECLAIM_CASH_AMOUNT,CASH_REMAIN_AMOUNT,
                                             PRE_TICKET_REMAIN,DAMAGE_SJT_COUNT,TICKET_SUPPLY_COUNT,TICKET_SALE_COUNT,
                                             TICKET_RECYCLE_COUNT)
				                             VALUES(:msg_pointer,:DEVICE_NID,:OPERATOR_ID,:SETTLE_DATE,:SETTLE_SEQ,
                                             TO_DATE(:START_SETTLE_TIME,'YYYYMMDDHH24MISS'),TO_DATE(:END_SETTLE_TIME,'YYYYMMDDHH24MISS'),
                                             :CASH_SALE_COUNT,:CASH_SALE_AMOUNT,:SVT_SALE_COUNT,:SVT_SALE_AMOUNT,
                                             :SVT_LOAD_COUNT,:SVT_LOAD_AMOUNT,:PERL_LOAD_COUNT,:PERL_LOAD_AMOUNT,
																						 :BANKCARD_LOAD_COUNT,:BANKCARD_LOAD_AMOUNT,:DEBITCARD_LOAD_COUNT,:DEBITCARD_LOAD_AMOUNT,
                                             :CREDITCARD_LOAD_COUNT,:CREDITCARD_LOAD_AMOUNT,:ERROR_TRANS_COUNT,:ERROR_TRANS_AMOUNT,
                                             :PRE_COIN_REMAIN_AMOUNT,:COIN_SUPPLY_AMOUNT,:RECYCLE_COIN_AMOUNT,:IN_COIN_AMOUNT,
                                             :RECLAIM_COIN_AMOUNT,:COIN_REMAIN_AMOUNT,:PRE_CASH_REMAIN_AMOUNT,:CASH_SUPPLY_AMOUNT,
                                             :CASH_RECYCLE_AMOUNT,:IN_CASH_AMOUNT,:RECLAIM_CASH_AMOUNT,:CASH_REMAIN_AMOUNT,
                                             :PRE_TICKET_REMAIN,:DAMAGE_SJT_COUNT,:TICKET_SUPPLY_COUNT,:TICKET_SALE_COUNT,
                                             :TICKET_RECYCLE_COUNT);
		p = p + sizeof(Trans_5005_Record_1);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5005 ErrorCode(TBL_MN_5005_TVM) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5010(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char	         DEVICE_NID[9];	
	char	         OPERATOR_ID[9];
	int	           OPERATE_TYPE;
	char           OCCUR_TIME[15];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_5010 				m_Trans_5010;
	BYTE          		*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5010);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5010 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	/*EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5010 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}*/
	/* ----- 包体入库 ---*/
	memset(&m_Trans_5010,0x00,sizeof(Trans_5010));
	m_Trans_5010 = *(Trans_5010 *)(recvbuf+sizeof(MsgHead));
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i=0;i<sizeof(m_Trans_5010.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5010.DEVICE_NID[i]);
	memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
	for(i=0;i<sizeof(m_Trans_5010.OPERATOR_ID);i++)
		sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_5010.OPERATOR_ID[i]);
	memset(OCCUR_TIME,0x00,sizeof(OCCUR_TIME));
	for(i=0;i<sizeof(m_Trans_5010.OCCUR_TIME);i++)
		sprintf(OCCUR_TIME+2*i,"%02X",m_Trans_5010.OCCUR_TIME[i]);
	OPERATE_TYPE = (int)m_Trans_5010.OPERATE_TYPE;
	EXEC SQL INSERT INTO TBL_MN_5010_BOM (PACKET_SEQ,DEVICE_NID,OPERATOR_ID,OPERATE_TYPE,OCCUR_TIME)
				                    VALUES(:msg_pointer,:DEVICE_NID,:OPERATOR_ID,:OPERATE_TYPE,TO_DATE(:OCCUR_TIME,'YYYYMMDDHH24MISS'));
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5010 ErrorCode(m_Trans_5010) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5020(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char           DEVICE_NID[9];  
	char           OCCUR_TIME[15];         
	unsigned int   ERROR_SEQ;    
	unsigned int   ERROR_NO;        
	unsigned int   TRANS_SEQ;      
	int            VALUE_TRANS;      
	char           ERROR_REASON[9]; 
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Trans_5020 				m_Trans_5020;
	BYTE          		*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5020);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5020 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5020 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ----- 包体入库 ---*/
	memset(&m_Trans_5020,0x00,sizeof(Trans_5020));
	m_Trans_5020 = *(Trans_5020 *)(recvbuf+sizeof(MsgHead));
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i=0;i<sizeof(m_Trans_5020.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5020.DEVICE_NID[i]);
	memset(OCCUR_TIME,0x00,sizeof(OCCUR_TIME));
	for(i=0;i<sizeof(m_Trans_5020.OCCUR_TIME);i++)
		sprintf(OCCUR_TIME+2*i,"%02X",m_Trans_5020.OCCUR_TIME[i]);
	ERROR_SEQ = CommonFuncs::dwordtowin(m_Trans_5020.ERROR_SEQ);
	ERROR_NO = CommonFuncs::dwordtowin(m_Trans_5020.ERROR_NO);
	TRANS_SEQ = CommonFuncs::dwordtowin(m_Trans_5020.TRANS_SEQ);
	VALUE_TRANS = CommonFuncs::ByteToInt(m_Trans_5020.VALUE_TRANS,sizeof(m_Trans_5020.VALUE_TRANS));
	memset(ERROR_REASON,0x00,sizeof(ERROR_REASON));
	for(i=0;i<sizeof(m_Trans_5020.ERROR_REASON);i++)
		sprintf(ERROR_REASON+2*i,"%02X",m_Trans_5020.ERROR_REASON[i]);
	EXEC SQL INSERT INTO TBL_MN_5020_TVM(PACKET_SEQ,DEVICE_NID,OCCUR_TIME,
	                                     ERROR_SEQ,ERROR_NO,TRANS_SEQ,VALUE_TRANS,ERROR_REASON)
				                        VALUES(:msg_pointer,:DEVICE_NID,TO_DATE(:OCCUR_TIME,'YYYYMMDDHH24MISS'),
				                               :ERROR_SEQ,:ERROR_NO,:TRANS_SEQ,:VALUE_TRANS,:ERROR_REASON);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5020 ErrorCode(TBL_MN_5020_TVM) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5021(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
 
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char           DEVICE_NID[9];  
	char           OCCUR_TIME[15];                
	unsigned int   TRANS_SEQ;  
	char           OPERATOR_ID[9]; 	        
	char           FAULT_DEVICE_NID[9]; 
	unsigned int   ERROR_NO;
	int            TRANS_VALUE;  
 	char           PAYMENT_METHOD[3]; 
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	MsgHead 					m_msghead;
	int           		i,rtn;
	Trans_5021 				m_Trans_5021;
	BYTE          		*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5021);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5021 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5021 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ----- 包体入库 ---*/
	memset(&m_Trans_5021,0x00,sizeof(Trans_5021));
	m_Trans_5021 = *(Trans_5021 *)(recvbuf+sizeof(MsgHead));
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i=0;i<sizeof(m_Trans_5021.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5021.DEVICE_NID[i]);
	memset(OCCUR_TIME,0x00,sizeof(OCCUR_TIME));
	for(i=0;i<sizeof(m_Trans_5021.OCCUR_TIME);i++)
		sprintf(OCCUR_TIME+2*i,"%02X",m_Trans_5021.OCCUR_TIME[i]);
	TRANS_SEQ = CommonFuncs::dwordtowin(m_Trans_5021.TRANS_SEQ);
	memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));	
	for(i=0;i<sizeof(m_Trans_5021.OPERATOR_ID);i++)
		sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_5021.OPERATOR_ID[i]);	
	memset(FAULT_DEVICE_NID,0x00,sizeof(FAULT_DEVICE_NID));	
	for(i=0;i<sizeof(m_Trans_5021.FAULT_DEVICE_NID);i++)
		sprintf(FAULT_DEVICE_NID+2*i,"%02X",m_Trans_5021.FAULT_DEVICE_NID[i]);		
	ERROR_NO = CommonFuncs::dwordtowin(m_Trans_5021.ERROR_NO);
	TRANS_VALUE = CommonFuncs::ByteToInt(m_Trans_5021.TRANS_VALUE,sizeof(m_Trans_5021.TRANS_VALUE));
	memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
	sprintf(PAYMENT_METHOD,"%02X",m_Trans_5021.PAYMENT_METHOD);	
	
	EXEC SQL INSERT INTO TBL_MN_5021_BOM (PACKET_SEQ, DEVICE_NID, OCCUR_TIME, TRANS_SEQ, OPERATOR_ID, 
													FAULT_DEVICE_NID, ERROR_NO, TRANS_VALUE, PAYMENT_METHOD) 
											VALUES(:msg_pointer,:DEVICE_NID, :OCCUR_TIME, :TRANS_SEQ, :OPERATOR_ID, 
													:FAULT_DEVICE_NID, :ERROR_NO, :TRANS_VALUE, :PAYMENT_METHOD);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5021 ErrorCode(TBL_MN_5021_BOM) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_5022(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
 
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char           DEVICE_NID[9];  
	char           OCCUR_TIME[15];                
	unsigned int   TRANS_SEQ;  
	char           OPERATOR_ID[9];
	int						 INOUT_FLAG;
	int						 INOUT_REASON;	
	int						 TRANS_VALUE;
 	char           PAYMENT_METHOD[3]; 	
 	char           MEMO[65]; 	
	
	int						 SALE_TICKET_FLAG;	 	        
	char           SALE_TICKET_TYPE[5]; 
	int            SALE_TRANS_VALUE;  
 	char           SALE_PAYMENT_METHOD[3]; 
  char           SALE_CARD_PHY_ID[17];
	unsigned int   SALE_DEVICE_TRACE_NBR;	

	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	MsgHead 					m_msghead;
	int           		i,rtn;
	Trans_5022 				m_Trans_5022;
	BYTE          		*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_5022);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5022 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5022 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ----- 包体入库 ---*/
	memset(&m_Trans_5022,0x00,sizeof(Trans_5022));
	m_Trans_5022 = *(Trans_5022 *)(recvbuf+sizeof(MsgHead));
	memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
	for(i=0;i<sizeof(m_Trans_5022.DEVICE_NID);i++)
		sprintf(DEVICE_NID+2*i,"%02X",m_Trans_5022.DEVICE_NID[i]);
	memset(OCCUR_TIME,0x00,sizeof(OCCUR_TIME));
	for(i=0;i<sizeof(m_Trans_5022.OCCUR_TIME);i++)
		sprintf(OCCUR_TIME+2*i,"%02X",m_Trans_5022.OCCUR_TIME[i]);
	TRANS_SEQ = CommonFuncs::dwordtowin(m_Trans_5022.TRANS_SEQ);
	memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));	
	for(i=0;i<sizeof(m_Trans_5022.OPERATOR_ID);i++)
		sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_5022.OPERATOR_ID[i]);
	INOUT_FLAG = (int)	m_Trans_5022.INOUT_FLAG;	
	INOUT_REASON = (int)	m_Trans_5022.INOUT_REASON;		
	TRANS_VALUE = CommonFuncs::ByteToInt(m_Trans_5022.TRANS_VALUE,sizeof(m_Trans_5022.TRANS_VALUE));
	memset(PAYMENT_METHOD,0x00,sizeof(PAYMENT_METHOD));
	sprintf(PAYMENT_METHOD,"%02X",m_Trans_5022.PAYMENT_METHOD);	
	memset(MEMO,0x00,sizeof(MEMO));
 	CommonFuncs::gbk2utf8(m_Trans_5022.MEMO, sizeof(m_Trans_5022.MEMO),MEMO,sizeof(MEMO));
 
	SALE_TICKET_FLAG = (int)	m_Trans_5022.SALE_TICKET_FLAG;	
	memset(SALE_TICKET_TYPE,0x00,sizeof(SALE_TICKET_TYPE));	
	for(i=0;i<sizeof(m_Trans_5022.SALE_TICKET_TYPE);i++)
		sprintf(SALE_TICKET_TYPE+2*i,"%02X",m_Trans_5022.SALE_TICKET_TYPE[i]);	
	SALE_TRANS_VALUE = CommonFuncs::ByteToInt(m_Trans_5022.TRANS_VALUE,sizeof(m_Trans_5022.TRANS_VALUE));
	memset(SALE_PAYMENT_METHOD,0x00,sizeof(SALE_PAYMENT_METHOD));
	sprintf(SALE_PAYMENT_METHOD,"%02X",m_Trans_5022.SALE_PAYMENT_METHOD);	
	memset(SALE_CARD_PHY_ID,0x00,sizeof(SALE_CARD_PHY_ID));
	for(i=0;i<sizeof(m_Trans_5022.SALE_CARD_PHY_ID);i++)
		sprintf(SALE_CARD_PHY_ID+2*i,"%02X",m_Trans_5022.SALE_CARD_PHY_ID[i]);	
	SALE_DEVICE_TRACE_NBR = CommonFuncs::dwordtowin(m_Trans_5022.SALE_DEVICE_TRACE_NBR);

	EXEC SQL INSERT INTO TBL_MN_5022_BOM (PACKET_SEQ, DEVICE_NID, OCCUR_TIME, TRANS_SEQ, OPERATOR_ID, 
															INOUT_FLAG, INOUT_REASON, TRANS_VALUE, PAYMENT_METHOD, MEMO, 
															SALE_TICKET_FLAG, SALE_TICKET_TYPE, SALE_TRANS_VALUE, 
															SALE_PAYMENT_METHOD, SALE_CARD_PHY_ID, SALE_DEVICE_TRACE_NBR)
												VALUES(:msg_pointer,:DEVICE_NID, :OCCUR_TIME, :TRANS_SEQ, :OPERATOR_ID, 
															:INOUT_FLAG, :INOUT_REASON, :TRANS_VALUE, :PAYMENT_METHOD, :MEMO, 
															:SALE_TICKET_FLAG, :SALE_TICKET_TYPE, :SALE_TRANS_VALUE, 
															:SALE_PAYMENT_METHOD,: SALE_CARD_PHY_ID, :SALE_DEVICE_TRACE_NBR);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_5022 ErrorCode(TBL_MN_5022_BOM) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

















 
/* ------------------------------------------------------
            返回值说明：1 正常 0 错误
--------------------------------------------------------- */
int ORA::insert_into_6101(unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char						b_SCID[5];				      /* ---  --- */
	int							b_RunMode;				      /* ---  --- */
	char            b_TransactionTime[15];	/* ---  --- */
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	Req_6101 					m_Req_6101;
	BYTE          		*p;
	
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%04X%010u.dat",w_MsgCode,dw_PkgID);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Req_6101);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_6101 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s,insert_into_6101 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ----- 包体入库 ---*/
	memset(&m_Req_6101,0x00,sizeof(Req_6101));
	m_Req_6101 = *(Req_6101 *)(recvbuf+sizeof(MsgHead));
	memset(b_SCID,0x00,sizeof(b_SCID));
	for(i=0;i<sizeof(m_Req_6101.b_SCID);i++)
		sprintf(b_SCID+2*i,"%02X",m_Req_6101.b_SCID[i]);
	memset(b_TransactionTime,0x00,sizeof(b_TransactionTime));
	for(i=0;i<sizeof(m_Req_6101.b_TransactionTime);i++)
		sprintf(b_TransactionTime+2*i,"%02X",m_Req_6101.b_TransactionTime[i]);
	b_RunMode = (int)m_Req_6101.b_RunMode;

	EXEC SQL DELETE FROM TBL_MN_6101_RUNMODE WHERE UPPER(STATION_NID) = :b_SCID OR LOWER(STATION_NID) = :b_SCID ;
	EXEC SQL INSERT INTO TBL_MN_6101_RUNMODE (PACKET_SEQ,OCCUR_TIME,STATION_NID,RUNMODE_CODE)
					                           VALUES(:msg_pointer,TO_DATE(:b_TransactionTime,'YYYYMMDDHH24MISS'),:b_SCID,:b_RunMode);													
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"insert_into_6101(TBL_MN_6101_RUNMODE) ERROR:%d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		return 0;
	}
 
	EXEC SQL COMMIT;
	
	/*------更新综合监控信息-----*/	
	memset(b_SCID,0x00,sizeof(b_SCID));
	sprintf(b_SCID,"%02X%02X",m_Req_6101.b_SCID[0],m_Req_6101.b_SCID[1]);
	ISCS::UpdateStationRunMode(b_SCID,b_RunMode);	
			
	return 1;
}

/* ------------------------------------------------------
            返回值说明：1 正常 0 错误
--------------------------------------------------------- */
int ORA::insert_into_6002(unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	int							b_RunMode;					        /* ---  --- */
	char						b_SCID[5];				      /* ---  --- */
	char						b_TransactionTime[15];	/* ---  --- */
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i;
	CMD_6002 					m_CMD_6002;
	BYTE          		*p;
	
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%04X%010u.dat",w_MsgCode,dw_PkgID);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(CMD_6002);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_6002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s,insert_into_6002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ----- 包体入库 ---*/
	memset(&m_CMD_6002,0x00,sizeof(CMD_6002));
	m_CMD_6002 = *(CMD_6002 *)(recvbuf+sizeof(MsgHead));
	memset(b_SCID,0x00,sizeof(b_SCID));
	for(i=0;i<sizeof(m_CMD_6002.b_SCID);i++)
		sprintf(b_SCID+2*i,"%02X",m_CMD_6002.b_SCID[i]);
	memset(b_TransactionTime,0x00,sizeof(b_TransactionTime));
	for(i=0;i<sizeof(m_CMD_6002.b_TransactionTime);i++)
		sprintf(b_TransactionTime+2*i,"%02X",m_CMD_6002.b_TransactionTime[i]);
	b_RunMode = (int)m_CMD_6002.b_RunMode;

	EXEC SQL DELETE FROM TBL_MN_6101_RUNMODE WHERE UPPER(STATION_NID) = :b_SCID OR LOWER(STATION_NID) = :b_SCID ;
	EXEC SQL INSERT INTO TBL_MN_6101_RUNMODE (PACKET_SEQ,OCCUR_TIME,STATION_NID,RUNMODE_CODE)
					                           VALUES(:msg_pointer,TO_DATE(:b_TransactionTime,'YYYYMMDDHH24MISS'),:b_SCID,:b_RunMode);													
	if(sqlca.sqlcode !=0 )
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"insert_into_6002 ErrorCode(TBL_MN_6101_RUNMODE) ERROR:%d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
		EXEC SQL ROLLBACK;
		return 0;
	}
	
	EXEC SQL COMMIT;
			
	return 1;
}



/* ------------------------------------------------------
            日切
--------------------------------------------------------- */
void ORA::exec_batch()
{ 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[14];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	char oplogmsg[1024];
		
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"存储过程执行开始!\n");
	CLog::WriteAppLog(oplogmsg);
	
	/*---存储过程调用 */
	EXEC SQL EXECUTE  
		BEGIN  
			P_BATCH_TEMP(TO_CHAR(SYSDATE-1,'YYYYMMDD'));  
		END;  
	END-EXEC;
	 
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"存储过程执行结束!\n");
	CLog::WriteAppLog(oplogmsg);
}

/* ------------------------------------------------------
            删除历史数据
--------------------------------------------------------- */
void ORA::del_his_data()
{
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[14];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	
	char oplogmsg[1024];
	
	EXEC SQL DELETE FROM TBL_PM_PKG_HEADER
	         WHERE TO_CHAR(DEAL_DATE,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_PM_PKG_HEADER)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM T_PKG_LCC_FTP_TRANS_FILE 
	         WHERE TO_CHAR(FILE_CREATE_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-30,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(T_PKG_LCC_FTP_TRANS_FILE)结束!\n");
	CLog::WriteAppLog(oplogmsg);
		
	EXEC SQL DELETE FROM TBL_MN_7010_STATUS_HIS 
	         WHERE TO_CHAR(OCCUR_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-30,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_7010_STATUS_HIS)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_MN_7010_STATUS_HIS 
	         WHERE TO_CHAR(OCCUR_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-1,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_7010_STATUS_HIS)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_MN_5010_BOM 
	         WHERE TO_CHAR(OCCUR_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-30,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5010_BOM)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL COMMIT; 
	
	EXEC SQL DELETE FROM TBL_TRANS_1001_SJT_TEMP
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1001_SJT_TEMP)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1002_SVT_TEMP
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1002_SVT_TEMP)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1003_PERL_TEMP
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1003_PERL_TEMP)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1004_UNION_PAY_TEMP
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1004_UNION_PAY_TEMP)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1005_QR_PAY_TEMP
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1005_QR_PAY_TEMP)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_TRANS_1001_SJT
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-180,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1001_SJT)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1002_SVT
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-180,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1002_SVT)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1003_PERL
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-180,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1003_PERL)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1004_UNION_PAY
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-180,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1004_UNION_PAY)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1005_QR_PAY
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-180,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1005_QR_PAY)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_TRANS_1001_SJT_ERROR
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');  
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1001_SJT_ERROR)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1002_SVT_ERROR
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1002_SVT_ERROR)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1003_PERL_ERROR
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1003_PERL_ERROR)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1004_UNION_PAY_ERROR
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1004_UNION_PAY_ERROR)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_TRANS_1005_QR_PAY_ERROR
	         WHERE TO_CHAR(TRANS_TIME,'YYYYMMDD') < TO_CHAR(SYSDATE-7,'YYYYMMDD');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_TRANS_1005_QR_PAY_ERROR)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL COMMIT; 
		
	EXEC SQL DELETE FROM TBL_BATCH_ENTRY_EXIT_DETAIL
	         WHERE TRANS_DATE < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_BATCH_ENTRY_EXIT_DETAIL)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_DM_4002_CASHBOX
	         WHERE TO_CHAR(CHANGE_TIME,'YYYYMMDD') < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_DM_4002_CASHBOX)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_DM_4003_TICKETBOX
	         WHERE TO_CHAR(CHANGE_TIME,'YYYYMMDD') < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_DM_4003_TICKETBOX)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_MN_5001_TVM
	         WHERE TO_CHAR(CURRENT_TIME,'YYYYMMDD') < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5001_TVM)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_MN_5002_BOM
	         WHERE TO_CHAR(CURRENT_TIME,'YYYYMMDD') < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5002_BOM)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_MN_5003_AG
	         WHERE TO_CHAR(CURRENT_TIME,'YYYYMMDD') < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5003_AG)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_MN_5004_BOM
	         WHERE RUN_DATE < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5004_BOM)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_MN_5004_BOM_SETTLE
	         WHERE RUN_DATE < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5004_BOM_SETTLE)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	EXEC SQL DELETE FROM TBL_MN_5004_BOM_TICKET
	         WHERE RUN_DATE < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5004_BOM_TICKET)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL DELETE FROM TBL_MN_5005_TVM
	         WHERE SETTLE_DATE < RTRIM(TO_CHAR(SYSDATE-30,'YYYYMMDD'),' ');
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	strcpy(oplogmsg,"清除历史数据(TBL_MN_5005_TVM)结束!\n");
	CLog::WriteAppLog(oplogmsg);
	
	EXEC SQL COMMIT; 
}

/* ------------------------------------------------------
            生成3001
            HHJT_CJP 20210323 文件名中的线路号由参数带入
--------------------------------------------------------- */
void ORA::create3001file(const char *c_apply_no,const char *c_recv_id)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	int           	ParamRecords;
	char            APPLY_NO[25];
	char            APPLY_TYPE[3];
	char            APPLY_NID[5];
	char            APPLY_DATE[15];
	char 	          TICKET_DIRECTORY[5];
  char          	TICKET_STATUS[3];
	unsigned int 		APPLY_NUM;
	char            APPLY_DEPLOY_DATE[15];
	char            APPLY_USER_ID[9];
  char            MEMO[201];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead	       		m_MsgHead;
	Trans_3001_1 			m_Trans_3001_1;
	Trans_3001_2   		*m_Trans_3001_2;
	Trans_3001_3 			m_Trans_3001_3;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	unsigned int 			sessionnum;
	char        			c_PkgID[30];
	BYTE         			b_PkgID;
	char              *stopstring;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(APPLY_NO,0x00,sizeof(APPLY_NO));
	strcpy(APPLY_NO,c_apply_no);
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_ST_3001_APPLY_DETAIL
		 WHERE APPLY_NO = :APPLY_NO;
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create3001file(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	/* -------- 包体头 ---------- */
	memset(APPLY_TYPE,0x00,sizeof(APPLY_TYPE));
	memset(APPLY_NID,0x00,sizeof(APPLY_NID));
	memset(APPLY_DATE,0x00,sizeof(APPLY_DATE));
	memset(APPLY_USER_ID,0x00,sizeof(APPLY_USER_ID));
	memset(MEMO,0x00,sizeof(MEMO));
	EXEC SQL SELECT APPLY_TYPE,SUBSTR(APPLY_NID,1,4),APPLY_DATE,APPLY_USER_ID, DECODE(MEMO,NULL,'未定义',MEMO)
	         INTO   :APPLY_TYPE,:APPLY_NID,:APPLY_DATE,:APPLY_USER_ID,:MEMO
	         FROM TBL_ST_3001_APPLY 
	         WHERE APPLY_NO = :APPLY_NO;
	memset(&m_Trans_3001_1,0x00,sizeof(Trans_3001_1));
	CommonFuncs::chartobyte(APPLY_NO,(char*)m_Trans_3001_1.APPLY_NO,sizeof(m_Trans_3001_1.APPLY_NO));
	m_Trans_3001_1.APPLY_TYPE = (BYTE)strtoul(APPLY_TYPE,&stopstring,16);
	CommonFuncs::chartobyte(APPLY_NID,(char*)m_Trans_3001_1.APPLY_NID,sizeof(m_Trans_3001_1.APPLY_NID));
	CommonFuncs::chartobyte(APPLY_DATE,(char*)m_Trans_3001_1.APPLY_DATE,sizeof(m_Trans_3001_1.APPLY_DATE));
	m_Trans_3001_1.w_Records 		=  CommonFuncs::wordtowin(ParamRecords);
	memset(&m_Trans_3001_3,0x00,sizeof(Trans_3001_3));
	CommonFuncs::chartobyte(APPLY_USER_ID,(char*)m_Trans_3001_3.APPLY_USER_ID,sizeof(m_Trans_3001_3.APPLY_USER_ID));
	memcpy(m_Trans_3001_3.MEMO,MEMO,sizeof(m_Trans_3001_3.MEMO));
	
	m_Trans_3001_2 = (Trans_3001_2*)malloc(ParamRecords * sizeof(Trans_3001_2));
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_3001_Record CURSOR FOR SELECT TICKET_DIRECTORY,TICKET_STATUS,APPLY_NUM,APPLY_DEPLOY_DATE
		                                          FROM   TBL_ST_3001_APPLY_DETAIL
		                                          WHERE APPLY_NO = :APPLY_NO
		                                          ORDER BY TICKET_DIRECTORY,TICKET_STATUS;                              
	EXEC SQL OPEN SQL_3001_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create3001file(OPEN SQL_3001_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Trans_3001_2);
		m_Trans_3001_2 = NULL;
		return;
	}
	index = 0;
	for(;;)
	{
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		memset(TICKET_STATUS,0x00,sizeof(TICKET_STATUS));
		memset(APPLY_DEPLOY_DATE,0x00,sizeof(APPLY_DEPLOY_DATE));
		EXEC SQL FETCH SQL_3001_Record INTO :TICKET_DIRECTORY,:TICKET_STATUS,:APPLY_NUM,:APPLY_DEPLOY_DATE;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create3001param(FETCH SQL_3001_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_3001_Record;
				free(m_Trans_3001_2);
				m_Trans_3001_2 = NULL;
				return;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Trans_3001_2[index],0x00,sizeof(Trans_3001_2 ));
		CommonFuncs::chartobyte(TICKET_DIRECTORY,(char*)m_Trans_3001_2[index].TICKET_DIRECTORY,sizeof(m_Trans_3001_2[index].TICKET_DIRECTORY));
		m_Trans_3001_2[index].TICKET_STATUS = (BYTE)strtoul(TICKET_STATUS,&stopstring,16);
		m_Trans_3001_2[index].APPLY_NUM = CommonFuncs::dwordtowin(APPLY_NUM);
		CommonFuncs::chartobyte(APPLY_DEPLOY_DATE,(char*)m_Trans_3001_2[index].APPLY_DEPLOY_DATE,sizeof(m_Trans_3001_2[index].APPLY_DEPLOY_DATE));
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_3001_Record;	
	
	bodylen = sizeof(Trans_3001_1)+ParamRecords*sizeof(Trans_3001_2)+sizeof(Trans_3001_3);
	/* -------- 生成包头 ---------- */
	sessionnum = get_session_number();
	b_PkgID = (BYTE)get_pkg_number();
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	CPackage::Create_Pkg_Head(b_PkgID,&m_MsgHead,bodylen,0x3001,sessionnum,CConfig::g_ACCIDCode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Trans_3001_1,sizeof(Trans_3001_1));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Trans_3001_1)+index*sizeof(Trans_3001_2),&m_Trans_3001_2[index],sizeof(Trans_3001_2));
	}
	memcpy(packagebody+sizeof(Trans_3001_1)+ParamRecords*sizeof(Trans_3001_2),(char*)&m_Trans_3001_3,sizeof(Trans_3001_3));
	/* --- 生成文件于发送目录 --- */
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
	
	char strTemp[5];
	memset(strTemp,0x00,sizeof(strTemp));
	memcpy(strTemp, c_recv_id,2);

	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%s%s_%04X_%s",CConfig::SendFilePath_ACC,strTemp,0x3001,c_PkgID);
	CommonFuncs::WriteBufferFile("wb",filename,(char*)filebuf,filelen);
	
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "车票库存调配请求文件%s生成成功\n",filename);
	CLog::WriteAppLog(oplogmsg);

	/* -------- 内存释放 ---------- */
	free(m_Trans_3001_2);
	m_Trans_3001_2 = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;
}

/* ------------------------------------------------------
            生成3003            
            HHJT_CJP 20210323 分线路生成文件
--------------------------------------------------------- */
void ORA::create3003file(int lineId)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	int           	ParamRecords;
	char            CENTER_ID[5];
	char            INVENTORY_DATE[15];
	char            LINE_NID[3];
		
  char          	TICKET_DIRECTORY[5];
	unsigned int 		GOOD_COUNT;
	unsigned int 		BAD_COUNT;
	unsigned int 		EXPIRATION_COUNT;
	unsigned int 		INUSE_COUNT;
	unsigned int 		PROFIT_COUNT;
	unsigned int 		LOSS_COUNT;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead	       		m_MsgHead;
	Trans_3003_1 			m_Trans_3003_1;
	Trans_3003_2   		*m_Trans_3003_2;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	char        			c_PkgID[30];
	char              *stopstring;
	DWORD 					  sessionnum;
	BYTE         		  b_PkgID;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[14];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(LINE_NID,0x00,sizeof(LINE_NID));
	sprintf(LINE_NID,"%02X",lineId);
 
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_ST_3003_INVENTORY
		 WHERE SUBSTR(INVENTORY_DATE,1,8) = TO_CHAR(SYSDATE-1,'YYYYMMDD') 
		 AND INVENT_STATUS = '01'
		 AND SUBSTR(CENTER_ID,1,2) = :LINE_NID;
		 
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create3003file(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	
	/* -------- 包体头 ---------- */
	memset(CENTER_ID,0x00,sizeof(CENTER_ID));
	memset(INVENTORY_DATE,0x00,sizeof(INVENTORY_DATE));
	EXEC SQL SELECT INVENTORY_DATE,CENTER_ID
	         INTO   :INVENTORY_DATE,:CENTER_ID
	         FROM TBL_ST_3003_INVENTORY 
	         WHERE SUBSTR(INVENTORY_DATE,1,8) = TO_CHAR(SYSDATE-1,'YYYYMMDD') 
	         AND INVENT_STATUS = '01'
	         AND SUBSTR(CENTER_ID,1,2) = :LINE_NID;
	         
	memset(&m_Trans_3003_1,0x00,sizeof(Trans_3003_1));
	CommonFuncs::chartobyte(INVENTORY_DATE,(char*)m_Trans_3003_1.INVENTORY_DATE,sizeof(m_Trans_3003_1.INVENTORY_DATE));
	CommonFuncs::chartobyte(CENTER_ID,(char*)m_Trans_3003_1.CENTER_ID,sizeof(m_Trans_3003_1.CENTER_ID));
	m_Trans_3003_1.w_Records 		=  CommonFuncs::wordtowin(ParamRecords);
	
	m_Trans_3003_2 = (Trans_3003_2*)malloc(ParamRecords * sizeof(Trans_3003_2));
	
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_3003_Record CURSOR FOR SELECT TICKET_DIRECTORY,GOOD_COUNT,BAD_COUNT,EXPIRATION_COUNT,
                                                     INUSE_COUNT,PROFIT_COUNT,LOSS_COUNT
		                                          FROM   TBL_ST_3003_INVENTORY
		                                          WHERE SUBSTR(INVENTORY_DATE,1,8) = TO_CHAR(SYSDATE-1,'YYYYMMDD') 
		                                          AND INVENT_STATUS = '01'		                                          
		                                          AND SUBSTR(CENTER_ID,1,2) = :LINE_NID
		                                          ORDER BY TICKET_DIRECTORY;                           
	EXEC SQL OPEN SQL_3003_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create3003file(OPEN SQL_3003_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Trans_3003_2);
		m_Trans_3003_2 = NULL;
		return;
	}
	index = 0;
	for(;;)
	{
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		EXEC SQL FETCH SQL_3003_Record INTO :TICKET_DIRECTORY,:GOOD_COUNT,:BAD_COUNT,:EXPIRATION_COUNT,
                                        :INUSE_COUNT,:PROFIT_COUNT,:LOSS_COUNT;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create3003param(FETCH SQL_3003_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_3003_Record;
				free(m_Trans_3003_2);
				m_Trans_3003_2 = NULL;
				return;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Trans_3003_2[index],0x00,sizeof(Trans_3003_2 ));
		CommonFuncs::chartobyte(TICKET_DIRECTORY,(char*)m_Trans_3003_2[index].TICKET_DIRECTORY,sizeof(m_Trans_3003_2[index].TICKET_DIRECTORY));
		m_Trans_3003_2[index].GOOD_COUNT 				= CommonFuncs::dwordtowin(GOOD_COUNT);
		m_Trans_3003_2[index].BAD_COUNT        	= CommonFuncs::dwordtowin(BAD_COUNT);
		m_Trans_3003_2[index].EXPIRATION_COUNT 	= CommonFuncs::dwordtowin(EXPIRATION_COUNT);
		m_Trans_3003_2[index].INUSE_COUNT 			= CommonFuncs::dwordtowin(INUSE_COUNT);
		m_Trans_3003_2[index].PROFIT_COUNT 			= CommonFuncs::dwordtowin(PROFIT_COUNT);
		m_Trans_3003_2[index].LOSS_COUNT 				= CommonFuncs::dwordtowin(LOSS_COUNT);
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_3003_Record;	
	
	bodylen = sizeof(Trans_3003_1)+ParamRecords*sizeof(Trans_3003_2);
	
	/* -------- 生成包头 ---------- */
	sessionnum = get_session_number();
	b_PkgID = (BYTE)get_pkg_number();
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	CPackage::Create_Pkg_Head(b_PkgID,&m_MsgHead,bodylen,0x3003,sessionnum,CConfig::g_ACCIDCode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Trans_3003_1,sizeof(Trans_3003_1));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Trans_3003_1)+index*sizeof(Trans_3003_2),&m_Trans_3003_2[index],sizeof(Trans_3003_2));
	}
	/* --- 生成文件于发送目录 --- */
	
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
 
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%s%s_%04X_%s",CConfig::SendFilePath_ACC,LINE_NID,0x3003,c_PkgID);
	CommonFuncs::WriteBufferFile("wb",filename,(char*)filebuf,filelen);
 
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "车票盘点文件%s生成成功\n",filename);
	CLog::WriteAppLog(oplogmsg);
 
	/* -------- 内存释放 ---------- */
	free(m_Trans_3003_2);
	m_Trans_3003_2 = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;

}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3002(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char 	          DEPLOY_NO[25];
  
  char          	TICKET_DIRECTORY[5];
	char            TICKET_STATUS[3];
	char            DEPLOY_DATE[15];
	char            APPLY_DEPLOY_DATE[15];
	char            APPLY_NO[25];
	char            APPLY_DATE[15];
	unsigned int 		DEPLOY_NUM;
	char            IN_NID[5];
	char            DEPLOY_IN_TYPE[3];
	char            OUT_NID[5];
	char            DEPLOY_OUT_TYPE[3];
	unsigned int 		AMOUNT;
	unsigned int 		UNIT_PRICE;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_3002_1   		m_Trans_3002_1;
	Trans_3002_2 			m_Trans_3002_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_3002_1,0x00,sizeof(Trans_3002_1));
	m_Trans_3002_1 = *(Trans_3002_1 *)(recvbuf + sizeof(MsgHead));
	memset(DEPLOY_NO,0x00,sizeof(DEPLOY_NO));
	for(i = 0;i < sizeof(m_Trans_3002_1.DEPLOY_NO);i++)
		sprintf(DEPLOY_NO+2*i,"%02X",m_Trans_3002_1.DEPLOY_NO[i]);
	count =  CommonFuncs::wordtowin(m_Trans_3002_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_3002_1) + count * sizeof(Trans_3002_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_3002_2,0x00,sizeof(Trans_3002_2));
		m_Trans_3002_2 = *(Trans_3002_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_3002_1)+sizeof(Trans_3002_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		for(i = 0;i < sizeof(m_Trans_3002_2.TICKET_DIRECTORY);i++)
			sprintf(TICKET_DIRECTORY+2*i,"%02X",m_Trans_3002_2.TICKET_DIRECTORY[i]);
		memset(TICKET_STATUS,0x00,sizeof(TICKET_STATUS));
		sprintf(TICKET_STATUS,"%02X",m_Trans_3002_2.TICKET_STATUS);
		memset(DEPLOY_DATE,0x00,sizeof(DEPLOY_DATE));
		for(i = 0;i < sizeof(m_Trans_3002_2.DEPLOY_DATE);i++)
			sprintf(DEPLOY_DATE+2*i,"%02X",m_Trans_3002_2.DEPLOY_DATE[i]);
		memset(APPLY_DEPLOY_DATE,0x00,sizeof(APPLY_DEPLOY_DATE));
		for(i = 0;i < sizeof(m_Trans_3002_2.APPLY_DEPLOY_DATE);i++)
			sprintf(APPLY_DEPLOY_DATE+2*i,"%02X",m_Trans_3002_2.APPLY_DEPLOY_DATE[i]);
		memset(APPLY_DATE,0x00,sizeof(APPLY_DATE));
		for(i = 0;i < sizeof(m_Trans_3002_2.APPLY_DATE);i++)
			sprintf(APPLY_DATE+2*i,"%02X",m_Trans_3002_2.APPLY_DATE[i]);
		DEPLOY_NUM 	= CommonFuncs::dwordtowin(m_Trans_3002_2.DEPLOY_NUM);
		memset(IN_NID,0x00,sizeof(IN_NID));
		for(i = 0;i < sizeof(m_Trans_3002_2.IN_NID);i++)
			sprintf(IN_NID+2*i,"%02X",m_Trans_3002_2.IN_NID[i]);
		memset(OUT_NID,0x00,sizeof(OUT_NID));
		for(i = 0;i < sizeof(m_Trans_3002_2.OUT_NID);i++)
			sprintf(OUT_NID+2*i,"%02X",m_Trans_3002_2.OUT_NID[i]);
		AMOUNT 		 = CommonFuncs::dwordtowin(m_Trans_3002_2.AMOUNT);
		UNIT_PRICE = CommonFuncs::dwordtowin(m_Trans_3002_2.UNIT_PRICE);
		memset(APPLY_NO,0x00,sizeof(APPLY_NO));
		for(i = 0;i < sizeof(m_Trans_3002_2.APPLY_NO);i++)
			sprintf(APPLY_NO+2*i,"%02X",m_Trans_3002_2.APPLY_NO[i]);
		memset(DEPLOY_IN_TYPE,0x00,sizeof(DEPLOY_IN_TYPE));
		sprintf(DEPLOY_IN_TYPE,"%02X",m_Trans_3002_2.DEPLOY_IN_TYPE);
		memset(DEPLOY_OUT_TYPE,0x00,sizeof(DEPLOY_OUT_TYPE));
		sprintf(DEPLOY_OUT_TYPE,"%02X",m_Trans_3002_2.DEPLOY_OUT_TYPE);
		EXEC SQL INSERT INTO TBL_ST_3002_DEPLOY (PACKET_SEQ,DEPLOY_NO,TICKET_DIRECTORY,TICKET_STATUS,
                                             DEPLOY_DATE,APPLY_DEPLOY_DATE,APPLY_DATE,DEPLOY_NUM,
                                             IN_NID,OUT_NID,AMOUNT,UNIT_PRICE,
                                             APPLY_NO,DEPLOY_IN_TYPE,DEPLOY_OUT_TYPE)
		                                  VALUES(:msg_pointer,:DEPLOY_NO,:TICKET_DIRECTORY,:TICKET_STATUS,
                                             :DEPLOY_DATE,:APPLY_DEPLOY_DATE,:APPLY_DATE,:DEPLOY_NUM,
                                             :IN_NID,:OUT_NID,:AMOUNT,:UNIT_PRICE,
                                             :APPLY_NO,:DEPLOY_IN_TYPE,:DEPLOY_OUT_TYPE);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_3002(第%d条记录)ErrorCode(TBL_RC_3002_PKG_DETAIL) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_3002_1,sizeof(Trans_3002_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_3002_1),&m_Trans_3002_2,sizeof(Trans_3002_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_3002_1)+sizeof(Trans_3002_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            生成3005
            HHJT_CJP 20210323 文件名中的线路号由参数带入
--------------------------------------------------------- */
void ORA::create3005file(const char *c_apply_no,const char *c_recv_id)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	int           	ParamRecords;
	char            IN_NO[25];
	char            CENTER_ID[5];
	
	char          	IN_TYPE[3];
  char          	TICKET_DIRECTORY[5];
	char   					TICKET_STATUS[3];
	char            IN_DATE[15];
	unsigned int 		IN_COUNT;
	char            RELE_NO[25];
	unsigned int 		AMOUNT;
	unsigned int 		UNIT_PRICE;
	char            OPERATOR_ID[9];
	char            APPROVAL_ID[9];
	char            START_CARD_ID[11];
	char            END_CARD_ID[11];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead	       		m_MsgHead;
	Trans_3005_1 			m_Trans_3005_1;
	Trans_3005_2   		*m_Trans_3005_2;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	unsigned int 			sessionnum;
	char        			c_PkgID[30];
	BYTE         			b_PkgID;
	char              *stopstring;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(IN_NO,0x00,sizeof(IN_NO));
	strcpy(IN_NO,c_apply_no);
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_ST_3005_IN
		 WHERE IN_NO = :IN_NO;
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create3005file(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	/* -------- 包体头 ---------- */
	memset(CENTER_ID,0x00,sizeof(CENTER_ID));
	EXEC SQL SELECT CENTER_ID
	         INTO   :CENTER_ID
	         FROM TBL_ST_3005_IN 
	         WHERE IN_NO = :IN_NO;
	memset(&m_Trans_3005_1,0x00,sizeof(Trans_3005_1));
	CommonFuncs::chartobyte(IN_NO,(char*)m_Trans_3005_1.IN_NO,sizeof(m_Trans_3005_1.IN_NO));
	CommonFuncs::chartobyte(CENTER_ID,(char*)m_Trans_3005_1.CENTER_ID,sizeof(m_Trans_3005_1.CENTER_ID));
	m_Trans_3005_1.w_Records 		=  CommonFuncs::wordtowin(ParamRecords);
	
	m_Trans_3005_2 = (Trans_3005_2*)malloc(ParamRecords * sizeof(Trans_3005_2));
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_3005_Record CURSOR FOR SELECT IN_TYPE,TICKET_DIRECTORY,TICKET_STATUS,IN_DATE,
                                                     IN_COUNT,RELE_NO,AMOUNT,UNIT_PRICE,OPERATOR_ID,
                                                     APPROVAL_ID,START_CARD_ID,END_CARD_ID
		                                          FROM   TBL_ST_3005_IN
		                                          WHERE IN_NO = :IN_NO
		                                          ORDER BY IN_TYPE,TICKET_DIRECTORY;                              
	EXEC SQL OPEN SQL_3005_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create3005file(OPEN SQL_3005_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Trans_3005_2);
		m_Trans_3005_2 = NULL;
		return;
	}
	index = 0;
	for(;;)
	{
		memset(IN_TYPE,0x00,sizeof(IN_TYPE));
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		memset(TICKET_STATUS,0x00,sizeof(TICKET_STATUS));
		memset(IN_DATE,0x00,sizeof(IN_DATE));
		memset(RELE_NO,0x00,sizeof(RELE_NO));
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		memset(APPROVAL_ID,0x00,sizeof(APPROVAL_ID));
		memset(START_CARD_ID,0x00,sizeof(START_CARD_ID));
		memset(END_CARD_ID,0x00,sizeof(END_CARD_ID));
		EXEC SQL FETCH SQL_3005_Record INTO :IN_TYPE,:TICKET_DIRECTORY,:TICKET_STATUS,:IN_DATE,
                                        :IN_COUNT,:RELE_NO,:AMOUNT,:UNIT_PRICE,:OPERATOR_ID,
                                        :APPROVAL_ID,:START_CARD_ID,:END_CARD_ID;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create3005param(FETCH SQL_3005_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_3005_Record;
				free(m_Trans_3005_2);
				m_Trans_3005_2 = NULL;
				return;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Trans_3005_2[index],0x00,sizeof(Trans_3005_2 ));
		m_Trans_3005_2[index].IN_TYPE = (BYTE)strtoul(IN_TYPE,&stopstring,16);
		CommonFuncs::chartobyte(TICKET_DIRECTORY,(char*)m_Trans_3005_2[index].TICKET_DIRECTORY,sizeof(m_Trans_3005_2[index].TICKET_DIRECTORY));
		m_Trans_3005_2[index].TICKET_STATUS = (BYTE)strtoul(TICKET_STATUS,&stopstring,16);
		CommonFuncs::chartobyte(IN_DATE,(char*)m_Trans_3005_2[index].IN_DATE,sizeof(m_Trans_3005_2[index].IN_DATE));
		m_Trans_3005_2[index].IN_COUNT = CommonFuncs::dwordtowin(IN_COUNT);
		CommonFuncs::chartobyte(RELE_NO,(char*)m_Trans_3005_2[index].RELE_NO,sizeof(m_Trans_3005_2[index].RELE_NO));
		m_Trans_3005_2[index].AMOUNT = CommonFuncs::dwordtowin(AMOUNT);
		m_Trans_3005_2[index].UNIT_PRICE = CommonFuncs::dwordtowin(UNIT_PRICE);
		CommonFuncs::chartobyte(OPERATOR_ID,(char*)m_Trans_3005_2[index].OPERATOR_ID,sizeof(m_Trans_3005_2[index].OPERATOR_ID));
		CommonFuncs::chartobyte(APPROVAL_ID,(char*)m_Trans_3005_2[index].APPROVAL_ID,sizeof(m_Trans_3005_2[index].APPROVAL_ID));
		CommonFuncs::chartobyte(START_CARD_ID,(char*)m_Trans_3005_2[index].START_CARD_ID,sizeof(m_Trans_3005_2[index].START_CARD_ID));
		CommonFuncs::chartobyte(END_CARD_ID,(char*)m_Trans_3005_2[index].END_CARD_ID,sizeof(m_Trans_3005_2[index].END_CARD_ID));
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_3005_Record;	
	
	bodylen = sizeof(Trans_3005_1)+ParamRecords*sizeof(Trans_3005_2);
	/* -------- 生成包头 ---------- */
	sessionnum = get_session_number();
	b_PkgID = (BYTE)get_pkg_number();
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	CPackage::Create_Pkg_Head(b_PkgID,&m_MsgHead,bodylen,0x3005,sessionnum,CConfig::g_ACCIDCode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Trans_3005_1,sizeof(Trans_3005_1));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Trans_3005_1)+index*sizeof(Trans_3005_2),&m_Trans_3005_2[index],sizeof(Trans_3005_2));
	}
	/* --- 生成文件于发送目录 --- */
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
	
	char strTemp[5];
	memset(strTemp,0x00,sizeof(strTemp));
	memcpy(strTemp, c_recv_id,2);	
	
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%s%s_%04X_%s",CConfig::SendFilePath_ACC,strTemp,0x3005,c_PkgID);
	CommonFuncs::WriteBufferFile("wb",filename,(char*)filebuf,filelen);
	
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "车票入库文件%s生成成功\n",filename);
	CLog::WriteAppLog(oplogmsg);
	
	/* -------- 内存释放 ---------- */
	free(m_Trans_3005_2);
	m_Trans_3005_2 = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;

}

/* ------------------------------------------------------
            生成3006           
            HHJT_CJP 20210323 文件名中的线路号由参数带入
--------------------------------------------------------- */
void ORA::create3006file(const char *c_apply_no,const char *c_recv_id)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	int           	ParamRecords;
	char            OUT_NO[25];
	char            CENTER_ID[5];
	
	char          	OUT_TYPE[3];
  char          	TICKET_DIRECTORY[5];
	char   					TICKET_STATUS[3];
	char            OUT_DATE[15];
	unsigned int 		OUT_COUNT;
	char            RELE_NO[25];
	unsigned int 		AMOUNT;
	unsigned int 		UNIT_PRICE;
	char            OPERATOR_ID[9];
	char            APPROVAL_ID[9];
	char            START_CARD_ID[11];
	char            END_CARD_ID[11];
	char            OUT_USER_ID[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead	       		m_MsgHead;
	Trans_3006_1 			m_Trans_3006_1;
	Trans_3006_2   		*m_Trans_3006_2;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	unsigned int 			sessionnum;
	char        			c_PkgID[30];
	BYTE         			b_PkgID;
	char              *stopstring;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(OUT_NO,0x00,sizeof(OUT_NO));
	strcpy(OUT_NO,c_apply_no);
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_ST_3006_OUT
		       WHERE OUT_NO = :OUT_NO 
		       	AND IS_UPLOADED = '00';
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create3006file(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	/* -------- 包体头 ---------- */
	memset(CENTER_ID,0x00,sizeof(CENTER_ID));
	EXEC SQL SELECT CENTER_ID
	         INTO   :CENTER_ID
	         FROM TBL_ST_3006_OUT 
	         WHERE OUT_NO = :OUT_NO 
	         	AND IS_UPLOADED = '00';
	memset(&m_Trans_3006_1,0x00,sizeof(Trans_3006_1));
	CommonFuncs::chartobyte(OUT_NO,(char*)m_Trans_3006_1.OUT_NO,sizeof(m_Trans_3006_1.OUT_NO));
	CommonFuncs::chartobyte(CENTER_ID,(char*)m_Trans_3006_1.CENTER_ID,sizeof(m_Trans_3006_1.CENTER_ID));
	m_Trans_3006_1.w_Records 		=  CommonFuncs::wordtowin(ParamRecords);
	
	m_Trans_3006_2 = (Trans_3006_2*)malloc(ParamRecords * sizeof(Trans_3006_2));
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_3006_Record CURSOR FOR SELECT OUT_TYPE,TICKET_DIRECTORY,TICKET_STATUS,OUT_DATE,
                                                     OUT_COUNT,RELE_NO,AMOUNT,UNIT_PRICE,OPERATOR_ID,
                                                     APPROVAL_ID,START_CARD_ID,END_CARD_ID,OUT_USER_ID
		                                          FROM   TBL_ST_3006_OUT
		                                          WHERE OUT_NO = :OUT_NO 
		                                          	AND IS_UPLOADED = '00'
		                                          ORDER BY OUT_TYPE,TICKET_DIRECTORY;                              
	EXEC SQL OPEN SQL_3006_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create3006file(OPEN SQL_3006_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Trans_3006_2);
		m_Trans_3006_2 = NULL;
		return;
	}
	index = 0;
	for(;;)
	{
		memset(OUT_TYPE,0x00,sizeof(OUT_TYPE));
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		memset(TICKET_STATUS,0x00,sizeof(TICKET_STATUS));
		memset(OUT_DATE,0x00,sizeof(OUT_DATE));
		memset(RELE_NO,0x00,sizeof(RELE_NO));
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		memset(APPROVAL_ID,0x00,sizeof(APPROVAL_ID));
		memset(START_CARD_ID,0x00,sizeof(START_CARD_ID));
		memset(END_CARD_ID,0x00,sizeof(END_CARD_ID));
		memset(OUT_USER_ID,0x00,sizeof(OUT_USER_ID));
		EXEC SQL FETCH SQL_3006_Record INTO :OUT_TYPE,:TICKET_DIRECTORY,:TICKET_STATUS,:OUT_DATE,
                                        :OUT_COUNT,:RELE_NO,:AMOUNT,:UNIT_PRICE,:OPERATOR_ID,
                                        :APPROVAL_ID,:START_CARD_ID,:END_CARD_ID,:OUT_USER_ID;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create3006param(FETCH SQL_3006_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_3006_Record;
				free(m_Trans_3006_2);
				m_Trans_3006_2 = NULL;
				return;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Trans_3006_2[index],0x00,sizeof(Trans_3006_2 ));
		m_Trans_3006_2[index].OUT_TYPE = (BYTE)strtoul(OUT_TYPE,&stopstring,16);
		CommonFuncs::chartobyte(TICKET_DIRECTORY,(char*)m_Trans_3006_2[index].TICKET_DIRECTORY,sizeof(m_Trans_3006_2[index].TICKET_DIRECTORY));
		m_Trans_3006_2[index].TICKET_STATUS = (BYTE)strtoul(TICKET_STATUS,&stopstring,16);
		CommonFuncs::chartobyte(OUT_DATE,(char*)m_Trans_3006_2[index].OUT_DATE,sizeof(m_Trans_3006_2[index].OUT_DATE));
		m_Trans_3006_2[index].OUT_COUNT = CommonFuncs::dwordtowin(OUT_COUNT);
		CommonFuncs::chartobyte(RELE_NO,(char*)m_Trans_3006_2[index].RELE_NO,sizeof(m_Trans_3006_2[index].RELE_NO));
		m_Trans_3006_2[index].AMOUNT = CommonFuncs::dwordtowin(AMOUNT);
		m_Trans_3006_2[index].UNIT_PRICE = CommonFuncs::dwordtowin(UNIT_PRICE);
		CommonFuncs::chartobyte(OPERATOR_ID,(char*)m_Trans_3006_2[index].OPERATOR_ID,sizeof(m_Trans_3006_2[index].OPERATOR_ID));
		CommonFuncs::chartobyte(APPROVAL_ID,(char*)m_Trans_3006_2[index].APPROVAL_ID,sizeof(m_Trans_3006_2[index].APPROVAL_ID));
		CommonFuncs::chartobyte(START_CARD_ID,(char*)m_Trans_3006_2[index].START_CARD_ID,sizeof(m_Trans_3006_2[index].START_CARD_ID));
		CommonFuncs::chartobyte(END_CARD_ID,(char*)m_Trans_3006_2[index].END_CARD_ID,sizeof(m_Trans_3006_2[index].END_CARD_ID));
		CommonFuncs::chartobyte(OUT_USER_ID,(char*)m_Trans_3006_2[index].OUT_USER_ID,sizeof(m_Trans_3006_2[index].OUT_USER_ID));
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_3006_Record;	
	
	bodylen = sizeof(Trans_3006_1)+ParamRecords*sizeof(Trans_3006_2);
	/* -------- 生成包头 ---------- */
	sessionnum = get_session_number();
	b_PkgID = (BYTE)get_pkg_number();
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	CPackage::Create_Pkg_Head(b_PkgID,&m_MsgHead,bodylen,0x3006,sessionnum,CConfig::g_ACCIDCode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Trans_3006_1,sizeof(Trans_3006_1));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Trans_3006_1)+index*sizeof(Trans_3006_2),&m_Trans_3006_2[index],sizeof(Trans_3006_2));
	}
	/* --- 生成文件于发送目录 --- */
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
	
	char strTemp[5];
	memset(strTemp,0x00,sizeof(strTemp));
	memcpy(strTemp, c_recv_id,2);	
	
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%s%s_%04X_%s",CConfig::SendFilePath_ACC,strTemp,0x3005,c_PkgID);
	CommonFuncs::WriteBufferFile("wb",filename,(char*)filebuf,filelen);
	
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "车票出库文件%s生成成功\n",filename);
	CLog::WriteAppLog(oplogmsg);
		
	/* -------- 内存释放 ---------- */
	free(m_Trans_3006_2);
	m_Trans_3006_2 = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;

}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3001(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char            APPLY_NO[25];
	char            APPLY_TYPE[3];
	char            APPLY_NID[5];
	char            APPLY_DATE[15];
	char 	          TICKET_DIRECTORY[5];
  char          	TICKET_STATUS[3];
	unsigned int 		APPLY_NUM;
	char            APPLY_DEPLOY_DATE[15];
	char            APPLY_USER_ID[9];
  char            MEMO[201];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 Records;
	Trans_3001_1				m_Trans_3001_1;
	Trans_3001_2 				m_Trans_3001_2;
	Trans_3001_3 				m_Trans_3001_3;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3001 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3001 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_3001_1,0x00,sizeof(Trans_3001_1));
	m_Trans_3001_1 = *(Trans_3001_1 *)p;
	memset(APPLY_NO,0x00,sizeof(APPLY_NO));
	for(i = 0;i < sizeof(m_Trans_3001_1.APPLY_NO);i++)
		sprintf(APPLY_NO+2*i,"%02X",m_Trans_3001_1.APPLY_NO[i]);
	memset(APPLY_TYPE,0x00,sizeof(APPLY_TYPE));
	sprintf(APPLY_TYPE,"%02X",m_Trans_3001_1.APPLY_TYPE);
	memset(APPLY_NID,0x00,sizeof(APPLY_NID));
	sprintf(APPLY_NID,"%02X%02X",m_Trans_3001_1.APPLY_NID[0],m_Trans_3001_1.APPLY_NID[1]);
	memset(APPLY_DATE,0x00,sizeof(APPLY_DATE));
	for(i = 0;i < sizeof(m_Trans_3001_1.APPLY_DATE);i++)
		sprintf(APPLY_DATE+2*i,"%02X",m_Trans_3001_1.APPLY_DATE[i]);
	Records =  CommonFuncs::wordtowin(m_Trans_3001_1.w_Records);	
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_3001_1) + Records * sizeof(m_Trans_3001_2);	
	memset(&m_Trans_3001_3,0x00,sizeof(Trans_3001_3));
	m_Trans_3001_3 = *(Trans_3001_3 *)p;
	memset(APPLY_USER_ID,0x00,sizeof(APPLY_USER_ID));
	for(i = 0;i < sizeof(m_Trans_3001_3.APPLY_USER_ID);i++)
		sprintf(APPLY_USER_ID+2*i,"%02X",m_Trans_3001_3.APPLY_USER_ID[i]);
	memset(MEMO,0x00,sizeof(MEMO));
	memcpy(MEMO,m_Trans_3001_3.MEMO,sizeof(m_Trans_3001_3.MEMO));
	EXEC SQL INSERT INTO TBL_ST_3001_APPLY(PACKET_SEQ,APPLY_NO,APPLY_TYPE,APPLY_NID,
	                                       APPLY_DATE,APPLY_USER_ID,MEMO,APPLY_SOURCE,IS_UPLOADED)
	                                VALUES(:msg_pointer,:APPLY_NO,:APPLY_TYPE,:APPLY_NID,
	                                       :APPLY_DATE,:APPLY_USER_ID,:MEMO,'01','01');
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3001 ErrorCode(TBL_ST_3001_APPLY) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	/* ----- 记录入库---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_3001_1);	
				
	for(j=0;j<Records;j++)
	{
		memset(&m_Trans_3001_2,0x00,sizeof(Trans_3001_2));
		m_Trans_3001_2 = *(Trans_3001_2 *)p;
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		for(i = 0;i < sizeof(m_Trans_3001_2.TICKET_DIRECTORY);i++)
			sprintf(TICKET_DIRECTORY+2*i,"%02X",m_Trans_3001_2.TICKET_DIRECTORY[i]);
		memset(TICKET_STATUS,0x00,sizeof(TICKET_STATUS));
		sprintf(TICKET_STATUS,"%02X",m_Trans_3001_2.TICKET_STATUS);
		APPLY_NUM = CommonFuncs::dwordtowin(m_Trans_3001_2.APPLY_NUM);	
		memset(APPLY_DEPLOY_DATE,0x00,sizeof(APPLY_DEPLOY_DATE));
		for(i = 0;i < sizeof(m_Trans_3001_2.APPLY_DEPLOY_DATE);i++)
			sprintf(APPLY_DEPLOY_DATE+2*i,"%02X",m_Trans_3001_2.APPLY_DEPLOY_DATE[i]);
		
		EXEC SQL INSERT INTO TBL_ST_3001_APPLY_DETAIL(PACKET_SEQ,APPLY_NO,
		                                              TICKET_DIRECTORY,TICKET_STATUS,APPLY_NUM,APPLY_DEPLOY_DATE)
				                                   VALUES(:msg_pointer,:APPLY_NO,
		                                              :TICKET_DIRECTORY,:TICKET_STATUS,:APPLY_NUM,:APPLY_DEPLOY_DATE);
		p = p + sizeof(Trans_3001_2);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3001 ErrorCode(TBL_ST_3001_APPLY_DETAIL) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}


/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3003(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char            CENTER_ID[5];
	char            STATION_NID[5];
	char            INVENTORY_DATE[15];
	
  char          	TICKET_DIRECTORY[5];
	unsigned int 		GOOD_COUNT;
	unsigned int 		BAD_COUNT;
	unsigned int 		EXPIRATION_COUNT;
	unsigned int 		INUSE_COUNT;
	unsigned int 		PROFIT_COUNT;
	unsigned int 		LOSS_COUNT;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 Records;
	Trans_3003_1				m_Trans_3003_1;
	Trans_3003_2 				m_Trans_3003_2;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(STATION_NID,0x00,sizeof(STATION_NID));
	memcpy(STATION_NID,b_SourceID,4);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3003 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3003 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_3003_1,0x00,sizeof(Trans_3003_1));
	m_Trans_3003_1 = *(Trans_3003_1 *)p;
	memset(CENTER_ID,0x00,sizeof(CENTER_ID));
	sprintf(CENTER_ID,"%02X%02X",m_Trans_3003_1.CENTER_ID[0],m_Trans_3003_1.CENTER_ID[1]);
	memset(INVENTORY_DATE,0x00,sizeof(INVENTORY_DATE));
	for(i = 0;i < sizeof(m_Trans_3003_1.INVENTORY_DATE);i++)
		sprintf(INVENTORY_DATE+2*i,"%02X",m_Trans_3003_1.INVENTORY_DATE[i]);
	Records =  CommonFuncs::wordtowin(m_Trans_3003_1.w_Records);	
	/* ----- 记录入库---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_3003_1);	
				
	for(j=0;j<Records;j++)
	{
		memset(&m_Trans_3003_2,0x00,sizeof(Trans_3003_2));
		m_Trans_3003_2 = *(Trans_3003_2 *)p;
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		for(i = 0;i < sizeof(m_Trans_3003_2.TICKET_DIRECTORY);i++)
			sprintf(TICKET_DIRECTORY+2*i,"%02X",m_Trans_3003_2.TICKET_DIRECTORY[i]);
		GOOD_COUNT 				= CommonFuncs::dwordtowin(m_Trans_3003_2.GOOD_COUNT);	
		BAD_COUNT 				= CommonFuncs::dwordtowin(m_Trans_3003_2.BAD_COUNT);	
		EXPIRATION_COUNT 	= CommonFuncs::dwordtowin(m_Trans_3003_2.EXPIRATION_COUNT);	
		INUSE_COUNT 			= CommonFuncs::dwordtowin(m_Trans_3003_2.INUSE_COUNT);	
		PROFIT_COUNT 			= CommonFuncs::dwordtowin(m_Trans_3003_2.PROFIT_COUNT);	
		LOSS_COUNT 				= CommonFuncs::dwordtowin(m_Trans_3003_2.LOSS_COUNT);	
		
		EXEC SQL DELETE FROM TBL_ST_3003_INVENTORY 
		                WHERE INVENTORY_DATE = :INVENTORY_DATE 
		                	AND STATION_NID = :STATION_NID 
		                		AND TICKET_DIRECTORY = :TICKET_DIRECTORY;
		EXEC SQL INSERT INTO TBL_ST_3003_INVENTORY(PACKET_SEQ,CENTER_ID,STATION_NID,INVENTORY_DATE,TICKET_DIRECTORY,
		                                           GOOD_COUNT,BAD_COUNT,EXPIRATION_COUNT,INUSE_COUNT,
		                                           PROFIT_COUNT,LOSS_COUNT,INVENT_STATUS)
				                                VALUES(:msg_pointer,:CENTER_ID,:STATION_NID,:INVENTORY_DATE,:TICKET_DIRECTORY,
		                                           :GOOD_COUNT,:BAD_COUNT,:EXPIRATION_COUNT,:INUSE_COUNT,
		                                           :PROFIT_COUNT,:LOSS_COUNT,'01');
		p = p + sizeof(Trans_3003_2);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3003 ErrorCode(TBL_ST_3003_INVENTORY) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}


/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3005(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char            IN_NO[25];
	char            CENTER_ID[3];
	char            STATION_NID[5];
	
	char          	IN_TYPE[3];
  char          	TICKET_DIRECTORY[5];
	char   					TICKET_STATUS[3];
	char            IN_DATE[15];
	unsigned int 		IN_COUNT;
	char            RELE_NO[25];
	unsigned int 		AMOUNT;
	unsigned int 		UNIT_PRICE;
	char            OPERATOR_ID[9];
	char            APPROVAL_ID[9];
	char            START_CARD_ID[11];
	char            END_CARD_ID[11];
	char            DEVICE_NID[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 Records;
	Trans_3005_1				m_Trans_3005_1;
	Trans_3005_2 				m_Trans_3005_2;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(STATION_NID,0x00,sizeof(STATION_NID));
	memcpy(STATION_NID,b_SourceID,4);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3005 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3005 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_3005_1,0x00,sizeof(Trans_3005_1));
	m_Trans_3005_1 = *(Trans_3005_1 *)p;
	memset(CENTER_ID,0x00,sizeof(CENTER_ID));
	sprintf(CENTER_ID,"%02X",m_Trans_3005_1.CENTER_ID[0]);
	memset(IN_NO,0x00,sizeof(IN_NO));
	for(i = 0;i < sizeof(m_Trans_3005_1.IN_NO);i++)
		sprintf(IN_NO+2*i,"%02X",m_Trans_3005_1.IN_NO[i]);
	Records =  CommonFuncs::wordtowin(m_Trans_3005_1.w_Records);	
	/* ----- 记录入库---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_3005_1);	
				
	for(j=0;j<Records;j++)
	{
		memset(&m_Trans_3005_2,0x00,sizeof(Trans_3005_2));
		m_Trans_3005_2 = *(Trans_3005_2 *)p;
		memset(IN_TYPE,0x00,sizeof(IN_TYPE));
		sprintf(IN_TYPE,"%02X",m_Trans_3005_2.IN_TYPE);
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		for(i = 0;i < sizeof(m_Trans_3005_2.TICKET_DIRECTORY);i++)
			sprintf(TICKET_DIRECTORY+2*i,"%02X",m_Trans_3005_2.TICKET_DIRECTORY[i]);
		memset(TICKET_STATUS,0x00,sizeof(TICKET_STATUS));
		sprintf(TICKET_STATUS,"%02X",m_Trans_3005_2.TICKET_STATUS);
		memset(IN_DATE,0x00,sizeof(IN_DATE));
		for(i = 0;i < sizeof(m_Trans_3005_2.IN_DATE);i++)
			sprintf(IN_DATE+2*i,"%02X",m_Trans_3005_2.IN_DATE[i]);
		IN_COUNT 				= CommonFuncs::dwordtowin(m_Trans_3005_2.IN_COUNT);	
		memset(RELE_NO,0x00,sizeof(RELE_NO));
		for(i = 0;i < sizeof(m_Trans_3005_2.RELE_NO);i++)
			sprintf(RELE_NO+2*i,"%02X",m_Trans_3005_2.RELE_NO[i]);
		AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_3005_2.AMOUNT);	
		UNIT_PRICE 		= CommonFuncs::dwordtowin(m_Trans_3005_2.UNIT_PRICE);	
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_3005_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_3005_2.OPERATOR_ID[i]);
		memset(APPROVAL_ID,0x00,sizeof(APPROVAL_ID));
		for(i = 0;i < sizeof(m_Trans_3005_2.APPROVAL_ID);i++)
			sprintf(APPROVAL_ID+2*i,"%02X",m_Trans_3005_2.APPROVAL_ID[i]);
		memset(START_CARD_ID,0x00,sizeof(START_CARD_ID));
		for(i = 0;i < sizeof(m_Trans_3005_2.START_CARD_ID);i++)
			sprintf(START_CARD_ID+2*i,"%02X",m_Trans_3005_2.START_CARD_ID[i]);
		memset(END_CARD_ID,0x00,sizeof(END_CARD_ID));
		for(i = 0;i < sizeof(m_Trans_3005_2.END_CARD_ID);i++)
			sprintf(END_CARD_ID+2*i,"%02X",m_Trans_3005_2.END_CARD_ID[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_3005_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_3005_2.DEVICE_NID[i]);
		EXEC SQL INSERT INTO TBL_ST_3005_IN(PACKET_SEQ,IN_NO,CENTER_ID,STATION_NID,
																				IN_TYPE,TICKET_DIRECTORY,TICKET_STATUS,IN_DATE,
                                        IN_COUNT,RELE_NO,AMOUNT,UNIT_PRICE,OPERATOR_ID,
                                        APPROVAL_ID,START_CARD_ID,END_CARD_ID,DEVICE_NID,IS_UPLOADED)
				                         VALUES(:msg_pointer,:IN_NO,:CENTER_ID,:STATION_NID,
																				:IN_TYPE,:TICKET_DIRECTORY,:TICKET_STATUS,:IN_DATE,
                                        :IN_COUNT,:RELE_NO,:AMOUNT,:UNIT_PRICE,:OPERATOR_ID,
                                        :APPROVAL_ID,:START_CARD_ID,:END_CARD_ID,:DEVICE_NID,'01');
		p = p + sizeof(Trans_3005_2);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3005 ErrorCode(TBL_ST_3005_IN) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}


/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3006(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char            OUT_NO[25];
	char            CENTER_ID[3];
	char            STATION_NID[5];
	
	char          	OUT_TYPE[3];
  char          	TICKET_DIRECTORY[5];
	char   					TICKET_STATUS[3];
	char            OUT_DATE[15];
	unsigned int 		OUT_COUNT;
	char            RELE_NO[25];
	unsigned int 		AMOUNT;
	unsigned int 		UNIT_PRICE;
	char            OPERATOR_ID[9];
	char            APPROVAL_ID[9];
	char            START_CARD_ID[11];
	char            END_CARD_ID[11];
	char            OUT_USER_ID[9];
	char            DEVICE_NID[9];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 Records;
	Trans_3006_1				m_Trans_3006_1;
	Trans_3006_2 				m_Trans_3006_2;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(STATION_NID,0x00,sizeof(STATION_NID));
	memcpy(STATION_NID,b_SourceID,4);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3006 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3006 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_3006_1,0x00,sizeof(Trans_3006_1));
	m_Trans_3006_1 = *(Trans_3006_1 *)p;
	memset(CENTER_ID,0x00,sizeof(CENTER_ID));
	sprintf(CENTER_ID,"%02X",m_Trans_3006_1.CENTER_ID[0]);
	memset(OUT_NO,0x00,sizeof(OUT_NO));
	for(i = 0;i < sizeof(m_Trans_3006_1.OUT_NO);i++)
		sprintf(OUT_NO+2*i,"%02X",m_Trans_3006_1.OUT_NO[i]);
	Records =  CommonFuncs::wordtowin(m_Trans_3006_1.w_Records);	
	/* ----- 记录入库---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_3006_1);	
				
	for(j=0;j<Records;j++)
	{
		memset(&m_Trans_3006_2,0x00,sizeof(Trans_3006_2));
		m_Trans_3006_2 = *(Trans_3006_2 *)p;
		memset(OUT_TYPE,0x00,sizeof(OUT_TYPE));
		sprintf(OUT_TYPE,"%02X",m_Trans_3006_2.OUT_TYPE);
		memset(TICKET_DIRECTORY,0x00,sizeof(TICKET_DIRECTORY));
		for(i = 0;i < sizeof(m_Trans_3006_2.TICKET_DIRECTORY);i++)
			sprintf(TICKET_DIRECTORY+2*i,"%02X",m_Trans_3006_2.TICKET_DIRECTORY[i]);
		memset(TICKET_STATUS,0x00,sizeof(TICKET_STATUS));
		sprintf(TICKET_STATUS,"%02X",m_Trans_3006_2.TICKET_STATUS);
		memset(OUT_DATE,0x00,sizeof(OUT_DATE));
		for(i = 0;i < sizeof(m_Trans_3006_2.OUT_DATE);i++)
			sprintf(OUT_DATE+2*i,"%02X",m_Trans_3006_2.OUT_DATE[i]);
		OUT_COUNT 				= CommonFuncs::dwordtowin(m_Trans_3006_2.OUT_COUNT);	
		memset(RELE_NO,0x00,sizeof(RELE_NO));
		for(i = 0;i < sizeof(m_Trans_3006_2.RELE_NO);i++)
			sprintf(RELE_NO+2*i,"%02X",m_Trans_3006_2.RELE_NO[i]);
		AMOUNT 				= CommonFuncs::dwordtowin(m_Trans_3006_2.AMOUNT);	
		UNIT_PRICE 		= CommonFuncs::dwordtowin(m_Trans_3006_2.UNIT_PRICE);	
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_3006_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_3006_2.OPERATOR_ID[i]);
		memset(APPROVAL_ID,0x00,sizeof(APPROVAL_ID));
		for(i = 0;i < sizeof(m_Trans_3006_2.APPROVAL_ID);i++)
			sprintf(APPROVAL_ID+2*i,"%02X",m_Trans_3006_2.APPROVAL_ID[i]);
		memset(START_CARD_ID,0x00,sizeof(START_CARD_ID));
		for(i = 0;i < sizeof(m_Trans_3006_2.START_CARD_ID);i++)
			sprintf(START_CARD_ID+2*i,"%02X",m_Trans_3006_2.START_CARD_ID[i]);
		memset(END_CARD_ID,0x00,sizeof(END_CARD_ID));
		for(i = 0;i < sizeof(m_Trans_3006_2.END_CARD_ID);i++)
			sprintf(END_CARD_ID+2*i,"%02X",m_Trans_3006_2.END_CARD_ID[i]);
		memset(OUT_USER_ID,0x00,sizeof(OUT_USER_ID));
		for(i = 0;i < sizeof(m_Trans_3006_2.OUT_USER_ID);i++)
			sprintf(OUT_USER_ID+2*i,"%02X",m_Trans_3006_2.OUT_USER_ID[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_3006_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_3006_2.DEVICE_NID[i]);
		EXEC SQL INSERT INTO TBL_ST_3006_OUT(PACKET_SEQ,OUT_NO,CENTER_ID,STATION_NID,
																				OUT_TYPE,TICKET_DIRECTORY,TICKET_STATUS,OUT_DATE,
                                        OUT_COUNT,RELE_NO,AMOUNT,UNIT_PRICE,OPERATOR_ID,
                                        APPROVAL_ID,START_CARD_ID,END_CARD_ID,OUT_USER_ID,DEVICE_NID,IS_UPLOADED)
				                         VALUES(:msg_pointer,:OUT_NO,:CENTER_ID,:STATION_NID,
																				:OUT_TYPE,:TICKET_DIRECTORY,:TICKET_STATUS,:OUT_DATE,
                                        :OUT_COUNT,:RELE_NO,:AMOUNT,:UNIT_PRICE,:OPERATOR_ID,
                                        :APPROVAL_ID,:START_CARD_ID,:END_CARD_ID,:OUT_USER_ID,:DEVICE_NID,'01');
		p = p + sizeof(Trans_3006_2);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3006 ErrorCode(TBL_ST_3006_OUT) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3007(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char          	APPLY_ID[25];
	char            CENTER_ID[3];
	char            LINE_ID[3];
	char            STATION_NID[5];
	char            DEVICE_NID[9];
	char            TICKET_TYPE[5];
	char         		APPLY_DATE[15];
	char         		VALID_DATE[9];
	char         		OPERATOR_ID[9];
	char            APPLY_NAME[31];
	int             GENDER;
	char         		BIRTH_DATE[9];
	char            CERT_TYPE[3];
	char            CERT_NO[31];
	char            TELPHONE[21];
	char            TELPHONE2[21];
	char            ADDRESS[51];
	char            MEMO[101];
	unsigned int 		PHOTO_LENGTH;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 w_Records;
	Trans_3007_1			  m_Trans_3007_1;
	Trans_3007_2        m_Trans_3007_2;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3007 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3007 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_3007_1,0x00,sizeof(Trans_3007_1));
	m_Trans_3007_1 = *(Trans_3007_1 *)p;
	w_Records =  CommonFuncs::wordtowin(m_Trans_3007_1.w_Records);	
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_3007_1);			
	for(j=0;j<w_Records;j++)
	{
		memset(&m_Trans_3007_2,0x00,sizeof(Trans_3007_2));
		m_Trans_3007_2 = *(Trans_3007_2 *)p;
		memset(APPLY_ID,0x00,sizeof(APPLY_ID));
		for(i = 0;i < sizeof(m_Trans_3007_2.APPLY_ID);i++)
			sprintf(APPLY_ID+2*i,"%02X",m_Trans_3007_2.APPLY_ID[i]);
		memset(CENTER_ID,0x00,sizeof(CENTER_ID));
		sprintf(CENTER_ID,"%02X",m_Trans_3007_2.CENTER_ID);
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_3007_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_3007_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_3007_2.STATION_NID[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_3007_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_3007_2.DEVICE_NID[i]);
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_3007_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_3007_2.TICKET_TYPE[i]);
		memset(APPLY_DATE,0x00,sizeof(APPLY_DATE));
		for(i = 0;i < sizeof(m_Trans_3007_2.APPLY_DATE);i++)
			sprintf(APPLY_DATE+2*i,"%02X",m_Trans_3007_2.APPLY_DATE[i]);
		memset(VALID_DATE,0x00,sizeof(VALID_DATE));
		for(i = 0;i < sizeof(m_Trans_3007_2.VALID_DATE);i++)
			sprintf(VALID_DATE+2*i,"%02X",m_Trans_3007_2.VALID_DATE[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_3007_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_3007_2.OPERATOR_ID[i]);
		memset(APPLY_NAME,0x00,sizeof(APPLY_NAME));
		memcpy(APPLY_NAME,m_Trans_3007_2.APPLY_NAME,sizeof(m_Trans_3007_2.APPLY_NAME));
		GENDER = (int)m_Trans_3007_2.GENDER;
		memset(BIRTH_DATE,0x00,sizeof(BIRTH_DATE));
		for(i = 0;i < sizeof(m_Trans_3007_2.BIRTH_DATE);i++)
			sprintf(BIRTH_DATE+2*i,"%02X",m_Trans_3007_2.BIRTH_DATE[i]);
		memset(CERT_TYPE,0x00,sizeof(CERT_TYPE));
		sprintf(CERT_TYPE,"%02X",m_Trans_3007_2.CERT_TYPE);
		memset(CERT_NO,0x00,sizeof(CERT_NO));
		memcpy(CERT_NO,m_Trans_3007_2.CERT_NO,sizeof(m_Trans_3007_2.CERT_NO));
		memset(TELPHONE,0x00,sizeof(TELPHONE));
		memcpy(TELPHONE,m_Trans_3007_2.TELPHONE,sizeof(m_Trans_3007_2.TELPHONE));
		memset(TELPHONE2,0x00,sizeof(TELPHONE2));
		memcpy(TELPHONE2,m_Trans_3007_2.TELPHONE2,sizeof(m_Trans_3007_2.TELPHONE2));
		memset(ADDRESS,0x00,sizeof(ADDRESS));
		memcpy(ADDRESS,m_Trans_3007_2.ADDRESS,sizeof(m_Trans_3007_2.ADDRESS));
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_3007_2.MEMO,sizeof(m_Trans_3007_2.MEMO));
		PHOTO_LENGTH = CommonFuncs::dwordtowin(m_Trans_3007_2.PHOTO_LENGTH);
		
		EXEC SQL INSERT INTO TBL_TK_3007_PERSONAL_APPLY(PACKET_SEQ,APPLY_ID,CENTER_ID,LINE_ID,        
                                                    STATION_NID,DEVICE_NID,TICKET_TYPE,APPLY_DATE,     
                                                    VALID_DATE,OPERATOR_ID,APPLY_NAME,GENDER,       
                                                    BIRTH_DATE,CERT_TYPE,CERT_NO,TELPHONE,TELPHONE2,      
                                                    ADDRESS,MEMO,PHOTO_LENGTH)
				                                     VALUES(:msg_pointer,:APPLY_ID,:CENTER_ID,:LINE_ID,        
                                                    :STATION_NID,:DEVICE_NID,:TICKET_TYPE,:APPLY_DATE,     
                                                    :VALID_DATE,:OPERATOR_ID,:APPLY_NAME,:GENDER,       
                                                    :BIRTH_DATE,:CERT_TYPE,:CERT_NO,:TELPHONE,:TELPHONE2,      
                                                    :ADDRESS,:MEMO,:PHOTO_LENGTH);
		p = p + sizeof(Trans_3007_2);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3007 ErrorCode(TBL_TK_3007_PERSONAL_APPLY) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3008(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char          	APPLY_NO[25];
	char            APPLY_TYPE[3];
	char            LINE_ID[3];
	char            STATION_NID[5];
	char            DEVICE_NID[9];
	char         		APPLY_DATE[15];
	char         		OPERATOR_ID[9];
	char            IDENTIFY_RESULT[3];
	int             IS_FACE_DAMAGE;
	int             IS_DATA_DAMAGE;
	char            IS_NONRT[3];
	char            TICKET_TYPE[5];
	char            ISSUE_DATE[9];
	char            PRE_CARD_ID[11];
	unsigned int    VALUE_REMAIN;
	char            TEST_FLAG[3];
	char            MEMO[201];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 						m_msghead;
	int           			i,j;
	int                 w_Records;
	Trans_3008_1			  m_Trans_3008_1;
	Trans_3008_2        m_Trans_3008_2;
	BYTE          			*p;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + dw_PkgLen;
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3008 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3008 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
	/* ---  结构体 --- */
	p = recvbuf + sizeof(MsgHead);	
	memset(&m_Trans_3008_1,0x00,sizeof(Trans_3008_1));
	m_Trans_3008_1 = *(Trans_3008_1 *)p;
	w_Records =  CommonFuncs::wordtowin(m_Trans_3008_1.w_Records);	
	p = recvbuf + sizeof(MsgHead) + sizeof(m_Trans_3008_1);			
	for(j=0;j<w_Records;j++)
	{
		memset(&m_Trans_3008_2,0x00,sizeof(Trans_3008_2));
		m_Trans_3008_2 = *(Trans_3008_2 *)p;
		memset(APPLY_NO,0x00,sizeof(APPLY_NO));
		for(i = 0;i < sizeof(m_Trans_3008_2.APPLY_NO);i++)
			sprintf(APPLY_NO+2*i,"%02X",m_Trans_3008_2.APPLY_NO[i]);
		memset(APPLY_TYPE,0x00,sizeof(APPLY_TYPE));
		sprintf(APPLY_TYPE,"%02X",m_Trans_3008_2.APPLY_TYPE);
		memset(LINE_ID,0x00,sizeof(LINE_ID));
		sprintf(LINE_ID,"%02X",m_Trans_3008_2.LINE_ID);
		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_3008_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_3008_2.STATION_NID[i]);
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_3008_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_3008_2.DEVICE_NID[i]);
		memset(APPLY_DATE,0x00,sizeof(APPLY_DATE));
		for(i = 0;i < sizeof(m_Trans_3008_2.APPLY_DATE);i++)
			sprintf(APPLY_DATE+2*i,"%02X",m_Trans_3008_2.APPLY_DATE[i]);
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_3008_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_3008_2.OPERATOR_ID[i]);
		memset(IDENTIFY_RESULT,0x00,sizeof(IDENTIFY_RESULT));
		sprintf(IDENTIFY_RESULT,"%02X",m_Trans_3008_2.IDENTIFY_RESULT);
		IS_FACE_DAMAGE = (int)m_Trans_3008_2.IS_FACE_DAMAGE;
		IS_DATA_DAMAGE = (int)m_Trans_3008_2.IS_DATA_DAMAGE;
		memset(IS_NONRT,0x00,sizeof(IS_NONRT));
		sprintf(IS_NONRT,"%02X",m_Trans_3008_2.IS_NONRT);
		memset(TICKET_TYPE,0x00,sizeof(TICKET_TYPE));
		for(i = 0;i < sizeof(m_Trans_3008_2.TICKET_TYPE);i++)
			sprintf(TICKET_TYPE+2*i,"%02X",m_Trans_3008_2.TICKET_TYPE[i]);
		memset(ISSUE_DATE,0x00,sizeof(ISSUE_DATE));
		for(i = 0;i < sizeof(m_Trans_3008_2.ISSUE_DATE);i++)
			sprintf(ISSUE_DATE+2*i,"%02X",m_Trans_3008_2.ISSUE_DATE[i]);
		memset(PRE_CARD_ID,0x00,sizeof(PRE_CARD_ID));
		for(i = 0;i < sizeof(m_Trans_3008_2.PRE_CARD_ID);i++)
			sprintf(PRE_CARD_ID+2*i,"%02X",m_Trans_3008_2.PRE_CARD_ID[i]);
		VALUE_REMAIN = CommonFuncs::dwordtowin(m_Trans_3008_2.VALUE_REMAIN);
		memset(TEST_FLAG,0x00,sizeof(TEST_FLAG));
		sprintf(TEST_FLAG,"%02X",m_Trans_3008_2.TEST_FLAG);
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_3008_2.MEMO,sizeof(m_Trans_3008_2.MEMO));
		
		EXEC SQL INSERT INTO TBL_TK_3008_NONRT_APPLY(PACKET_SEQ,APPLY_NO,APPLY_TYPE,LINE_ID,        
                                                 STATION_NID,DEVICE_NID,APPLY_DATE,OPERATOR_ID,    
                                                 IDENTIFY_RESULT,IS_FACE_DAMAGE,IS_DATA_DAMAGE,IS_NONRT,      
                                                 TICKET_TYPE,ISSUE_DATE,PRE_CARD_ID,VALUE_REMAIN,   
                                                 TEST_FLAG,MEMO)
				                                     VALUES(:msg_pointer,:APPLY_NO,:APPLY_TYPE,:LINE_ID,        
                                                 :STATION_NID,:DEVICE_NID,:APPLY_DATE,:OPERATOR_ID,    
                                                 :IDENTIFY_RESULT,:IS_FACE_DAMAGE,:IS_DATA_DAMAGE,:IS_NONRT,      
                                                 :TICKET_TYPE,:ISSUE_DATE,:PRE_CARD_ID,:VALUE_REMAIN,   
                                                 :TEST_FLAG,:MEMO);
		p = p + sizeof(Trans_3008_2);
	}
	
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3008 ErrorCode(TBL_TK_3008_NONRT_APPLY) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		EXEC SQL ROLLBACK;
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
	}
	else
	{
		EXEC SQL COMMIT;
	}
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_3009(unsigned char* recvbuf,char *name,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char          	APPLY_NO[25];
	char         		APPLY_DATE[15];
	char         		MEASURE_DATE[15];
	unsigned int    VALUE_REMAIN;
	char            IDENTIFY_RESULT[3];
	unsigned int    REFUND_VALUE;
	unsigned int    REFUND_DEPOSIT;
	unsigned int    FEE;
	unsigned int    REASON_LENGTH;
	char            REASON[1025];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_3009_1   		m_Trans_3009_1;
	Trans_3009_2 			m_Trans_3009_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_3009_1,0x00,sizeof(Trans_3009_1));
	m_Trans_3009_1 = *(Trans_3009_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_3009_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_3009_1) + count * sizeof(Trans_3009_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3009 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_3009 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_3009_2,0x00,sizeof(Trans_3009_2));
		m_Trans_3009_2 = *(Trans_3009_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_3009_1)+sizeof(Trans_3009_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(APPLY_NO,0x00,sizeof(APPLY_NO));
		for(i = 0;i < sizeof(m_Trans_3009_2.APPLY_NO);i++)
			sprintf(APPLY_NO+2*i,"%02X",m_Trans_3009_2.APPLY_NO[i]);
		memset(APPLY_DATE,0x00,sizeof(APPLY_DATE));
		for(i = 0;i < sizeof(m_Trans_3009_2.APPLY_DATE);i++)
			sprintf(APPLY_DATE+2*i,"%02X",m_Trans_3009_2.APPLY_DATE[i]);
		memset(MEASURE_DATE,0x00,sizeof(MEASURE_DATE));
		for(i = 0;i < sizeof(m_Trans_3009_2.MEASURE_DATE);i++)
			sprintf(MEASURE_DATE+2*i,"%02X",m_Trans_3009_2.MEASURE_DATE[i]);
		VALUE_REMAIN 						  = CommonFuncs::dwordtowin(m_Trans_3009_2.VALUE_REMAIN);
		memset(IDENTIFY_RESULT,0x00,sizeof(IDENTIFY_RESULT));
		sprintf(IDENTIFY_RESULT,"%02X",m_Trans_3009_2.IDENTIFY_RESULT);
		REFUND_VALUE 		= CommonFuncs::dwordtowin(m_Trans_3009_2.REFUND_VALUE);
		REFUND_DEPOSIT 	= CommonFuncs::dwordtowin(m_Trans_3009_2.REFUND_DEPOSIT);
		FEE 						= CommonFuncs::dwordtowin(m_Trans_3009_2.FEE);
		REASON_LENGTH 	= CommonFuncs::dwordtowin(m_Trans_3009_2.REASON_LENGTH);
		memset(REASON,0x00,sizeof(REASON));
		memcpy(REASON,m_Trans_3009_2.REASON,199);
		EXEC SQL INSERT INTO TBL_TK_3009_NONRT_RESULT (PACKET_SEQ,APPLY_NO,APPLY_DATE,MEASURE_DATE,   
                                                   VALUE_REMAIN,IDENTIFY_RESULT,REFUND_VALUE,REFUND_DEPOSIT, 
                                                   FEE,REASON_LENGTH,REASON)
		                                       VALUES(:msg_pointer,:APPLY_NO,:APPLY_DATE,:MEASURE_DATE,   
                                                  :VALUE_REMAIN,:IDENTIFY_RESULT,:REFUND_VALUE,:REFUND_DEPOSIT, 
                                                  :FEE,:REASON_LENGTH,:REASON);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_3009(第%d条记录)ErrorCode(TBL_TK_3009_NONRT_RESULT) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_3009_1,sizeof(Trans_3009_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_3009_1),&m_Trans_3009_2,sizeof(Trans_3009_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_3009_1)+sizeof(Trans_3009_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            生成7001参数
            HHJT_CJP 20210323 按指定线路生成文件
--------------------------------------------------------- */
void ORA::create7001file(int lineId)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	int           	ParamRecords;
  char          	SLE_NID[9];
	char            ParamVer[15];
	char            READER1[33];
	char            READER2[33];
  char          	LINE_NID[3];	
  
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead	       		m_MsgHead;
	Trans_7001_1 			m_Trans_7001_1;
	Trans_7001_2   		*m_Trans_7001_2;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	unsigned int 			sessionnum;
	char        			c_PkgID[30];
	BYTE         			b_PkgID;
	char              *stopstring;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[14];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;

	memset(LINE_NID,0x00,sizeof(LINE_NID));
	sprintf(LINE_NID, "%02X",lineId);	
	
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   TBL_MN_7001_DEVICE
	         WHERE SUBSTR(DEVICE_NID,1,2) = :LINE_NID;
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create7001file(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
 
	/* -------- 包体头 ---------- */
	memset(&m_Trans_7001_1,0x00,sizeof(Trans_7001_1));
	m_Trans_7001_1.w_Records 		=  CommonFuncs::wordtowin(ParamRecords);
	/* -------- 获得所有记录 ---------- */
	m_Trans_7001_2 = (Trans_7001_2*)malloc(ParamRecords * sizeof(Trans_7001_2));
	EXEC SQL DECLARE SQL_7001_Record CURSOR FOR SELECT DEVICE_NID,MASTER_PARA_INDEX,CRWA_PROG_INDEX,CRWB_PROG_INDEX
		                                          FROM   TBL_MN_7001_DEVICE
		                                          WHERE SUBSTR(DEVICE_NID,1,2) = :LINE_NID
		                                          ORDER BY DEVICE_NID;                              
	EXEC SQL OPEN SQL_7001_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create7001file(OPEN SQL_7001_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Trans_7001_2);
		m_Trans_7001_2 = NULL;
		return;
	}
	index = 0;
	for(;;)
	{
		memset(SLE_NID,0x00,sizeof(SLE_NID));
		memset(ParamVer,0x00,sizeof(ParamVer));
		memset(READER1,0x00,sizeof(READER1));
		memset(READER2,0x00,sizeof(READER2));
		EXEC SQL FETCH SQL_7001_Record INTO :SLE_NID,:ParamVer,:READER1,:READER2;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create7001param(FETCH SQL_7001_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_7001_Record;
				free(m_Trans_7001_2);
				m_Trans_7001_2 = NULL;
				return;
			}
		}
		/* -- 参数结构赋值 -- */ 
		memset(&m_Trans_7001_2[index],0x00,sizeof(Trans_7001_2 ));
		CommonFuncs::chartobyte(SLE_NID,(char*)m_Trans_7001_2[index].SLE_NID,sizeof(m_Trans_7001_2[index].SLE_NID));
		CommonFuncs::chartobyte(ParamVer,(char*)m_Trans_7001_2[index].ParamVer,sizeof(m_Trans_7001_2[index].ParamVer));
		memcpy(m_Trans_7001_2[index].READER1,READER1,sizeof(m_Trans_7001_2[index].READER1));
		memcpy(m_Trans_7001_2[index].READER2,READER2,sizeof(m_Trans_7001_2[index].READER2));
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_7001_Record;	
	
	bodylen = sizeof(Trans_7001_1)+ParamRecords*sizeof(Trans_7001_2);
	/* -------- 生成包头 ---------- */
	sessionnum = get_session_number();
	b_PkgID = (BYTE)get_pkg_number();
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	CPackage::Create_Pkg_Head(b_PkgID,&m_MsgHead,bodylen,0x7001,sessionnum,CConfig::g_ACCIDCode,c_PkgID);
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Trans_7001_1,sizeof(Trans_7001_1));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Trans_7001_1)+index*sizeof(Trans_7001_2),&m_Trans_7001_2[index],sizeof(Trans_7001_2));
	}
	/* --- 生成文件于发送目录 --- */
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
	
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%s%s_%04X_%s",CConfig::SendFilePath_ACC,LINE_NID,0x7001,c_PkgID);
	CommonFuncs::WriteBufferFile("wb",filename,(char*)filebuf,filelen);
	
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "设备软件版本信息%s生成成功\n",filename);
	CLog::WriteAppLog(oplogmsg);
 
	/* -------- 内存释放 ---------- */
	free(m_Trans_7001_2);
	m_Trans_7001_2 = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;

}

/* ------------------------------------------------------
            生成7002 
            HHJT_CJP 20210323 按指定线路生成文件
--------------------------------------------------------- */
void ORA::create7002file(int lineId)
{
	EXEC SQL BEGIN DECLARE SECTION;
	
	int           	ParamRecords;
	
  char          	LINE_NID[3]; 
  char          	SC_NID[5];
  int           	SLE_TYPE;
	unsigned short  Right_Count;
	unsigned short  Offline_Count;
	unsigned short  Failure_Count;
	char            c_SLE_TYPE[3];
	
	unsigned short  Total_Count;
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead	       		m_MsgHead;
	Trans_7002_1 			m_Trans_7002_1;
	Trans_7002_2   		*m_Trans_7002_2;
	char        			filename[MAX_PATH],*filebuf,*packagebody;
	int         			index;
	unsigned int      bodylen,filelen;
	unsigned int 			sessionnum;
	char        			c_PkgID[30];
	BYTE         			b_PkgID;
	char              *stopstring;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[13];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(LINE_NID,0x00,sizeof(LINE_NID));
	sprintf(LINE_NID,"%02X",lineId);
 
 
	/* -------- 动态分配内存 ---------- */	
	ParamRecords = 0; 
	EXEC SQL SELECT COUNT(*)
	         INTO   :ParamRecords
	         FROM   (SELECT COUNT(*) FROM TBL_PM_0301_DEVICE  
	                 WHERE PARAMETER_NBR IN (SELECT PARAMETER_NBR 
	                                         FROM T_PARAMETER_CTRL 
	                                         WHERE PARAMETER_STATUS = 0 
	                                         AND PARAMETER_TYPE = '0301'
	                                         AND SUBSTR(PARAMETER_CTRL_NID,1,2) = :LINE_NID
	                                         ) 
	                 GROUP BY SUBSTR(DEVICE_NID,1,4),DEVICE_TYPE);
	if(ParamRecords == 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "create7002file(Record = %d)\n",ParamRecords);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	/* -------- 包体头 ---------- */
	memset(&m_Trans_7002_1,0x00,sizeof(Trans_7002_1));
	m_Trans_7002_1.w_Records 		=  CommonFuncs::wordtowin(ParamRecords);
	m_Trans_7002_1.CC_NID = CConfig::g_CCIDCode[0];
	/* -------- 获得所有记录 ---------- */
	m_Trans_7002_2 = (Trans_7002_2*)malloc(ParamRecords * sizeof(Trans_7002_2));
	EXEC SQL DECLARE SQL_7002_Record CURSOR FOR SELECT SUBSTR(DEVICE_NID,1,4),DEVICE_TYPE,COUNT(*)
		                                          FROM   TBL_PM_0301_DEVICE 
																				      WHERE  PARAMETER_NBR IN (SELECT PARAMETER_NBR 
	                                                                     FROM T_PARAMETER_CTRL 
	                                                                     WHERE PARAMETER_STATUS = 0 
	                                                                     AND PARAMETER_TYPE = '0301'
	                                                                     AND SUBSTR(PARAMETER_CTRL_NID,1,2) = :LINE_NID
	                                                                     )  
																				      GROUP BY SUBSTR(DEVICE_NID,1,4),DEVICE_TYPE
																				      ORDER BY SUBSTR(DEVICE_NID,1,4),DEVICE_TYPE;                              
	EXEC SQL OPEN SQL_7002_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"create7002file(OPEN SQL_7002_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		free(m_Trans_7002_2);
		m_Trans_7002_2 = NULL;
		return;
	}
	index = 0;
	for(;;)
	{
		memset(SC_NID,0x00,sizeof(SC_NID));
		EXEC SQL FETCH SQL_7002_Record INTO :SC_NID,:SLE_TYPE,:Total_Count;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"create7002param(FETCH SQL_7002_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_7002_Record;
				free(m_Trans_7002_2);
				m_Trans_7002_2 = NULL;
				return;
			}
		}
		memset(c_SLE_TYPE,0x00,sizeof(c_SLE_TYPE));
		sprintf(c_SLE_TYPE,"%02X",SLE_TYPE);
		/* -- 离线数量 -- */ 
		Offline_Count = 0;
		EXEC SQL SELECT COUNT(*) INTO :Offline_Count 
		         FROM T_MONITOR_FAILURE 
		         WHERE SUBSTR(DEVICE_NID,1,4) = :SC_NID AND SUBSTR(DEVICE_NID,5,2) = :c_SLE_TYPE AND EVENT_LEVEL = 5;
		/* -- 故障数量 -- */ 
		Failure_Count = 0;
		EXEC SQL SELECT COUNT(*) INTO :Failure_Count 
		         FROM T_MONITOR_FAILURE 
		         WHERE SUBSTR(DEVICE_NID,1,4) = :SC_NID AND SUBSTR(DEVICE_NID,5,2) = :c_SLE_TYPE AND EVENT_LEVEL = 3;
		/* -- 参数结构赋值 -- */ 
		memset(&m_Trans_7002_2[index],0x00,sizeof(Trans_7002_2 ));
		CommonFuncs::chartobyte(SC_NID,(char*)m_Trans_7002_2[index].SC_NID,sizeof(m_Trans_7002_2[index].SC_NID));
		m_Trans_7002_2[index].Right_Count   =  CommonFuncs::wordtowin(Total_Count - Offline_Count - Failure_Count);
		m_Trans_7002_2[index].Offline_Count =  CommonFuncs::wordtowin(Offline_Count);
		m_Trans_7002_2[index].Failure_Count =  CommonFuncs::wordtowin(Failure_Count);
		m_Trans_7002_2[index].SLE_TYPE = (BYTE)SLE_TYPE;
			
		index++;	
		if(index >= ParamRecords)
				break;	
	}
	EXEC SQL CLOSE SQL_7002_Record;	
	
	bodylen = sizeof(Trans_7002_1)+ParamRecords*sizeof(Trans_7002_2);

	/* -------- 生成包头 ---------- */
	sessionnum = get_session_number();
	b_PkgID = (BYTE)get_pkg_number();
	memset(&m_MsgHead,0x00,sizeof(MsgHead));
	memset(c_PkgID,0x00,sizeof(c_PkgID));
	CPackage::Create_Pkg_Head(b_PkgID,&m_MsgHead,bodylen,0x7002,sessionnum,CConfig::g_ACCIDCode,c_PkgID);
	
	/* --- 包体 --- */
	packagebody = (char*)malloc(bodylen);
	memset(packagebody,0x00,bodylen);
	memcpy(packagebody,(char*)&m_Trans_7002_1,sizeof(Trans_7002_1));
	for(index=0;index<ParamRecords;index++)
	{
		memcpy(packagebody+sizeof(Trans_7002_1)+index*sizeof(Trans_7002_2),&m_Trans_7002_2[index],sizeof(Trans_7002_2));
	}
	/* --- 生成文件于发送目录 --- */
	filelen = sizeof(MsgHead)+bodylen+LEN_OF_PackageTail; 
	filebuf = (char*)malloc(filelen);
	memset(filebuf,0x00,filelen);
	CPackage::CreatePackage(0,(char*)filebuf,&m_MsgHead,(char*)(packagebody),bodylen);
	memset(filename,0x00,sizeof(filename));
	sprintf(filename,"%s%s_%04X_%s",CConfig::SendFilePath_ACC,LINE_NID,0x7002,c_PkgID);
	CommonFuncs::WriteBufferFile("wb",filename,(char*)filebuf,filelen);
	
	memset(oplogmsg,0x00,sizeof(oplogmsg));
	sprintf(oplogmsg, "设备状态统计信息%s生成成功\n",filename);
	CLog::WriteAppLog(oplogmsg);
	/* -------- 内存释放 ---------- */
	free(m_Trans_7002_2);
	m_Trans_7002_2 = NULL;
	
	free(filebuf);
	filebuf = NULL;
	
	free(packagebody);
	packagebody = NULL;

}

/* ------------------------------------------------------
            获得上一日时间
--------------------------------------------------------- */
void ORA::Get_Last_Day(char *c_date)
{
	EXEC SQL BEGIN DECLARE SECTION;
	char last_day[9];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(last_day,0x00,sizeof(last_day));
	EXEC SQL SELECT TO_CHAR(SYSDATE-1,'YYYYMMDD') INTO :last_day FROM DUAL ;
	if(sqlca.sqlcode == 0)
	{
		strcpy(c_date,last_day);
	}
}

/* ------------------------------------------------------
            获得非即时退卡信息
--------------------------------------------------------- */
int ORA::query_3009_info(char *applyid,Trans_3009_2 *m_Trans_3009_2)
{
	EXEC SQL BEGIN DECLARE SECTION;
	char          	APPLY_NO[25];
	char         		APPLY_DATE[15];
	char         		MEASURE_DATE[15];
	unsigned int    VALUE_REMAIN;
	char            IDENTIFY_RESULT[3];
	unsigned int    REFUND_VALUE;
	unsigned int    REFUND_DEPOSIT;
	unsigned int    FEE;
	unsigned int    REASON_LENGTH;
	char            REASON[1025];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	int rtn;
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	rtn = 1;
	memset(APPLY_NO,0x00,sizeof(APPLY_NO));
	strcpy(APPLY_NO,applyid);
	
	memset(APPLY_DATE,0x00,sizeof(APPLY_DATE));
	memset(MEASURE_DATE,0x00,sizeof(MEASURE_DATE));
	memset(IDENTIFY_RESULT,0x00,sizeof(IDENTIFY_RESULT));
	memset(REASON,0x00,sizeof(REASON));
	EXEC SQL SELECT APPLY_DATE,MEASURE_DATE,VALUE_REMAIN,IDENTIFY_RESULT,
                  REFUND_VALUE,REFUND_DEPOSIT,FEE,REASON_LENGTH,REASON        
             INTO :APPLY_DATE,:MEASURE_DATE,:VALUE_REMAIN,:IDENTIFY_RESULT,
                  :REFUND_VALUE,:REFUND_DEPOSIT,:FEE,:REASON_LENGTH,:REASON
             FROM TBL_TK_3009_NONRT_RESULT 
             WHERE APPLY_NO = :APPLY_NO ;
	if(sqlca.sqlcode != 0)
	{
		rtn = 0;
	}
	else
	{
		CommonFuncs::chartobyte(APPLY_NO,(char*)m_Trans_3009_2->APPLY_NO,sizeof(m_Trans_3009_2->APPLY_NO));
		CommonFuncs::chartobyte(APPLY_DATE,(char*)m_Trans_3009_2->APPLY_DATE,sizeof(m_Trans_3009_2->APPLY_DATE));
		CommonFuncs::chartobyte(MEASURE_DATE,(char*)m_Trans_3009_2->MEASURE_DATE,sizeof(m_Trans_3009_2->MEASURE_DATE));
		m_Trans_3009_2->VALUE_REMAIN = CommonFuncs::dwordtowin(VALUE_REMAIN);
		m_Trans_3009_2->IDENTIFY_RESULT = (BYTE)atoi(IDENTIFY_RESULT);
		m_Trans_3009_2->REFUND_VALUE = CommonFuncs::dwordtowin(REFUND_VALUE);
		m_Trans_3009_2->REFUND_DEPOSIT = CommonFuncs::dwordtowin(REFUND_DEPOSIT);
		m_Trans_3009_2->FEE = CommonFuncs::dwordtowin(FEE);
		m_Trans_3009_2->REASON_LENGTH = CommonFuncs::dwordtowin(REASON_LENGTH);
		memcpy(m_Trans_3009_2->REASON,REASON,sizeof(m_Trans_3009_2->REASON));
	}
	
	return rtn;
}

/* ------------------------------------------------------
            参数生效
--------------------------------------------------------- */
void ORA::Validate_Single_Param(const char *msgtype,const char *c_id)
{  
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  ParamNbr;
	char          ValidTime[15];
	int           gap;
	char          PARAMETER_TYPE[5];
	char          sc_id[9];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	memset(sc_id,0x00,sizeof(sc_id));
	if(c_id != NULL)
		strcpy(sc_id,c_id);
	memset(PARAMETER_TYPE,0x00,sizeof(PARAMETER_TYPE));
	strcpy(PARAMETER_TYPE,msgtype);
	memset(ValidTime,0x00,sizeof(ValidTime));
	if(c_id == NULL)
		EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :PARAMETER_TYPE;
	else
		EXEC SQL SELECT PARAMETER_NBR,TO_CHAR(EFFECTIVE_TIME,'YYYYMMDDHH24MISS')
		                INTO :ParamNbr,:ValidTime
		                FROM T_PARAMETER_CTRL 
		                WHERE PARAMETER_STATUS = 2 AND PARAMETER_TYPE = :PARAMETER_TYPE AND PARAMETER_CTRL_NID = :sc_id;
	if(sqlca.sqlcode != 0)
	{
		return;
	}
	
	gap = 0;
	EXEC SQL SELECT (SYSDATE - TO_DATE(:ValidTime,'YYYYMMDDHH24MISS')) * 86400 INTO :gap FROM DUAL;
	if(gap >=0)
	{
		if(c_id == NULL)
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
				       SET    PARAMETER_STATUS = 1
				       WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = :PARAMETER_TYPE;
			EXEC SQL UPDATE T_PARAMETER_CTRL
				       SET    PARAMETER_STATUS = 0
				       WHERE PARAMETER_NBR = :ParamNbr AND PARAMETER_TYPE = :PARAMETER_TYPE;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s生效\n",msgtype);
			CLog::WriteAppLog(oplogmsg);
		}
		else
		{
			EXEC SQL UPDATE T_PARAMETER_CTRL
				       SET    PARAMETER_STATUS = 1
				       WHERE PARAMETER_STATUS = 0 AND PARAMETER_TYPE = :PARAMETER_TYPE AND PARAMETER_CTRL_NID = :sc_id;
			EXEC SQL UPDATE T_PARAMETER_CTRL
				       SET    PARAMETER_STATUS = 0
				       WHERE PARAMETER_NBR = :ParamNbr AND PARAMETER_TYPE = :PARAMETER_TYPE AND PARAMETER_CTRL_NID = :sc_id;
				       	
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "参数%s(%s)生效\n",msgtype,c_id);
			CLog::WriteAppLog(oplogmsg);
		}
		EXEC SQL COMMIT;
	}
}

/* ------------------------------------------------------
            参数生效
--------------------------------------------------------- */
void ORA::Validate_Group_Param()
{  
	EXEC SQL BEGIN DECLARE SECTION;
	char          PARAMETER_TYPE[5];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
		         	
	/* -------- 获得所有记录 ---------- */
	EXEC SQL DECLARE SQL_PARAMTYPE_Record CURSOR FOR SELECT PARAMETER_TYPE
		                                               FROM   T_PARAMETER_CTRL
		                                               WHERE PARAMETER_TYPE NOT IN ('0301','0302')
		                                               GROUP BY PARAMETER_TYPE
		                                               ORDER BY PARAMETER_TYPE;                                 
	EXEC SQL OPEN SQL_PARAMTYPE_Record;
	if(sqlca.sqlcode != 0)
	{	
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg,"Validate_Group_Param(OPEN SQL_PARAMTYPE_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		return;
	}
	for(;;)
	{
		memset(PARAMETER_TYPE,0x00,sizeof(PARAMETER_TYPE));
		EXEC SQL FETCH SQL_PARAMTYPE_Record INTO :PARAMETER_TYPE;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				memset(oplogmsg,0x00,sizeof(oplogmsg));
				sprintf(oplogmsg,"Validate_Group_Param(FETCH SQL_PARAMTYPE_Record):ErrorCode is %d,ErrorDesc is:%s\n",sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
				CLog::WriteAppLog(oplogmsg);
				EXEC SQL CLOSE SQL_PARAMTYPE_Record;
				return;
			}
		}
		/* -- 参数生效 -- */ 
		Validate_Single_Param(PARAMETER_TYPE,NULL);
	}
	EXEC SQL CLOSE SQL_PARAMTYPE_Record;	
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_F001(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
  char          	DATA_SEQ[21];
  char          	LINE_NID[3];
  char          	STATION_NID[5];
  char          	DEVICE_NID[9];
	char            CHECK_TIME[15]; 
	int             CHECK_AMOUNT;
	int             SPECIAL_REFUND_AMOUNT;
	int             TRANSACTION_AMOUNT;
	char            TRANS_DATE[9];
  char          	BOM_OPERATOR[9];		       
  char          	OPERATOR_ID[9];
	char            MEMO[101];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_F001_1   		m_Trans_F001_1;
	Trans_F001_2 			m_Trans_F001_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 		= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		= CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_F001_1,0x00,sizeof(Trans_F001_1));
	m_Trans_F001_1 = *(Trans_F001_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_F001_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_F001_1) + count * sizeof(Trans_F001_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F001 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F001 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_F001_2,0x00,sizeof(Trans_F001_2));
		m_Trans_F001_2 = *(Trans_F001_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_F001_1)+sizeof(Trans_F001_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(DATA_SEQ,0x00,sizeof(DATA_SEQ));
		memcpy(DATA_SEQ,m_Trans_F001_2.DATA_SEQ,sizeof(m_Trans_F001_2.DATA_SEQ));
		
		memset(LINE_NID,0x00,sizeof(LINE_NID));
		sprintf(LINE_NID,"%02X",m_Trans_F001_2.LINE_NID);			

		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_F001_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_F001_2.STATION_NID[i]);		
				
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_F001_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_F001_2.DEVICE_NID[i]);

		memset(CHECK_TIME,0x00,sizeof(CHECK_TIME));
		for(i = 0;i < sizeof(m_Trans_F001_2.CHECK_TIME);i++)
			sprintf(CHECK_TIME+2*i,"%02X",m_Trans_F001_2.CHECK_TIME[i]);

		CHECK_AMOUNT          = CommonFuncs::ByteToInt(m_Trans_F001_2.CHECK_AMOUNT,sizeof(m_Trans_F001_2.CHECK_AMOUNT));
		SPECIAL_REFUND_AMOUNT = CommonFuncs::ByteToInt(m_Trans_F001_2.SPECIAL_REFUND_AMOUNT,sizeof(m_Trans_F001_2.SPECIAL_REFUND_AMOUNT));
		TRANSACTION_AMOUNT    = CommonFuncs::ByteToInt(m_Trans_F001_2.TRANSACTION_AMOUNT,sizeof(m_Trans_F001_2.TRANSACTION_AMOUNT));
 
		memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
		for(i = 0;i < sizeof(m_Trans_F001_2.TRANS_DATE);i++)
			sprintf(TRANS_DATE+2*i,"%02X",m_Trans_F001_2.TRANS_DATE[i]);

		memset(BOM_OPERATOR,0x00,sizeof(BOM_OPERATOR));
		for(i = 0;i < sizeof(m_Trans_F001_2.BOM_OPERATOR);i++)
			sprintf(BOM_OPERATOR+2*i,"%02X",m_Trans_F001_2.BOM_OPERATOR[i]);
		
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_F001_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_F001_2.OPERATOR_ID[i]);
 
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_F001_2.MEMO,sizeof(m_Trans_F001_2.MEMO));
		
		EXEC SQL INSERT INTO TBL_CH_CASH_CHECK_BOM (DATA_SEQ,LINE_NID,STATION_NID,DEVICE_NID,
																								CHECK_TIME,
																								CHECK_AMOUNT,SPECIAL_REFUND_AMOUNT,TRANSACTION_AMOUNT,
                                                TRANS_DATE,BOM_OPERATOR,OPERATOR_ID,MEMO)
		                                     VALUES(:DATA_SEQ,:LINE_NID,:STATION_NID,:DEVICE_NID,
		                                     				TO_DATE(:CHECK_TIME,'YYYYMMDDHH24MISS'),
		                                     				:CHECK_AMOUNT,:SPECIAL_REFUND_AMOUNT,:TRANSACTION_AMOUNT,
                                                :TRANS_DATE,:BOM_OPERATOR,:OPERATOR_ID,:MEMO);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_F001(第%d条记录)ErrorCode(TBL_CH_CASH_CHECK_BOM) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_F001_1,sizeof(Trans_F001_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_F001_1),&m_Trans_F001_2,sizeof(Trans_F001_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_F001_1)+sizeof(Trans_F001_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_F002(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer,CHECK_NBR;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];
	
	char          	DATA_SEQ[21];
  char          	LINE_NID[3];
  char          	STATION_NID[5];
  char          	DEVICE_NID[9];
	char            CHECK_TIME[15]; 
  char          	CASHBOX_NBR[3];	
	int             CHECK_AMOUNT;
	char            TRANS_DATE[9];
  char          	TVM_OPERATOR[9];		       
  char          	OPERATOR_ID[9];
	char            MEMO[101];
	
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_F002_1   		m_Trans_F002_1;
	Trans_F002_2 			m_Trans_F002_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_F002_1,0x00,sizeof(Trans_F002_1));
	m_Trans_F002_1 = *(Trans_F002_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_F002_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_F002_1) + count * sizeof(Trans_F002_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F002 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F002 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_F002_2,0x00,sizeof(Trans_F002_2));
		m_Trans_F002_2 = *(Trans_F002_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_F002_1)+sizeof(Trans_F002_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(DATA_SEQ,0x00,sizeof(DATA_SEQ));
		memcpy(DATA_SEQ,m_Trans_F002_2.DATA_SEQ,sizeof(m_Trans_F002_2.DATA_SEQ));
		
		memset(LINE_NID,0x00,sizeof(LINE_NID));
		sprintf(LINE_NID,"%02X",m_Trans_F002_2.LINE_NID);			

		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_F002_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_F002_2.STATION_NID[i]);		
				
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_F002_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_F002_2.DEVICE_NID[i]);

		memset(CHECK_TIME,0x00,sizeof(CHECK_TIME));
		for(i = 0;i < sizeof(m_Trans_F002_2.CHECK_TIME);i++)
			sprintf(CHECK_TIME+2*i,"%02X",m_Trans_F002_2.CHECK_TIME[i]);

		memset(CASHBOX_NBR,0x00,sizeof(CASHBOX_NBR));
		sprintf(CASHBOX_NBR,"%02X",m_Trans_F002_2.CASHBOX_NBR);
		CHECK_AMOUNT          = CommonFuncs::ByteToInt(m_Trans_F002_2.CHECK_AMOUNT,sizeof(m_Trans_F002_2.CHECK_AMOUNT));

		memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
		for(i = 0;i < sizeof(m_Trans_F002_2.TRANS_DATE);i++)
			sprintf(TRANS_DATE+2*i,"%02X",m_Trans_F002_2.TRANS_DATE[i]);

		memset(TVM_OPERATOR,0x00,sizeof(TVM_OPERATOR));
		for(i = 0;i < sizeof(m_Trans_F002_2.TVM_OPERATOR);i++)
			sprintf(TVM_OPERATOR+2*i,"%02X",m_Trans_F002_2.TVM_OPERATOR[i]);
		
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_F002_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_F002_2.OPERATOR_ID[i]);
 
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_F002_2.MEMO,sizeof(m_Trans_F002_2.MEMO));
		
		EXEC SQL INSERT INTO TBL_CH_CASH_CHECK_TVM (DATA_SEQ,LINE_NID,STATION_NID,DEVICE_NID,
																								CHECK_TIME,
																								CHECK_AMOUNT,CASHBOX_NBR,
                                                TRANS_DATE,TVM_OPERATOR,OPERATOR_ID,MEMO)
		                                     VALUES(:DATA_SEQ,:LINE_NID,:STATION_NID,:DEVICE_NID,
		                                     				TO_DATE(:CHECK_TIME,'YYYYMMDDHH24MISS'),
		                                     				:CHECK_AMOUNT,:CASHBOX_NBR,
                                                :TRANS_DATE,:TVM_OPERATOR,:OPERATOR_ID,:MEMO);
			
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_F002(第%d条记录)ErrorCode(TBL_CH_CASH_CHECK_TVM) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_F002_1,sizeof(Trans_F002_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_F002_1),&m_Trans_F002_2,sizeof(Trans_F002_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_F002_1)+sizeof(Trans_F002_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_F003(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer,CHECK_NBR;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];

  char          	DATA_SEQ[21];
  char          	LINE_NID[3];
  char          	STATION_NID[5];
  char          	DEVICE_NID[9];
	char            CHECK_TIME[15]; 
	int             CHECK_AMOUNT;
	char            TRANS_DATE[9];	       
  char          	OPERATOR_ID[9];
	char            MEMO[101];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_F003_1   		m_Trans_F003_1;
	Trans_F003_2 			m_Trans_F003_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_F003_1,0x00,sizeof(Trans_F003_1));
	m_Trans_F003_1 = *(Trans_F003_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_F003_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_F003_1) + count * sizeof(Trans_F003_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F003 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F003 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_F003_2,0x00,sizeof(Trans_F003_2));
		m_Trans_F003_2 = *(Trans_F003_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_F003_1)+sizeof(Trans_F003_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(DATA_SEQ,0x00,sizeof(DATA_SEQ));
		memcpy(DATA_SEQ,m_Trans_F003_2.DATA_SEQ,sizeof(m_Trans_F003_2.DATA_SEQ));
		
		memset(LINE_NID,0x00,sizeof(LINE_NID));
		sprintf(LINE_NID,"%02X",m_Trans_F003_2.LINE_NID);		

		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_F003_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_F003_2.STATION_NID[i]);		
				
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_F003_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_F003_2.DEVICE_NID[i]);

		memset(CHECK_TIME,0x00,sizeof(CHECK_TIME));
		for(i = 0;i < sizeof(m_Trans_F003_2.CHECK_TIME);i++)
			sprintf(CHECK_TIME+2*i,"%02X",m_Trans_F003_2.CHECK_TIME[i]);

		CHECK_AMOUNT          = CommonFuncs::ByteToInt(m_Trans_F003_2.CHECK_AMOUNT,sizeof(m_Trans_F003_2.CHECK_AMOUNT));

		memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
		for(i = 0;i < sizeof(m_Trans_F003_2.TRANS_DATE);i++)
			sprintf(TRANS_DATE+2*i,"%02X",m_Trans_F003_2.TRANS_DATE[i]);
		
		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_F003_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_F003_2.OPERATOR_ID[i]);
 
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_F003_2.MEMO,sizeof(m_Trans_F003_2.MEMO));
		
		EXEC SQL INSERT INTO TBL_CH_CASH_MANUAL_CHECK_TVM (DATA_SEQ,LINE_NID,STATION_NID,DEVICE_NID,
																								CHECK_TIME,CHECK_AMOUNT,
                                                TRANS_DATE,OPERATOR_ID,MEMO)
		                                     VALUES(:DATA_SEQ,:LINE_NID,:STATION_NID,:DEVICE_NID,
		                                     				TO_DATE(:CHECK_TIME,'YYYYMMDDHH24MISS'),
		                                     				:CHECK_AMOUNT,
                                                :TRANS_DATE,:OPERATOR_ID,:MEMO);
		
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_F003(第%d条记录)ErrorCode(TBL_CH_CASH_MANUAL_CHECK_TVM) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_F003_1,sizeof(Trans_F003_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_F003_1),&m_Trans_F003_2,sizeof(Trans_F003_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_F003_1)+sizeof(Trans_F003_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_F004(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer,CHECK_NBR;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];

 	char          	DATA_SEQ[21];
  char          	LINE_NID[3];
  char          	STATION_NID[5];
	char            OPERATE_TIME[15]; 
	int             PAYMENT_AMOUNT;
	char            PAYMENT_DATE[9];	       
  char          	OPERATOR_ID[9];
	char            MEMO[101];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_F004_1   		m_Trans_F004_1;
	Trans_F004_2 			m_Trans_F004_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_F004_1,0x00,sizeof(Trans_F004_1));
	m_Trans_F004_1 = *(Trans_F004_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_F004_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_F004_1) + count * sizeof(Trans_F004_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
		
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F004 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F004 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_F004_2,0x00,sizeof(Trans_F004_2));
		m_Trans_F004_2 = *(Trans_F004_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_F004_1)+sizeof(Trans_F004_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(DATA_SEQ,0x00,sizeof(DATA_SEQ));
		memcpy(DATA_SEQ,m_Trans_F004_2.DATA_SEQ,sizeof(m_Trans_F004_2.DATA_SEQ));
		
		memset(LINE_NID,0x00,sizeof(LINE_NID));
		sprintf(LINE_NID,"%02X",m_Trans_F004_2.LINE_NID);		

		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_F004_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_F004_2.STATION_NID[i]);		
	 
		memset(OPERATE_TIME,0x00,sizeof(OPERATE_TIME));
		for(i = 0;i < sizeof(m_Trans_F004_2.OPERATE_TIME);i++)
			sprintf(OPERATE_TIME+2*i,"%02X",m_Trans_F004_2.OPERATE_TIME[i]);

		PAYMENT_AMOUNT          = CommonFuncs::ByteToInt(m_Trans_F004_2.PAYMENT_AMOUNT,sizeof(m_Trans_F004_2.PAYMENT_AMOUNT));
 
		memset(PAYMENT_DATE,0x00,sizeof(PAYMENT_DATE));
		for(i = 0;i < sizeof(m_Trans_F004_2.PAYMENT_DATE);i++)
			sprintf(PAYMENT_DATE+2*i,"%02X",m_Trans_F004_2.PAYMENT_DATE[i]);

		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_F004_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_F004_2.OPERATOR_ID[i]);
 
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_F004_2.MEMO,sizeof(m_Trans_F004_2.MEMO));
 
		EXEC SQL INSERT INTO TBL_CH_CASH_PAYMENT (DATA_SEQ,LINE_NID,STATION_NID,
																							OPERATE_TIME,PAYMENT_AMOUNT,
																							PAYMENT_DATE,OPERATOR_ID,MEMO)
					                             VALUES(:DATA_SEQ,:LINE_NID,:STATION_NID,
																							TO_DATE(:OPERATE_TIME,'YYYYMMDDHH24MISS'),:PAYMENT_AMOUNT,
																							:PAYMENT_DATE,:OPERATOR_ID,:MEMO);
																					 
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_F004(第%d条记录)ErrorCode(TBL_CH_CASH_PAYMENT) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_F004_1,sizeof(Trans_F004_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_F004_1),&m_Trans_F004_2,sizeof(Trans_F004_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_F004_1)+sizeof(Trans_F004_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}


/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_F005(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer,CHECK_NBR;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];

	char          	DATA_SEQ[21];
  char          	LINE_NID[3];
  char          	STATION_NID[5];
  char          	DEVICE_NID[9];  
 	char            INOUT_TIME[15];
  char            CASHBOX_NBR[3]; 	
  int             OPERATE_TYPE;
	int             INOUT_AMOUNT;
	char            TRANS_DATE[9];
  char          	INOUT_OPERATOR[9];
  char          	OPERATOR_ID[9];
	char            MEMO[101];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_F005_1   		m_Trans_F005_1;
	Trans_F005_2 			m_Trans_F005_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_F005_1,0x00,sizeof(Trans_F005_1));
	m_Trans_F005_1 = *(Trans_F005_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_F005_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_F005_1) + count * sizeof(Trans_F005_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F005 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F005 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_F005_2,0x00,sizeof(Trans_F005_2));
		m_Trans_F005_2 = *(Trans_F005_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_F005_1)+sizeof(Trans_F005_2)*j); 

		/* ----- 结构变量赋值 ---*/
		memset(DATA_SEQ,0x00,sizeof(DATA_SEQ));
		memcpy(DATA_SEQ,m_Trans_F005_2.DATA_SEQ,sizeof(m_Trans_F005_2.DATA_SEQ));
		
		memset(LINE_NID,0x00,sizeof(LINE_NID));
		sprintf(LINE_NID,"%02X",m_Trans_F005_2.LINE_NID);		

		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_F005_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_F005_2.STATION_NID[i]);		
				
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_F005_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_F005_2.DEVICE_NID[i]);
		
		memset(INOUT_TIME,0x00,sizeof(INOUT_TIME));
		for(i = 0;i < sizeof(m_Trans_F005_2.INOUT_TIME);i++)
			sprintf(INOUT_TIME+2*i,"%02X",m_Trans_F005_2.INOUT_TIME[i]);		

		memset(CASHBOX_NBR,0x00,sizeof(CASHBOX_NBR));
		sprintf(CASHBOX_NBR,"%02X",m_Trans_F005_2.CASHBOX_NBR);		

		OPERATE_TYPE = (int)m_Trans_F005_2.OPERATE_TYPE;		
		INOUT_AMOUNT = CommonFuncs::ByteToInt(m_Trans_F005_2.INOUT_AMOUNT,sizeof(m_Trans_F005_2.INOUT_AMOUNT));
		
		memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
		for(i = 0;i < sizeof(m_Trans_F005_2.TRANS_DATE);i++)
			sprintf(TRANS_DATE+2*i,"%02X",m_Trans_F005_2.TRANS_DATE[i]);

		memset(INOUT_OPERATOR,0x00,sizeof(INOUT_OPERATOR));
		for(i = 0;i < sizeof(m_Trans_F005_2.INOUT_OPERATOR);i++)
			sprintf(INOUT_OPERATOR+2*i,"%02X",m_Trans_F005_2.INOUT_OPERATOR[i]);

		memset(OPERATOR_ID,0x00,sizeof(OPERATOR_ID));
		for(i = 0;i < sizeof(m_Trans_F005_2.OPERATOR_ID);i++)
			sprintf(OPERATOR_ID+2*i,"%02X",m_Trans_F005_2.OPERATOR_ID[i]);
					
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_F005_2.MEMO,sizeof(m_Trans_F005_2.MEMO));
 
		EXEC SQL INSERT INTO TBL_CH_PETTYCASH_INOUT (DATA_SEQ,LINE_NID,STATION_NID,DEVICE_NID,
		                                          INOUT_TIME,
		                                          CASHBOX_NBR,OPERATE_TYPE,INOUT_AMOUNT,TRANS_DATE,
                                              INOUT_OPERATOR,OPERATOR_ID,MEMO)
					                             VALUES(:DATA_SEQ,:LINE_NID,:STATION_NID,:DEVICE_NID,
		                                          TO_DATE(:INOUT_TIME,'YYYYMMDDHH24MISS'),
		                                          :CASHBOX_NBR,:OPERATE_TYPE,:INOUT_AMOUNT,:TRANS_DATE,
                                              :INOUT_OPERATOR,:OPERATOR_ID,:MEMO);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_F005(第%d条记录)ErrorCode(TBL_CH_PETTYCASH_INOUT) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_F005_1,sizeof(Trans_F005_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_F005_1),&m_Trans_F005_2,sizeof(Trans_F005_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_F005_1)+sizeof(Trans_F005_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}


/* ------------------------------------------------------
            功能描述:   数据报文入库
            返回值说明：>0 正常 -1 数据库异常 -2 入库错误
--------------------------------------------------------- */
int ORA::insert_into_F006(char *name,WORD msgtype,unsigned char* recvbuf,int buflen)
{
	EXEC SQL BEGIN DECLARE SECTION;
	unsigned int  	msg_pointer,CHECK_NBR;
	
	char            filename[256];
	unsigned int		dw_PkgDefault;			/* ---  --- */
	char						b_SourceID[9];			/* ---  --- */
	char						b_DestID[9];			  /* ---  --- */
	unsigned short	w_MsgCode;					/* ---  --- */
	char            c_MsgCode[5];
	unsigned int		dw_PkgID;				  	/* ---  --- */
	char	          b_PkgID[25];				/* ---  --- */
	unsigned int	  dw_PkgLen;					/* ---  --- */
	char						b_IsACK[3];					/* ---  --- */
	char						b_ZipType[3];				/* ---  --- */
	unsigned int		dw_ZipPkgLen;				/* ---  --- */
	char						b_EncryptType[3];		/* ---  --- */
	char						b_EncryptCRC[9];		/* ---  --- */
	char            CRC[9];

	char          	DATA_SEQ[21];
  char          	LINE_NID[3];
  char          	STATION_NID[5];
  char          	DEVICE_NID[9];  
 	char            SE_TIME[15];
  int             SE_TYPE;
	int             SE_AMOUNT; 	
  char          	TRANS_DATE[9];	
  char          	SE_OPERATOR[9];
	char            MEMO[101];
	
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	MsgHead 					m_msghead;
	int           		i,j,count;
	Trans_F006_1   		m_Trans_F006_1;
	Trans_F006_2 			m_Trans_F006_2;
	BYTE          		*p;
	unsigned char     errorbuf[8192];
	int               errorlen;
	
	memset(filename,0x00,sizeof(filename));
	strcpy(filename,name);
	/* ----- 包头 ---*/
	m_msghead = *(MsgHead *)(recvbuf);
	memset(b_SourceID,0x00,sizeof(b_SourceID));
	for(i=0;i<sizeof(m_msghead.b_SourceID);i++)
		sprintf(b_SourceID+2*i,"%02X",m_msghead.b_SourceID[i]);
	memset(b_DestID,0x00,sizeof(b_DestID));
	for(i=0;i<sizeof(m_msghead.b_DestID);i++)
		sprintf(b_DestID+2*i,"%02X",m_msghead.b_DestID[i]);
	memset(b_PkgID,0x00,sizeof(b_PkgID));
	for(i=0;i<sizeof(m_msghead.b_PkgID);i++)
		sprintf(b_PkgID+2*i,"%02X",m_msghead.b_PkgID[i]);
	memset(b_IsACK,0x00,sizeof(b_IsACK));
	sprintf(b_IsACK,"%02X",m_msghead.b_IsACK);
	memset(b_ZipType,0x00,sizeof(b_ZipType));
	sprintf(b_ZipType,"%02X",m_msghead.b_ZipType);
	memset(b_EncryptType,0x00,sizeof(b_EncryptType));
	sprintf(b_EncryptType,"%02X",m_msghead.b_EncryptType);
	memset(b_EncryptCRC,0x00,sizeof(b_EncryptCRC));
	for(i=0;i<sizeof(m_msghead.b_EncryptType);i++)
		sprintf(b_EncryptCRC+2*i,"%02X",m_msghead.b_EncryptCRC[i]);
	dw_PkgDefault = CommonFuncs::dwordtowin(m_msghead.dw_PkgDefault);
	dw_PkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_PkgLen);
	w_MsgCode 		=  CommonFuncs::wordtowin(m_msghead.w_MsgCode);
	dw_PkgID  		= CommonFuncs::dwordtowin(m_msghead.dw_PkgID);	
	dw_ZipPkgLen 	= CommonFuncs::dwordtowin(m_msghead.dw_ZipPkgLen);
	memset(c_MsgCode,0x00,sizeof(c_MsgCode));
	sprintf(c_MsgCode,"%04X",w_MsgCode);
	/* ----- 包固定部分 ---*/
	memset(&m_Trans_F006_1,0x00,sizeof(Trans_F006_1));
	m_Trans_F006_1 = *(Trans_F006_1 *)(recvbuf + sizeof(MsgHead));
	count =  CommonFuncs::wordtowin(m_Trans_F006_1.w_Records);
	/* ----- 包尾 ---*/
	p = recvbuf + sizeof(MsgHead) + sizeof(Trans_F006_1) + count * sizeof(Trans_F006_2);
	memset(CRC,0x00,sizeof(CRC));
	for(i=0;i<4;i++)
		sprintf(CRC+2*i,"%02X",*(p+i));
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR  CONTINUE;
	
	msg_pointer = 0;
	EXEC SQL SELECT SEQ_MSG_POINTER.nextval INTO :msg_pointer FROM DUAL ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F006 ErrorCode(SEQ_MSG_POINTER) is %d, error message is %s\n",filename,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		return -1;
	}
	EXEC SQL INSERT INTO TBL_PM_PKG_HEADER (PACKET_SEQ,FILE_NAME,DEAL_DATE,
	                                        SEND_NID,RECV_NID,MSG_TYPE,MSG_ID,
	                                        MSG_CODE,PACKET_LENGTH,IS_REPLY,
	                                        COMPRESS_TYPE,ORIGIN_LENGTH,ENCRY_TYPE,CRC)
				                           VALUES(:msg_pointer,:filename,SYSDATE,
				                                  :b_SourceID,:b_DestID,:c_MsgCode,:dw_PkgID,
				                                  :b_PkgID,:dw_PkgLen,:b_IsACK,
				                                  :b_ZipType,:dw_ZipPkgLen,:b_EncryptCRC,:CRC);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "%s:insert_into_F006 ErrorCode(TBL_PM_PKG_HEADER) is %d, error message is %s\n",filename,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		/* ----- 写入错误文件---*/
		COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,recvbuf,buflen);
		return msg_pointer;
	}
				
	/* ----- 包体 ---*/
	for(j=0;j<count;j++)
	{
	  memset(&m_Trans_F006_2,0x00,sizeof(Trans_F006_2));
		m_Trans_F006_2 = *(Trans_F006_2 *)(recvbuf+sizeof(MsgHead)+sizeof(Trans_F006_1)+sizeof(Trans_F006_2)*j); 
		/* ----- 结构变量赋值 ---*/
		memset(DATA_SEQ,0x00,sizeof(DATA_SEQ));
		memcpy(DATA_SEQ,m_Trans_F006_2.DATA_SEQ,sizeof(m_Trans_F006_2.DATA_SEQ));
		
		memset(LINE_NID,0x00,sizeof(LINE_NID));
		sprintf(LINE_NID,"%02X",m_Trans_F006_2.LINE_NID);		

		memset(STATION_NID,0x00,sizeof(STATION_NID));
		for(i = 0;i < sizeof(m_Trans_F006_2.STATION_NID);i++)
			sprintf(STATION_NID+2*i,"%02X",m_Trans_F006_2.STATION_NID[i]);		
				
		memset(DEVICE_NID,0x00,sizeof(DEVICE_NID));
		for(i = 0;i < sizeof(m_Trans_F006_2.DEVICE_NID);i++)
			sprintf(DEVICE_NID+2*i,"%02X",m_Trans_F006_2.DEVICE_NID[i]);

		memset(SE_TIME,0x00,sizeof(SE_TIME));
		for(i = 0;i < sizeof(m_Trans_F006_2.SE_TIME);i++)
			sprintf(SE_TIME+2*i,"%02X",m_Trans_F006_2.SE_TIME[i]);

		SE_TYPE   = (int)m_Trans_F006_2.SE_TYPE;
		SE_AMOUNT = CommonFuncs::ByteToInt(m_Trans_F006_2.SE_AMOUNT,sizeof(m_Trans_F006_2.SE_AMOUNT));
		
		memset(TRANS_DATE,0x00,sizeof(TRANS_DATE));
		for(i = 0;i < sizeof(m_Trans_F006_2.TRANS_DATE);i++)
			sprintf(TRANS_DATE+2*i,"%02X",m_Trans_F006_2.TRANS_DATE[i]);

		memset(SE_OPERATOR,0x00,sizeof(SE_OPERATOR));
		for(i = 0;i < sizeof(m_Trans_F006_2.SE_OPERATOR);i++)
			sprintf(SE_OPERATOR+2*i,"%02X",m_Trans_F006_2.SE_OPERATOR[i]);
		
		memset(MEMO,0x00,sizeof(MEMO));
		memcpy(MEMO,m_Trans_F006_2.MEMO,sizeof(m_Trans_F006_2.MEMO));
		
		EXEC SQL INSERT INTO TBL_CH_PETTYCASH_SE (DATA_SEQ,LINE_NID,STATION_NID,DEVICE_NID,
		                                          SE_TIME,SE_TYPE,SE_AMOUNT,
                                              TRANS_DATE,SE_OPERATOR,MEMO)
					                             VALUES(:DATA_SEQ,:LINE_NID,:STATION_NID,:DEVICE_NID,
			                                        TO_DATE(:SE_TIME,'YYYYMMDDHH24MISS'),:SE_TYPE,:SE_AMOUNT,
			                                        :TRANS_DATE,:SE_OPERATOR,:MEMO);
		if(sqlca.sqlcode != 0)
		{
			memset(oplogmsg,0x00,sizeof(oplogmsg));
			sprintf(oplogmsg, "%s:insert_into_F006(第%d条记录)ErrorCode(TBL_CH_PETTYCASH_SE) is %d, error message is %s\n",filename,j,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			CLog::WriteAppLog(oplogmsg);
		
			/* ----- 写入错误文件---*/
			memset(errorbuf,0x00,sizeof(errorbuf));
			memcpy(errorbuf,&m_msghead,sizeof(MsgHead));
			memcpy(errorbuf+sizeof(MsgHead),&m_Trans_F006_1,sizeof(Trans_F006_1));
			memcpy(errorbuf+sizeof(MsgHead)+sizeof(Trans_F006_1),&m_Trans_F006_2,sizeof(Trans_F006_2));
			errorlen = sizeof(MsgHead)+sizeof(Trans_F006_1)+sizeof(Trans_F006_2);
			COtherFuncs::CreateErrorTransfile(CConfig::ErrorPath,errorbuf,errorlen);
		}
	}                        
	
	EXEC SQL COMMIT;
	
	return msg_pointer;
}

 
void ORA::update_operator_passwd(Trans_5011 *m_Trans_5011)
{
	EXEC SQL BEGIN DECLARE SECTION;
	char USER_ID[9];
	int     i_OperateID;
	char USER_PIN[33];
	char MEMO[51];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
 
	memset(USER_ID,0x00,sizeof(USER_ID));
	for(int i = 0;i < sizeof(m_Trans_5011->USER_ID);i++)
		sprintf(USER_ID+2*i,"%02X",m_Trans_5011->USER_ID[i]);
 	
 	i_OperateID = atoi(USER_ID);	
 	
	memset(USER_PIN,0x00,sizeof(USER_PIN));
	for(int i = 0;i < sizeof(m_Trans_5011->USER_PIN);i++)
		sprintf(USER_PIN+2*i,"%02X",m_Trans_5011->USER_PIN[i]);
		
	int intTemp = (int)	m_Trans_5011->UPDATE_FLAG;
	memset(MEMO,0x00,sizeof(MEMO));
	if(intTemp == 0x00)
	{
		strcpy(MEMO,"修改密码");
	}
	else
	{
		strcpy(MEMO,"重置密码");
	}
 
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
 	         
	EXEC SQL UPDATE TBL_PM_0302_USER SET USER_PIN = :USER_PIN WHERE USER_ID = :USER_ID;
		if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "update_operator_passwd(TBL_PM_0302_USER)(USER_ID:%s) ErrorCode is %d, error message is %s\n",USER_ID,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
	}
	
	EXEC SQL UPDATE TBL_SS_USER SET USER_PIN = :USER_PIN , MEMO = :MEMO,UPDATE_TIME = SYSDATE
																WHERE USER_ID = :USER_ID ;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "update_operator_passwd(TBL_SS_USER)(USER_ID:%s) ErrorCode is %d, error message is %s\n",USER_ID,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
	}
																
	EXEC SQL UPDATE T_PARAMETER_CTRL SET UPDATE_FLAG = 1 
             WHERE PARAMETER_NBR IN (SELECT PARAMETER_NBR FROM TBL_PM_0302_USER  
											            WHERE  USER_ID = :USER_ID 
											            AND PARAMETER_NBR IN (SELECT PARAMETER_NBR FROM T_PARAMETER_CTRL
                                  WHERE PARAMETER_TYPE='0302' AND PARAMETER_STATUS = 0));															
																
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "update_operator_passwd(T_PARAMETER_CTRL)(USER_ID:%s) ErrorCode is %d, error message is %s\n",USER_ID,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
	}
	
	EXEC SQL COMMIT;
}


/* ------------------------------------------------------

--------------------------------------------------------*/
void ORA::Insert_Ftp_FileName(Lcc_Ftp_File *m_Lcc_Ftp_File)
{
	EXEC SQL BEGIN DECLARE SECTION;
	char FILE_NAME[64];
	int  FILE_LENGTH;
	int  FILE_RECORDS;
	char BELONGS_FILE_NAME[64];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	memset(FILE_NAME,0x00,sizeof(FILE_NAME));
	memset(BELONGS_FILE_NAME,0x00,sizeof(BELONGS_FILE_NAME));
	strcpy(FILE_NAME,m_Lcc_Ftp_File->FILE_NAME);
	FILE_LENGTH = m_Lcc_Ftp_File->FILE_LENGTH;
	FILE_RECORDS = m_Lcc_Ftp_File->FILE_RECORDS;
	strcpy(BELONGS_FILE_NAME,m_Lcc_Ftp_File->BELONGS_FILE_NAME);

	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[11];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	EXEC SQL INSERT INTO T_PKG_LCC_FTP_TRANS_FILE(FILE_NAME,FILE_LENGTH,FILE_RECORDS,FILE_CREATE_TIME,
	                                              FILE_UPLOAD_FLAG,BELONGS_FILE_NAME)
	                                       VALUES(:FILE_NAME,:FILE_LENGTH,:FILE_RECORDS,SYSDATE,
	                                              0,:BELONGS_FILE_NAME);
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "Insert_Ftp_FileName(%s->%s) ErrorCode is %d, error message is %s\n",FILE_NAME,BELONGS_FILE_NAME,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
	}
	
	EXEC SQL COMMIT;
}

/* ------------------------------------------------------

--------------------------------------------------------*/
void ORA::Update_Ftp_FileName(char *name)
{
	EXEC SQL BEGIN DECLARE SECTION;
	char FILE_NAME[64];
	EXEC SQL END DECLARE SECTION;
	
	char oplogmsg[1024];
	
	memset(FILE_NAME,0x00,sizeof(FILE_NAME));
	strcpy(FILE_NAME,name);
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[12];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	EXEC SQL UPDATE T_PKG_LCC_FTP_TRANS_FILE SET FILE_UPLOAD_FLAG = 1,FILE_UPLOAD_TIME = SYSDATE 
		       WHERE FILE_NAME = :FILE_NAME;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "Update_Ftp_FileName(%s) ErrorCode is %d, error message is %s\n",name,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		CLog::WriteAppLog(oplogmsg);
		
		EXEC SQL ROLLBACK;
	}
	
	EXEC SQL COMMIT;
}


void ORA::updateFlow()
{
	EXEC SQL BEGIN DECLARE SECTION;
	int entryNum,exitNum,saleNum;
	char sccode[9];
	EXEC SQL END DECLARE SECTION;
	int i;
	char  oplogmsg[1024];
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[15];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
  
  for(i=0;i<MAX_SLE_COUNT;i++)
	{
		CConfig::g_ScList[i].EntryFlow = 0;		
		CConfig::g_ScList[i].ExitFlow  = 0;
		CConfig::g_ScList[i].SJTFlow  = 0;
	}
  
	EXEC SQL DECLARE SQL_SC_FLOW CURSOR FOR SELECT STATION_NID,SUM(ENTRY_NUM),SUM(EXIT_NUM),SUM(SALE_NUM)  
	                                                 FROM TBL_BATCH_ENTRY_EXIT_DETAIL
	                                                 WHERE TRANS_DATE =  to_char(SYSDATE,'yyyymmdd')
								                							      GROUP BY STATION_NID
							                                      ORDER BY STATION_NID;
	EXEC SQL OPEN SQL_SC_FLOW;
	if(sqlca.sqlcode != 0)
	{
		memset(oplogmsg,0x00,sizeof(oplogmsg));
		sprintf(oplogmsg, "SQL_SC_FLOW error code is %d\n",sqlca.sqlcode);
		CLog::WriteAppLog(oplogmsg);
 
		return;
	}
	for(;;)
	{
		memset(sccode,0x00,sizeof(sccode));
		EXEC SQL FETCH SQL_SC_FLOW INTO :sccode,:entryNum,:exitNum,:saleNum;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				return;
			}
		}

		for(i=0;i<MAX_SLE_COUNT;i++)
		{
			if(strncmp(CConfig::g_ScList[i].sccode,sccode,4) == 0)
			{
				CConfig::g_ScList[i].EntryFlow = entryNum;		
				CConfig::g_ScList[i].ExitFlow  = exitNum;
				CConfig::g_ScList[i].SJTFlow  = saleNum;
				break;
			}
		}
	}
	EXEC SQL CLOSE SQL_SC_FLOW;

}



/* ------------------------------------------------------
            功能描述:   获得设备的初始状态
--------------------------------------------------------- */
void ORA::GetSleStatus()
{
	EXEC SQL BEGIN DECLARE SECTION;
	char sleid[9];
	int  eventlevel;
	EXEC SQL END DECLARE SECTION;
	BYTE b_sleid[4];

	char	 oplogmsg[1024];
		
	
	struct sqlca sqlca;
	EXEC SQL CONTEXT USE :g_context[0];	
	EXEC SQL WHENEVER NOT FOUND CONTINUE;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	
	EXEC SQL DECLARE SQL_SLESTATUS CURSOR FOR SELECT DEVICE_NID,EVENT_LEVEL
	                                          FROM   T_MONITOR_DEVSTAT 
	                                          WHERE  SUBSTR(DEVICE_NID,5,2) <> '61' 
	                                          ORDER BY DEVICE_NID;
	EXEC SQL OPEN SQL_SLESTATUS;
	if(sqlca.sqlcode != 0)
	{
		return;
	}
	
	for(;;)
	{
		memset(sleid,0x00,sizeof(sleid));
		EXEC SQL FETCH SQL_SLESTATUS INTO :sleid,:eventlevel;
		if(sqlca.sqlcode != 0)
		{
			if(sqlca.sqlcode == 1403)
			{
				break;
			}
			else
			{
				return;
			}
		}
		memset(b_sleid,0x00,sizeof(b_sleid));
		CommonFuncs::chartobyte(sleid,(char*)b_sleid,4);
		
		/*----------更新综合监控信息-----------*/
		ISCS::UpdateDeviceStatus(b_sleid,eventlevel);	
	}	
	EXEC SQL CLOSE SQL_SLESTATUS;
	
	return;
}
