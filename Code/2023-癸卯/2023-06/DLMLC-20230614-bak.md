-- CCDB.TBL_BATCH_TRANS_DEVICE definition

CREATE TABLE "CCDB"."TBL_BATCH_TRANS_DEVICE" 
   (	"SETTLE_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"TRANS_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"LINE_NID" VARCHAR2(2) NOT NULL ENABLE, 
	"STATION_NID" VARCHAR2(4) NOT NULL ENABLE, 
	"DEVICE_NID" VARCHAR2(8) NOT NULL ENABLE, 
	"DEVICE_TYPE" VARCHAR2(2) NOT NULL ENABLE, 
	"TICKET_CATEGORY" VARCHAR2(4) NOT NULL ENABLE, 
	"TICKET_TYPE" VARCHAR2(4) NOT NULL ENABLE, 
	"PAYMENT_METHOD" VARCHAR2(2) NOT NULL ENABLE, 
	"SALE_COUNT" NUMBER(10,0), 
	"SALE_AMOUNT" NUMBER(10,0), 
	"IN_COUNT" NUMBER(10,0), 
	"OUT_COUNT" NUMBER(10,0), 
	"OUT_AMOUNT" NUMBER(10,0), 
	"LOAD_COUNT" NUMBER(10,0), 
	"LOAD_AMOUNT" NUMBER(10,0), 
	"LOAD_OFFSET_COUNT" NUMBER(10,0), 
	"LOAD_OFFSET_AMOUNT" NUMBER(10,0), 
	"UPDATE_COUNT" NUMBER(10,0), 
	"UPDATE_AMOUNT" NUMBER(10,0), 
	"CARD_UPDATE_COUNT" NUMBER(10,0), 
	"CARD_UPDATE_AMOUNT" NUMBER(10,0), 
	"REFUND_COUNT" NUMBER(10,0), 
	"REFUND_AMOUNT" NUMBER(10,0), 
	"DEPOSIT" NUMBER(10,0), 
	"TRANS_FEE" NUMBER(10,0), 
	"CARD_PAY_COUNT" NUMBER(10,0) DEFAULT 0, 
	"CARD_PAY_AMOUNT" NUMBER(10,0) DEFAULT 0, 
	 CONSTRAINT "PK_BATCH_TRANS_DEVICE" PRIMARY KEY ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "DEVICE_NID", "DEVICE_TYPE", "PAYMENT_METHOD")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBACCOUNT" ;

CREATE UNIQUE INDEX "CCDB"."PK_BATCH_TRANS_DEVICE" ON "CCDB"."TBL_BATCH_TRANS_DEVICE" ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "DEVICE_NID", "DEVICE_TYPE", "PAYMENT_METHOD") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS" ;


  -- CCDB.TBL_BATCH_TRANS_OPERATOR definition

CREATE TABLE "CCDB"."TBL_BATCH_TRANS_OPERATOR" 
   (	"SETTLE_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"TRANS_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"OPERATOR_ID" VARCHAR2(8) NOT NULL ENABLE, 
	"LINE_NID" VARCHAR2(2) NOT NULL ENABLE, 
	"STATION_NID" VARCHAR2(4) NOT NULL ENABLE, 
	"TICKET_CATEGORY" VARCHAR2(4) NOT NULL ENABLE, 
	"TICKET_TYPE" VARCHAR2(4) NOT NULL ENABLE, 
	"PAYMENT_METHOD" VARCHAR2(2) NOT NULL ENABLE, 
	"SALE_COUNT" NUMBER(10,0), 
	"SALE_AMOUNT" NUMBER(10,0), 
	"IN_COUNT" NUMBER(10,0), 
	"OUT_COUNT" NUMBER(10,0), 
	"OUT_AMOUNT" NUMBER(10,0), 
	"LOAD_COUNT" NUMBER(10,0), 
	"LOAD_AMOUNT" NUMBER(10,0), 
	"LOAD_OFFSET_COUNT" NUMBER(10,0), 
	"LOAD_OFFSET_AMOUNT" NUMBER(10,0), 
	"UPDATE_COUNT" NUMBER(10,0), 
	"UPDATE_AMOUNT" NUMBER(10,0), 
	"CARD_UPDATE_COUNT" NUMBER(10,0), 
	"CARD_UPDATE_AMOUNT" NUMBER(10,0), 
	"REFUND_COUNT" NUMBER(10,0), 
	"REFUND_AMOUNT" NUMBER(10,0), 
	"DEPOSIT" NUMBER(10,0), 
	"TRANS_FEE" NUMBER(10,0), 
	"CARD_PAY_COUNT" NUMBER(10,0) DEFAULT 0, 
	"CARD_PAY_AMOUNT" NUMBER(10,0) DEFAULT 0, 
	 CONSTRAINT "PK_BATCH_TRANS_OPERATOR" PRIMARY KEY ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "OPERATOR_ID", "PAYMENT_METHOD")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBACCOUNT" ;

CREATE UNIQUE INDEX "CCDB"."PK_BATCH_TRANS_OPERATOR" ON "CCDB"."TBL_BATCH_TRANS_OPERATOR" ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "OPERATOR_ID", "PAYMENT_METHOD") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS" ;


-- CCDB.TBL_BATCH_TRANS_SETTLE_TRANS definition

CREATE TABLE "CCDB"."TBL_BATCH_TRANS_SETTLE_TRANS" 
   (	"SETTLE_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"TRANS_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"OPERATOR_ID" VARCHAR2(8) NOT NULL ENABLE, 
	"LINE_NID" VARCHAR2(2) NOT NULL ENABLE, 
	"STATION_NID" VARCHAR2(4) NOT NULL ENABLE, 
	"DEVICE_NID" VARCHAR2(8) NOT NULL ENABLE, 
	"DEVICE_TYPE" VARCHAR2(2) NOT NULL ENABLE, 
	"TICKET_CATEGORY" VARCHAR2(4) NOT NULL ENABLE, 
	"TICKET_TYPE" VARCHAR2(4) NOT NULL ENABLE, 
	"PAYMENT_METHOD" VARCHAR2(2) NOT NULL ENABLE, 
	"SALE_COUNT" NUMBER(10,0), 
	"SALE_AMOUNT" NUMBER(10,0), 
	"IN_COUNT" NUMBER(10,0), 
	"OUT_COUNT" NUMBER(10,0), 
	"OUT_AMOUNT" NUMBER(10,0), 
	"LOAD_COUNT" NUMBER(10,0), 
	"LOAD_AMOUNT" NUMBER(10,0), 
	"LOAD_OFFSET_COUNT" NUMBER(10,0), 
	"LOAD_OFFSET_AMOUNT" NUMBER(10,0), 
	"UPDATE_COUNT" NUMBER(10,0), 
	"UPDATE_AMOUNT" NUMBER(10,0), 
	"CARD_UPDATE_COUNT" NUMBER(10,0), 
	"CARD_UPDATE_AMOUNT" NUMBER(10,0), 
	"REFUND_COUNT" NUMBER(10,0), 
	"REFUND_AMOUNT" NUMBER(10,0), 
	"DEPOSIT" NUMBER(10,0), 
	"TRANS_FEE" NUMBER(10,0), 
	"CARD_PAY_COUNT" NUMBER(10,0) DEFAULT 0, 
	"CARD_PAY_AMOUNT" NUMBER(10,0) DEFAULT 0, 
	 CONSTRAINT "PK_BATCH_TRANS_SETTLE_TRANS" PRIMARY KEY ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "OPERATOR_ID", "DEVICE_NID", "DEVICE_TYPE", "PAYMENT_METHOD")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBACCOUNT" ;

CREATE UNIQUE INDEX "CCDB"."PK_BATCH_TRANS_SETTLE_TRANS" ON "CCDB"."TBL_BATCH_TRANS_SETTLE_TRANS" ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "OPERATOR_ID", "DEVICE_NID", "DEVICE_TYPE", "PAYMENT_METHOD") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS" ;

-- CCDB.TBL_BATCH_TRANS_SETTLE_HIS definition

CREATE TABLE "CCDB"."TBL_BATCH_TRANS_SETTLE_HIS" 
   (	"SETTLE_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"TRANS_DATE" VARCHAR2(8) NOT NULL ENABLE, 
	"OPERATOR_ID" VARCHAR2(8) NOT NULL ENABLE, 
	"LINE_NID" VARCHAR2(2), 
	"STATION_NID" VARCHAR2(4) NOT NULL ENABLE, 
	"DEVICE_NID" VARCHAR2(8) NOT NULL ENABLE, 
	"DEVICE_TYPE" VARCHAR2(2) NOT NULL ENABLE, 
	"TICKET_CATEGORY" VARCHAR2(4) NOT NULL ENABLE, 
	"TICKET_TYPE" VARCHAR2(4) NOT NULL ENABLE, 
	"PAYMENT_METHOD" VARCHAR2(2) NOT NULL ENABLE, 
	"SALE_COUNT" NUMBER(10,0), 
	"SALE_AMOUNT" NUMBER(10,0), 
	"IN_COUNT" NUMBER(10,0), 
	"OUT_COUNT" NUMBER(10,0), 
	"OUT_AMOUNT" NUMBER(10,0), 
	"LOAD_COUNT" NUMBER(10,0), 
	"LOAD_AMOUNT" NUMBER(10,0), 
	"LOAD_OFFSET_COUNT" NUMBER(10,0), 
	"LOAD_OFFSET_AMOUNT" NUMBER(10,0), 
	"UPDATE_COUNT" NUMBER(10,0), 
	"UPDATE_AMOUNT" NUMBER(10,0), 
	"CARD_UPDATE_COUNT" NUMBER(10,0), 
	"CARD_UPDATE_AMOUNT" NUMBER(10,0), 
	"REFUND_COUNT" NUMBER(10,0), 
	"REFUND_AMOUNT" NUMBER(10,0), 
	"DEPOSIT" NUMBER(10,0), 
	"TRANS_FEE" NUMBER(10,0), 
	"CARD_PAY_COUNT" NUMBER(10,0) DEFAULT 0, 
	"CARD_PAY_AMOUNT" NUMBER(10,0) DEFAULT 0, 
	 CONSTRAINT "PK_BATCH_TRANS_SETTLE_HIS" PRIMARY KEY ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "OPERATOR_ID", "DEVICE_NID", "DEVICE_TYPE", "PAYMENT_METHOD")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBACCOUNT" ;

CREATE UNIQUE INDEX "CCDB"."PK_BATCH_TRANS_SETTLE_HIS" ON "CCDB"."TBL_BATCH_TRANS_SETTLE_HIS" ("TRANS_DATE", "SETTLE_DATE", "LINE_NID", "STATION_NID", "TICKET_CATEGORY", "TICKET_TYPE", "OPERATOR_ID", "DEVICE_NID", "DEVICE_TYPE", "PAYMENT_METHOD") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSDCCDBTRANS" ;



# 2.存储过程
CCDB_BATCH
```sql
CREATE OR REPLACE PACKAGE CCDB.CCDB_BATCH IS

  /******************************************************
   Name(名称): CCDB_BATCH
   Purpose(功能说明): 日结应用

   修订记录
   版本      编辑时间       编辑人       编辑内容
   1.0.0     20210330       HHJT_CJP     1.创建包
  *******************************************************/

  -- Name   : PROC_ENTRY_EXIT_STAT
  -- Purpose: 进、出站客流统计
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_ENTRY_EXIT_STAT(batch_date IN VARCHAR2);

  -- Name   : PROC_SJT_DEVICE_TRACK
  -- Purpose: 单程票票卡跟踪
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_SJT_DEVICE_TRACK(batch_date IN VARCHAR2);

  -- Name   : PROC_SVT_DEVICE_TRACK
  -- Purpose: 储值票票卡跟踪
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_SVT_DEVICE_TRACK(batch_date IN VARCHAR2);

  -- Name   : PROC_PERL_DEVICE_TRACK
  -- Purpose: 明珠卡票卡跟踪
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_PERL_DEVICE_TRACK(batch_date IN VARCHAR2);

  -- Name   : PROC_PBOC_DEVICE_TRACK
  -- Purpose: 金融IC卡票卡跟踪
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_PBOC_DEVICE_TRACK(batch_date IN VARCHAR2);

  -- Name   : PROC_QR_DEVICE_TRACK
  -- Purpose: 二维码票卡跟踪
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_QR_DEVICE_TRACK(batch_date IN VARCHAR2);

  -- Name   : PROC_SJT_FLOW_STAT
  -- Purpose: 单程票售票出站跟踪
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_SJT_FLOW_STAT(batch_date IN VARCHAR2);

  -- Name   : PROC_CARD_LOCK
  -- Purpose: 黑名单锁卡
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_CARD_LOCK(batch_date IN VARCHAR2);

  -- Name   : PROC_CLEAR_DATA
  -- Purpose: 清理数据
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_CLEAR_DATA(batch_date IN VARCHAR2);

  -- Name   : PROC_ERROR_SETTLE
  -- Purpose: 故障退款统计
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_ERROR_SETTLE(batch_date IN VARCHAR2);

  -- Name   : PROC_TRANS_SETTLE
  -- Purpose: 票卡汇总
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_TRANS_SETTLE(batch_date IN VARCHAR2);

  -- Name   : PROC_TRANS_SETTLE_STAT
  -- Purpose: 票卡统计
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_TRANS_SETTLE_STAT(batch_date IN VARCHAR2);

  -- Name   : PROC_REPORT_INALL
  -- Purpose: 汇总统计
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_REPORT_INALL(batch_date IN VARCHAR2);

  -- Name   : PROC_CASH_BATCH
  -- Purpose: 现金管理日结统计
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_CASH_BATCH(batch_date IN VARCHAR2);

  -- Name   : PROC_ST_INVENTORY_BACKUP
  -- Purpose: 每日库存备份
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_ST_INVENTORY_BACKUP(batch_date IN VARCHAR2);

  -- Name   : PROC_ST_INVENTORY
  -- Purpose: 库存台账统计
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_ST_INVENTORY(batch_date IN VARCHAR2);

  -- Name   : PROC_CH_DIFF
  -- Purpose: 长短款统计
  -- INPUT  : batch_date  运营日
  PROCEDURE PROC_CH_DIFF(batch_date IN VARCHAR2);

END CCDB_BATCH;



CREATE OR REPLACE PACKAGE BODY CCDB.CCDB_BATCH IS

  -------------------------------------------
  --           PACKAGE IMPLEMENT          --
  -------------------------------------------
  --------------------------------------------------------
  --  进、出站客流统计                                  --
  --------------------------------------------------------
  PROCEDURE PROC_ENTRY_EXIT_STAT(batch_date IN VARCHAR2) IS
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time := SYSDATE;
    batch_name := proc_version||'CCDB_BATCH.PROC_ENTRY_EXIT_STAT';
    rid        := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_batch_entry_exit_stat WHERE settle_date = batch_date;
    COMMIT;

    -- 进出站分时客流统计表
    INSERT INTO tbl_batch_entry_exit_stat
      (trans_date, settle_date, slot_id, line_nid,station_nid, ticket_category, ticket_type,
       device_nid, device_type, entry_num, exit_num)
      SELECT trans_date, settle_date, slot_id, line_nid,station_nid, ticket_category,
             ticket_type, device_nid, substr(device_nid, 5, 2), SUM(entry_num),
             SUM(exit_num)
        FROM tbl_batch_entry_exit_detail
       WHERE settle_date = batch_date
       GROUP BY trans_date, settle_date, slot_id,line_nid, station_nid, ticket_category,
                ticket_type, device_nid;

    -- 进出站分时客流统计表_历史表
    INSERT INTO tbl_batch_entry_exit_stat_his
      (trans_date, settle_date, slot_id, line_nid,station_nid, ticket_category, ticket_type,
       device_nid, device_type, entry_num, exit_num)
      SELECT trans_date, settle_date, slot_id, line_nid,station_nid, ticket_category,
             ticket_type, device_nid, substr(device_nid, 5, 2), SUM(entry_num),
             SUM(exit_num)
        FROM tbl_batch_entry_exit_detail
       WHERE settle_date = batch_date
       GROUP BY trans_date, settle_date, slot_id,line_nid, station_nid, ticket_category,
                ticket_type, device_nid;

    end_time     := SYSDATE;
    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_ENTRY_EXIT_STAT',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  单程票票卡跟踪                                    --
  --------------------------------------------------------
  PROCEDURE PROC_SJT_DEVICE_TRACK(batch_date IN VARCHAR2) IS
    --跳转-03
    CURSOR sjt_device_data IS
      SELECT device_nid, MIN(device_trace_nbr) min_value,
             MAX(device_trace_nbr) max_value, COUNT(*) record_num
        FROM (SELECT device_nid, device_trace_nbr
                 FROM tbl_trans_1001_sjt_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_SJT
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid
      HAVING MAX(device_trace_nbr) - MIN(device_trace_nbr) + 1 > COUNT(*) + CCDB_STD.C_REC_MAX_NUM;

    --缺失-01
    CURSOR sjt_mis_device_data IS
      SELECT dr.device_nid, MIN(dr.device_trace_nbr) min_val,
             MAX(dr.device_trace_nbr) max_val
        FROM (SELECT orig.*, orig.device_trace_nbr - ROWNUM d, ROWNUM r
                 FROM (SELECT DISTINCT device_nid, device_trace_nbr
                          FROM (SELECT DISTINCT device_nid, device_trace_nbr
                                   FROM tbl_trans_1001_sjt_temp t
                                  WHERE t.trans_time >=
                                        to_date(batch_date, 'yyyyMMdd') +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                    AND t.trans_time <=
                                        to_date(batch_date, 'yyyyMMdd') + 1 +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                 UNION ALL
                                 SELECT device_nid, device_trace_max
                                   FROM tbl_tk_track_device_max
                                  WHERE ticket_category = CCDB_STD.C_TC_SJT
                                    AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1)
                                  ORDER BY device_nid, device_trace_nbr)
                         ORDER BY device_nid, device_trace_nbr) orig) dr
       GROUP BY dr.device_nid, dr.d
       ORDER BY device_nid, MIN(dr.device_trace_nbr);

    --重复-02
    CURSOR sjt_rep_device_data IS
      SELECT device_nid, device_trace_nbr
        FROM (SELECT device_nid, device_trace_nbr
                 FROM tbl_trans_1001_sjt_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_SJT
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid, device_trace_nbr
      HAVING COUNT(*) > 1;
    --local variable
    record_num               NUMBER;
    jump_num                 NUMBER;
    device_trace_no          NUMBER;
    device_trace_no_min_temp NUMBER;
    device_trace_no_max_temp NUMBER;
    device_trace_no_flag     NUMBER;
    v_device_nid             CHAR(8);
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
  BEGIN
    start_time := SYSDATE;
    batch_name := 'CCDB_BATCH.PROC_SJT_DEVICE_TRACK';
    rid        := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_tk_track_device
     WHERE trans_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_SJT;

    --跳转-03
    FOR record_device_data IN sjt_device_data
    LOOP
      --最大值最小值之差大于个数，且过大（差值大于1000）
      --设备重新设置nbr流水号
      --处理，插入设备流水号更新记录表
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_SJT, record_device_data.min_value, record_device_data.max_value,
         '03');
    END LOOP;

    --缺失-01
    FOR record_device_data IN sjt_mis_device_data
    LOOP
      SELECT COUNT(*)
        INTO jump_num
        FROM tbl_tk_track_device
       WHERE settle_date = batch_date
         AND trans_date = batch_date
         AND device_nid = record_device_data.device_nid
         AND ticket_category = CCDB_STD.C_TC_SJT
         AND ERROR_CODE = '03'
         AND rownum = 1;
      IF jump_num = 0 THEN
        IF v_device_nid = record_device_data.device_nid THEN
          device_trace_no_max_temp := record_device_data.min_val - 1;
          INSERT INTO tbl_tk_track_device
            (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
             ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
          VALUES
            (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
             substr(record_device_data.device_nid, 1, 4),
             substr(record_device_data.device_nid, 5, 2),
             record_device_data.device_nid, CCDB_STD.C_TC_SJT,
             device_trace_no_min_temp, device_trace_no_max_temp, '01');
          device_trace_no_min_temp := record_device_data.max_val + 1;
        ELSE
          v_device_nid             := record_device_data.device_nid;
          device_trace_no_min_temp := record_device_data.max_val + 1;
        END IF;
      END IF;
    END LOOP;

    --重复-02
    FOR record_device_data IN sjt_rep_device_data
    LOOP
      device_trace_no := record_device_data.device_trace_nbr;
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_SJT, device_trace_no, device_trace_no, '02');
    END LOOP;

    --更新tbl_tk_track_device_max
    DELETE FROM tbl_tk_track_device_max
     WHERE settle_date = batch_date
       AND ticket_category = ccdb_std.C_TC_SJT;
    INSERT INTO tbl_tk_track_device_max
      (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
       ticket_category)
      SELECT batch_date, line_id, station_nid, device_type, device_nid,
             device_trace_max, ticket_category
        FROM tbl_tk_track_device_max
       WHERE settle_date = ccdb_lib.F_SYS_CDATE(batch_date, -1)
         AND ticket_category = ccdb_std.C_TC_SJT;

    MERGE INTO tbl_tk_track_device_max tk
    USING (SELECT line_id, station_nid, device_type, device_nid,
                  device_trace_nbr max_value
             FROM (SELECT line_id, station_nid, device_type, device_nid,
                           device_trace_nbr,
                           row_number() OVER(PARTITION BY line_id, station_nid, device_type, device_nid ORDER BY trans_time DESC, device_trace_nbr DESC) rn
                      FROM tbl_trans_1001_sjt_temp
                     WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                           TO_DATE(batch_date, 'yyyymmdd') + 1 +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60))
            WHERE rn = 1) trans
    ON (tk.line_id = trans.line_id AND tk.station_nid = trans.station_nid AND tk.device_type = trans.device_type AND tk.device_nid = trans.device_nid AND ticket_category = CCDB_STD.C_TC_SJT AND tk.settle_date = batch_date)
    WHEN MATCHED THEN
      UPDATE SET device_trace_max = trans.max_value
    WHEN NOT MATCHED THEN
      INSERT
        (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
         ticket_category)
      VALUES
        (batch_date, trans.line_id, trans.station_nid, trans.device_type,
         trans.device_nid, max_value, CCDB_STD.C_TC_SJT);

    end_time     := SYSDATE;
    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_SJT_DEVICE_TRACK',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  储值票票卡跟踪                                    --
  --------------------------------------------------------
  PROCEDURE PROC_SVT_DEVICE_TRACK(batch_date IN VARCHAR2) IS
    --跳转-03
    CURSOR svt_device_data IS
      SELECT device_nid, MIN(device_trace_nbr) min_value,
             MAX(device_trace_nbr) max_value, COUNT(*) record_num
        FROM (SELECT device_nid, device_trace_nbr
                 FROM tbl_trans_1002_svt_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_SVT
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid
      HAVING MAX(device_trace_nbr) - MIN(device_trace_nbr) + 1 > COUNT(*) + CCDB_STD.C_REC_MAX_NUM;

    --缺失-01
    CURSOR svt_mis_device_data IS
      SELECT dr.device_nid, MIN(dr.device_trace_nbr) min_val,
             MAX(dr.device_trace_nbr) max_val
        FROM (SELECT orig.*, orig.device_trace_nbr - ROWNUM d, ROWNUM r
                 FROM (SELECT DISTINCT device_nid, device_trace_nbr
                          FROM (SELECT DISTINCT device_nid, device_trace_nbr
                                   FROM tbl_trans_1002_svt_temp t
                                  WHERE t.trans_time >=
                                        to_date(batch_date, 'yyyyMMdd') +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                    AND t.trans_time <=
                                        to_date(batch_date, 'yyyyMMdd') + 1 +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                 UNION ALL
                                 SELECT device_nid, device_trace_max
                                   FROM tbl_tk_track_device_max
                                  WHERE ticket_category = CCDB_STD.C_TC_SVT
                                    AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1)
                                  ORDER BY device_nid, device_trace_nbr)
                         ORDER BY device_nid, device_trace_nbr) orig) dr
       GROUP BY dr.device_nid, dr.d
       ORDER BY device_nid, MIN(dr.device_trace_nbr);

    --重复-02
    CURSOR svt_rep_device_data IS
      SELECT device_nid, device_trace_nbr
        FROM (SELECT device_nid, device_trace_nbr
                 FROM tbl_trans_1002_svt_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_SVT
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid, device_trace_nbr
      HAVING COUNT(*) > 1;
    --local variable
    record_num               NUMBER;
    jump_num                 NUMBER;
    device_trace_no          NUMBER;
    device_trace_no_min_temp NUMBER;
    device_trace_no_max_temp NUMBER;
    device_trace_no_flag     NUMBER;
    v_device_nid             CHAR(8);
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
  BEGIN
    start_time := SYSDATE;
    batch_name := 'CCDB_BATCH.PROC_SVT_DEVICE_TRACK';
    rid        := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_tk_track_device
     WHERE trans_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_SVT;

    --跳转-03
    FOR record_device_data IN svt_device_data
    LOOP
      --最大值最小值之差大于个数，且过大（差值大于1000）
      --设备重新设置nbr流水号
      --处理，插入设备流水号更新记录表
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 3, 2),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_SVT, record_device_data.min_value, record_device_data.max_value,
         '03');
    END LOOP;

    --缺失-01
    FOR record_device_data IN svt_mis_device_data
    LOOP
      SELECT COUNT(*)
        INTO jump_num
        FROM tbl_tk_track_device
       WHERE settle_date = batch_date
         AND trans_date = batch_date
         AND device_nid = record_device_data.device_nid
         AND ticket_category = CCDB_STD.C_TC_SVT
         AND ERROR_CODE = '03'
         AND rownum = 1;
      IF jump_num = 0 THEN
        IF v_device_nid = record_device_data.device_nid THEN
          device_trace_no_max_temp := record_device_data.min_val - 1;
          INSERT INTO tbl_tk_track_device
            (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
             ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
          VALUES
            (batch_date, batch_date, substr(record_device_data.device_nid, 1, 2),
             substr(record_device_data.device_nid, 1, 4),
             substr(record_device_data.device_nid, 5, 2),
             record_device_data.device_nid, CCDB_STD.C_TC_SVT,
             device_trace_no_min_temp, device_trace_no_max_temp, '01');
          device_trace_no_min_temp := record_device_data.max_val + 1;
        ELSE
          v_device_nid             := record_device_data.device_nid;
          device_trace_no_min_temp := record_device_data.max_val + 1;
        END IF;
      END IF;
    END LOOP;

    --重复-02
    FOR record_device_data IN svt_rep_device_data
    LOOP
      device_trace_no := record_device_data.device_trace_nbr;
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_SVT, device_trace_no, device_trace_no, '02');
    END LOOP;

    --更新tbl_tk_track_device_max
    DELETE FROM tbl_tk_track_device_max
     WHERE settle_date = batch_date
       AND ticket_category = ccdb_std.C_TC_SVT;
    INSERT INTO tbl_tk_track_device_max
      (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
       ticket_category)
      SELECT batch_date, line_id, station_nid, device_type, device_nid,
             device_trace_max, ticket_category
        FROM tbl_tk_track_device_max
       WHERE settle_date = ccdb_lib.F_SYS_CDATE(batch_date, -1)
         AND ticket_category = ccdb_std.C_TC_SVT;

    MERGE INTO tbl_tk_track_device_max tk
    USING (SELECT line_id, station_nid, device_type, device_nid,
                  device_trace_nbr max_value
             FROM (SELECT line_id, station_nid, device_type, device_nid,
                           device_trace_nbr,
                           row_number() OVER(PARTITION BY line_id, station_nid, device_type, device_nid ORDER BY trans_time DESC, device_trace_nbr DESC) rn
                      FROM tbl_trans_1002_svt_temp
                     WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                           TO_DATE(batch_date, 'yyyymmdd') + 1 +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60))
            WHERE rn = 1) trans
    ON (tk.line_id = trans.line_id AND tk.station_nid = trans.station_nid AND tk.device_type = trans.device_type AND tk.device_nid = trans.device_nid AND ticket_category = CCDB_STD.C_TC_SVT AND tk.settle_date = batch_date)
    WHEN MATCHED THEN
      UPDATE SET device_trace_max = trans.max_value
    WHEN NOT MATCHED THEN
      INSERT
        (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
         ticket_category)
      VALUES
        (batch_date, trans.line_id, trans.station_nid, trans.device_type,
         trans.device_nid, max_value, CCDB_STD.C_TC_SVT);

    end_time     := SYSDATE;
    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_SVT_DEVICE_TRACK',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  明珠卡票卡跟踪                                    --
  --------------------------------------------------------
  PROCEDURE PROC_PERL_DEVICE_TRACK(batch_date IN VARCHAR2) IS
    --跳转-03
    CURSOR perl_device_data IS
      SELECT device_nid, MIN(device_trace_nbr) min_value,
             MAX(device_trace_nbr) max_value, COUNT(*) record_num
        FROM (SELECT device_nid, device_trace_nbr
                 FROM tbl_trans_1003_perl_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_PERL
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid
      HAVING MAX(device_trace_nbr) - MIN(device_trace_nbr) + 1 > COUNT(*) + CCDB_STD.C_REC_MAX_NUM;

    --缺失-01
    CURSOR perl_mis_device_data IS
      SELECT dr.device_nid, MIN(dr.device_trace_nbr) min_val,
             MAX(dr.device_trace_nbr) max_val
        FROM (SELECT orig.*, orig.device_trace_nbr - ROWNUM d, ROWNUM r
                 FROM (SELECT DISTINCT device_nid, device_trace_nbr
                          FROM (SELECT DISTINCT device_nid, device_trace_nbr
                                   FROM tbl_trans_1003_perl_temp t
                                  WHERE t.trans_time >=
                                        to_date(batch_date, 'yyyyMMdd') +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                    AND t.trans_time <=
                                        to_date(batch_date, 'yyyyMMdd') + 1 +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                 UNION ALL
                                 SELECT device_nid, device_trace_max
                                   FROM tbl_tk_track_device_max
                                  WHERE ticket_category = CCDB_STD.C_TC_PERL
                                    AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1)
                                  ORDER BY device_nid, device_trace_nbr)
                         ORDER BY device_nid, device_trace_nbr) orig) dr
       GROUP BY dr.device_nid, dr.d
       ORDER BY device_nid, MIN(dr.device_trace_nbr);

    --重复-02
    CURSOR perl_rep_device_data IS
      SELECT device_nid, device_trace_nbr
        FROM (SELECT device_nid, device_trace_nbr
                 FROM tbl_trans_1003_perl_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_PERL
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid, device_trace_nbr
      HAVING COUNT(*) > 1;
    --local variable
    record_num               NUMBER;
    jump_num                 NUMBER;
    device_trace_no          NUMBER;
    device_trace_no_min_temp NUMBER;
    device_trace_no_max_temp NUMBER;
    device_trace_no_flag     NUMBER;
    v_device_nid             CHAR(8);
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
  BEGIN
    start_time := SYSDATE;
    batch_name := 'CCDB_BATCH.PROC_PERL_DEVICE_TRACK';
    rid        := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_tk_track_device
     WHERE trans_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_PERL;

    --跳转-03
    FOR record_device_data IN perl_device_data
    LOOP
      --最大值最小值之差大于个数，且过大（差值大于1000）
      --设备重新设置nbr流水号
      --处理，插入设备流水号更新记录表
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_PERL, record_device_data.min_value,
         record_device_data.max_value, '03');
    END LOOP;

    --缺失-01
    FOR record_device_data IN perl_mis_device_data
    LOOP
      SELECT COUNT(*)
        INTO jump_num
        FROM tbl_tk_track_device
       WHERE settle_date = batch_date
         AND trans_date = batch_date
         AND device_nid = record_device_data.device_nid
         AND ticket_category = CCDB_STD.C_TC_PERL
         AND ERROR_CODE = '03'
         AND rownum = 1;
      IF jump_num = 0 THEN
        IF v_device_nid = record_device_data.device_nid THEN
          device_trace_no_max_temp := record_device_data.min_val - 1;
          INSERT INTO tbl_tk_track_device
            (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
             ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
          VALUES
            (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
             substr(record_device_data.device_nid, 1, 4),
             substr(record_device_data.device_nid, 5, 2),
             record_device_data.device_nid, CCDB_STD.C_TC_PERL,
             device_trace_no_min_temp, device_trace_no_max_temp, '01');
          device_trace_no_min_temp := record_device_data.max_val + 1;
        ELSE
          v_device_nid             := record_device_data.device_nid;
          device_trace_no_min_temp := record_device_data.max_val + 1;
        END IF;
      END IF;
    END LOOP;

    --重复-02
    FOR record_device_data IN perl_rep_device_data
    LOOP
      device_trace_no := record_device_data.device_trace_nbr;
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_PERL, device_trace_no, device_trace_no, '02');
    END LOOP;

    --更新tbl_tk_track_device_max
    DELETE FROM tbl_tk_track_device_max
     WHERE settle_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_PERL;
    INSERT INTO tbl_tk_track_device_max
      (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
       ticket_category)
      SELECT batch_date, line_id, station_nid, device_type, device_nid,
             device_trace_max, ticket_category
        FROM tbl_tk_track_device_max
       WHERE settle_date = ccdb_lib.F_SYS_CDATE(batch_date, -1)
         AND ticket_category = CCDB_STD.C_TC_PERL;

    MERGE INTO tbl_tk_track_device_max tk
    USING (SELECT line_id, station_nid, device_type, device_nid,
                  device_trace_nbr max_value
             FROM (SELECT line_id, station_nid, device_type, device_nid,
                           device_trace_nbr,
                           row_number() OVER(PARTITION BY line_id, station_nid, device_type, device_nid ORDER BY trans_time DESC, device_trace_nbr DESC) rn
                      FROM tbl_trans_1003_perl_temp
                     WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                           TO_DATE(batch_date, 'yyyymmdd') + 1 +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60))
            WHERE rn = 1) trans
    ON (tk.line_id = trans.line_id AND tk.station_nid = trans.station_nid AND tk.device_type = trans.device_type AND tk.device_nid = trans.device_nid AND ticket_category = CCDB_STD.C_TC_PERL AND tk.settle_date = batch_date)
    WHEN MATCHED THEN
      UPDATE SET device_trace_max = trans.max_value
    WHEN NOT MATCHED THEN
      INSERT
        (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
         ticket_category)
      VALUES
        (batch_date, trans.line_id, trans.station_nid, trans.device_type,
         trans.device_nid, max_value, CCDB_STD.C_TC_PERL);

    end_time     := SYSDATE;
    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_PERL_DEVICE_TRACK',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  金融IC卡票卡跟踪                                    --
  --------------------------------------------------------
  PROCEDURE PROC_PBOC_DEVICE_TRACK(batch_date IN VARCHAR2) IS

    --跳转-03
    CURSOR pboc_device_data IS
      SELECT device_nid, MIN(device_trace_nbr_int) min_value,
             MAX(device_trace_nbr_int) max_value, COUNT(*) record_num
        FROM (SELECT device_nid, device_trace_nbr_int
                 FROM tbl_trans_1004_union_pay_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_PBOC
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid
      HAVING MAX(device_trace_nbr_int) - MIN(device_trace_nbr_int) + 1 > COUNT(*) + CCDB_STD.C_REC_MAX_NUM;

    --缺失-01
    CURSOR pboc_mis_device_data IS
      SELECT dr.device_nid, MIN(dr.device_trace_nbr_int) min_val,
             MAX(dr.device_trace_nbr_int) max_val
        FROM (SELECT orig.*, orig.device_trace_nbr_int - ROWNUM d, ROWNUM r
                 FROM (SELECT DISTINCT device_nid, device_trace_nbr_int
                          FROM (SELECT DISTINCT device_nid, device_trace_nbr_int
                                   FROM tbl_trans_1004_union_pay_temp t
                                  WHERE t.trans_time >=
                                        to_date(batch_date, 'yyyyMMdd') +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                    AND t.trans_time <=
                                        to_date(batch_date, 'yyyyMMdd') + 1 +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                 UNION ALL
                                 SELECT device_nid, device_trace_max
                                   FROM tbl_tk_track_device_max
                                  WHERE ticket_category = CCDB_STD.C_TC_PBOC
                                    AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1)
                                  ORDER BY device_nid, device_trace_nbr_int)
                         ORDER BY device_nid, device_trace_nbr_int) orig) dr
       GROUP BY dr.device_nid, dr.d
       ORDER BY device_nid, MIN(dr.device_trace_nbr_int);

    --重复-02
    CURSOR pboc_rep_device_data IS
      SELECT device_nid, device_trace_nbr_int
        FROM (SELECT device_nid, device_trace_nbr_int
                 FROM tbl_trans_1004_union_pay_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_PBOC
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid, device_trace_nbr_int
      HAVING COUNT(*) > 1;
    --local variable
    record_num               NUMBER;
    jump_num                 NUMBER;
    device_trace_no          NUMBER;
    device_trace_no_min_temp NUMBER;
    device_trace_no_max_temp NUMBER;
    device_trace_no_flag     NUMBER;
    v_device_nid             CHAR(8);
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(19.11.20)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_PBOC_DEVICE_TRACK';
    rid        := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_tk_track_device
     WHERE trans_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_PBOC;

    --跳转-03
    FOR record_device_data IN pboc_device_data
    LOOP
      --最大值最小值之差大于个数，且过大（差值大于1000）
      --设备重新设置nbr流水号
      --处理，插入设备流水号更新记录表
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_PBOC, record_device_data.min_value,
         record_device_data.max_value, '03');
    END LOOP;

    --缺失-01
    FOR record_device_data IN pboc_mis_device_data
    LOOP
      SELECT COUNT(*)
        INTO jump_num
        FROM tbl_tk_track_device
       WHERE settle_date = batch_date
         AND trans_date = batch_date
         AND device_nid = record_device_data.device_nid
         AND ticket_category = CCDB_STD.C_TC_PBOC
         AND ERROR_CODE = '03'
         AND rownum = 1;
      IF jump_num = 0 THEN
        IF v_device_nid = record_device_data.device_nid THEN
          device_trace_no_max_temp := record_device_data.min_val - 1;
          INSERT INTO tbl_tk_track_device
            (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
             ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
          VALUES
            (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
             substr(record_device_data.device_nid, 1, 4),
             substr(record_device_data.device_nid, 5, 2),
             record_device_data.device_nid, CCDB_STD.C_TC_PBOC,
             device_trace_no_min_temp, device_trace_no_max_temp, '01');
          device_trace_no_min_temp := record_device_data.max_val + 1;
        ELSE
          v_device_nid             := record_device_data.device_nid;
          device_trace_no_min_temp := record_device_data.max_val + 1;
        END IF;
      END IF;
    END LOOP;

    --重复-02
    FOR record_device_data IN pboc_rep_device_data
    LOOP
      device_trace_no := record_device_data.device_trace_nbr_int;
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_PBOC, device_trace_no, device_trace_no, '02');
    END LOOP;

    --更新tbl_tk_track_device_max
    DELETE FROM tbl_tk_track_device_max
     WHERE settle_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_PBOC;
    INSERT INTO tbl_tk_track_device_max
      (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
       ticket_category)
      SELECT batch_date, line_id, station_nid, device_type, device_nid,
             device_trace_max, ticket_category
        FROM tbl_tk_track_device_max
       WHERE settle_date = ccdb_lib.F_SYS_CDATE(batch_date, -1)
         AND ticket_category = CCDB_STD.C_TC_PBOC;

    MERGE INTO tbl_tk_track_device_max tk
    USING (SELECT line_id, station_nid, device_type, device_nid,
                  device_trace_nbr_int max_value
             FROM (SELECT line_id, station_nid, device_type, device_nid,
                           device_trace_nbr_int,
                           row_number() OVER(PARTITION BY line_id, station_nid, device_type, device_nid ORDER BY trans_time DESC, device_trace_nbr_int DESC) rn
                      FROM tbl_trans_1004_union_pay_temp
                     WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                           TO_DATE(batch_date, 'yyyymmdd') + 1 +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60))
            WHERE rn = 1) trans
    ON (tk.line_id = trans.line_id AND tk.station_nid = trans.station_nid AND tk.device_type = trans.device_type AND tk.device_nid = trans.device_nid AND ticket_category = CCDB_STD.C_TC_PBOC AND tk.settle_date = batch_date)
    WHEN MATCHED THEN
      UPDATE SET device_trace_max = trans.max_value
    WHEN NOT MATCHED THEN
      INSERT
        (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
         ticket_category)
      VALUES
        (batch_date, trans.line_id, trans.station_nid, trans.device_type,
         trans.device_nid, max_value, CCDB_STD.C_TC_PBOC);

    end_time     := SYSDATE;
    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_PBOC_DEVICE_TRACK',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

 	--------------------------------------------------------
  --  二维码票卡跟踪
  --	HHJT_CJP 20191121 新增                                    --
  --------------------------------------------------------
  PROCEDURE PROC_QR_DEVICE_TRACK(batch_date IN VARCHAR2) IS
    --跳转-03
    CURSOR qr_device_data IS
      SELECT device_nid, MIN(device_trace_nbr_int) min_value,
             MAX(device_trace_nbr_int) max_value, COUNT(*) record_num
        FROM (SELECT device_nid, device_trace_nbr_int
                 FROM tbl_trans_1005_qr_pay_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_QR
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid
      HAVING MAX(device_trace_nbr_int) - MIN(device_trace_nbr_int) + 1 > COUNT(*) + CCDB_STD.C_REC_MAX_NUM;

    --缺失-01
    CURSOR qr_mis_device_data IS
      SELECT dr.device_nid, MIN(dr.device_trace_nbr_int) min_val,
             MAX(dr.device_trace_nbr_int) max_val
        FROM (SELECT orig.*, orig.device_trace_nbr_int - ROWNUM d, ROWNUM r
                 FROM (SELECT DISTINCT device_nid, device_trace_nbr_int
                          FROM (SELECT DISTINCT device_nid, device_trace_nbr_int
                                   FROM tbl_trans_1005_qr_pay_temp t
                                  WHERE t.trans_time >=
                                        to_date(batch_date, 'yyyyMMdd') +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                    AND t.trans_time <=
                                        to_date(batch_date, 'yyyyMMdd') + 1 +
                                        CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
                                 UNION ALL
                                 SELECT device_nid, device_trace_max
                                   FROM tbl_tk_track_device_max
                                  WHERE ticket_category = CCDB_STD.C_TC_QR
                                    AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1)
                                  ORDER BY device_nid, device_trace_nbr_int)
                         ORDER BY device_nid, device_trace_nbr_int) orig) dr
       GROUP BY dr.device_nid, dr.d
       ORDER BY device_nid, MIN(dr.device_trace_nbr_int);

    --重复-02
    CURSOR qr_rep_device_data IS
      SELECT device_nid, device_trace_nbr_int
        FROM (SELECT device_nid, device_trace_nbr_int
                 FROM tbl_trans_1005_qr_pay_temp
                WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                      TO_DATE(batch_date, 'yyyymmdd') + 1 +
                      CCDB_STD.C_REPORT_TIME * 15 / (24 * 60)
               UNION ALL
               SELECT device_nid, device_trace_max
                 FROM tbl_tk_track_device_max
                WHERE ticket_category = CCDB_STD.C_TC_QR
                  AND settle_date = CCDB_LIB.F_SYS_CDATE(batch_date, -1))
       GROUP BY device_nid, device_trace_nbr_int
      HAVING COUNT(*) > 1;
    --local variable
    record_num               NUMBER;
    jump_num                 NUMBER;
    device_trace_no          NUMBER;
    device_trace_no_min_temp NUMBER;
    device_trace_no_max_temp NUMBER;
    device_trace_no_flag     NUMBER;
    v_device_nid             CHAR(8);
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(19.11.20)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_QR_DEVICE_TRACK';
    rid        := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_tk_track_device
     WHERE trans_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_QR;

    --跳转-03
    FOR record_device_data IN qr_device_data
    LOOP
      --最大值最小值之差大于个数，且过大（差值大于1000）
      --设备重新设置nbr流水号
      --处理，插入设备流水号更新记录表
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_QR, record_device_data.min_value,
         record_device_data.max_value, '03');
    END LOOP;

    --缺失-01
    FOR record_device_data IN qr_mis_device_data
    LOOP
      SELECT COUNT(*)
        INTO jump_num
        FROM tbl_tk_track_device
       WHERE settle_date = batch_date
         AND trans_date = batch_date
         AND device_nid = record_device_data.device_nid
         AND ticket_category = CCDB_STD.C_TC_QR
         AND ERROR_CODE = '03'
         AND rownum = 1;
      IF jump_num = 0 THEN
        IF v_device_nid = record_device_data.device_nid THEN
          device_trace_no_max_temp := record_device_data.min_val - 1;
          INSERT INTO tbl_tk_track_device
            (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
             ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
          VALUES
            (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
             substr(record_device_data.device_nid, 1, 4),
             substr(record_device_data.device_nid, 5, 2),
             record_device_data.device_nid, CCDB_STD.C_TC_QR,
             device_trace_no_min_temp, device_trace_no_max_temp, '01');
          device_trace_no_min_temp := record_device_data.max_val + 1;
        ELSE
          v_device_nid             := record_device_data.device_nid;
          device_trace_no_min_temp := record_device_data.max_val + 1;
        END IF;
      END IF;
    END LOOP;

    --重复-02
    FOR record_device_data IN qr_rep_device_data
    LOOP
      device_trace_no := record_device_data.device_trace_nbr_int;
      INSERT INTO tbl_tk_track_device
        (settle_date, trans_date, line_id, station_nid, device_type, device_nid,
         ticket_category, start_trace_no, end_trace_no, ERROR_CODE)
      VALUES
        (batch_date, batch_date, CCDB_LIB.F_SYS_GETLINENID(record_device_data.device_nid),
         substr(record_device_data.device_nid, 1, 4),
         substr(record_device_data.device_nid, 5, 2), record_device_data.device_nid,
         CCDB_STD.C_TC_QR, device_trace_no, device_trace_no, '02');
    END LOOP;

    --更新tbl_tk_track_device_max
    DELETE FROM tbl_tk_track_device_max
     WHERE settle_date = batch_date
       AND ticket_category = CCDB_STD.C_TC_PBOC;
    INSERT INTO tbl_tk_track_device_max
      (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
       ticket_category)
      SELECT batch_date, line_id, station_nid, device_type, device_nid,
             device_trace_max, ticket_category
        FROM tbl_tk_track_device_max
       WHERE settle_date = ccdb_lib.F_SYS_CDATE(batch_date, -1)
         AND ticket_category = CCDB_STD.C_TC_QR;

    MERGE INTO tbl_tk_track_device_max tk
    USING (SELECT line_id, station_nid, device_type, device_nid,
                  device_trace_nbr_int max_value
             FROM (SELECT line_id, station_nid, device_type, device_nid,
                           device_trace_nbr_int,
                           row_number() OVER(PARTITION BY line_id, station_nid, device_type, device_nid ORDER BY trans_time DESC, device_trace_nbr_int DESC) rn
                      FROM tbl_trans_1005_qr_pay_temp
                     WHERE trans_time BETWEEN TO_DATE(batch_date, 'yyyymmdd') +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60) AND
                           TO_DATE(batch_date, 'yyyymmdd') + 1 +
                           CCDB_STD.C_REPORT_TIME * 15 / (24 * 60))
            WHERE rn = 1) trans
    ON (tk.line_id = trans.line_id AND tk.station_nid = trans.station_nid AND tk.device_type = trans.device_type AND tk.device_nid = trans.device_nid AND ticket_category = CCDB_STD.C_TC_QR AND tk.settle_date = batch_date)
    WHEN MATCHED THEN
      UPDATE SET device_trace_max = trans.max_value
    WHEN NOT MATCHED THEN
      INSERT
        (settle_date, line_id, station_nid, device_type, device_nid, device_trace_max,
         ticket_category)
      VALUES
        (batch_date, trans.line_id, trans.station_nid, trans.device_type,
         trans.device_nid, max_value, CCDB_STD.C_TC_QR);

    end_time     := SYSDATE;
    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_QR_DEVICE_TRACK',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;


  --------------------------------------------------------
  --  单程票售票出站跟踪                                --
  --------------------------------------------------------
  PROCEDURE PROC_SJT_FLOW_STAT(batch_date IN VARCHAR2) IS
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
  BEGIN
    start_time := SYSDATE;
    batch_name := 'CCDB_BATCH.PROC_SJT_FLOW_STAT';
    rid        := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_tk_ticket_flow_stat WHERE settle_date = batch_date;

    INSERT INTO tbl_tk_ticket_flow_stat
      (settle_date, trans_date, ticket_type, sale_ticket_num, exit_ticket_num,
       entry_ticket_num,LINE_NID)
      SELECT settle_date, trans_date, ticket_type, nvl(SUM(sale_count), 0),
             nvl(SUM(out_count), 0), nvl(SUM(in_count), 0),LINE_NID
        FROM tbl_batch_trans_settle_trans
       WHERE settle_date = batch_date
       AND   ticket_category = CCDB_STD.C_TC_SJT
       GROUP BY settle_date, trans_date, ticket_type,LINE_NID;

    end_time     := SYSDATE;
    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_SJT_FLOW_STAT',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  黑名单锁卡
  --	HHJT_CJP 20210330 PBOC,QR不存在锁卡               --
  --------------------------------------------------------
  PROCEDURE PROC_CARD_LOCK(batch_date IN VARCHAR2) IS
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_CARD_LOCK';
    rid       		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_batch_card_lock_detail WHERE settle_date = batch_date;

    -- SJT
    INSERT INTO tbl_batch_card_lock_detail
      (settle_date, trans_date,line_nid, station_nid, ticket_category, ticket_type, trans_type,
       card_id, card_phy_id, trans_time, device_nid)
      SELECT settle_date,
             to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60), 'yyyyMMdd'),
             line_id line_nid,station_nid, CCDB_STD.C_TC_SJT, ticket_type, trans_type, card_id,
             card_phy_id, trans_time, device_nid
        FROM tbl_trans_1001_sjt_temp
       WHERE settle_date = batch_date
         AND trans_type = CCDB_STD.C_TRT_CARD_LOCK;

    --SVT
    INSERT INTO tbl_batch_card_lock_detail
      (settle_date, trans_date, line_nid, station_nid, ticket_category, ticket_type, trans_type,
       card_id, card_phy_id, trans_time, device_nid)
      SELECT settle_date,
             to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60), 'yyyyMMdd'),
             line_id line_nid,station_nid, CCDB_STD.C_TC_SVT, ticket_type, trans_type, card_id,
             card_phy_id, trans_time, device_nid
        FROM tbl_trans_1002_svt_temp
       WHERE settle_date = batch_date
         AND trans_type = CCDB_STD.C_TRT_CARD_LOCK;

    --PERL
    INSERT INTO tbl_batch_card_lock_detail
      (settle_date, trans_date,line_nid,  station_nid, ticket_category, ticket_type, trans_type,
       card_id, card_phy_id, trans_time, device_nid)
      SELECT settle_date,
             to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60), 'yyyyMMdd'),
             line_id line_nid,station_nid, CCDB_STD.C_TC_PERL, ticket_type, trans_type, card_id,
             card_phy_id, trans_time, device_nid
        FROM tbl_trans_1003_perl_temp
       WHERE settle_date = batch_date
         AND trans_type = CCDB_STD.C_TRT_CARD_LOCK;

    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CARD_LOCK', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  清理数据                                --
  --------------------------------------------------------
  PROCEDURE PROC_CLEAR_DATA(batch_date IN VARCHAR2) IS
    --local variable
    reserve_day   NUMBER(3);
    del_partition NUMBER(3);
    exec_date     DATE;
    sqlstat       VARCHAR2(300);
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_CLEAR_DATA';
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);


	  --====清理非临时性数据=========================
	  DELETE FROM TBL_BATCH_ENTRY_EXIT_STAT where settle_date<= to_char(to_date(batch_date,'yyyyMMdd') - 360,'yyyyMMdd');

	  --保存7天
    reserve_day := 7;
	  --DELETE FROM TBL_BATCH_RG_AGM_MAX where settle_date<= to_char(to_date(batch_date,'yyyyMMdd')-reserve_day,'yyyyMMdd');

	  --====清理临时数据==============================
	  DELETE FROM tbl_batch_trans_settle_data ;
	  DELETE FROM tbl_batch_trans_settle_trans ;

    COMMIT;


    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CLEAR_DATA', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  故障退款统计                                --
  --------------------------------------------------------
  PROCEDURE PROC_ERROR_SETTLE(batch_date IN VARCHAR2) IS
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_ERROR_SETTLE';
    rid       	  := CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    DELETE FROM tbl_batch_error WHERE settle_date = batch_date;

    INSERT INTO tbl_batch_error
      (SETTLE_DATE, TRANS_DATE, DEVICE_TYPE, DEVICE_NID, ERROR_COUNT, ERROR_AMOUNT)
      SELECT batch_date, batch_date, substr(mt.device_nid, 5, 2), mt.device_nid,
             COUNT(*), SUM(nvl(mt.value_trans, 0))
        FROM tbl_mn_5020_tvm mt
       WHERE occur_time >= to_date(batch_date, 'yyyymmdd') +
             ccdb_std.c_report_time * 15 / (24 * 60)
         AND occur_time < to_date(batch_date, 'yyyymmdd') +
             ccdb_std.c_report_time * 15 / (24 * 60) + 1
       GROUP BY mt.device_nid;


    INSERT INTO tbl_batch_error
      (SETTLE_DATE, TRANS_DATE, DEVICE_TYPE, DEVICE_NID, ERROR_COUNT, ERROR_AMOUNT)
      SELECT batch_date, batch_date, substr(mt.device_nid, 5, 2), mt.device_nid,
             COUNT(*), SUM(nvl(mt.TRANS_VALUE, 0))
        FROM tbl_mn_5021_bom mt
       WHERE occur_time >= to_date(batch_date, 'yyyymmdd') +
             ccdb_std.c_report_time * 15 / (24 * 60)
         AND occur_time < to_date(batch_date, 'yyyymmdd') +
             ccdb_std.c_report_time * 15 / (24 * 60) + 1
       GROUP BY mt.device_nid;

    COMMIT;

    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_ERROR_SETTLE', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  交易数据票卡汇总
  --------------------------------------------------------
  PROCEDURE PROC_TRANS_SETTLE(batch_date IN VARCHAR2) IS

    CURSOR trans_settle_cur IS
      SELECT settle_date, trans_date, operator_id, line_nid,station_nid, device_nid,
             ticket_category,ticket_type,payment_method
        FROM tbl_batch_trans_settle_data
       WHERE settle_date = batch_date
       GROUP BY settle_date, trans_date, operator_id,line_nid, station_nid, device_nid,
                ticket_category,ticket_type,payment_method;


    --local variable
    rec_trans_settle_trans tbl_batch_trans_settle_trans%ROWTYPE;
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_TRANS_SETTLE';
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

	  DELETE FROM tbl_batch_trans_settle_data WHERE settle_date = batch_date;

		BEGIN
	    --初始化统计-放入汇总表
			--单程票数据统计
	    INSERT INTO tbl_batch_trans_settle_data
	      (settle_date, trans_date,line_nid, station_nid, device_nid, ticket_category,ticket_type, trans_type,
	       payment_method, operator_id, value_trans, settle_count, settle_amount,
	       trans_fee, deposit)
	      SELECT settle_date, trans_date, line_nid,station_nid, device_nid,ticket_category, ticket_type, trans_type,
	             payment_method, operator_id, value_trans, COUNT(*) settle_count,
	             nvl(SUM(value_trans), 0) settle_amount, nvl(SUM(trans_fee), 0) trans_fee,
	             nvl(SUM(deposit), 0) deposit
	        FROM (SELECT settle_date,
	                      to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60),
	                               'yyyyMMdd') trans_date,LINE_ID line_nid,station_nid, device_nid,
	                      CCDB_STD.C_TC_SJT ticket_category,ticket_type, trans_type, payment_method, operator_id,
	                      trans_value value_trans,
	                      0 trans_fee, 0 deposit
	                 FROM tbl_trans_1001_sjt_temp
	                WHERE settle_date = batch_date)
	       GROUP BY settle_date, trans_date,line_nid, station_nid, device_nid,ticket_category, ticket_type,
	                trans_type, payment_method, operator_id, value_trans;

		 COMMIT;
		    EXCEPTION
		      WHEN OTHERS THEN
		        ROLLBACK;
		        IF (CCDB_STD.DEBUG__) THEN
		          dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
		        ELSE
		          errmsg := SQLERRM(SQLCODE);
		          CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE.SJT',
		                                CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
		        END IF;
		 END;


		BEGIN
	    --储值票数据统计
	    INSERT INTO tbl_batch_trans_settle_data
	      (settle_date, trans_date, line_nid,station_nid, device_nid,ticket_category, ticket_type, trans_type,
	       payment_method, operator_id, value_trans,settle_count, settle_amount, trans_fee, deposit)
	      SELECT settle_date, trans_date, line_nid,station_nid, device_nid,ticket_category, ticket_type, trans_type,
	             payment_method, operator_id,value_trans, COUNT(*) settle_count,
	             nvl(SUM(value_trans), 0) settle_amount, nvl(SUM(trans_fee), 0) trans_fee,
	             nvl(SUM(deposit), 0) deposit
	        FROM (SELECT settle_date,
	                      to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60),
	                               'yyyyMMdd') trans_date, LINE_ID line_nid,station_nid, device_nid,
	                      CCDB_STD.C_TC_SVT ticket_category,ticket_type, trans_type, payment_method, operator_id,
	                      trans_value value_trans, trans_fee, deposit
	                 FROM tbl_trans_1002_svt_temp
	                WHERE settle_date = batch_date)
	       GROUP BY settle_date, trans_date,line_nid, station_nid, device_nid,ticket_category, ticket_type,
	                trans_type, payment_method, operator_id,value_trans;
		 COMMIT;
		    EXCEPTION
		      WHEN OTHERS THEN
		        ROLLBACK;
		        IF (CCDB_STD.DEBUG__) THEN
		          dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
		        ELSE
		          errmsg := SQLERRM(SQLCODE);
		          CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE.SVT',
		                                CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
		        END IF;
		 END;

		BEGIN
	    --一卡通数据统计(明珠卡和交通部卡)
	    --手续费字段只对退卡换卡有效，其他情况置0(因为交通部卡本字段会填发卡机构代码);
	    --退卡 '05';换卡 '06';
	    INSERT INTO tbl_batch_trans_settle_data
	      (settle_date, trans_date,line_nid, station_nid, device_nid, ticket_category,ticket_type, trans_type,
	       payment_method, operator_id, value_trans,settle_count, settle_amount, trans_fee, deposit)
	      SELECT settle_date, trans_date, line_nid,station_nid, device_nid,ticket_category, ticket_type, trans_type,
	             payment_method, operator_id,  value_trans,COUNT(*) settle_count,
	             nvl(SUM(value_trans), 0) settle_amount, nvl(SUM(trans_fee), 0) trans_fee,
	             nvl(SUM(deposit), 0) deposit
	        FROM (SELECT settle_date,
	                      to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60),
	                               'yyyyMMdd') trans_date, LINE_ID line_nid,station_nid, device_nid,
	                      CCDB_STD.C_TC_PERL ticket_category,ticket_type, trans_type, payment_method, operator_id,
	                      trans_value value_trans,
	                      DECODE(trans_type,'05',trans_fee,'06',trans_fee,0) trans_fee, deposit
	                 FROM tbl_trans_1003_perl_temp
	                WHERE settle_date = batch_date
	               )
	       GROUP BY settle_date, trans_date,line_nid, station_nid, device_nid, ticket_category,ticket_type,
	                trans_type, payment_method, operator_id, value_trans;
		 COMMIT;
		    EXCEPTION
		      WHEN OTHERS THEN
		        ROLLBACK;
		        IF (CCDB_STD.DEBUG__) THEN
		          dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
		        ELSE
		          errmsg := SQLERRM(SQLCODE);
		          CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE.PERL',
		                                CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
		        END IF;
		 END;

		BEGIN
	    --银行卡数据统计
	    INSERT INTO tbl_batch_trans_settle_data
	      (settle_date, trans_date,line_nid, station_nid, device_nid, ticket_category,ticket_type, trans_type,
	       payment_method, operator_id, value_trans, settle_count, settle_amount, trans_fee, deposit)
	      SELECT settle_date, trans_date, line_nid,station_nid, device_nid,ticket_category, ticket_type, trans_type,
	             payment_method, operator_id, value_trans, COUNT(*) settle_count,
	             nvl(SUM(value_trans), 0) settle_amount, nvl(SUM(trans_fee), 0) trans_fee,
	             nvl(SUM(deposit), 0) deposit
	        FROM (SELECT settle_date,
	                      to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60),
	                               'yyyyMMdd') trans_date,LINE_ID line_nid, station_nid, device_nid,
	                      CCDB_STD.C_TC_PBOC ticket_category,ticket_type, trans_type, payment_method, operator_id,
	                      trans_value value_trans,0 trans_fee, 0 deposit
	                 FROM tbl_trans_1004_union_pay_temp
	                WHERE settle_date = batch_date
	               )
	       GROUP BY settle_date, trans_date,line_nid, station_nid, device_nid, ticket_category,ticket_type,
	                trans_type, payment_method, operator_id, value_trans;
		 COMMIT;
		    EXCEPTION
		      WHEN OTHERS THEN
		        ROLLBACK;
		        IF (CCDB_STD.DEBUG__) THEN
		          dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
		        ELSE
		          errmsg := SQLERRM(SQLCODE);
		          CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE.PBOC',
		                                CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
		        END IF;
		 END;

		BEGIN
	    --二维码数据统计
	    INSERT INTO tbl_batch_trans_settle_data
	      (settle_date, trans_date, line_nid,station_nid, device_nid, ticket_category,ticket_type, trans_type,
	       payment_method, operator_id, value_trans, settle_count, settle_amount, trans_fee, deposit)
	      SELECT settle_date, trans_date, line_nid,station_nid, device_nid,ticket_category, ticket_type, trans_type,
	             payment_method, operator_id, value_trans, COUNT(*) settle_count,
	             nvl(SUM(value_trans), 0) settle_amount, nvl(SUM(trans_fee), 0) trans_fee,
	             nvl(SUM(deposit), 0) deposit
	        FROM (SELECT settle_date,
	                      to_char(trans_time - CCDB_STD.C_REPORT_TIME * 15 / (24 * 60),
	                               'yyyyMMdd') trans_date,LINE_ID line_nid, station_nid, device_nid,
	                      CCDB_STD.C_TC_QR ticket_category,ticket_type, trans_type, payment_method, operator_id,
	                      trans_value value_trans,0 trans_fee, 0 deposit
	                 FROM tbl_trans_1005_qr_pay_temp
	                WHERE settle_date = batch_date
	               )
	       GROUP BY settle_date, trans_date,line_nid, station_nid, device_nid,ticket_category, ticket_type,
	                trans_type, payment_method, operator_id, value_trans;

   COMMIT;
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        IF (CCDB_STD.DEBUG__) THEN
          dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
        ELSE
          errmsg := SQLERRM(SQLCODE);
          CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE.QR',
                                CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
        END IF;
    END;


    ----从汇总中统计放入统计表
    DELETE FROM tbl_batch_trans_settle_trans 		 WHERE settle_date = batch_date;
    DELETE FROM tbl_batch_trans_settle_his 			 WHERE settle_date = batch_date;

    FOR rec_trans_settle_head IN trans_settle_cur
    LOOP
      rec_trans_settle_trans.settle_date     := rec_trans_settle_head.settle_date;
      rec_trans_settle_trans.trans_date      := rec_trans_settle_head.trans_date;
      rec_trans_settle_trans.operator_id     := rec_trans_settle_head.operator_id;
      rec_trans_settle_trans.line_nid     	 := rec_trans_settle_head.line_nid;
      rec_trans_settle_trans.station_nid     := rec_trans_settle_head.station_nid;
      rec_trans_settle_trans.device_nid      := rec_trans_settle_head.device_nid;
      rec_trans_settle_trans.device_type     := substr(rec_trans_settle_head.device_nid,
                                                     5, 2);
      rec_trans_settle_trans.ticket_type     := rec_trans_settle_head.ticket_type;
      rec_trans_settle_trans.payment_method  := rec_trans_settle_head.payment_method;
      rec_trans_settle_trans.ticket_category := rec_trans_settle_head.ticket_category;

      --售票
      SELECT NVL(SUM(SETTLE_COUNT), 0), NVL(SUM(SETTLE_AMOUNT), 0)
        INTO rec_trans_settle_trans.sale_count, rec_trans_settle_trans.sale_amount
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type 		= CCDB_STD.C_TRT_SALE;

      --进站
      SELECT NVL(SUM(SETTLE_COUNT), 0)
        INTO rec_trans_settle_trans.in_count
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type 		= CCDB_STD.C_TRT_IN;

      --出站
      SELECT NVL(SUM(SETTLE_COUNT), 0), NVL(SUM(SETTLE_AMOUNT), 0)
        INTO rec_trans_settle_trans.out_count, rec_trans_settle_trans.out_amount
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type 		= CCDB_STD.C_TRT_OUT;

      --充值
      SELECT NVL(SUM(SETTLE_COUNT), 0), NVL(SUM(SETTLE_AMOUNT), 0)
        INTO rec_trans_settle_trans.load_count, rec_trans_settle_trans.load_amount
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type 		= CCDB_STD.C_TRT_LOAD;

      --充值抵消
      SELECT NVL(SUM(SETTLE_COUNT), 0), NVL(SUM(SETTLE_AMOUNT), 0)
        INTO rec_trans_settle_trans.load_offset_count,
             rec_trans_settle_trans.load_offset_amount
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type 		= CCDB_STD.C_TRT_LOAD_OFFSET;

      --补票
      SELECT NVL(SUM(SETTLE_COUNT), 0), NVL(SUM(SETTLE_AMOUNT), 0)
        INTO rec_trans_settle_trans.update_count, rec_trans_settle_trans.update_amount
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type IN (ccdb_std.C_TRT_UPDATE, ccdb_std.C_TRT_UPDATE2, ccdb_std.C_TRT_UPDATE3);

      --卡内补票
      --(原)修改为储值票支付
      --(新)该字段直接置0,因为已区分支付方式
      SELECT 0, 0
        INTO rec_trans_settle_trans.card_update_count,
             rec_trans_settle_trans.card_update_amount
        FROM dual;


      --退卡
      SELECT NVL(SUM(SETTLE_COUNT), 0), NVL(SUM(SETTLE_AMOUNT), 0)
        INTO rec_trans_settle_trans.refund_count, rec_trans_settle_trans.refund_amount
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type 		= CCDB_STD.C_TRT_REFUND;

      --押金
      SELECT NVL(SUM(DEPOSIT * decode(trans_type, '04', 1, '05', -1, 0)), 0)
        INTO rec_trans_settle_trans.deposit
        FROM tbl_batch_trans_settle_data
       WHERE trans_date = rec_trans_settle_trans.trans_date
         AND settle_date = batch_date
         AND operator_id = rec_trans_settle_trans.operator_id
         AND ticket_type = rec_trans_settle_trans.ticket_type
         AND device_nid = rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method;

      --手续费
      SELECT NVL(SUM(TRANS_FEE), 0)
        INTO rec_trans_settle_trans.trans_fee
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method;

      --储值票支付
      SELECT NVL(SUM(SETTLE_COUNT), 0), NVL(SUM(SETTLE_AMOUNT), 0)
        INTO rec_trans_settle_trans.card_pay_count,
             rec_trans_settle_trans.card_pay_amount
        FROM tbl_batch_trans_settle_data
       WHERE trans_date 		= rec_trans_settle_trans.trans_date
         AND settle_date 		= batch_date
         AND operator_id 		= rec_trans_settle_trans.operator_id
         AND ticket_type 		= rec_trans_settle_trans.ticket_type
         AND device_nid 		= rec_trans_settle_trans.device_nid
         AND payment_method = rec_trans_settle_trans.payment_method
         AND trans_type 		= CCDB_STD.C_TRT_CARD_PAY;

      INSERT INTO tbl_batch_trans_settle_trans 		 VALUES rec_trans_settle_trans;
      INSERT INTO tbl_batch_trans_settle_his 			 VALUES rec_trans_settle_trans;

    END LOOP;
    COMMIT;

    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  票卡数据统计
  --  HHJT_CJP 20210406 修改                               --
  --------------------------------------------------------

  PROCEDURE PROC_TRANS_SETTLE_STAT(batch_date IN VARCHAR2)  IS

    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_TRANS_SETTLE_STAT';
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

  	--操作员
    BEGIN
      DELETE TBL_BATCH_TRANS_OPERATOR WHERE settle_date = batch_date;

      INSERT INTO TBL_BATCH_TRANS_OPERATOR
				 (settle_date, trans_date, operator_id, line_nid,station_nid, ticket_category,ticket_type, payment_method,
					sale_count, sale_amount,
					in_count,out_count,out_amount,
					load_count, load_amount,
					load_offset_count, load_offset_amount,
					update_count, update_amount,
					card_update_count,card_update_amount,
					refund_count, refund_amount,
          deposit,trans_fee,
          card_pay_count,card_pay_amount)
        SELECT settle_date, trans_date, operator_id, line_nid,station_nid, ticket_category,ticket_type, payment_method,
               SUM(sale_count), SUM(sale_amount),
               SUM(in_count), SUM(out_count), SUM(out_amount),
               SUM(load_count), SUM(load_amount),
               SUM(load_offset_count), SUM(load_offset_amount),
               SUM(update_count), SUM(update_amount),
               SUM(card_update_count), SUM(card_update_amount),
               SUM(refund_count), SUM(refund_amount),
               SUM(deposit), SUM(trans_fee),
               SUM(card_pay_count), SUM(card_pay_amount)
          FROM tbl_batch_trans_settle_trans
         WHERE settle_date = batch_date
         	AND  OPERATOR_ID > '00000000'
         GROUP BY settle_date, trans_date, operator_id, line_nid,station_nid, ticket_category,ticket_type, payment_method
        HAVING   SUM(sale_count) + SUM(sale_amount)
               + SUM(in_count) + SUM(out_count) + SUM(out_amount)
               + SUM(load_count) + SUM(load_amount)
               + SUM(load_offset_count) + SUM(load_offset_amount)
               + SUM(update_count) + SUM(update_amount)
               + SUM(card_update_count) + SUM(card_update_amount)
               + SUM(refund_count) + SUM(refund_amount)
               + SUM(deposit) + SUM(trans_fee)
               + SUM(card_pay_count) + SUM(card_pay_amount) > 0;

      COMMIT;
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        IF (CCDB_STD.DEBUG__) THEN
          dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
        ELSE
          errmsg := SQLERRM(SQLCODE);
          CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE_STAT.OPERATOR',
                                CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
        END IF;
    END;


  	--设备
    BEGIN
      DELETE TBL_BATCH_TRANS_DEVICE WHERE settle_date = batch_date;

      INSERT INTO TBL_BATCH_TRANS_DEVICE
				 (settle_date, trans_date, line_nid,station_nid,device_nid, device_type, ticket_category,ticket_type, payment_method,
					sale_count, sale_amount,
					in_count,out_count,out_amount,
					load_count, load_amount,
					load_offset_count, load_offset_amount,
					update_count, update_amount,
					card_update_count,card_update_amount,
					refund_count, refund_amount,
          deposit,trans_fee,
          card_pay_count,card_pay_amount)
        SELECT settle_date, trans_date, line_nid,station_nid,device_nid, device_type, ticket_category,ticket_type, payment_method,
               SUM(sale_count), SUM(sale_amount),
               SUM(in_count), SUM(out_count), SUM(out_amount),
               SUM(load_count), SUM(load_amount),
               SUM(load_offset_count), SUM(load_offset_amount),
               SUM(update_count), SUM(update_amount),
               SUM(card_update_count), SUM(card_update_amount),
               SUM(refund_count), SUM(refund_amount),
               SUM(deposit), SUM(trans_fee),
               SUM(card_pay_count), SUM(card_pay_amount)
          FROM tbl_batch_trans_settle_trans
         WHERE settle_date = batch_date
         GROUP BY settle_date, trans_date, line_nid,station_nid,device_nid, device_type, ticket_category,ticket_type, payment_method
        HAVING   SUM(sale_count) + SUM(sale_amount)
               + SUM(in_count) + SUM(out_count) + SUM(out_amount)
               + SUM(load_count) + SUM(load_amount)
               + SUM(load_offset_count) + SUM(load_offset_amount)
               + SUM(update_count) + SUM(update_amount)
               + SUM(card_update_count) + SUM(card_update_amount)
               + SUM(refund_count) + SUM(refund_amount)
               + SUM(deposit) + SUM(trans_fee)
               + SUM(card_pay_count) + SUM(card_pay_amount) > 0;

      COMMIT;
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        IF (CCDB_STD.DEBUG__) THEN
          dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
        ELSE
          errmsg := SQLERRM(SQLCODE);
          CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE_STAT.DEVICE',
                                CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
        END IF;
    END;

    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_TRANS_SETTLE_STAT',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;



  --------------------------------------------------------
  --  汇总统计
  --	HHJT_CJP 20191122 修改                              --
  --------------------------------------------------------

  PROCEDURE PROC_REPORT_INALL(batch_date IN VARCHAR2) IS

    CURSOR transtype_month_cur IS
      SELECT DISTINCT substr(trans_date, 1, 6) transmonth
        FROM tbl_batch_transtype_day
       WHERE settle_date = batch_date;

    CURSOR transtype_year_cur IS
      SELECT DISTINCT substr(trans_date, 1, 4) transyear
        FROM tbl_batch_transtype_day
       WHERE settle_date = batch_date;

    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_REPORT_INALL';
 	  rid       		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    --交易类型统计

    --日报表
    DELETE FROM tbl_batch_transtype_day WHERE settle_date = batch_date;

    INSERT INTO tbl_batch_transtype_day
      (settle_date, trans_date, line_nid,station_nid, device_nid, device_type,
       ticket_category, ticket_type, trans_type,payment_method,
       operator_id,value_trans,settle_count, settle_amount,trans_fee, deposit)
      SELECT settle_date, trans_date, line_nid,station_nid, device_nid,
             substr(device_nid, 5, 2), ticket_category, ticket_type, trans_type,payment_method,
             operator_id,value_trans,SUM(settle_count), SUM(settle_amount), SUM(trans_fee), SUM(deposit)
        FROM tbl_batch_trans_settle_data
       WHERE settle_date = batch_date
       GROUP BY settle_date, trans_date,line_nid, station_nid, device_nid, ticket_category,ticket_type,
                trans_type,payment_method,operator_id,value_trans;

    --故障退款0xFF(其中ticket_catagory为0x9999,ticketTYPE为0xFFFF(BOM)0xFFFE(TVM))
    --HHJT_CJP 20191123 故障交易类型的支付方式为 CCDB_STD.C_PM_CASH('01')
    INSERT INTO tbl_batch_transtype_day
      (settle_date, trans_date,line_nid, station_nid, device_nid, device_type,
       ticket_category, ticket_type, trans_type,payment_method,
       operator_id,value_trans,settle_count, settle_amount,trans_fee, deposit)
      SELECT settle_date, trans_date, substr(device_nid, 1, 2), substr(device_nid, 1, 4), device_nid,
             device_type, '9999',
             CASE
               WHEN device_type = '11' THEN
                'FFFE'
               WHEN device_type = '21' THEN
                'FFFF'
             END, 'FF',
             CCDB_STD.C_PM_CASH payment_method,'00000000',error_amount,error_count, error_amount, 0, 0
        FROM tbl_batch_error
       WHERE settle_date = batch_date;

      --月报表
      FOR rec_transtype_month IN transtype_month_cur
      LOOP
        DELETE FROM tbl_batch_transtype_month
         WHERE trans_date = rec_transtype_month.transmonth;

        INSERT INTO tbl_batch_transtype_month
          (settle_date, trans_date,line_nid, station_nid, device_nid, device_type,
           ticket_category, ticket_type, trans_type, operator_id,value_trans,
           settle_count, settle_amount, trans_fee, deposit)
          SELECT batch_date, rec_transtype_month.transmonth,line_nid, station_nid, device_nid,device_type,
                 ticket_category, ticket_type, trans_type,operator_id,value_trans,
                 SUM(settle_count), SUM(settle_amount), SUM(trans_fee), SUM(deposit)
            FROM tbl_batch_transtype_day
           WHERE trans_date BETWEEN rec_transtype_month.transmonth || '01' AND
                 rec_transtype_month.transmonth || '31'
           GROUP BY line_nid,station_nid, device_nid, device_type, ticket_category, ticket_type,
                    trans_type,operator_id,value_trans;
      END LOOP;

    --年报表
    FOR rec_transtype_year IN transtype_year_cur
    LOOP
      DELETE FROM tbl_batch_transtype_year
       WHERE trans_date = rec_transtype_year.transyear;

      INSERT INTO tbl_batch_transtype_year
        (settle_date, trans_date,line_nid, station_nid, device_nid, device_type,
         ticket_category, ticket_type, trans_type, operator_id,value_trans,
         settle_count, settle_amount, trans_fee, deposit)
        SELECT batch_date, rec_transtype_year.transyear,line_nid, station_nid, device_nid,device_type,
               ticket_category, ticket_type, trans_type,operator_id,value_trans,
               SUM(settle_count), SUM(settle_amount), SUM(trans_fee), SUM(deposit)
          FROM tbl_batch_transtype_month
         WHERE trans_date BETWEEN rec_transtype_year.transyear || '01' AND
               rec_transtype_year.transyear || '12'
         GROUP BY line_nid,station_nid, device_nid, device_type, ticket_category, ticket_type,
                  trans_type,operator_id,value_trans;
    END LOOP;
    COMMIT;

    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_REPORT_INALL', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  现金管理日结统计                                --
  --------------------------------------------------------
  PROCEDURE PROC_CASH_BATCH(batch_date IN VARCHAR2) IS
    --local variable
    v_start_trans_time DATE;
    v_end_trans_time   DATE;
    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_CASH_BATCH';
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    --统计balance
    v_start_trans_time := to_date(batch_date, 'yyyyMMdd') +
                          CCDB_STD.C_REPORT_TIME * 15 / (24 * 60);
    v_end_trans_time   := to_date(batch_date, 'yyyyMMdd') + 1 +
                          CCDB_STD.C_REPORT_TIME * 15 / (24 * 60);

    --1.清空表
    DELETE FROM tbl_ch_pettycash_balance;

    BEGIN
	    --2.取得前一天数据
	    INSERT INTO tbl_ch_pettycash_balance
	      			(line_nid,station_nid, pettycash_amount)
	      SELECT line_nid,station_nid, pettycash_amount
	        FROM tbl_ch_pettycash_balance_his
	       WHERE settle_date = to_char(to_date(batch_date, 'yyyyMMdd') - 1, 'yyyyMMdd');

	   COMMIT;
	  EXCEPTION
	    WHEN OTHERS THEN
	      ROLLBACK;
	      IF (CCDB_STD.DEBUG__) THEN
	        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
	      ELSE
	        errmsg := SQLERRM(SQLCODE);
	        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH.2', CCDB_STD.LEVEL_LOG_FERR,
	                              errmsg, CCDB_STD.DEST_BOTH);
	      END IF;
	  END;

    BEGIN
	    --3.SE
	    MERGE INTO tbl_ch_pettycash_balance ba
	    USING (SELECT line_nid,station_nid, SUM(operate_factor * se_amount) diff
	             FROM (SELECT line_nid,station_nid,
	                           CASE
	                             WHEN se_type = 3 THEN
	                              1
	                             WHEN se_type = 4 THEN
	                              -1
	                             WHEN se_type = 5 THEN
	                              1
	                             ELSE
	                              0
	                           END operate_factor, se_amount
	                      FROM tbl_ch_pettycash_se
	                     WHERE settle_date = batch_date)
	            GROUP BY line_nid,station_nid) io
	    ON (ba.station_nid = io.station_nid)
	    WHEN MATCHED THEN
	      UPDATE SET pettycash_amount = pettycash_amount + io.diff
	    WHEN NOT MATCHED THEN
	      INSERT VALUES (io.LINE_NID ,io.station_nid, io.diff);

	   COMMIT;
	  EXCEPTION
	    WHEN OTHERS THEN
	      ROLLBACK;
	      IF (CCDB_STD.DEBUG__) THEN
	        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
	      ELSE
	        errmsg := SQLERRM(SQLCODE);
	        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH.3', CCDB_STD.LEVEL_LOG_FERR,
	                              errmsg, CCDB_STD.DEST_BOTH);
	      END IF;
	  END;

    BEGIN
	    --4.INOUT
	    MERGE INTO tbl_ch_pettycash_balance ba
	    USING (SELECT line_nid,station_nid, SUM(operate_factor * inout_amount) diff
	             FROM (SELECT line_nid, station_nid,
	                           CASE
	                             WHEN operate_type = 1 THEN
	                              1
	                             WHEN operate_type = 2 THEN
	                              -1
	                             WHEN operate_type = 6 THEN
	                              -1
	                             ELSE
	                              0
	                           END operate_factor, inout_amount
	                      FROM tbl_ch_pettycash_inout
	                     WHERE settle_date = batch_date)
	            GROUP BY line_nid,station_nid) io
	    ON (ba.station_nid = io.station_nid)
	    WHEN MATCHED THEN
	      UPDATE SET pettycash_amount = pettycash_amount + io.diff
	    WHEN NOT MATCHED THEN
	      INSERT VALUES (io.line_nid,io.station_nid, io.diff);

	   COMMIT;
	  EXCEPTION
	    WHEN OTHERS THEN
	      ROLLBACK;
	      IF (CCDB_STD.DEBUG__) THEN
	        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
	      ELSE
	        errmsg := SQLERRM(SQLCODE);
	        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH.4', CCDB_STD.LEVEL_LOG_FERR,
	                              errmsg, CCDB_STD.DEST_BOTH);
	      END IF;
	  END;

    BEGIN
    	--5.BOM

    MERGE INTO tbl_ch_pettycash_balance ba USING (SELECT
    line_nid,station_nid, SUM(check_amount) diff FROM (SELECT
    line_nid,station_nid, check_amount FROM tbl_ch_cash_check_bom WHERE
    settle_date = batch_date) GROUP BY line_nid,station_nid) io ON
    (ba.station_nid = io.station_nid) WHEN MATCHED THEN UPDATE SET
    pettycash_amount = pettycash_amount + io.diff WHEN NOT MATCHED THEN INSERT
    VALUES (io.line_nid,io.station_nid, io.diff); COMMIT; EXCEPTION WHEN OTHERS
    THEN ROLLBACK; IF (CCDB_STD.DEBUG__) THEN dbms_output.put_line('ERR:' ||
    SQLERRM(SQLCODE)); ELSE errmsg := SQLERRM(SQLCODE);
    CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH.5',
    CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH); END IF; END;

    BEGIN
	    --6.TVM
	    MERGE INTO tbl_ch_pettycash_balance ba
	    USING (SELECT line_nid,station_nid, SUM(check_amount) diff
	             FROM (SELECT line_nid,station_nid, check_amount
	                      FROM tbl_ch_cash_check_tvm
	                     WHERE settle_date = batch_date
	                    UNION ALL
	                    SELECT line_nid,station_nid, check_amount
	                      FROM tbl_ch_cash_manual_check_tvm
	                     WHERE settle_date = batch_date)
	            GROUP BY line_nid,station_nid) io
	    ON (ba.station_nid = io.station_nid)
	    WHEN MATCHED THEN
	      UPDATE SET pettycash_amount = pettycash_amount + io.diff
	    WHEN NOT MATCHED THEN
	      INSERT VALUES (io.line_nid,io.station_nid, io.diff);

	   COMMIT;
	  EXCEPTION
	    WHEN OTHERS THEN
	      ROLLBACK;
	      IF (CCDB_STD.DEBUG__) THEN
	        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
	      ELSE
	        errmsg := SQLERRM(SQLCODE);
	        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH.6', CCDB_STD.LEVEL_LOG_FERR,
	                              errmsg, CCDB_STD.DEST_BOTH);
	      END IF;
	  END;

    BEGIN
	    --7.BANK
	    --HHJT_CJP 20230321 银行缴款按照运营日计算 PAYMENT_DATE
	    MERGE INTO tbl_ch_pettycash_balance ba
	    USING (SELECT line_nid,station_nid, SUM(check_amount) diff
	             FROM (SELECT line_nid,station_nid, payment_amount * -1 check_amount
	                      FROM tbl_ch_cash_payment
	                     WHERE PAYMENT_DATE = batch_date)
	            GROUP BY line_nid,station_nid) io
	    ON (ba.station_nid = io.station_nid)
	    WHEN MATCHED THEN
	      UPDATE SET pettycash_amount = pettycash_amount + io.diff
	    WHEN NOT MATCHED THEN
	      INSERT VALUES (io.line_nid,io.station_nid, io.diff);
	   COMMIT;
	  EXCEPTION
	    WHEN OTHERS THEN
	      ROLLBACK;
	      IF (CCDB_STD.DEBUG__) THEN
	        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
	      ELSE
	        errmsg := SQLERRM(SQLCODE);
	        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH.7', CCDB_STD.LEVEL_LOG_FERR,
	                              errmsg, CCDB_STD.DEST_BOTH);
	      END IF;
	  END;

    BEGIN
	    --备份balance
	    DELETE FROM tbl_ch_pettycash_balance_his WHERE settle_date = batch_date;

	    INSERT INTO tbl_ch_pettycash_balance_his
	      (settle_date, line_nid,station_nid, pettycash_amount)
	      SELECT batch_date, line_nid,station_nid, pettycash_amount FROM tbl_ch_pettycash_balance;
	   COMMIT;
	  EXCEPTION
	    WHEN OTHERS THEN
	      ROLLBACK;
	      IF (CCDB_STD.DEBUG__) THEN
	        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
	      ELSE
	        errmsg := SQLERRM(SQLCODE);
	        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH.8', CCDB_STD.LEVEL_LOG_FERR,
	                              errmsg, CCDB_STD.DEST_BOTH);
	      END IF;
	  END;

    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CASH_BATCH', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  库存备份统计                                --
  --------------------------------------------------------
  PROCEDURE PROC_ST_INVENTORY_BACKUP(batch_date IN VARCHAR2) IS
    --local variable

    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_ST_INVENTORY_BACKUP';
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    --统计balance
    DELETE FROM tbl_st_balance_his WHERE settle_date = batch_date;
    COMMIT;

    INSERT INTO tbl_st_balance_his
      (settle_date,line_nid, station_nid, directory_code, ticket_status, inventory_num)
      SELECT batch_date, LINE_NID,station_nid, directory_code, ticket_status, invenory_num
        FROM tbl_st_balance;
    COMMIT;
    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_ST_INVENTORY_BACKUP',
                              CCDB_STD.LEVEL_LOG_FERR, errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  库存台账统计                                --
  --------------------------------------------------------
  PROCEDURE PROC_ST_INVENTORY(batch_date IN VARCHAR2) IS
    --local variable
    v_start_trans_time  DATE;
    v_end_trans_time    DATE;
    v_current_station   VARCHAR2(4);
    v_count             NUMBER(1);
    v_batch_time        NUMBER;
    v_invent_time       DATE;
    record_report_day   tbl_st_report_day%ROWTYPE;
    record_report_month tbl_st_report_month%ROWTYPE;
    record_report_year  tbl_st_report_year%ROWTYPE;


    CURSOR blank_cur IS
      SELECT line_nid,station_nid, directory_code, ticket_status FROM tbl_st_balance;

    --error message
    errmsg VARCHAR2(500);
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_ST_INVENTORY';
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    --统计balance
    v_start_trans_time := to_date(batch_date, 'yyyyMMdd') +
                          CCDB_STD.C_REPORT_TIME * 15 / (24 * 60);
    v_end_trans_time   := to_date(batch_date, 'yyyyMMdd') + 1 +
                          CCDB_STD.C_REPORT_TIME * 15 / (24 * 60);

    DELETE FROM tbl_st_report_day WHERE settle_date = batch_date;
    DELETE FROM tbl_st_report_month WHERE settle_date = SUBSTR(batch_date, 1, 6);
    DELETE FROM tbl_st_report_year WHERE settle_date = SUBSTR(batch_date, 1, 4);
    COMMIT;

    v_current_station := 'C600';

    -- 库存台帐
    FOR blank_rec IN blank_cur
    LOOP
      -- 库存每日台帐
      record_report_day.settle_date    := batch_date;
      record_report_day.line_nid    	 := blank_rec.line_nid;
      record_report_day.station_nid    := blank_rec.station_nid;
      record_report_day.directory_code := blank_rec.directory_code;
      record_report_day.ticket_status  := blank_rec.ticket_status;

      SELECT NVL(SUM(inventory_num), 0)
        INTO record_report_day.start_num
        FROM tbl_st_balance_his
       WHERE settle_date = TO_CHAR(TO_DATE(batch_date, 'YYYYMMDD') - 1, 'YYYYMMDD')
         AND station_nid = blank_rec.station_nid
         AND directory_code = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status;

      SELECT nvl(SUM(in_count), 0)
        INTO record_report_day.in_num
        FROM tbl_st_3005_in
       WHERE in_date >= TO_CHAR(v_start_trans_time,'yyyyMMddHH24miss')
	     AND in_date <  TO_CHAR(v_end_trans_time,'yyyyMMddHH24miss')
         AND station_nid = blank_rec.station_nid
         AND ticket_directory = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status
         AND in_type IN ('04', '06', '07')
         AND is_uploaded = '01';

      SELECT nvl(SUM(out_count), 0)
        INTO record_report_day.out_num
        FROM tbl_st_3006_out
       WHERE out_date >= TO_CHAR(v_start_trans_time,'yyyyMMddHH24miss')
	     AND out_date < TO_CHAR(v_end_trans_time,'yyyyMMddHH24miss')
         AND station_nid = blank_rec.station_nid
         AND ticket_directory = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status
         AND out_type IN ('06', '08', '09')
         AND is_uploaded = '01';

      -- 库存领用、上缴情况
      record_report_day.out2_num := 0;
      record_report_day.in2_num  := 0;
      SELECT nvl(SUM(in_count), 0)
        INTO record_report_day.in2_num
        FROM tbl_st_3005_in
       WHERE in_date >= TO_CHAR(v_start_trans_time,'yyyyMMddHH24miss')
	     AND in_date < TO_CHAR(v_end_trans_time,'yyyyMMddHH24miss')
         AND station_nid = blank_rec.station_nid
         AND ticket_directory = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status
         AND in_type IN ('05')
         AND is_uploaded = '01';
      SELECT nvl(SUM(out_count), 0)
        INTO record_report_day.out2_num
        FROM tbl_st_3006_out
       WHERE out_date >= TO_CHAR(v_start_trans_time,'yyyyMMddHH24miss')
	     AND out_date < TO_CHAR(v_end_trans_time,'yyyyMMddHH24miss')
         AND station_nid = blank_rec.station_nid
         AND ticket_directory = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status
         AND out_type IN ('07')
         AND is_uploaded = '01';
      /*
      SELECT NVL(SUM(operate_num * decode(operate_type, 2, 1, 0)), 0),
             NVL(SUM(operate_num * decode(operate_type, 1, 1, 0)), 0)
        INTO record_report_day.out2_num, record_report_day.in2_num
        FROM tbl_st_ticket_oper
       WHERE operate_time >= v_start_trans_time
         AND operate_time < v_end_trans_time
         AND substr(device_nid, 1, 4) = blank_rec.station_nid
         AND directory_code = blank_rec.directory_code
         AND ticket_status=blank_rec.ticket_status;
         */

      --添加盘点功能，当当天有盘点时，则上述盘点数据均进行修改
      --开始数量为盘点数量
      --出入库信息为盘点后的出入库数量
      --领用上缴数量为盘点后的领用上缴数量
      /**/
        SELECT COUNT(*)
          INTO v_count
          FROM tbl_st_3003_inventory t
         WHERE rownum = 1
           AND INVENT_STATUS = '01'
           AND t.station_nid = blank_rec.station_nid
           AND t.inventory_date >= TO_CHAR(v_start_trans_time,'yyyyMMddHH24miss')
           AND t.inventory_date < TO_CHAR(v_end_trans_time,'yyyyMMddHH24miss')
           AND t.ticket_directory = blank_rec.directory_code;

        IF v_count = 1 THEN
          --若当前车站0200,则说明是其他车站上传的
          --更新3003,3005,3006
          IF v_current_station = '0200' THEN

            MERGE INTO tbl_st_3003_inventory inv
            USING (SELECT PACKET_SEQ, DEAL_DATE
                     FROM TBL_PM_PKG_HEADER
                    WHERE deal_date >= v_start_trans_time
                      AND deal_date < v_end_trans_time) header
            ON (inv.packet_seq = header.packet_seq)
            WHEN MATCHED THEN
              UPDATE
                 SET inv.invent_time = header.deal_date
               WHERE inv.station_nid = blank_rec.station_nid
                 AND inv.inventory_date = batch_date
                 AND inv.ticket_directory = blank_rec.directory_code;

            MERGE INTO tbl_st_3005_in inv
            USING (SELECT PACKET_SEQ, DEAL_DATE
                     FROM TBL_PM_PKG_HEADER
                    WHERE deal_date >= v_start_trans_time
                      AND deal_date < v_end_trans_time) header
            ON (inv.packet_seq = header.packet_seq)
            WHEN MATCHED THEN
              UPDATE
                 SET inv.upload_time = header.deal_date
               WHERE inv.station_nid = blank_rec.station_nid
                 AND inv.in_date = batch_date
                 AND inv.ticket_directory = blank_rec.directory_code;

            MERGE INTO tbl_st_3006_out inv
            USING (SELECT PACKET_SEQ, DEAL_DATE
                     FROM TBL_PM_PKG_HEADER
                    WHERE deal_date >= v_start_trans_time
                      AND deal_date < v_end_trans_time) header
            ON (inv.packet_seq = header.packet_seq)
            WHEN MATCHED THEN
              UPDATE
                 SET inv.upload_time = header.deal_date
               WHERE inv.station_nid = blank_rec.station_nid
                 AND inv.out_date = batch_date
                 AND inv.ticket_directory = blank_rec.directory_code;

            SELECT invent_time, good_count
              INTO v_invent_time, record_report_day.start_num
              FROM tbl_st_3003_inventory_temp t
             WHERE rownum = 1
               AND t.station_nid = blank_rec.station_nid
               AND t.ticket_directory = blank_rec.directory_code
               AND t.invent_time >= v_start_trans_time
               AND t.invent_time < v_end_trans_time + 1 / 48;
          ELSE
            SELECT invent_time, good_count
              INTO v_invent_time, record_report_day.start_num
              FROM tbl_st_3003_inventory t
             WHERE rownum = 1
               AND INVENT_STATUS = '01'
               AND t.station_nid = blank_rec.station_nid
               AND t.inventory_date = batch_date
               AND t.ticket_directory = blank_rec.directory_code;

          END IF;

          SELECT nvl(SUM(in_count), 0)
            INTO record_report_day.in_num
            FROM tbl_st_3005_in
           WHERE in_date = batch_date
             AND upload_time >= v_invent_time
             AND upload_time < v_end_trans_time
             AND station_nid = blank_rec.station_nid
             AND ticket_directory = blank_rec.directory_code
             AND is_uploaded = '01';

          SELECT nvl(SUM(out_count), 0)
            INTO record_report_day.out_num
            FROM tbl_st_3006_out
           WHERE out_date = batch_date
             AND upload_time >= v_invent_time
             AND upload_time < v_end_trans_time
             AND station_nid = blank_rec.station_nid
             AND ticket_directory = blank_rec.directory_code
             AND is_uploaded = '01';
          -- 库存领用、上缴情况
          record_report_day.out2_num := 0;
          record_report_day.in2_num  := 0;
          SELECT NVL(SUM(operate_num * decode(operate_type, 2, 1, 0)), 0),
                 NVL(SUM(operate_num * decode(operate_type, 1, 1, 0)), 0)
            INTO record_report_day.out2_num, record_report_day.in2_num
            FROM tbl_st_ticket_oper
           WHERE operate_time >= v_invent_time
             AND operate_time < v_end_trans_time
             AND substr(device_nid, 1, 4) = blank_rec.station_nid
             AND directory_code = blank_rec.directory_code;

        END IF;

      INSERT INTO tbl_st_report_day VALUES record_report_day;

      --日库存台账后将数据插入历史表中

      MERGE INTO tbl_st_balance_his his
      USING (SELECT batch_date settle_date, record_report_day.line_nid line_nid,record_report_day.station_nid station_nid,
                    record_report_day.directory_code directory_code,
                    record_report_day.ticket_status ticket_status,
                    record_report_day.start_num - record_report_day.out_num -
                     record_report_day.out2_num + record_report_day.in_num +
                     record_report_day.in2_num invent_num
               FROM dual) du
      ON (his.settle_date = du.settle_date AND his.station_nid = du.station_nid AND his.directory_code = du.directory_code AND his.ticket_status = du.ticket_status)
      WHEN MATCHED THEN
        UPDATE SET his.inventory_num = du.invent_num
      WHEN NOT MATCHED THEN
        INSERT
          (settle_date, line_nid,station_nid, directory_code, ticket_status, inventory_num)
        VALUES
          (du.settle_date, du.line_nid,du.station_nid, du.directory_code, du.ticket_status,
           du.invent_num);

      --判断当前时间是否为0200~0400 :是
      --判断是否已执行过batch :否
      --将更新后的数量插入到库存表中
      /*
        SELECT COUNT(*)
          INTO v_count
          FROM TBL_BATCH_LOG
         WHERE rownum = 1
           AND PROC_NAME = 'CCDB_BATCH.PROC_ST_INVENTORY'
           AND DATA_ARGU = batch_date
           AND TIME_ELAPSED IS NOT NULL;

        SELECT (SYSDATE - TRUNC(SYSDATE)) * 86400 INTO v_batch_time FROM dual;
        IF v_count = 0 AND v_batch_time >= 7200 AND v_batch_time < 14400 THEN
          MERGE INTO tbl_st_balance his
          USING (SELECT batch_date settle_date, record_report_day.station_nid station_nid,
                        record_report_day.directory_code directory_code,
                        record_report_day.start_num - record_report_day.out_num -
                         record_report_day.out2_num + record_report_day.in_num +
                         record_report_day.in2_num invent_num
                   FROM dual) du
          ON (his.station_nid = du.station_nid AND his.directory_code = du.directory_code)
          WHEN MATCHED THEN
            UPDATE SET his.INVENORY_NUM = du.invent_num
          WHEN NOT MATCHED THEN
            INSERT
              (station_nid, directory_code, INVENORY_NUM)
            VALUES
              (du.station_nid, du.directory_code, du.invent_num);
        END IF;
      */
      -- 白票库存每月台帐
      record_report_month.settle_date    := SUBSTR(batch_date, 1, 6);
      record_report_month.line_nid    	 := blank_rec.line_nid;
      record_report_month.station_nid    := blank_rec.station_nid;
      record_report_month.directory_code := blank_rec.directory_code;
      record_report_month.ticket_status  := blank_rec.ticket_status;
      SELECT NVL(SUM(start_num), 0)
        INTO record_report_month.start_num
        FROM tbl_st_report_day
       WHERE settle_date = SUBSTR(batch_date, 1, 6) || '01'
         AND station_nid = blank_rec.station_nid
         AND directory_code = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status;

      SELECT NVL(SUM(in_num), 0), NVL(SUM(out_num), 0), NVL(SUM(in2_num), 0),
             NVL(SUM(out2_num), 0)
        INTO record_report_month.in_num, record_report_month.out_num,
             record_report_month.in2_num, record_report_month.out2_num
        FROM tbl_st_report_day
       WHERE settle_date BETWEEN SUBSTR(batch_date, 1, 6) || '01' AND
             SUBSTR(batch_date, 1, 6) || '31'
         AND station_nid = blank_rec.station_nid
         AND directory_code = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status;

      INSERT INTO tbl_st_report_month VALUES record_report_month;

      -- 白票库存每年台帐
      record_report_year.settle_date    := SUBSTR(batch_date, 1, 4);
      record_report_year.line_nid    	  := blank_rec.line_nid;
      record_report_year.station_nid    := blank_rec.station_nid;
      record_report_year.directory_code := blank_rec.directory_code;
      record_report_year.ticket_status  := blank_rec.ticket_status;

      -- NVL(SUM(start_num),0) 异常处理
      SELECT NVL(SUM(start_num), 0)
        INTO record_report_year.start_num
        FROM tbl_st_report_month
       WHERE settle_date = SUBSTR(batch_date, 1, 4) || '01'
         AND station_nid = blank_rec.station_nid
         AND directory_code = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status;

      SELECT NVL(SUM(in_num), 0), NVL(SUM(out_num), 0), NVL(SUM(in2_num), 0),
             NVL(SUM(out2_num), 0)
        INTO record_report_year.in_num, record_report_year.out_num,
             record_report_year.in2_num, record_report_year.out2_num
        FROM tbl_st_report_month
       WHERE settle_date BETWEEN SUBSTR(batch_date, 1, 4) || '01' AND
             SUBSTR(batch_date, 1, 4) || '12'
         AND station_nid = blank_rec.station_nid
         AND directory_code = blank_rec.directory_code
         AND ticket_status = blank_rec.ticket_status;

      INSERT INTO tbl_st_report_year VALUES record_report_year;
    END LOOP;
    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_ST_INVENTORY', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

  --------------------------------------------------------
  --  长短款统计                                --
  --------------------------------------------------------
  PROCEDURE PROC_CH_DIFF(batch_date IN VARCHAR2) IS
    --error message
    errmsg VARCHAR2(500);
    --variables
    v_count NUMBER;
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_CH_DIFF';
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);

    --删除历史
    DELETE tbl_batch_cash_diff WHERE settle_date = batch_date;

    --设备领用上缴
     INSERT INTO tbl_batch_cash_diff
      (SETTLE_DATE, TRANS_DATE, OPERATOR_ID,LINE_NID, STATION_NID, DEVICE_NID, DEVICE_TYPE,
       DATA_AMOUNT, DATA_TYPE)
      SELECT batch_date, trans_date, operator_id,
             line_nid,station_nid, device_nid,
             substr(device_nid, 5, 2) device_type, SUM(data_amount), 1 data_type
        FROM (
               --按照设备,操作员统计领用上缴金额(备用金)
               SELECT trans_date, operator_id,line_nid,station_nid, device_nid,
                       SUM(inout_amount * decode(operate_type, 1, 1, -1)) data_amount
                 FROM tbl_ch_pettycash_inout
                WHERE settle_date = batch_date
                GROUP BY trans_date, operator_id,line_nid,station_nid, device_nid
               UNION ALL
               --按照设备,操作员统计BOM运营款
               SELECT trans_date, bom_operator,line_nid,station_nid, device_nid, SUM(check_amount)
                 FROM tbl_ch_cash_check_bom
                WHERE settle_date = batch_date
                GROUP BY trans_date, bom_operator,line_nid,station_nid, device_nid
               UNION ALL
               --按照设备,操作员统计TVM运营款
               SELECT trans_date, tvm_operator,line_nid,station_nid, device_nid, SUM(check_amount)
                 FROM tbl_ch_cash_check_tvm
                WHERE settle_date = batch_date
                GROUP BY trans_date, tvm_operator,line_nid,station_nid, device_nid
               --按照设备，统计TVM手工款
               UNION ALL
               SELECT trans_date, '00000000',line_nid,station_nid, device_nid, SUM(check_amount)
                 FROM tbl_ch_cash_manual_check_tvm
                WHERE settle_date = batch_date
                GROUP BY line_nid,station_nid, device_nid,trans_date)
       GROUP BY trans_date, operator_id, line_nid,station_nid, device_nid;

    --领用：3
    --上缴：4
    --BOM运营款上缴：5
    --TVM运营款上缴：6
    --TVM手工：7
 		INSERT INTO tbl_batch_cash_diff
      (SETTLE_DATE, TRANS_DATE, OPERATOR_ID, LINE_NID, STATION_NID, DEVICE_NID, DEVICE_TYPE,
       DATA_AMOUNT, DATA_TYPE)
      SELECT batch_date, trans_date, operator_id,
             line_nid, station_nid, device_nid,
             substr(device_nid, 5, 2) device_type, SUM(data_amount),
             decode(operate_type, 1, 4, 3) data_type
        FROM (
               --按照设备,操作员统计领用上缴金额(备用金)
               SELECT trans_date, operator_id, line_nid,station_nid,device_nid,operate_type,
                       SUM(inout_amount * decode(operate_type, 1, 1, 1)) data_amount
                 FROM tbl_ch_pettycash_inout
                WHERE settle_date = batch_date
                GROUP BY trans_date, operator_id, line_nid,station_nid,device_nid,operate_type)
       GROUP BY trans_date, operator_id, line_nid, station_nid, device_nid, operate_type;


    INSERT INTO tbl_batch_cash_diff
      (SETTLE_DATE, TRANS_DATE, OPERATOR_ID, LINE_NID,STATION_NID, DEVICE_NID, DEVICE_TYPE,
       DATA_AMOUNT, DATA_TYPE)
      SELECT batch_date, trans_date, operator_id,
             line_nid,station_nid, device_nid,
             substr(device_nid, 5, 2) device_type, SUM(data_amount), 5 data_type
        FROM (
               --按照设备,操作员统计BOM运营款
               SELECT trans_date, bom_operator operator_id,line_nid,station_nid, device_nid,
                       SUM(check_amount) data_amount
                 FROM tbl_ch_cash_check_bom
                WHERE settle_date = batch_date
                GROUP BY bom_operator, line_nid,station_nid,device_nid, trans_date
              )
       GROUP BY trans_date, operator_id,line_nid,station_nid, device_nid;


    INSERT INTO tbl_batch_cash_diff
      (SETTLE_DATE, TRANS_DATE, OPERATOR_ID,LINE_NID, STATION_NID, DEVICE_NID, DEVICE_TYPE,
       DATA_AMOUNT, DATA_TYPE)
      SELECT batch_date, trans_date, operator_id,
             line_nid,station_nid, device_nid,
             substr(device_nid, 5, 2) device_type, SUM(data_amount), 6 data_type
        FROM (
               --按照设备,操作员统计TVM运营款
               SELECT trans_date, tvm_operator operator_id,line_nid,station_nid, device_nid,
                       SUM(check_amount) data_amount
                 FROM tbl_ch_cash_check_tvm
                WHERE settle_date = batch_date
                GROUP BY tvm_operator, line_nid,station_nid,device_nid, trans_date)
       GROUP BY trans_date, operator_id,line_nid,station_nid, device_nid;


    INSERT INTO tbl_batch_cash_diff
      (SETTLE_DATE, TRANS_DATE, OPERATOR_ID,LINE_NID, STATION_NID, DEVICE_NID, DEVICE_TYPE,
       DATA_AMOUNT, DATA_TYPE)
      SELECT batch_date, trans_date, operator_id,
             line_nid,station_nid, device_nid,
             substr(device_nid, 5, 2) device_type, SUM(data_amount), 7 data_type
        FROM (
               --按照设备，统计TVM手工款
               SELECT trans_date, '00000000' operator_id,line_nid,station_nid, device_nid,
                       SUM(check_amount) data_amount
                 FROM tbl_ch_cash_manual_check_tvm
                WHERE settle_date = batch_date
                GROUP BY line_nid,station_nid,device_nid, trans_date
              )
       GROUP BY trans_date, operator_id,line_nid,station_nid, device_nid;

    --实际交易金额
    INSERT INTO tbl_batch_cash_diff
      (SETTLE_DATE, TRANS_DATE, OPERATOR_ID, LINE_NID, STATION_NID, DEVICE_NID, DEVICE_TYPE,
       DATA_AMOUNT, DATA_TYPE)
      SELECT batch_date, trans_date, operator_id,
             line_nid,station_nid, device_nid,
             substr(device_nid, 5, 2) device_type, SUM(settle_amount), 2 data_type
        FROM (
               --交易数据
               SELECT operator_id,line_nid,station_nid, device_nid, trans_date,
                       SUM(settle_amount *
                            decode(trans_type, '02', -1, '05', -1, '06', -1, '11', -1,
                                   '13', -1, 1) + trans_fee +
                            deposit * decode(trans_type, '04', 1, '05', -1, 0)) settle_amount
                 FROM tbl_batch_trans_settle_data
                WHERE settle_date = batch_date
                  AND payment_method = '01'
                GROUP BY line_nid,station_nid,device_nid, operator_id, trans_date
               UNION ALL
               --故障退款(TVM)
 							SELECT  '00000000' operator_id,
                       CCDB_LIB.F_SYS_GETLINENID(DEVICE_NID),
                       substr(device_nid, 1, 4)  STATION_NID,
                       DEVICE_NID,
                       to_char(OCCUR_TIME - 8 / 96, 'yyyyMMdd') trans_date,
                       SUM(VALUE_TRANS) settle_amount
                 FROM TBL_MN_5020_TVM
                WHERE OCCUR_TIME >=
                      to_date(batch_date || '020000', 'yyyyMMddHH24miss')
                  AND OCCUR_TIME <
                      to_date(batch_date || '020000', 'yyyyMMddHH24miss') + 1
                  AND (ERROR_REASON = '00000001' OR ERROR_REASON = '00000000')
                GROUP BY  device_nid, to_char(OCCUR_TIME - 8 / 96, 'yyyyMMdd')
               UNION ALL
               --故障退款(BOM)
 							SELECT   operator_id,
                       CCDB_LIB.F_SYS_GETLINENID(DEVICE_NID),
                       substr(device_nid, 1, 4)  STATION_NID,
                       DEVICE_NID,
                       to_char(OCCUR_TIME - 8 / 96, 'yyyyMMdd') trans_date,
                       SUM(-1 * TRANS_VALUE) settle_amount
                 FROM TBL_MN_5021_BOM
                WHERE OCCUR_TIME >=
                      to_date(batch_date || '020000', 'yyyyMMddHH24miss')
                  AND OCCUR_TIME <
                      to_date(batch_date || '020000', 'yyyyMMddHH24miss') + 1
                  AND PAYMENT_METHOD = '01'
                GROUP BY  device_nid, to_char(OCCUR_TIME - 8 / 96, 'yyyyMMdd'),operator_id
               UNION ALL
               --非营业性收支(BOM)
 							SELECT   operator_id,
                       CCDB_LIB.F_SYS_GETLINENID(DEVICE_NID),
                       substr(device_nid, 1, 4)  STATION_NID,
                       DEVICE_NID,
                       to_char(OCCUR_TIME - 8 / 96, 'yyyyMMdd') trans_date,
                       SUM(TRANS_VALUE * DECODE(INOUT_FLAG,1,1,2,-1,0)) settle_amount
                 FROM TBL_MN_5022_BOM
                WHERE OCCUR_TIME >=
                      to_date(batch_date || '020000', 'yyyyMMddHH24miss')
                  AND OCCUR_TIME <
                      to_date(batch_date || '020000', 'yyyyMMddHH24miss') + 1
                  AND PAYMENT_METHOD = '01'
                GROUP BY  device_nid, to_char(OCCUR_TIME - 8 / 96, 'yyyyMMdd'),INOUT_FLAG,operator_id
             )
       GROUP BY line_nid,station_nid,device_nid, operator_id, trans_date;

    COMMIT;

    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CH_DIFF', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;

END CCDB_BATCH;

```
CCDB_STD
```sql
CREATE OR REPLACE PACKAGE CCDB."CCDB_STD" IS


  /******************************************************
   Name(鍚嶇О): CCDB_STD
   Purpose(鍔熻兘璇存槑): 闈欐€佸彉閲�

   淇璁板綍
   鐗堟湰      缂栬緫鏃堕棿       缂栬緫浜�      缂栬緫鍐呭
   1.0.0     20210330       HHJT_CJP     1.鍒涘缓鍖�
  *******************************************************/

  -- Public constant declarations
  C_FLUSH      CONSTANT BINARY_INTEGER := 1;
  C_NOFLUSH    CONSTANT BINARY_INTEGER := 0;
  C_SORT_NAME  CONSTANT BINARY_INTEGER := 1;
  C_SORT_COUNT CONSTANT BINARY_INTEGER := 2;

  C_TIMEBASE   CONSTANT VARCHAR(17) := '19700101 00:00:00';
  C_TIMEFORMAT CONSTANT VARCHAR2(16) := 'yyyyMMddHH24miss';
  C_DATEFORMAT CONSTANT VARCHAR2(8) := 'yyyyMMdd';


  C_LINE_ID CONSTANT VARCHAR2(2) := '02';

  C_PROC_VERSION   CONSTANT VARCHAR(40) := '(21.3.30)';
  --15鍒嗛挓涓轰竴鍗曚綅
  C_REPORT_TIME CONSTANT BINARY_INTEGER := 8;

  --绁ㄥ崱璺熻釜璺宠浆鏁伴噺
  C_REC_MAX_NUM CONSTANT BINARY_INTEGER := 1000;

  --浜ゆ槗绫诲瀷
  C_TRT_LOAD 				CONSTANT VARCHAR2(2) := '01';
  C_TRT_LOAD_OFFSET CONSTANT VARCHAR2(2) := '02';
  C_TRT_UPDATE 			CONSTANT VARCHAR2(2) := '03';
  C_TRT_UPDATE2 		CONSTANT VARCHAR2(2) := '07'; --娆″簭绾犳
  C_TRT_UPDATE3 		CONSTANT VARCHAR2(2) := '08'; --瓒呮椂缃氭
  C_TRT_SALE 				CONSTANT VARCHAR2(2) := '04';
  C_TRT_REFUND 			CONSTANT VARCHAR2(2) := '05';
  C_TRT_OUT 				CONSTANT VARCHAR2(2) := '0A';
  C_TRT_IN					CONSTANT VARCHAR2(2) := '09';
  C_TRT_CARD_LOCK 	CONSTANT VARCHAR2(2) := '0E';
  C_TRT_CARD_PAY 		CONSTANT VARCHAR2(2) := '15'; --鍌ㄥ€肩エ鏀粯


  --绁ㄥ崱涓荤被鍨�
  C_TC_SJT 	CONSTANT VARCHAR2(4) := '1001';
  C_TC_SVT 	CONSTANT VARCHAR2(4) := '1002';
  C_TC_PERL CONSTANT VARCHAR2(4) := '1003';
  C_TC_PBOC CONSTANT VARCHAR2(4) := '1004';
  C_TC_QR 	CONSTANT VARCHAR2(4) := '1005';

  --鏀粯鏂瑰紡
  C_PM_CASH 	CONSTANT VARCHAR2(2) := '01';
  C_PM_CARD 	CONSTANT VARCHAR2(2) := '02';
  C_PM_CREDIT CONSTANT VARCHAR2(2) := '03';
  C_PM_QR 		CONSTANT VARCHAR2(2) := '04';
  C_PM_PBOC 	CONSTANT VARCHAR2(2) := '05';
  C_PM_WX 		CONSTANT VARCHAR2(2) := '06';
  C_PM_ZFB 		CONSTANT VARCHAR2(2) := '07';

  --[LOG LEVEL]
  LEVEL_LOG_INFO CONSTANT NUMBER := 0;
  LEVEL_LOG_WARN CONSTANT NUMBER := 1;
  LEVEL_LOG_NERR CONSTANT NUMBER := 2;
  LEVEL_LOG_FERR CONSTANT NUMBER := 3;
  --[LOG DESTINATION]
  DEST_NONE CONSTANT NUMBER := 0;
  DEST_DB   CONSTANT NUMBER := 1;
  DEST_OS   CONSTANT NUMBER := 2;
  DEST_BOTH CONSTANT NUMBER := 3;
  --[DEVICE NID PART]
  NID_LINE_PART    CONSTANT NUMBER := 1;
  NID_STATION_PART CONSTANT NUMBER := 2;
  NID_TYPE_PART    CONSTANT NUMBER := 3;
  NID_DEVICE_PART  CONSTANT NUMBER := 4;

  --[RECORD ID]
  RNT_WITH_INPUTERR CONSTANT BINARY_INTEGER := -1;
  RNT_WITH_NODATA   CONSTANT BINARY_INTEGER := -2;
  RNT_WITH_SQLERR   CONSTANT BINARY_INTEGER := -4;
  RNT_WITH_SUCCESS  CONSTANT BINARY_INTEGER := 0;

  DEBUG__ CONSTANT BOOLEAN := FALSE;
  -- Public exception declarations
  E_SYS_TBL EXCEPTION;
END CCDB_STD;

```