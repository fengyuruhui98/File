1、表
ALTER TABLE TBL_BATCH_ENTRY_EXIT_DETAIL ADD SALE_NUM NUMBER DEFAULT 0;

2、新增接口
0x5021 BOM退故障单信息
0x5022 BOM非营业性收支数据

DROP TABLE  TBL_MN_5021_BOM;
CREATE TABLE  TBL_MN_5021_BOM
(
  PACKET_SEQ     NUMBER(10),
  DEVICE_NID    VARCHAR(8),
  OCCUR_TIME    DATE,
  TRANS_SEQ     NUMBER,
  OPERATOR_ID   VARCHAR(8), 
  FAULT_DEVICE_NID    VARCHAR(8),  
  ERROR_NO      NUMBER,
  TRANS_VALUE   NUMBER(10),
  PAYMENT_METHOD  VARCHAR(2),  
  CREATE_TIME		DATE DEFAULT SYSDATE
)
TABLESPACE TBSDCCDBADMIN;

ALTER TABLE  TBL_MN_5021_BOM  
	ADD  CONSTRAINT PK_MN_5021_BOM
  PRIMARY KEY  (DEVICE_NID,TRANS_SEQ, OPERATOR_ID,FAULT_DEVICE_NID);

DROP TABLE  TBL_MN_5022_BOM;
CREATE TABLE  TBL_MN_5022_BOM
(
  PACKET_SEQ    NUMBER(10),
  DEVICE_NID    VARCHAR(8),
  OCCUR_TIME    DATE,
  TRANS_SEQ     NUMBER(10),
  OPERATOR_ID   VARCHAR(8), 
  INOUT_FLAG      	NUMBER(10), 
  INOUT_REASON      NUMBER(10),
  TRANS_VALUE   		NUMBER(10),
  PAYMENT_METHOD  VARCHAR(2), 
  MEMO    				VARCHAR(64),  
  
  SALE_TICKET_FLAG      NUMBER(10),
  SALE_TICKET_TYPE  		VARCHAR(4), 
  SALE_TRANS_VALUE      NUMBER(10), 
  SALE_PAYMENT_METHOD 	 VARCHAR(2),   
 	SALE_CARD_PHY_ID 	 		 VARCHAR(16),   
	SALE_DEVICE_TRACE_NBR	      NUMBER(10),
  CREATE_TIME		DATE DEFAULT SYSDATE
)
TABLESPACE TBSDCCDBADMIN;

ALTER TABLE  TBL_MN_5022_BOM  
	ADD  CONSTRAINT PK_MN_5022_BOM
  PRIMARY KEY  (DEVICE_NID,TRANS_SEQ, OPERATOR_ID,INOUT_FLAG);
  

工作站入口  
票务管理->车票跟踪->BOM退款/非营业性

3、因为换乘站沿用既有线路、车站编号，
故需要对换乘站工作站界面做特殊处理，
ISCS做特殊处理



3.1 工作站界面特殊处理

界面获取车站列表时选取 
TBL_SS_STATION_INFO 联合
TBL_SS_SPECIAL_STATION 的 SPECIAL 所有数据
再结合 TBL_SS_MLC_LINE 即可。

DROP TABLE  "TBL_SS_SPECIAL_STATION";
CREATE TABLE  "TBL_SS_SPECIAL_STATION" 
(	
  "LINE_ID" VARCHAR2(2)  NOT NULL, 
	"STATION_NID" VARCHAR2(4) NOT NULL, 
	"STATION_NAME_CN" VARCHAR2(80)  NOT NULL, 
	"STATION_NAME_EN" VARCHAR2(80)  NOT NULL,
	"SPECIAL_LINE_NID" VARCHAR2(2)  NOT NULL,
	"SPECIAL_STATION_NID" VARCHAR2(4)  NOT NULL,
	"MEMO" VARCHAR2(255), 
	"CREATE_TIME" DATE DEFAULT SYSDATE, 
	 CONSTRAINT PK_SS_SPECIAL_STATION PRIMARY KEY (STATION_NID,SPECIAL_STATION_NID)
)
TABLESPACE TBSDCCDBADMIN;

 
3.2综合监控换乘站处理
DROP TABLE  "TBL_SS_ISCS_STATION";
CREATE TABLE  "TBL_SS_ISCS_STATION" 
(	
  "AFC_LINE_NID" VARCHAR2(2)  NOT NULL, 
	"AFC_STATION_NID" VARCHAR2(4) NOT NULL, 
	"ISCS_LINE_NID" VARCHAR2(2)  NOT NULL,
	"ISCS_STATION_NID" VARCHAR2(4)  NOT NULL,
	"ISCS_STATION_ID" 	NUMBER(10)  NOT NULL,	
	"ISCS_BOM_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_TVM_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_TCM_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_AGM_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_BOM_START_OFFSET" NUMBER(10)  NOT NULL,
	"ISCS_TVM_START_OFFSET" NUMBER(10)  NOT NULL,
	"ISCS_TCM_START_OFFSET" NUMBER(10)  NOT NULL,
	"ISCS_AGM_START_OFFSET" NUMBER(10)  NOT NULL,	
	"ISCS_SNC_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_RUNMODE_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_EPF_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_XPF_START_BYTE" NUMBER(10)  NOT NULL,
	"ISCS_SPF_START_BYTE" NUMBER(10)  NOT NULL,	
	"CREATE_TIME" DATE DEFAULT SYSDATE,
	 CONSTRAINT PK_SS_ISCS_STATION PRIMARY KEY (ISCS_STATION_NID,ISCS_STATION_ID)
)
TABLESPACE TBSDCCDBADMIN; 
由AFC的车站设备编号计算出ISCS的相关点位(和点表有关)。  
  
/*
0501虎滩新区站、
0502虎滩公园站、
0503秀月街站、
0504桃园街站、
0505青云街站、
0506石葵路站、
0507劳动公园站、
0508青泥洼桥站（0208）、
0509火车站站（0301）、
050A梭鱼湾南站（050A）、
050B梭鱼湾站（050B）、
050C甘井子站（050C）、
050D山花街站（050D）、
050E中华路站（050E）、
050F泉水东站（050F）、
0510前盐站（0510）、
0511后盐站（0305）、
0512后关村站（0512）
*/  
   
ISCS_STATION_ID 为车站序号，按照顺序，十进制,从0开始
   
   
   
   
 
4.MLC工作站分公司权限管理 
表 TBL_SS_COMPANYCODE(CODE_TYPE, CODE_NAME) 
---做约束 CODE_TYPE实际就是线路号，手动维护，0号线默认为管理所有MLC线路
结合 TBL_SS_USER中的 COMPANY_NAME(实际对应TBL_SS_COMPANYCODE中的 CODE_TYPE)
 
操作员登录之后，获取到操作员的 COMPANY_NAME 及操作员的所属线路
然后通过所属线路获取到该操作员的所有管理车站(常规和换乘站)，
提前准备好需要拼接的范围SQL语句---线路范围SQL语句和车站范围SQL语句。 
最后所有有关数据查询的SQL语句最后拼接范围SQL语句，即可在MLC工作站实现数据范围管理。


5.软件更新接口 0x6022
5.1 工作站 参数管理->参数管理->软件包管理 
  功能：将软件包导入到服务器中，并将软件包信息入库保存，便于下发筛选
  
DROP TABLE TBL_PM_SOFT;
CREATE TABLE "TBL_PM_SOFT" 
   (	"FILE_NAME" VARCHAR2(100) NOT NULL, 
	"OPERATOR_ID" VARCHAR2(8), 
	"SOFT_STATUS" NUMBER(3,0) DEFAULT 3, 
	"VERSION_MEMO" VARCHAR2(255), 
	"CREATE_DATE" DATE DEFAULT SYSDATE, 
	 CONSTRAINT "PK_PM_SOFT" PRIMARY KEY ("FILE_NAME")
   );

5.2 监控管理->线路监控 增加软件更新软件，负责下发软件更新指令


6.MLC区分5号线和13号线全线，故 TBL_SS_FUNC 表字段扩大。
ALTER TABLE  TBL_SS_FUNC MODIFY FUNC_ID NUMBER(10,0);
ALTER TABLE  TBL_SS_FUNC MODIFY ROOT_FUNC_ID NUMBER(10,0);
alter table TBL_SS_FUNC  add constraint PK_SS_FUNC primary key (FUNC_ID);

--另外13号线的根菜单要调整，5号线的菜单基础数据要录入
ALTER TABLE  TBL_SS_ROLE_TO_FUNC MODIFY FUNC_ID NUMBER(10,0);
ALTER TABLE  TBL_SS_ROLE_TO_FUNC MODIFY ROLE_RIGHT  NUMBER(10,0);

7.
TBL_SS_DEVICE 增加字段LIND_NID 保存设备所在线路，设备号是唯一的
ALTER TABLE TBL_SS_DEVICE ADD LINE_NID VARCHAR2(2);
MLC 的CCDB_LIB.F_SYS_GETLINENID(in deviceNid) 函数，获取设备所在线路号，便于MLC查询。

8.MLC前端增加  BOM收入差异审核报表 RP0120_BomDiff.cs
9.MLC前端增加  线路分系统与MLC系统数据差异自动对比

增加表
DROP TABLE  TBL_BATCH_TRANSTYPE_DAY_BACK;
CREATE TABLE  TBL_BATCH_TRANSTYPE_DAY_BACK
(
  SETTLE_DATE      VARCHAR2(8 BYTE)             NOT NULL,
  TRANS_DATE       VARCHAR2(8 BYTE)             NOT NULL,
  LINE_NID      	 VARCHAR2(2 BYTE), 
  STATION_NID      VARCHAR2(4 BYTE)             NOT NULL,
  DEVICE_NID       VARCHAR2(8 BYTE)             NOT NULL,
  DEVICE_TYPE      VARCHAR2(2 BYTE)             NOT NULL,
  TICKET_CATEGORY  VARCHAR2(4 BYTE)             NOT NULL,
  TICKET_TYPE      VARCHAR2(4 BYTE)             NOT NULL,
  TRANS_TYPE      VARCHAR2(2 BYTE)              NOT NULL,
  PAYMENT_METHOD  VARCHAR2(2 BYTE)              DEFAULT 0                     NOT NULL,
  OPERATOR_ID     VARCHAR2(8 BYTE)              NOT NULL,
  VALUE_TRANS     NUMBER(10)                    NOT NULL,
  SETTLE_COUNT    NUMBER(10),
  SETTLE_AMOUNT   NUMBER(10),
  TRANS_FEE       NUMBER(10),
  DEPOSIT         NUMBER(10)
)
TABLESPACE TBSDCCDBACCOUNT ;


DROP VIEW V_TRANSTYPE_DATA;
CREATE VIEW V_TRANSTYPE_DATA
AS
SELECT T1.SETTLE_DATE, T1.TRANS_DATE, T1.LINE_NID, T1.STATION_NID, T1.DEVICE_NID, 
T1.TICKET_CATEGORY, T1.TICKET_TYPE, T1.TRANS_TYPE, 
T1.SETTLE_COUNT_SUM,T1.SETTLE_AMOUNT_SUM,T2.SETTLE_COUNT_SUM SETTLE_COUNT_SUM_MLC,T2.SETTLE_AMOUNT_SUM SETTLE_AMOUNT_SUM_MLC
FROM 
(
SELECT   SETTLE_DATE,TRANS_DATE,LINE_NID, STATION_NID, DEVICE_NID, TICKET_CATEGORY, TICKET_TYPE, TRANS_TYPE,
SUM(SETTLE_COUNT) SETTLE_COUNT_SUM,SUM(SETTLE_AMOUNT) SETTLE_AMOUNT_SUM
	FROM TBL_BATCH_TRANSTYPE_DAY 
GROUP BY SETTLE_DATE,TRANS_DATE,LINE_NID, STATION_NID, DEVICE_NID, TICKET_CATEGORY, TICKET_TYPE, TRANS_TYPE
) T1
LEFT JOIN 
(
SELECT   SETTLE_DATE,TRANS_DATE,LINE_NID, STATION_NID, DEVICE_NID, TICKET_CATEGORY, TICKET_TYPE, TRANS_TYPE,
SUM(SETTLE_COUNT) SETTLE_COUNT_SUM,SUM(SETTLE_AMOUNT) SETTLE_AMOUNT_SUM
	FROM TBL_BATCH_TRANSTYPE_DAY_BACK 
GROUP BY SETTLE_DATE,TRANS_DATE,LINE_NID, STATION_NID, DEVICE_NID, TICKET_CATEGORY, TICKET_TYPE, TRANS_TYPE
) T2
ON T1.SETTLE_DATE = T2.SETTLE_DATE
AND T1.TRANS_DATE = T2.TRANS_DATE
AND T1.DEVICE_NID = T2.DEVICE_NID
AND T1.TICKET_CATEGORY = T2.TICKET_CATEGORY
AND T1.TICKET_TYPE = T2.TICKET_TYPE
AND T1.TRANS_TYPE = T2.TRANS_TYPE;


线路分系统与MLC系统数据差异对比报表
RP.0307.Integrated.DataCompare.cs

配置文件 DBConfig.xml

  <MlcServerIP>192.168.249.133</MlcServerIP>
  <MlcServerPort>1521</MlcServerPort>
  <MlcServiceName>XE</MlcServiceName>
  <MlcUserID>mlcdb</MlcUserID>  
  <MlcPassword>mlcdb</MlcPassword>  
  
10.配置文件 OTHER 下面增加 1--mlc；2---线路分中心
SOFT_TYPE=1

  
11.参数入库，软件入库

DROP table TBL_MN_DEVICE_PARAM;
create table TBL_MN_DEVICE_PARAM
(
   DATA_SEQ 						NUMBER(10),
   DEVICE_NID           VARCHAR(8)	not null,
   PARAM_STATUS         NUMBER(10),
   PARAM_TYPE        		VARCHAR(4)	not null,   
   PARAM_VERSION        VARCHAR(14)	not null,
   EFFECT_TIME          VARCHAR(14),
   CREATE_TIME          DATE DEFAULT SYSDATE
)
TABLESPACE TBSDCCDBACCOUNT ;

DROP table TBL_MN_DEVICE_SOFT;
create table TBL_MN_DEVICE_SOFT
(
   DATA_SEQ 						NUMBER(10),
   DEVICE_NID           VARCHAR(8)	not null,
   SOFT_TYPE         		NUMBER(10),
   SOFT_VERSION         VARCHAR(24),
   CREATE_TIME          DATE DEFAULT SYSDATE
)
TABLESPACE TBSDCCDBACCOUNT ;


12.
20230321 HHJT_CJP 
(1) tbl_tk_ticket_flow_stat 增加字段 LINE_NID ,已增加线路号区分

ALTER TABLE TBL_TK_TICKET_FLOW_STAT ADD LINE_NID VARCHAR2(2);

13.
20230404 HHJT_CJP 
(1) 表结构增加字段。
ALTER TABLE TBL_BATCH_TRANS_DEVICE ADD FAULT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_DEVICE ADD FAULT_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_DEVICE ADD UNBUSINESS_IN_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_DEVICE ADD UNBUSINESS_IN_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_DEVICE ADD UNBUSINESS_OUT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_DEVICE ADD UNBUSINESS_OUT_AMOUNT NUMBER(10,0) DEFAULT 0;

ALTER TABLE TBL_BATCH_TRANS_OPERATOR ADD FAULT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_OPERATOR ADD FAULT_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_OPERATOR ADD UNBUSINESS_IN_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_OPERATOR ADD UNBUSINESS_IN_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_OPERATOR ADD UNBUSINESS_OUT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_OPERATOR ADD UNBUSINESS_OUT_AMOUNT NUMBER(10,0) DEFAULT 0;

ALTER TABLE TBL_BATCH_TRANS_SETTLE_TRANS ADD FAULT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_TRANS ADD FAULT_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_TRANS ADD UNBUSINESS_IN_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_TRANS ADD UNBUSINESS_IN_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_TRANS ADD UNBUSINESS_OUT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_TRANS ADD UNBUSINESS_OUT_AMOUNT NUMBER(10,0) DEFAULT 0;

ALTER TABLE TBL_BATCH_TRANS_SETTLE_HIS ADD FAULT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_HIS ADD FAULT_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_HIS ADD UNBUSINESS_IN_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_HIS ADD UNBUSINESS_IN_AMOUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_HIS ADD UNBUSINESS_OUT_COUNT NUMBER(10,0) DEFAULT 0;
ALTER TABLE TBL_BATCH_TRANS_SETTLE_HIS ADD UNBUSINESS_OUT_AMOUNT NUMBER(10,0) DEFAULT 0;

(2)
存储过程更改
A. 银行缴款的日期由 PAYMENT_DATE  改为SETTLE_DATE
B. PROC_ERROR_SETTLE 故障退款统计弃用
C. 相关表增加字段的赋值
D.故障退款线路号错误修复

14.
20230526 HHJT_ZDD
(1)表结构增加字段

ALTER TABLE TBL_BATCH_CASH_DIFF ADD MEMO VARCHAR2(1024);

(2)存储过程更改
A.操作员与设备操作员在插入CASH_DIFF表中时字段取值修改
B.增加MEMO字段

(3)新增表
-- CCDB.TBL_BATCH_TRANS_OPERATOR definition

-- DDL generated by DBeaver
-- WARNING: It may differ from actual native database DDL

-- Drop table

-- DROP TABLE TBL_BATCH_TRANS_BOM_OPERATOR;

CREATE TABLE TBL_BATCH_TRANS_BOM_OPERATOR (
	SETTLE_DATE VARCHAR2(8),
	TRANS_DATE VARCHAR2(8),
	OPERATOR_ID VARCHAR2(8),
	LINE_NID VARCHAR2(2),
	STATION_NID VARCHAR2(4),
	TICKET_CATEGORY VARCHAR2(4),
	TICKET_TYPE VARCHAR2(4),
	PAYMENT_METHOD VARCHAR2(2),
	SALE_COUNT NUMBER(10,0),
	SALE_AMOUNT NUMBER(10,0),
	IN_COUNT NUMBER(10,0),
	OUT_COUNT NUMBER(10,0),
	OUT_AMOUNT NUMBER(10,0),
	LOAD_COUNT NUMBER(10,0),
	LOAD_AMOUNT NUMBER(10,0),
	LOAD_OFFSET_COUNT NUMBER(10,0),
	LOAD_OFFSET_AMOUNT NUMBER(10,0),
	UPDATE_COUNT NUMBER(10,0),
	UPDATE_AMOUNT NUMBER(10,0),
	CARD_UPDATE_COUNT NUMBER(10,0),
	CARD_UPDATE_AMOUNT NUMBER(10,0),
	REFUND_COUNT NUMBER(10,0),
	REFUND_AMOUNT NUMBER(10,0),
	DEPOSIT NUMBER(10,0),
	TRANS_FEE NUMBER(10,0),
	CARD_PAY_COUNT NUMBER(10,0) DEFAULT 0,
	CARD_PAY_AMOUNT NUMBER(10,0) DEFAULT 0
,
	FAULT_COUNT NUMBER(10,0) DEFAULT 0,
	FAULT_AMOUNT NUMBER(10,0) DEFAULT 0,
	UNBUSINESS_IN_COUNT NUMBER(10,0) DEFAULT 0,
	UNBUSINESS_IN_AMOUNT NUMBER(10,0) DEFAULT 0,
	UNBUSINESS_OUT_COUNT NUMBER(10,0) DEFAULT 0,
	UNBUSINESS_OUT_AMOUNT NUMBER(10,0) DEFAULT 0
);

















