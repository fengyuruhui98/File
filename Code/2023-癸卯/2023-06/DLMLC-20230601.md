```sql
    --------------------------------------------------------
  --  操作员长短款统计                                --
  --------------------------------------------------------
  PROCEDURE PROC_CH_DIFF_OP(batch_date IN VARCHAR2) IS
    --error message
    errmsg VARCHAR2(500);
    --variables
    v_count NUMBER;
    -- performance log variables
    batch_name   VARCHAR2(50);
    start_time   DATE;
    end_time     DATE;
    elapsed_time BINARY_INTEGER;
    rid          NUMBER(10);
    proc_version VARCHAR2(50);
  BEGIN
  	proc_version	:= '(21.3.30)';
    start_time 		:= SYSDATE;
    batch_name 		:= proc_version||'CCDB_BATCH.PROC_CH_DIFF_OP';    
    rid        		:= CCDB_LIB.IF_DB_LOG_INSERT(batch_name, batch_date);    
 
    --删除历史
    DELETE tbl_batch_cash_diff_op WHERE settle_date = batch_date;
    
    --1.设备领用上缴
    --2.实际交易金额
    --3.
    --设备领用上缴
     INSERT INTO tbl_batch_cash_diff_op
      (line_name, station_nid, station_name, ticket_type, ticket_name, ticket_category, operator_name, sale_count,
      sale_amount, load_count, load_amount, load_offset_count, load_offset_amount, update_count, update_amount, 
      card_update_count, card_update_amount,refund_count, refund_amount, deposit, trans_fee, fault_count, fault_amount, unbusiness_in_count, unbusiness_in_amount, unbusiness_out_count, unbusiness_out_amount, trans_date)
      SELECT line_name, station_nid, station_name, ticket_type, ticket_name, ticket_category, operator_name, sum(sale_count),
            sum(sale_amount), sum(load_count), sum(load_amount), sum(load_offset_count), sum(load_offset_amount), sum(update_count), sum(update_amount),sum(card_update_count), sum(card_update_amount),sum(refund_count), sum(refund_amount), sum(deposit), sum(trans_fee), sum(fault_count), sum(fault_amount), sum(unbusiness_in_count), sum(unbusiness_in_amount), sum(unbusiness_out_count), sum(unbusiness_out_amount), trans_date
        FROM (
               SELECT NVL((select Line_name_cn from tbl_ss_line_info where line_id = substr(batchtable.line_nid,1,2)) ,'未知线路') line_name, station_nid, 
               NVL((select station_name_cn from tbl_ss_station_info where station_nid = batchtable.station_nid union all select station_name_cn from tbl_ss_special_station where station_nid = batchtable.station_nid),'未知车站') station_name,
               ticket_type, 
               NVL((select TICKET_NAME from  (select TICKET_TYPE,TRIM(TICKET_NAME) TICKET_NAME from TBL_SS_TICKET_TYPE
                 union  
                 select 'FFFF','BOM故障退款' from dual
                 union  
                 select 'FFFE','TVM故障退款' from dual
                 union 
                 select 'FFFD','非营业性收入' from dual
                 union 
                 select 'FFFC','非营业性支出' from dual
                  ) where TICKET_TYPE=batchtable.TICKET_TYPE),'未知票卡类型') ticket_name, 
               ticket_category,
               '['||batchtable.operator_id||']'|| NVL((select user_name from tbl_ss_user where user_id = batchtable.operator_id), '未知操作员') operator_name,
                                               SALE_COUNT, SALE_AMOUNT, 
                                               LOAD_COUNT, LOAD_AMOUNT, LOAD_OFFSET_COUNT, 
                                               LOAD_OFFSET_AMOUNT, UPDATE_COUNT, UPDATE_AMOUNT, 
                                               CARD_UPDATE_COUNT, CARD_UPDATE_AMOUNT, REFUND_COUNT, 
                                               REFUND_AMOUNT, DEPOSIT, TRANS_FEE, fault_count, fault_amount, 
                                               UNBUSINESS_IN_COUNT,UNBUSINESS_IN_AMOUNT,
                                               UNBUSINESS_OUT_COUNT,UNBUSINESS_OUT_AMOUNT,
                                               trans_date
                                        FROM TBL_BATCH_TRANS_OPERATOR batchtable
                                        where trans_date = '20230524'
                                     
            )
       GROUP BY line_name, station_nid, station_name, ticket_type, ticket_name, ticket_category, operator_name, trans_date;
       
    COMMIT;
  
    end_time := SYSDATE;

    elapsed_time := (end_time - start_time) * 86400;
    IF (NOT CCDB_LIB.IF_DB_LOG_UPDATE(rid, elapsed_time) AND CCDB_STD.DEBUG__) THEN
      errmsg := ' error when executing IF_DB_LOG_UPDATE';
      DBMS_OUTPUT.PUT_LINE(errmsg);
    END IF;

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      IF (CCDB_STD.DEBUG__) THEN
        dbms_output.put_line('ERR:' || SQLERRM(SQLCODE));
      ELSE
        errmsg := SQLERRM(SQLCODE);
        CCDB_LIB.IP_BATCH_LOG('CCDB_BATCH.PROC_CH_DIFF', CCDB_STD.LEVEL_LOG_FERR,
                              errmsg, CCDB_STD.DEST_BOTH);
      END IF;
  END;
```
